var j=Object.defineProperty;var z=(n,e,t)=>e in n?j(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var _=(n,e,t)=>z(n,typeof e!="symbol"?e+"":e,t);import{x as I,r as o,y as D,j as l,e as N}from"./index-CZxPsgtl.js";import{C as k,t as g,f as F,p as P,w as q,x as Q}from"./use-mobile-sheet-gestures-7ZTHhJaI.js";import{B as T}from"./button-U-gaqQbr.js";import{e as B}from"./datasources-CeLYhvmT.js";import{c as G}from"./IconDotsVertical-eEUAHx4i.js";import"./index-B-AaFApu.js";import"./index-C0ojYzrY.js";import"./dropdown-menu-3wu0TjhC.js";import"./index-DWgOKySk.js";/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var K=G("outline","player-play","IconPlayerPlay",[["path",{d:"M7 4v16l13 -8z",key:"svg-0"}]]);class A{constructor(){_(this,"grid",new Map);_(this,"cellIndex",new k)}loadQueryResults(e,t){this.grid.clear();for(let s=0;s<e.length;s++){const d=g({r:1,c:s+1});this.grid.set(d,{v:e[s].name,s:{b:!0}})}for(let s=0;s<t.length;s++){const d=t[s];for(let r=0;r<e.length;r++){const a=d[e[r].name];if(a==null)continue;const f=g({r:s+2,c:r+1});this.grid.set(f,{v:String(a)})}}this.rebuildIndex()}async set(e,t){}async get(e){return this.grid.get(g(e))}async has(e){return this.grid.has(g(e))}async delete(e){return!1}async deleteRange(e){return new Set}async setGrid(e){}async getGrid(e){const t=new Map;for(const[s,d]of this.cellIndex.cellsInRange(e)){const r=g({r:s,c:d}),a=this.grid.get(r);a!==void 0&&t.set(r,a)}return t}async findEdge(e,t,s){return F(this.cellIndex,e,t,s,(d,r)=>{const a=this.grid.get(g({r:d,c:r}));return a!==void 0&&(!!a.v||!!a.f)})}async shiftCells(e,t,s){}async moveCells(e,t,s,d){}async buildDependantsMap(e){return new Map}async getFormulaGrid(){return new Map}getPresences(){return[]}updateActiveCell(e){}async setDimensionSize(e,t,s){}async getDimensionSizes(e){return new Map}async setColumnStyle(e,t){}async getColumnStyles(){return new Map}async setRowStyle(e,t){}async getRowStyles(){return new Map}async setSheetStyle(e){}async getSheetStyle(){}async addRangeStyle(e){}async setRangeStyles(e){}async getRangeStyles(){return[]}async setConditionalFormats(e){}async getConditionalFormats(){return[]}async setMerge(e,t){}async deleteMerge(e){return!1}async getMerges(){return new Map}async setFilterState(e){}async getFilterState(){}async setFreezePane(e,t){}async getFreezePane(){return{frozenRows:0,frozenCols:0}}beginBatch(){}endBatch(){}async undo(){return{success:!1}}async redo(){return{success:!1}}canUndo(){return!1}canRedo(){return!1}rebuildIndex(){this.cellIndex.rebuild(Array.from(this.grid.keys()).map(e=>{const t=P(e);return[t.r,t.c]}))}}function $({tabId:n}){const{resolvedTheme:e}=I(),t=o.useRef(null),[s,d]=o.useState(!1),r=o.useRef(void 0),a=o.useRef(new A),{doc:f,loading:M,error:w}=D.useDocument(),[y,v]=o.useState(""),[S,R]=o.useState(!1),[x,E]=o.useState(null),[C,m]=o.useState(null);q({containerRef:t,sheetRef:r}),o.useEffect(()=>{d(!0)},[]),o.useEffect(()=>{if(!f)return;const c=f.getRoot().tabs[n];c!=null&&c.query&&v(c.query)},[f,n]),o.useEffect(()=>{const i=t.current;if(!s||!i)return;let c,u=!1;return Q(i,{theme:e,store:a.current,readOnly:!0}).then(p=>{if(u){p.cleanup();return}c=p,r.current=p}),()=>{u=!0,c&&c.cleanup(),r.current=void 0}},[s,e]);const h=o.useCallback(async()=>{if(!f||!y.trim())return;const c=f.getRoot().tabs[n];if(!(c!=null&&c.datasourceId)){m("No datasource connected to this tab");return}f.update(u=>{u.tabs[n]&&(u.tabs[n].query=y)}),R(!0),m(null);try{const u=await B(c.datasourceId,y);E(u),a.current.loadQueryResults(u.columns,u.rows),r.current&&(await r.current.reloadDimensions(),r.current.render())}catch(u){m(u.message)}finally{R(!1)}},[f,n,y]),b=o.useCallback(i=>{(i.metaKey||i.ctrlKey)&&i.key==="Enter"&&(i.preventDefault(),h())},[h]);return M?l.jsx(N,{}):w?l.jsx("div",{className:"flex h-full w-full items-center justify-center",children:l.jsx("div",{className:"text-red-500",children:w.message})}):l.jsxs("div",{className:"flex h-full w-full flex-col",children:[l.jsx("div",{className:"border-b p-2 shrink-0",children:l.jsx("textarea",{className:"w-full h-24 p-2 font-mono text-sm border rounded resize-y bg-background text-foreground focus:outline-none focus:ring-1 focus:ring-primary",placeholder:"SELECT * FROM users LIMIT 100",value:y,onChange:i=>v(i.target.value),onKeyDown:b})}),l.jsxs("div",{className:"flex items-center gap-3 px-3 py-1.5 border-b shrink-0",children:[l.jsxs(T,{size:"sm",onClick:h,disabled:S||!y.trim(),children:[l.jsx(K,{className:"size-4"}),S?"Executing...":"Execute"]}),x&&l.jsxs("span",{className:"text-xs text-muted-foreground",children:[x.rowCount," row",x.rowCount!==1?"s":"",x.truncated?" (truncated)":""," in ",x.executionTime,"ms"]}),C&&l.jsx("span",{className:"text-xs text-destructive truncate",children:C})]}),l.jsx("div",{ref:t,className:"flex-1 w-full",style:{touchAction:"manipulation"}})]})}export{$ as DataSourceView};
