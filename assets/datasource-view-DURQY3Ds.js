import{r as t,j as s}from"./vendor-react-Bg6UneQK.js";import"./sheet-formula-parser-CbheDyXI.js";import"./sheet-formula-eval-Dt5gAu0n.js";import{R as k,f as C}from"./sheet-core-CkcOJo3G.js";import{y as D}from"./vendor-yorkie-DqSL832E.js";import{u as M,i as q,L as z}from"./index-C3XCa7RV.js";import{B as T}from"./button-DWQ-sR7I.js";import{e as K}from"./datasources-D2U5CDAG.js";import{u as L}from"./use-mobile-sheet-gestures-D5cbSotk.js";import{c as P}from"./IconDotsVertical-CWmuc0X_.js";import"./vendor-app-HGRjaN7r.js";import"./vendor-ui-DUghwSYy.js";import"./index-3UDGtr2f.js";import"./utils-DjqsqOe8.js";import"./http-error-XKKRT0jQ.js";/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var Q=P("outline","player-play","IconPlayerPlay",[["path",{d:"M7 4v16l13 -8z",key:"svg-0"}]]);function O({tabId:a,readOnly:n=!1}){const{resolvedTheme:p}=M(),f=t.useRef(null),[h,w]=t.useState(!1),c=t.useRef(void 0),y=t.useRef(new k),{doc:u,loading:N,error:g}=D.useDocument(),[i,E]=t.useState(""),[v,R]=t.useState(!1),[l,S]=t.useState(null),[j,m]=t.useState(null);L({containerRef:f,sheetRef:c}),t.useEffect(()=>{w(!0)},[]),t.useEffect(()=>{if(!u)return;const e=u.getRoot().tabs[a];e!=null&&e.query&&E(e.query)},[u,a]),t.useEffect(()=>{const o=f.current;if(!h||!o)return;let e,r=!1;return C(o,{theme:p,store:y.current,readOnly:!0}).then(x=>{if(r){x.cleanup();return}e=x,c.current=x}),()=>{r=!0,e&&e.cleanup(),c.current=void 0}},[h,p]);const d=t.useCallback(async()=>{if(!u||!i.trim()||n)return;const e=u.getRoot().tabs[a];if(!(e!=null&&e.datasourceId)){m("No datasource connected to this tab");return}u.update(r=>{r.tabs[a]&&(r.tabs[a].query=i)}),R(!0),m(null);try{const r=await K(e.datasourceId,i);S(r),y.current.loadQueryResults(r.columns,r.rows),c.current&&(await c.current.reloadDimensions(),c.current.render())}catch(r){if(q(r))return;m(r.message)}finally{R(!1)}},[u,a,i,n]),b=t.useCallback(o=>{if((o.metaKey||o.ctrlKey)&&o.key==="Enter"){if(n)return;o.preventDefault(),d()}},[d,n]);return N?s.jsx(z,{}):g?s.jsx("div",{className:"flex h-full w-full items-center justify-center",children:s.jsx("div",{className:"text-red-500",children:g.message})}):s.jsxs("div",{className:"flex h-full w-full flex-col",children:[s.jsx("div",{className:"border-b p-2 shrink-0",children:s.jsx("textarea",{className:"w-full h-24 p-2 font-mono text-sm border rounded resize-y bg-background text-foreground focus:outline-none focus:ring-1 focus:ring-primary",placeholder:"SELECT * FROM users LIMIT 100",value:i,onChange:o=>{n||E(o.target.value)},onKeyDown:b,readOnly:n})}),s.jsxs("div",{className:"flex items-center gap-3 px-3 py-1.5 border-b shrink-0",children:[s.jsxs(T,{size:"sm",onClick:d,disabled:n||v||!i.trim(),children:[s.jsx(Q,{className:"size-4"}),v?"Executing...":"Execute"]}),l&&s.jsxs("span",{className:"text-xs text-muted-foreground",children:[l.rowCount," row",l.rowCount!==1?"s":"",l.truncated?" (truncated)":""," in ",l.executionTime,"ms"]}),j&&s.jsx("span",{className:"text-xs text-destructive truncate",children:j})]}),s.jsx("div",{ref:f,className:"flex-1 w-full",style:{touchAction:"manipulation"}})]})}export{O as DataSourceView};
