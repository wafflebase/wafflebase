var _t=Object.defineProperty;var Xt=(l,e,t)=>e in l?_t(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var p=(l,e,t)=>Xt(l,typeof e!="symbol"?e+"":e,t);import{e as Fe,a as _e,b as qt,n as Ze,s as jt,f as Qt,c as Ge,F as Ne,S as Zt,l as Jt,d as ye,i as es,g as Je}from"./sheet-formula-DQdd396h.js";function*et(l){const[e,t]=l;for(let s=e.r;s<=t.r;s++)for(let n=e.c;n<=t.c;n++)yield{r:s,c:n}}function Z(l,e){const[t,s]=e;return t.r<=l.r&&l.r<=s.r&&t.c<=l.c&&l.c<=s.c}function ts(l,e){const[t,s]=l,[n,i]=e;return n.r<=t.r&&s.r<=i.r&&n.c<=t.c&&s.c<=i.c}function G(l,e){return[{r:Math.min(l.r,e.r),c:Math.min(l.c,e.c)},{r:Math.max(l.r,e.r),c:Math.max(l.c,e.c)}]}function q(l){return[tt(l[0]),tt(l[1])]}function se(l,e){return ve(l[0],e[0])&&ve(l[1],e[1])}function ss(l,e){const t=[];return l[0].r>e[0].r&&t.push([{r:l[0].r-1,c:l[0].c},{r:l[0].r-1,c:l[1].c}]),l[1].r<e[1].r&&t.push([{r:l[1].r+1,c:l[0].c},{r:l[1].r+1,c:l[1].c}]),l[0].c>e[0].c&&t.push([{r:l[0].r,c:l[0].c-1},{r:l[1].r,c:l[0].c-1}]),l[1].c<e[1].c&&t.push([{r:l[0].r,c:l[1].c+1},{r:l[1].r,c:l[1].c+1}]),t}function We(l,e){const[t,s]=l,[n,i]=e;return[{r:Math.min(t.r,n.r),c:Math.min(t.c,n.c)},{r:Math.max(s.r,i.r),c:Math.max(s.c,i.c)}]}function ve(l,e){return l.r===e.r&&l.c===e.c}function tt(l){return{r:l.r,c:l.c}}function ns(l){return l.includes(":")}function He(l){return l.includes("!")}function bt(l){const e=l.indexOf("!");if(e===-1)throw new Error(`Not a cross-sheet reference: ${l}`);let t=l.substring(0,e);t.startsWith("'")&&t.endsWith("'")&&(t=t.slice(1,-1));const s=l.substring(e+1);return{sheetName:t,localRef:s}}function*Ft(l){for(const e of l){if(He(e)){const{sheetName:t,localRef:s}=bt(e);if(s.includes(":")){const n=st(s);for(const i of et(n))yield`${t}!${M(i)}`}else yield e;continue}if(ns(e)){const t=st(e);for(const s of et(t))yield M(s);continue}yield e}}function M(l){return fe(l.c)+l.r}function is(l){const[e,t]=l;return`${M(e)}:${M(t)}`}function fe(l){let e="";for(;l>0;){const t=l%26;t===0?(e="Z"+e,l=Math.floor(l/26)-1):(e=String.fromCharCode(t+64)+e,l=Math.floor(l/26))}return e}function H(l){const e=l.replace(/\$/g,"");let t=0;for(let i=0;i<e.length;i++){const r=e.charCodeAt(i);if(48<=r&&r<=57){t=i;break}}if(t===0)throw new Error("Invalid Reference");const s=parseInt(e.substring(t)),n=e.substring(0,t).split("").reverse().reduce((i,r,o)=>i+Math.pow(26,o)*(r.charCodeAt(0)-65+1),0);if(isNaN(s)||isNaN(n))throw new Error("Invalid Reference");return{r:s,c:n}}function st(l){const[e,t]=l.split(":");return[H(e),H(t)]}function U(l,e,t,s){const n=e+t;return s<=e?l>=e&&l<n?s+(l-e):l>=s&&l<e?l+t:l:l>=e&&l<n?s-t+(l-e):l>=n&&l<s?l-t:l}function ae(l,e,t,s,n){return e==="row"?{r:U(l.r,t,s,n),c:l.c}:{r:l.r,c:U(l.c,t,s,n)}}function rs(l,e,t,s,n){const i=Fe(l);let r="=";for(const o of i)if(o.type==="REFERENCE"){const a=o.text;if(a.includes("!"))r+=a;else if(a.includes(":")){const[h,c]=a.split(":"),u=H(h.toUpperCase()),d=H(c.toUpperCase()),f=ae(u,e,t,s,n),C=ae(d,e,t,s,n);r+=M(f)+":"+M(C)}else{const h=H(a.toUpperCase()),c=ae(h,e,t,s,n);r+=M(c)}}else r+=o.text;return r}function os(l,e,t,s,n){const i=new Map;for(const[r,o]of l){const a=H(r),h=ae(a,e,t,s,n),c=M(h);let u;o.f?u={...o,f:rs(o.f,e,t,s,n)}:u={...o},i.set(c,u)}return i}function re(l,e,t,s){const n=new Map;for(const[i,r]of l)n.set(U(i,e,t,s),r);return n}function nt(l,e,t){const s=Fe(l);let n="=";for(const i of s)if(i.type==="REFERENCE"){const r=i.text;if(r.includes("!"))n+=r;else if(r.includes(":")){const[o,a]=r.split(":"),h=H(o.toUpperCase()),c=H(a.toUpperCase()),u={r:h.r+e,c:h.c+t},d={r:c.r+e,c:c.c+t};u.r<1||u.c<1||d.r<1||d.c<1?n+="#REF!":n+=M(u)+":"+M(d)}else{const o=H(r.toUpperCase()),a={r:o.r+e,c:o.c+t};a.r<1||a.c<1?n+="#REF!":n+=M(a)}}else n+=i.text;return n}function Pe(l,e,t,s){const n=e==="row"?l.r:l.c;if(s>0)return n>=t?e==="row"?{r:l.r+s,c:l.c}:{r:l.r,c:l.c+s}:l;const i=Math.abs(s);return n>=t&&n<t+i?null:n>=t+i?e==="row"?{r:l.r+s,c:l.c}:{r:l.r,c:l.c+s}:l}function ls(l,e,t,s){const n=H(l),i=Pe(n,e,t,s);return i?M(i):null}function as(l,e,t,s){const n=Fe(l);let i="=";for(const r of n)if(r.type==="REFERENCE"){const o=r.text;if(o.includes("!"))i+=o;else if(o.includes(":")){const[a,h]=o.split(":"),c=H(a.toUpperCase()),u=H(h.toUpperCase()),d=Pe(c,e,t,s),f=Pe(u,e,t,s);!d||!f?i+="#REF!":i+=M(d)+":"+M(f)}else{const a=H(o.toUpperCase()),h=Pe(a,e,t,s);h?i+=M(h):i+="#REF!"}}else i+=r.text;return i}function oe(l,e,t){const s=new Map;for(const[n,i]of l)if(t>0)n>=e?s.set(n+t,i):s.set(n,i);else{const r=Math.abs(t);n>=e&&n<e+r||(n>=e+r?s.set(n+t,i):s.set(n,i))}return s}function hs(l,e,t,s){const n=new Map;for(const[i,r]of l){const o=ls(i,e,t,s);if(o===null)continue;let a;r.f?a={...r,f:as(r.f,e,t,s)}:a={...r},n.set(o,a)}return n}const cs=new Set(["isEmpty","isNotEmpty","textContains","greaterThan","between","dateBefore","dateAfter"]),us=new Set(["textContains","greaterThan","dateBefore","dateAfter"]);function ds(l){return[{r:l[0].r,c:l[0].c},{r:l[1].r,c:l[1].c}]}function fs(l){return cs.has(l)}function j(l){if(typeof l=="string")return l;if(l==null)return"";if(typeof l=="number"||typeof l=="boolean")return String(l);if(typeof l=="object"){const e=l;if(e.value!==void 0&&e.value!==l)return j(e.value);if(typeof e.toJSON=="function")try{const t=e.toJSON.call(l);if(t!==l)return j(t)}catch{}}return String(l)}function ps(l){return G(l[0],l[1])}function Ce(l){if(!l)return;const e=l.trim().replace(/,/g,"");if(!e)return;const t=Number(e);return Number.isFinite(t)?t:void 0}function ze(l){if(!l)return;const e=l.trim();if(!e)return;const t=e.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(t){const n=Number(t[1]),i=Number(t[2]),r=Number(t[3]),o=new Date(n,i-1,r);return o.getFullYear()!==n||o.getMonth()!==i-1||o.getDate()!==r?void 0:o.getTime()}const s=new Date(e);if(!Number.isNaN(s.getTime()))return new Date(s.getFullYear(),s.getMonth(),s.getDate()).getTime()}function Ie(l,e,t){if(t>0)return l>=e?l+t:l;const s=Math.abs(t);return l>=e&&l<e+s?e:l>=e+s?l+t:l}function zt(l){return G({r:Math.max(1,l[0].r),c:Math.max(1,l[0].c)},{r:Math.max(1,l[1].r),c:Math.max(1,l[1].c)})}function it(l){if(typeof l!="string")return;const e=l.trim();return e.length>0?e:void 0}function gs(l){const e={};l.b!==void 0&&(e.b=l.b),l.i!==void 0&&(e.i=l.i),l.u!==void 0&&(e.u=l.u);const t=it(l.tc);t!==void 0&&(e.tc=t);const s=it(l.bg);return s!==void 0&&(e.bg=s),Object.keys(e).length>0?e:void 0}function pe(l){const e={id:l.id,range:ds(l.range),op:l.op,style:{...l.style}};return l.value!==void 0&&(e.value=l.value),l.value2!==void 0&&(e.value2=l.value2),e}function De(l){const e=j(l.id).trim();if(!e)return;const t=j(l.op).trim();if(!fs(t))return;const s=gs(l.style||{});if(!s)return;const n={id:e,range:ps(l.range),op:t,style:s};if(us.has(t)){const i=j(l.value).trim();return i?(n.value=i,n):void 0}if(t==="between"){const i=j(l.value).trim(),r=j(l.value2).trim();return!i||!r?void 0:(n.value=i,n.value2=r,n)}return n}function ms(l,e){const s=j(l).trim();switch(e.op){case"isEmpty":return s.length===0;case"isNotEmpty":return s.length>0;case"textContains":{const n=j(e.value).trim().toLowerCase();return n?s.toLowerCase().includes(n):!1}case"greaterThan":{const n=Ce(s),i=Ce(e.value);return n!==void 0&&i!==void 0&&n>i}case"between":{const n=Ce(s),i=Ce(e.value),r=Ce(e.value2);if(n===void 0||i===void 0||r===void 0)return!1;const o=Math.min(i,r),a=Math.max(i,r);return n>=o&&n<=a}case"dateBefore":{const n=ze(s),i=ze(e.value);return n!==void 0&&i!==void 0&&n<i}case"dateAfter":{const n=ze(s),i=ze(e.value);return n!==void 0&&i!==void 0&&n>i}default:return!1}}function ys(l,e,t,s){if(l.length===0)return;const n={r:e,c:t},i=j(s==null?void 0:s.v);let r;for(const o of l)Z(n,o.range)&&ms(i,o)&&(r={...r||{},...o.style});return r}function It(l,e,t,s){const n=[];for(const i of l){const r=De(i);if(!r)continue;const o=r.range,a=e==="row"?G({r:Ie(o[0].r,t,s),c:o[0].c},{r:Ie(o[1].r,t,s),c:o[1].c}):G({r:o[0].r,c:Ie(o[0].c,t,s)},{r:o[1].r,c:Ie(o[1].c,t,s)});n.push({...pe(r),range:zt(a)})}return n}function Mt(l,e,t,s,n){const i=[];for(const r of l){const o=De(r);if(!o)continue;const a=o.range,h=e==="row"?G({r:U(a[0].r,t,s,n),c:a[0].c},{r:U(a[1].r,t,s,n),c:a[1].c}):G({r:a[0].r,c:U(a[0].c,t,s,n)},{r:a[1].r,c:U(a[1].c,t,s,n)});i.push({...pe(o),range:zt(h)})}return i}function xt(l){const e={};for(const t of Object.keys(l)){const s=l[t];s!==void 0&&(e[t]=s)}return Object.keys(e).length>0?e:void 0}function At(l,e){const t=l?{...l}:{};let s=!1;for(const n of Object.keys(e)){const i=e[n];i!==void 0&&(t[n]=i,s=!0)}if(Object.keys(t).length!==0&&!(!l&&!s))return t}function Xe(l){const e=Math.min(l[0].r,l[1].r),t=Math.min(l[0].c,l[1].c),s=Math.max(l[0].r,l[1].r),n=Math.max(l[0].c,l[1].c);return[{r:e,c:t},{r:s,c:n}]}function Se(l){return{range:Xe(l.range),style:{...l.style}}}function ee(l){const e=xt(l.style);if(e)return{range:Xe(l.range),style:e}}function Re(l,e){const t=Object.keys(l),s=Object.keys(e);if(t.length!==s.length)return!1;for(const n of t)if(l[n]!==e[n])return!1;return!0}function Cs(l,e){return l[0].r<=e[0].r&&l[0].c<=e[0].c&&l[1].r>=e[1].r&&l[1].c>=e[1].c}function qe(l){const e=[];for(let t=l.length-1;t>=0;t--){const s=ee(l[t]);if(!s)continue;let n=!1;for(const i of e)if(Re(i.style,s.style)&&Cs(i.range,s.range)){n=!0;break}n||e.push(Se(s))}return e.reverse()}function Tt(l){if(l.length<=1)return l;const e=[...l].sort((s,n)=>s[0]-n[0]),t=[];for(const s of e){const n=t[t.length-1];if(!n){t.push([s[0],s[1]]);continue}if(s[0]<=n[1]+1){n[1]=Math.max(n[1],s[1]);continue}t.push([s[0],s[1]])}return t}function rt(l,e,t,s){if(s===0)return[[l,e]];if(s>0)return e<t?[[l,e]]:l>=t?[[l+s,e+s]]:[[l,e+s]];const n=Math.abs(s),i=t+n-1,r=[];return l<t&&r.push([l,Math.min(e,t-1)]),e>i&&r.push([Math.max(l,i+1)+s,e+s]),Tt(r.filter(([o,a])=>o<=a))}function ot(l,e,t,s,n){const i=t+s,r=[];n<=t?(r.push({start:Number.NEGATIVE_INFINITY,end:n-1,delta:0}),r.push({start:n,end:t-1,delta:s}),r.push({start:t,end:i-1,delta:n-t}),r.push({start:i,end:Number.POSITIVE_INFINITY,delta:0})):(r.push({start:Number.NEGATIVE_INFINITY,end:t-1,delta:0}),r.push({start:t,end:i-1,delta:n-s-t}),r.push({start:i,end:n-1,delta:-s}),r.push({start:n,end:Number.POSITIVE_INFINITY,delta:0}));const o=[];for(const a of r){const h=Math.max(l,a.start),c=Math.min(e,a.end);h>c||o.push([h+a.delta,c+a.delta])}return Tt(o)}function Bt(l,e,t){const s=[];for(const[n,i]of t){if(e==="row"){s.push({range:[{r:n,c:l.range[0].c},{r:i,c:l.range[1].c}],style:{...l.style}});continue}s.push({range:[{r:l.range[0].r,c:n},{r:l.range[1].r,c:i}],style:{...l.style}})}return s}function Et(l,e){if(l.length<=1)return l.map(Se);const t=[];for(const s of l){const n=ee(s);if(!n)continue;const i=t[t.length-1];if(!i||!Re(i.style,n.style)){t.push(n);continue}if(e==="row"){const a=i.range[0].c===n.range[0].c&&i.range[1].c===n.range[1].c,h=n.range[0].r<=i.range[1].r+1;if(!a||!h){t.push(n);continue}i.range[0].r=Math.min(i.range[0].r,n.range[0].r),i.range[1].r=Math.max(i.range[1].r,n.range[1].r);continue}const r=i.range[0].r===n.range[0].r&&i.range[1].r===n.range[1].r,o=n.range[0].c<=i.range[1].c+1;if(!r||!o){t.push(n);continue}i.range[0].c=Math.min(i.range[0].c,n.range[0].c),i.range[1].c=Math.max(i.range[1].c,n.range[1].c)}return t}function Pt(l,e,t,s){const n=[];for(const i of l){const r=ee(i);if(!r)continue;const o=e==="row"?rt(r.range[0].r,r.range[1].r,t,s):rt(r.range[0].c,r.range[1].c,t,s);n.push(...Bt(r,e,o))}return qe(Et(n,e))}function kt(l,e,t,s,n){const i=[];for(const r of l){const o=ee(r);if(!o)continue;const a=e==="row"?ot(o.range[0].r,o.range[1].r,t,s,n):ot(o.range[0].c,o.range[1].c,t,s,n);i.push(...Bt(o,e,a))}return qe(Et(i,e))}function ws(l,e){const t=Xe(e),s=[];for(const n of l){const i=ee(n);if(!i)continue;const r=Math.max(i.range[0].r,t[0].r),o=Math.min(i.range[1].r,t[1].r),a=Math.max(i.range[0].c,t[0].c),h=Math.min(i.range[1].c,t[1].c);r>o||a>h||s.push({range:[{r,c:a},{r:o,c:h}],style:{...i.style}})}return s}function vs(l,e,t){const s=[];for(const n of l){const i=ee(n);if(!i)continue;const r=i.range[0].r+e,o=i.range[1].r+e,a=i.range[0].c+t,h=i.range[1].c+t;o<1||h<1||s.push({range:[{r:Math.max(1,r),c:Math.max(1,a)},{r:Math.max(1,o),c:Math.max(1,h)}],style:{...i.style}})}return s}function Ht(l,e,t){let s;for(const n of l)e<n.range[0].r||e>n.range[1].r||t<n.range[0].c||t>n.range[1].c||(s=At(s,n.style));return s}function we(l,e){return[{r:l.r,c:l.c},{r:l.r+e.rs-1,c:l.c+e.cs-1}]}function lt(l,e,t,s){if(s>0)return t<=l?[l+s,e+s]:t<=e?[l,e+s]:[l,e];const n=Math.abs(s),i=t,r=t+n-1;if(r<l)return[l+s,e+s];if(i>e)return[l,e];const o=Math.max(l,i),h=Math.min(e,r)-o+1,c=e-l+1-h;return c<=0?null:i<=l?[i,i+c-1]:[l,l+c-1]}function Ss(l,e,t,s,n){const i=lt(l.r,l.r+e.rs-1,t==="row"?s:Number.NEGATIVE_INFINITY,t==="row"?n:0);if(!i)return null;const r=lt(l.c,l.c+e.cs-1,t==="column"?s:Number.NEGATIVE_INFINITY,t==="column"?n:0);if(!r)return null;const[o,a]=i,[h,c]=r,u=a-o+1,d=c-h+1;return u<=1&&d<=1?null:{anchor:{r:o,c:h},span:{rs:u,cs:d}}}function Rs(l,e,t,s,n,i){const r=t==="row"?l.r+e.rs-1:l.c+e.cs-1,o=t==="row"?l.r:l.c,a=U(o,s,n,i),h=U(r,s,n,i),c=Math.min(a,h),d=Math.max(a,h)-c+1;if(t==="row"){const y=d,v=e.cs;return y<=1&&v<=1?null:{anchor:{r:c,c:l.c},span:{rs:y,cs:v}}}const f=e.rs,C=d;return f<=1&&C<=1?null:{anchor:{r:l.r,c},span:{rs:f,cs:C}}}function Ot(l,e,t,s){const n=new Map;for(const[i,r]of l){const o=H(i),a=Ss(o,r,e,t,s);a&&n.set(M(a.anchor),a.span)}return n}function Lt(l,e,t,s,n){const i=new Map;for(const[r,o]of l){const a=H(r),h=Rs(a,o,e,t,s,n);h&&i.set(M(h.anchor),h.span)}return i}function bs(l,e,t,s,n){const i=t==="row"?l.r:l.c,r=t==="row"?l.r+e.rs-1:l.c+e.cs-1,o=s+n-1;return r<s||i>o?!1:!(i>=s&&r<=o)}class at{constructor(e){p(this,"customSizes");p(this,"defaultSize");p(this,"cacheDirty",!0);p(this,"sortedIndices",[]);p(this,"sortedSizes",[]);p(this,"prefixDeltas",[]);p(this,"customStarts",[]);this.defaultSize=e,this.customSizes=new Map}getSize(e){return this.customSizes.get(e)??this.defaultSize}setSize(e,t){t===this.defaultSize?this.customSizes.delete(e):this.customSizes.set(e,t),this.cacheDirty=!0}getDefaultSize(){return this.defaultSize}getOffset(e){let t=(e-1)*this.defaultSize;if(this.customSizes.size===0)return t;this.ensureCache();const s=this.lowerBound(this.sortedIndices,e)-1;return s>=0&&(t+=this.prefixDeltas[s]),t}findIndex(e){if(e<0)return 1;if(this.customSizes.size===0)return Math.floor(e/this.defaultSize)+1;this.ensureCache();const t=this.customStarts[0];if(e<t)return Math.floor(e/this.defaultSize)+1;const s=this.upperBound(this.customStarts,e)-1,n=this.sortedIndices[s],i=this.customStarts[s],r=this.sortedSizes[s];if(e<i+r)return n;const o=e-(i+r);return n+1+Math.floor(o/this.defaultSize)}shift(e,t){const s=new Map;for(const[n,i]of this.customSizes)if(t>0)n>=e?s.set(n+t,i):s.set(n,i);else{const r=Math.abs(t);n>=e&&n<e+r||(n>=e+r?s.set(n+t,i):s.set(n,i))}this.customSizes=s,this.cacheDirty=!0}move(e,t,s){const n=new Map;for(const[i,r]of this.customSizes)n.set(U(i,e,t,s),r);this.customSizes=n,this.cacheDirty=!0}clear(){this.customSizes.clear(),this.cacheDirty=!0}hasCustomSizes(){return this.customSizes.size>0}ensureCache(){if(!this.cacheDirty)return;if(this.customSizes.size===0){this.sortedIndices=[],this.sortedSizes=[],this.prefixDeltas=[],this.customStarts=[],this.cacheDirty=!1;return}const e=Array.from(this.customSizes.entries()).sort((s,n)=>s[0]-n[0]);this.sortedIndices=[],this.sortedSizes=[],this.prefixDeltas=[],this.customStarts=[];let t=0;for(const[s,n]of e)this.sortedIndices.push(s),this.sortedSizes.push(n),this.customStarts.push((s-1)*this.defaultSize+t),t+=n-this.defaultSize,this.prefixDeltas.push(t);this.cacheDirty=!1}lowerBound(e,t){let s=0,n=e.length;for(;s<n;){const i=s+Math.floor((n-s)/2);e[i]<t?s=i+1:n=i}return s}upperBound(e,t){let s=0,n=e.length;for(;s<n;){const i=s+Math.floor((n-s)/2);e[i]<=t?s=i+1:n=i}return s}}class Dt{constructor(){p(this,"rowIndex",new Map);p(this,"colIndex",new Map)}add(e,t){let s=this.rowIndex.get(e);s||(s=new Set,this.rowIndex.set(e,s)),s.add(t);let n=this.colIndex.get(t);n||(n=new Set,this.colIndex.set(t,n)),n.add(e)}remove(e,t){const s=this.rowIndex.get(e);s&&(s.delete(t),s.size===0&&this.rowIndex.delete(e));const n=this.colIndex.get(t);n&&(n.delete(e),n.size===0&&this.colIndex.delete(t))}has(e,t){const s=this.rowIndex.get(e);return s!==void 0&&s.has(t)}clear(){this.rowIndex.clear(),this.colIndex.clear()}rebuild(e){this.clear();for(const[t,s]of e)this.add(t,s)}*cellsInRange(e){const[t,s]=e;for(const[n,i]of this.rowIndex)if(!(n<t.r||n>s.r))for(const r of i)r>=t.c&&r<=s.c&&(yield[n,r])}hasAnyInRange(e){return!this.cellsInRange(e).next().done}getOccupiedColsInRow(e){return this.rowIndex.get(e)}getOccupiedRowsInCol(e){return this.colIndex.get(e)}get size(){let e=0;for(const t of this.rowIndex.values())e+=t.size;return e}}function Nt(l,e,t,s,n){const i=t==="left"||t==="right",r=t==="down"||t==="right",o=i?e.c:e.r,a=i?s[0].c:s[0].r,h=i?s[1].c:s[1].r,c=i?l.getOccupiedColsInRow(e.r):l.getOccupiedRowsInCol(e.c);let u;if(c&&n){const x=new Set;for(const E of c){const m=i?e.r:E,z=i?E:e.c;n(m,z)&&x.add(E)}u=x.size>0?x:void 0}else u=c;if(!u||u.size===0)return ht(e,t,s);const d=Array.from(u).sort((x,E)=>x-E);r||d.reverse();const f=r?d.filter(x=>x>o):d.filter(x=>x<o),C=u.has(o),y=r?o+1:o-1,v=Z(i?{r:e.r,c:y}:{r:y,c:e.c},s)&&u.has(y);if(C&&v){let x=o,E=y;for(;(r?E<=h:E>=a)&&u.has(E);)x=E,E=r?E+1:E-1;return i?{r:e.r,c:x}:{r:x,c:e.c}}if(f.length>0){const x=f[0];return i?{r:e.r,c:x}:{r:x,c:e.c}}return ht(e,t,s)}function ht(l,e,t){switch(e){case"up":return{r:t[0].r,c:l.c};case"down":return{r:t[1].r,c:l.c};case"left":return{r:l.r,c:t[0].c};case"right":return{r:l.r,c:t[1].c}}}class Fs{constructor(e){p(this,"grid");p(this,"cellIndex",new Dt);p(this,"rowHeights",new Map);p(this,"colWidths",new Map);p(this,"colStyles",new Map);p(this,"rowStyles",new Map);p(this,"sheetStyle");p(this,"rangeStyles",[]);p(this,"conditionalFormats",[]);p(this,"merges",new Map);p(this,"filterState");p(this,"frozenRows",0);p(this,"frozenCols",0);this.grid=e||new Map,this.rebuildIndex()}async set(e,t){this.grid.set(M(e),t),this.cellIndex.add(e.r,e.c)}async get(e){return this.grid.get(M(e))}async has(e){return this.grid.has(M(e))}async delete(e){const t=this.grid.delete(M(e));return t&&this.cellIndex.remove(e.r,e.c),t}async deleteRange(e){const t=new Set,s=[];for(const[n,i]of this.cellIndex.cellsInRange(e)){const r=M({r:n,c:i});this.grid.delete(r),t.add(r),s.push([n,i])}for(const[n,i]of s)this.cellIndex.remove(n,i);return t}async setGrid(e){for(const[t,s]of e){this.grid.set(t,s);const n=H(t);this.cellIndex.add(n.r,n.c)}}async getGrid(e){const t=new Map;for(const[s,n]of this.cellIndex.cellsInRange(e)){const i=M({r:s,c:n}),r=this.grid.get(i);r!==void 0&&t.set(i,r)}return t}async findEdge(e,t,s){return Nt(this.cellIndex,e,t,s,(n,i)=>{const r=this.grid.get(M({r:n,c:i}));return r!==void 0&&(!!r.v||!!r.f)})}async shiftCells(e,t,s){this.grid=hs(this.grid,e,t,s),this.rebuildIndex(),e==="row"?(this.rowHeights=oe(this.rowHeights,t,s),this.rowStyles=oe(this.rowStyles,t,s)):(this.colWidths=oe(this.colWidths,t,s),this.colStyles=oe(this.colStyles,t,s)),this.rangeStyles=Pt(this.rangeStyles,e,t,s),this.conditionalFormats=It(this.conditionalFormats,e,t,s),this.merges=Ot(this.merges,e,t,s)}async moveCells(e,t,s,n){this.grid=os(this.grid,e,t,s,n),this.rebuildIndex(),e==="row"?(this.rowHeights=re(this.rowHeights,t,s,n),this.rowStyles=re(this.rowStyles,t,s,n)):(this.colWidths=re(this.colWidths,t,s,n),this.colStyles=re(this.colStyles,t,s,n)),this.rangeStyles=kt(this.rangeStyles,e,t,s,n),this.conditionalFormats=Mt(this.conditionalFormats,e,t,s,n),this.merges=Lt(this.merges,e,t,s,n)}async getFormulaGrid(){const e=new Map;for(const[t,s]of this.grid)s.f&&e.set(t,s);return e}async buildDependantsMap(e){const t=Array.from(this.grid.entries()),s=new Map;for(const[n,i]of t)if(i.f)for(const r of Ft(_e(i.f)))He(r)||(s.has(r)||s.set(r,new Set),s.get(r).add(n));return s}getPresences(){return[]}async setDimensionSize(e,t,s){(e==="row"?this.rowHeights:this.colWidths).set(t,s)}async getDimensionSizes(e){return new Map(e==="row"?this.rowHeights:this.colWidths)}updateActiveCell(e){}async setColumnStyle(e,t){this.colStyles.set(e,t)}async getColumnStyles(){return new Map(this.colStyles)}async setRowStyle(e,t){this.rowStyles.set(e,t)}async getRowStyles(){return new Map(this.rowStyles)}async setSheetStyle(e){this.sheetStyle=e}async getSheetStyle(){return this.sheetStyle?{...this.sheetStyle}:void 0}async addRangeStyle(e){const t=ee(e);t&&this.rangeStyles.push(Se(t))}async setRangeStyles(e){this.rangeStyles=e.map(t=>ee(t)).filter(t=>!!t).map(t=>Se(t))}async getRangeStyles(){return this.rangeStyles.map(e=>Se(e))}async setConditionalFormats(e){this.conditionalFormats=e.map(t=>De(t)).filter(t=>!!t).map(t=>pe(t))}async getConditionalFormats(){return this.conditionalFormats.map(e=>pe(e))}async setMerge(e,t){this.merges.set(M(e),{...t})}async deleteMerge(e){return this.merges.delete(M(e))}async getMerges(){return new Map(this.merges)}async setFilterState(e){if(!e){this.filterState=void 0;return}this.filterState={range:[{...e.range[0]},{...e.range[1]}],columns:Object.fromEntries(Object.entries(e.columns).map(([t,s])=>[t,{...s}])),hiddenRows:[...e.hiddenRows]}}async getFilterState(){if(this.filterState)return{range:[{...this.filterState.range[0]},{...this.filterState.range[1]}],columns:Object.fromEntries(Object.entries(this.filterState.columns).map(([e,t])=>[e,{...t}])),hiddenRows:[...this.filterState.hiddenRows]}}async setFreezePane(e,t){this.frozenRows=e,this.frozenCols=t}async getFreezePane(){return{frozenRows:this.frozenRows,frozenCols:this.frozenCols}}beginBatch(){}endBatch(){}async undo(){return{success:!1}}async redo(){return{success:!1}}canUndo(){return!1}canRedo(){return!1}rebuildIndex(){this.cellIndex.rebuild(Array.from(this.grid.keys()).map(e=>{const t=H(e);return[t.r,t.c]}))}}class wn{constructor(){p(this,"grid",new Map);p(this,"cellIndex",new Dt)}loadQueryResults(e,t){this.grid.clear();for(let s=0;s<e.length;s++){const n=M({r:1,c:s+1});this.grid.set(n,{v:e[s].name,s:{b:!0}})}for(let s=0;s<t.length;s++){const n=t[s];for(let i=0;i<e.length;i++){const r=n[e[i].name];if(r==null)continue;const o=M({r:s+2,c:i+1});this.grid.set(o,{v:String(r)})}}this.rebuildIndex()}async set(e,t){}async get(e){return this.grid.get(M(e))}async has(e){return this.grid.has(M(e))}async delete(e){return!1}async deleteRange(e){return new Set}async setGrid(e){}async getGrid(e){const t=new Map;for(const[s,n]of this.cellIndex.cellsInRange(e)){const i=M({r:s,c:n}),r=this.grid.get(i);r!==void 0&&t.set(i,r)}return t}async findEdge(e,t,s){return Nt(this.cellIndex,e,t,s,(n,i)=>{const r=this.grid.get(M({r:n,c:i}));return r!==void 0&&(!!r.v||!!r.f)})}async shiftCells(e,t,s){}async moveCells(e,t,s,n){}async buildDependantsMap(e){return new Map}async getFormulaGrid(){return new Map}getPresences(){return[]}updateActiveCell(e){}async setDimensionSize(e,t,s){}async getDimensionSizes(e){return new Map}async setColumnStyle(e,t){}async getColumnStyles(){return new Map}async setRowStyle(e,t){}async getRowStyles(){return new Map}async setSheetStyle(e){}async getSheetStyle(){}async addRangeStyle(e){}async setRangeStyles(e){}async getRangeStyles(){return[]}async setConditionalFormats(e){}async getConditionalFormats(){return[]}async setMerge(e,t){}async deleteMerge(e){return!1}async getMerges(){return new Map}async setFilterState(e){}async getFilterState(){}async setFreezePane(e,t){}async getFreezePane(){return{frozenRows:0,frozenCols:0}}beginBatch(){}endBatch(){}async undo(){return{success:!1}}async redo(){return{success:!1}}canUndo(){return!1}canRedo(){return!1}rebuildIndex(){this.cellIndex.rebuild(Array.from(this.grid.keys()).map(e=>{const t=H(e);return[t.r,t.c]}))}}function ct(l,e){if(l===e)return!0;if(!l||!e)return!1;const t=Object.keys(l),s=Object.keys(e);if(t.length!==s.length)return!1;for(const n of t)if(l[n]!==e[n])return!1;return!0}async function te(l,e,t){const[s,n]=zs(e,t);for(const i of s){const r=H(i);if(!await l.hasFormula(r))continue;const o=await l.getCell(r);if(n.has(i)){const d={v:"#REF!",f:o.f,s:o.s};if(o.v===d.v&&o.f===d.f&&ct(o.s,d.s))continue;await l.setCell(r,d);continue}const a=_e(o.f),h=await l.fetchGridByReferences(a),u={v:await qt(o.f,h),f:o.f,s:o.s};o.v===u.v&&o.f===u.f&&ct(o.s,u.s)||await l.setCell(r,u)}}function zs(l,e){const t=[],s=new Set,n=new Set,i=new Set,r=o=>{if(i.has(o))for(const a of i)s.add(a);if(i.add(o),!n.has(o)){if(n.add(o),l.has(o))for(const a of l.get(o))r(a);t.push(o)}i.delete(o)};for(const o of e)r(o);return[t.reverse(),s]}function Is(l){let e=1/0,t=1/0,s=0,n=0;for(const[r]of l.entries()){const{r:o,c:a}=H(r);e=Math.min(e,o),t=Math.min(t,a),s=Math.max(s,o),n=Math.max(n,a)}const i=Array.from({length:s-e+1},()=>Array(n-t+1).fill(""));for(const[r,o]of l.entries()){const{r:a,c:h}=H(r);i[a-e][h-t]=o.v||o.f||""}return i.map(r=>r.join("	")).join(`
`)}function Ms(l,e){let t=l.r,s=l.c;const n=new Map,i=e.split(`
`);for(const r of i){const o=r.split("	");for(const a of o)n.set(M({r:t,c:s}),{v:a}),s+=1;t+=1,s=l.c}return n}function ut(l){const e=l.match(/rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/);if(!e)return;const t=parseInt(e[1],10),s=parseInt(e[2],10),n=parseInt(e[3],10);if(!(t===255&&s===255&&n===255))return"#"+t.toString(16).padStart(2,"0")+s.toString(16).padStart(2,"0")+n.toString(16).padStart(2,"0")}function xs(l){return l.includes("google-sheets-html-origin")||l.includes("data-sheets-value")||l.includes("urn:schemas-microsoft-com:office:excel")||l.includes('xmlns:x="urn:schemas-microsoft-com:office:excel"')}function As(l,e){const n=new DOMParser().parseFromString(l,"text/html").querySelector("table");if(!n)return new Map;const i=new Map,r=n.querySelectorAll("tr");for(let o=0;o<r.length;o++){const a=r[o].querySelectorAll("td, th");for(let h=0;h<a.length;h++){const c=a[h],u=c.textContent||"";if(!u&&!c.style.cssText)continue;const d={v:u},f={};let C=!1;const y=c.style.fontWeight;if((y==="bold"||y==="700")&&(f.b=!0,C=!0),c.style.fontStyle==="italic"&&(f.i=!0,C=!0),c.style.backgroundColor){const v=ut(c.style.backgroundColor);v&&(f.bg=v,C=!0)}if(c.style.color){const v=ut(c.style.color);v&&(f.tc=v,C=!0)}if(c.style.textAlign){const v=c.style.textAlign;(v==="left"||v==="center"||v==="right")&&(f.al=v,C=!0)}C&&(d.s=f),i.set(M({r:e.r+o,c:e.c+h}),d)}}return i}const Wt="en-US",dt="USD",Ts=new Set(["AT","BE","CY","DE","EE","ES","FI","FR","GR","HR","IE","IT","LT","LU","LV","MT","NL","PT","SI","SK"]),Bs={AE:"AED",AR:"ARS",AU:"AUD",BD:"BDT",BR:"BRL",CA:"CAD",CH:"CHF",CL:"CLP",CN:"CNY",CO:"COP",CZ:"CZK",DK:"DKK",EG:"EGP",GB:"GBP",HK:"HKD",HU:"HUF",ID:"IDR",IL:"ILS",IN:"INR",JP:"JPY",KE:"KES",KR:"KRW",KW:"KWD",MX:"MXN",MY:"MYR",NG:"NGN",NO:"NOK",NZ:"NZD",PE:"PEN",PH:"PHP",PK:"PKR",PL:"PLN",QA:"QAR",RO:"RON",RU:"RUB",SA:"SAR",SE:"SEK",SG:"SGD",TH:"THB",TR:"TRY",TW:"TWD",UA:"UAH",US:"USD",VN:"VND",ZA:"ZAR"},ft=new Map;function je(l){return l&&l.trim()?l.trim():typeof navigator<"u"&&navigator.language?navigator.language:Intl.DateTimeFormat().resolvedOptions().locale||Wt}function Es(l){const[e]=l.replace(/_/g,"-").split("-u-"),t=e.split("-").filter(Boolean);for(let s=1;s<t.length;s++){const n=t[s];if(/^[a-z]{2}$/i.test(n))return n.toUpperCase()}try{const s=new Intl.Locale(l).maximize().region;if(s)return s.toUpperCase()}catch{}}function Ve(l,e,t){try{return new Intl.NumberFormat(e,t).format(l)}catch{return new Intl.NumberFormat(Wt,t).format(l)}}function Ps(l,e){const t=String(l.getFullYear()).padStart(4,"0"),s=String(l.getMonth()+1).padStart(2,"0"),n=String(l.getDate()).padStart(2,"0");return`${t}-${s}-${n}`}function ks(){return je()}function Vt(l){const e=je(l),t=ft.get(e);if(t)return t;const s=Es(e);let n=dt;return s&&(n=Ts.has(s)?"EUR":Bs[s]??dt),ft.set(e,n),n}function vn(l){const e=je(l),t=Vt(e);return{locale:e,currency:t,number:Ve(1234.56,e,{minimumFractionDigits:2,maximumFractionDigits:2}),currencyValue:Ve(1234.56,e,{style:"currency",currency:t,minimumFractionDigits:2,maximumFractionDigits:2}),percent:Ve(.1234,e,{style:"percent",minimumFractionDigits:2,maximumFractionDigits:2}),date:Ps(new Date(2026,1,18))}}function Me(l,e,t){try{return l.toLocaleString(e,t)}catch{return l.toLocaleString("en-US",t)}}function Hs(l){const e=l.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(e){const s=Number(e[1]),n=Number(e[2]),i=Number(e[3]),r=new Date(s,n-1,i);return r.getFullYear()===s&&r.getMonth()===n-1&&r.getDate()===i?r:void 0}const t=new Date(l);if(!isNaN(t.getTime()))return t}function Os(l,e){const t=Hs(l);if(!t)return l;const s=String(t.getFullYear()).padStart(4,"0"),n=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0");return`${s}-${n}-${i}`}function Ke(l,e,t,s){if(!e||e==="plain"||l==="")return l;const n=t??2,i=(s==null?void 0:s.locale)??ks(),r=(s==null?void 0:s.currency)??Vt(i);switch(e){case"number":{const o=Number(l);return isNaN(o)?l:Me(o,i,{minimumFractionDigits:n,maximumFractionDigits:n})}case"currency":{const o=Number(l);return isNaN(o)?l:t===void 0?Me(o,i,{style:"currency",currency:r}):Me(o,i,{style:"currency",currency:r,minimumFractionDigits:n,maximumFractionDigits:n})}case"percent":{const o=Number(l);return isNaN(o)?l:Me(o,i,{style:"percent",minimumFractionDigits:n,maximumFractionDigits:n})}case"date":return Os(l);default:return l}}const Ls={$:"USD","₩":"KRW"};function pt(l){return l.length>1&&l.startsWith("0")}function Ds(l){if(!l.includes(","))return/^\d+$/.test(l)?l:void 0;const e=l.split(",");if(/^\d{1,3}$/.test(e[0])){for(let t=1;t<e.length;t++)if(!/^\d{3}$/.test(e[t]))return;return e.join("")}}function Qe(l,e){if(l.length===0||/\s/.test(l))return;if(e.allowExponent&&/[eE]/.test(l)){const s=l.match(/^([+-])?(\d+(?:\.\d+)?|\.\d+)[eE]([+-]?\d+)$/);if(!s)return;const n=s[1]??"",i=s[2],r=s[3],o=i.startsWith(".")?"0":i.split(".")[0];if(!e.allowPaddedInteger&&pt(o))return;const a=+`${n}${i}e${r}`;return Number.isFinite(a)?a:void 0}const t=l.match(/^([+-])?(\d[\d,]*)(?:\.(\d*))?$/);if(t){const s=t[1]??"",n=t[2],i=t[3],r=Ds(n);if(!r||!e.allowPaddedInteger&&pt(r))return;const o=i!==void 0?`${s}${r}.${i}`:`${s}${r}`,a=Number(o);return Number.isFinite(a)?a:void 0}if(e.allowLeadingDot){const s=l.match(/^([+-])?\.(\d+)$/);if(!s)return;const n=s[1]??"",i=s[2],r=+`${n}0.${i}`;return Number.isFinite(r)?r:void 0}}function $t(l,e,t){const s=new Date(l,e-1,t);if(!(s.getFullYear()!==l||s.getMonth()!==e-1||s.getDate()!==t))return`${String(l).padStart(4,"0")}-${String(e).padStart(2,"0")}-${String(t).padStart(2,"0")}`}function Ns(l){const e=l.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(!e)return;const t=Number(e[1]),s=Number(e[2]),n=Number(e[3]);return $t(t,s,n)}function Ws(l,e){const t=l.match(/^(\d{1,2})\/(\d{1,2})$/);if(!t)return;const s=Number(t[1]),n=Number(t[2]);return $t(e,s,n)}function Vs(l){const e=l.match(/^([+-])?\s*([$₩])\s*([0-9][0-9,]*(?:\.[0-9]+)?|\.\d+)$/);if(!e)return;const t=e[1]??"",s=e[2],n=e[3],i=Qe(`${t}${n}`,{allowExponent:!1,allowLeadingDot:!0,allowPaddedInteger:!0});if(i!==void 0)return{code:Ls[s],value:i}}function $s(l){const e=l.match(/^([+-])?\s*([0-9][0-9,]*(?:\.[0-9]+)?|\.\d+)\s*%$/);if(!e)return;const t=e[1]??"",s=e[2],n=Qe(`${t}${s}`,{allowExponent:!1,allowLeadingDot:!0,allowPaddedInteger:!0});if(n!==void 0)return n/100}function gt(l,e){const t=l.trim();if(t.startsWith("="))return{type:"formula",value:t.slice(1).trimStart()};const s=t.toLowerCase();if(s==="true")return{type:"boolean",value:!0};if(s==="false")return{type:"boolean",value:!1};const n=Vs(t);if(n)return{type:"number",value:n.value,format:`currency:${n.code}`};const i=$s(t);if(i!==void 0)return{type:"number",value:i,format:"percent"};const r=Ns(t);if(r)return{type:"date",value:r,format:"yyyy-mm-dd"};const o=new Date().getFullYear(),a=Ws(t,o);if(a)return{type:"date",value:a,format:"yyyy-mm-dd"};const h=Qe(t,{allowExponent:!0,allowLeadingDot:!0,allowPaddedInteger:!1});return h!==void 0?{type:"number",value:h}:{type:"text",value:t}}const Gs={rows:1e6,columns:18278},Ks=5e4,Us={b:!1,i:!1,u:!1,st:!1,bt:!1,br:!1,bb:!1,bl:!1,tc:"",bg:"",al:"left",va:"top",nf:"plain",dp:2},Ys={b:!1,i:!1,u:!1,st:!1,bt:!1,br:!1,bb:!1,bl:!1,tc:"",bg:"",al:"left",va:"top",nf:"plain"};class _s{constructor(e){p(this,"store");p(this,"dimension");p(this,"activeCell");p(this,"range");p(this,"selectionType","cell");p(this,"rowDimensions");p(this,"colDimensions");p(this,"frozenRows",0);p(this,"frozenCols",0);p(this,"colStyles",new Map);p(this,"rowStyles",new Map);p(this,"sheetStyle");p(this,"rangeStyles",[]);p(this,"conditionalFormats",[]);p(this,"merges",new Map);p(this,"mergeCoverMap",new Map);p(this,"filterRange");p(this,"filterColumns",new Map);p(this,"hiddenRows",new Set);p(this,"copyBuffer");p(this,"gridResolver");this.store=e,this.dimension={...Gs},this.activeCell={r:1,c:1}}get dimensionRange(){return[{r:1,c:1},{r:this.dimension.rows,c:this.dimension.columns}]}getDimension(){return this.dimension}setDimensions(e,t){this.rowDimensions=e,this.colDimensions=t}getRowDimensions(){return this.rowDimensions}getColDimensions(){return this.colDimensions}setRowHeight(e,t){var s;(s=this.rowDimensions)==null||s.setSize(e,t),this.store.setDimensionSize("row",e,t)}setColumnWidth(e,t){var s;(s=this.colDimensions)==null||s.setSize(e,t),this.store.setDimensionSize("column",e,t)}async loadDimensions(){if(this.rowDimensions){this.rowDimensions.clear();const e=await this.store.getDimensionSizes("row");for(const[t,s]of e)this.rowDimensions.setSize(t,s)}if(this.colDimensions){this.colDimensions.clear();const e=await this.store.getDimensionSizes("column");for(const[t,s]of e)this.colDimensions.setSize(t,s)}}getFreezePane(){return{frozenRows:this.frozenRows,frozenCols:this.frozenCols}}async setFreezePane(e,t){this.frozenRows=e,this.frozenCols=t,await this.store.setFreezePane(e,t)}async loadFreezePane(){const{frozenRows:e,frozenCols:t}=await this.store.getFreezePane();this.frozenRows=e,this.frozenCols=t}async loadStyles(){this.colStyles=await this.store.getColumnStyles(),this.rowStyles=await this.store.getRowStyles(),this.sheetStyle=await this.store.getSheetStyle(),this.rangeStyles=await this.store.getRangeStyles(),this.conditionalFormats=await this.store.getConditionalFormats()}async loadMerges(){this.merges=await this.store.getMerges(),this.rebuildMergeCoverMap()}async loadFilterState(){const e=await this.store.getFilterState();if(!e){this.filterRange=void 0,this.filterColumns.clear(),this.hiddenRows.clear();return}this.filterRange=G(e.range[0],e.range[1]),this.filterColumns=new Map;for(const[t,s]of Object.entries(e.columns)){const n=Number(t);Number.isFinite(n)&&this.filterColumns.set(n,{...s})}this.normalizeFilterColumnsToRange(),this.hiddenRows=new Set(e.hiddenRows.filter(t=>t>0)),this.pruneHiddenRowsOutsideFilter(),this.ensureActiveCellVisibleAfterFiltering()}hasFilter(){return!!this.filterRange}getFilterRange(){return this.filterRange?q(this.filterRange):void 0}getHiddenRows(){return new Set(this.hiddenRows)}getFilteredColumns(){return new Set(this.filterColumns.keys())}getColumnFilterCondition(e){const t=this.filterColumns.get(e);if(t)return{...t,values:t.values?[...t.values]:void 0}}isColumnInFilter(e){return this.filterRange?e>=this.filterRange[0].c&&e<=this.filterRange[1].c:!1}getFilterState(){return this.buildFilterStatePayload()}getColStyles(){return this.colStyles}getRowStyles(){return this.rowStyles}getSheetStyle(){return this.sheetStyle}getRangeStyles(){return this.rangeStyles.map(e=>({range:q(e.range),style:{...e.style}}))}getConditionalFormats(){return this.conditionalFormats.map(e=>pe(e))}getMerges(){return this.merges}rebuildMergeCoverMap(){this.mergeCoverMap.clear();for(const[e,t]of this.merges){const s=H(e);for(let n=s.r;n<s.r+t.rs;n++)for(let i=s.c;i<s.c+t.cs;i++){const r=M({r:n,c:i});r!==e&&this.mergeCoverMap.set(r,e)}}}getAnchorSrefForRef(e){const t=M(e);return this.merges.has(t)?t:this.mergeCoverMap.get(t)||t}normalizeRefToAnchor(e){return H(this.getAnchorSrefForRef(e))}getMergeForRef(e){const t=this.getAnchorSrefForRef(e),s=this.merges.get(t);if(!s)return;const n=H(t);return{anchorSref:t,anchor:n,span:s,range:we(n,s)}}expandRangeToMergedBoundaries(e){let t=q(e),s=!0;for(;s;){s=!1;for(const[n,i]of this.merges){const r=we(H(n),i);if(!Z(r[0],t)&&!Z(r[1],t)&&!(r[0].r<=t[1].r&&r[1].r>=t[0].r&&r[0].c<=t[1].c&&r[1].c>=t[0].c))continue;const o=We(t,r);se(o,t)||(t=o,s=!0)}}return t}*mergeCoveredSrefs(e,t){for(let s=e.r;s<e.r+t.rs;s++)for(let n=e.c;n<e.c+t.cs;n++)yield M({r:s,c:n})}expandChangedSrefsWithMergeAliases(e){const t=new Set;for(const s of e){const n=this.getAnchorSrefForRef(H(s)),i=this.merges.get(n);if(!i){t.add(s);continue}const r=H(n);for(const o of this.mergeCoveredSrefs(r,i))t.add(o)}return t}getMergesIntersecting(e){const t=[];for(const[s,n]of this.merges){const i=H(s),r=we(i,n);r[0].r<=e[1].r&&r[1].r>=e[0].r&&r[0].c<=e[1].c&&r[1].c>=e[0].c&&t.push({anchorSref:s,anchor:i,span:n,range:r})}return t}resolveEffectiveStyle(e,t,s){const n=this.sheetStyle,i=this.colStyles.get(t),r=this.rowStyles.get(e),o=Ht(this.rangeStyles,e,t);if(!(!n&&!i&&!r&&!o&&!s))return{...n,...i,...r,...o,...s}}async getCell(e){return this.store.get(this.normalizeRefToAnchor(e))}async setCell(e,t){await this.store.set(this.normalizeRefToAnchor(e),t)}async setGrid(e){await this.store.setGrid(e)}async hasFormula(e){const t=await this.getCell(e);return!!(t&&t.f)}async toInputString(e){const t=await this.getCell(e);return t?t.f?t.f:t.v||"":""}async toDisplayString(e){const t=this.normalizeRefToAnchor(e),s=await this.store.get(t);if(!s||!s.v)return"";const n=this.resolveEffectiveStyle(t.r,t.c,s.s);return Ke(s.v,n==null?void 0:n.nf,n==null?void 0:n.dp,{currency:n==null?void 0:n.cu})}toStoredValue(e){switch(e.type){case"number":return e.value.toString();case"date":case"text":return e.value;case"boolean":return e.value?"TRUE":"FALSE"}}applyInferredFormat(e,t){var s;if(t.type==="date"){const n={...e||{},nf:"date"};return delete n.cu,n}if(t.type==="number"&&t.format==="percent"){const n={...e||{},nf:"percent"};return delete n.cu,n}return t.type==="number"&&((s=t.format)!=null&&s.startsWith("currency:"))?{...e||{},nf:"currency",cu:t.format.slice(9)}:e?{...e}:void 0}applyInputInferenceToGrid(e){const t=new Map;for(const[s,n]of e){if(n.f){t.set(s,{...n});continue}const i=gt(n.v??""),r=this.applyInferredFormat(n.s,i),o=i.type==="formula"?{f:Ze(`=${i.value}`)}:{v:this.toStoredValue(i)};t.set(s,this.compactCell(o,r))}return t}async setData(e,t){const s=this.normalizeRefToAnchor(e);this.store.beginBatch();try{const n=await this.store.get(s),i=gt(t),r=this.applyInferredFormat(n==null?void 0:n.s,i),o=i.type==="formula"?{f:Ze(`=${i.value}`)}:{v:this.toStoredValue(i)},a=this.compactCell(o,r);this.isEmptyCell(a)?await this.store.delete(s):await this.store.set(s,a);const h=this.expandChangedSrefsWithMergeAliases([M(s)]),c=await this.store.buildDependantsMap(h);await te(this,c,h),this.filterRange&&await this.recomputeFilterHiddenRows()}finally{this.store.endBatch()}}async removeData(){this.store.beginBatch();try{const e=this.getRangeOrActiveCell(),t=await this.store.getGrid(e),s=new Set;for(const[r,o]of t){const a=H(r);o.s&&Object.keys(o.s).length>0?await this.store.set(a,{s:o.s}):await this.store.delete(a),s.add(r)}if(s.size===0)return!1;const n=this.expandChangedSrefsWithMergeAliases(s),i=await this.store.buildDependantsMap(n);return await te(this,i,n),this.filterRange&&await this.recomputeFilterHiddenRows(),!0}finally{this.store.endBatch()}}async insertRows(e,t=1){await this.shiftCells("row",e,t)}async deleteRows(e,t=1){await this.shiftCells("row",e,-t)}async insertColumns(e,t=1){await this.shiftCells("column",e,t)}async deleteColumns(e,t=1){await this.shiftCells("column",e,-t)}async moveRows(e,t,s){await this.moveCells("row",e,t,s)}async moveColumns(e,t,s){await this.moveCells("column",e,t,s)}async shiftCells(e,t,s){var i,r;await this.store.shiftCells(e,t,s),e==="row"?((i=this.rowDimensions)==null||i.shift(t,s),this.rowStyles=oe(this.rowStyles,t,s)):((r=this.colDimensions)==null||r.shift(t,s),this.colStyles=oe(this.colStyles,t,s)),this.rangeStyles=Pt(this.rangeStyles,e,t,s),this.conditionalFormats=It(this.conditionalFormats,e,t,s),this.merges=Ot(this.merges,e,t,s),this.rebuildMergeCoverMap(),this.shiftFilterState(e,t,s);const n=e==="row"?this.activeCell.r:this.activeCell.c;if(s>0&&n>=t)e==="row"?this.activeCell={r:this.activeCell.r+s,c:this.activeCell.c}:this.activeCell={r:this.activeCell.r,c:this.activeCell.c+s};else if(s<0){const o=Math.abs(s);n>=t&&n<t+o?e==="row"?this.activeCell={r:Math.max(1,t),c:this.activeCell.c}:this.activeCell={r:this.activeCell.r,c:Math.max(1,t)}:n>=t+o&&(e==="row"?this.activeCell={r:this.activeCell.r+s,c:this.activeCell.c}:this.activeCell={r:this.activeCell.r,c:this.activeCell.c+s})}this.activeCell=this.normalizeRefToAnchor(this.activeCell),this.store.beginBatch();try{const o=e==="row"?this.frozenRows:this.frozenCols;if(o>0){if(s>0&&t<=o){const a=o+s;e==="row"?this.frozenRows=a:this.frozenCols=a,await this.store.setFreezePane(this.frozenRows,this.frozenCols)}else if(s<0){const a=Math.abs(s);if(t<=o){const h=Math.min(a,o-t+1),c=Math.max(0,o-h);e==="row"?this.frozenRows=c:this.frozenCols=c,await this.store.setFreezePane(this.frozenRows,this.frozenCols)}}}await this.recalculateAllFormulaCells(),this.filterRange&&await this.recomputeFilterHiddenRows()}finally{this.store.endBatch()}}async moveCells(e,t,s,n,i){var r,o;if(!(n>=t&&n<=t+s)){for(const[a,h]of this.merges){const c=H(a);if(bs(c,h,e,t,s))return}if(await this.store.moveCells(e,t,s,n),e==="row"?((r=this.rowDimensions)==null||r.move(t,s,n),this.rowStyles=re(this.rowStyles,t,s,n)):((o=this.colDimensions)==null||o.move(t,s,n),this.colStyles=re(this.colStyles,t,s,n)),this.rangeStyles=kt(this.rangeStyles,e,t,s,n),this.conditionalFormats=Mt(this.conditionalFormats,e,t,s,n),this.merges=Lt(this.merges,e,t,s,n),this.rebuildMergeCoverMap(),this.moveFilterState(e,t,s,n),this.activeCell=this.normalizeRefToAnchor(ae(this.activeCell,e,t,s,n)),this.range&&(this.range=this.expandRangeToMergedBoundaries([ae(this.range[0],e,t,s,n),ae(this.range[1],e,t,s,n)])),!(i!=null&&i.skipPostRecalculate)){this.store.beginBatch();try{await this.recalculateAllFormulaCells(),this.filterRange&&await this.recomputeFilterHiddenRows()}finally{this.store.endBatch()}}}}async recalculateAllFormulaCells(){const e=new Set,t=[{r:1,c:1},{r:1e3,c:100}],s=await this.store.getGrid(t);for(const[n,i]of s)i.f&&e.add(n);if(e.size>0){const n=await this.store.buildDependantsMap(e);await te(this,n,e)}}buildFilterStatePayload(){if(!this.filterRange)return;const e={},t=Array.from(this.filterColumns.entries()).sort((s,n)=>s[0]-n[0]);for(const[s,n]of t)this.isColumnInFilter(s)&&(e[String(s)]={...n});return{range:q(this.filterRange),columns:e,hiddenRows:Array.from(this.hiddenRows).sort((s,n)=>s-n)}}normalizeFilterColumnsToRange(){if(!this.filterRange){this.filterColumns.clear();return}for(const e of this.filterColumns.keys())this.isColumnInFilter(e)||this.filterColumns.delete(e)}pruneHiddenRowsOutsideFilter(){if(!this.filterRange){this.hiddenRows.clear();return}const e=this.filterRange[0].r+1,t=this.filterRange[1].r,s=new Set;for(const n of this.hiddenRows)n>=e&&n<=t&&s.add(n);this.hiddenRows=s}normalizeFilterText(e){if(typeof e=="string")return e;if(e==null)return"";if(typeof e=="number"||typeof e=="boolean")return String(e);if(typeof e=="object"){const t=e;if(t.value!==void 0&&t.value!==e)return this.normalizeFilterText(t.value);if(typeof t.toJSON=="function")try{const s=t.toJSON.call(e);if(s!==e)return this.normalizeFilterText(s)}catch{}}return String(e)}normalizeFilterCondition(e){const t=e.op;if(t==="in"){const n=Array.from(new Set((e.values||[]).map(i=>this.normalizeFilterText(i).trim())));return{op:t,values:n}}if(t==="isEmpty"||t==="isNotEmpty")return{op:t};const s=this.normalizeFilterText(e.value).trim();if(s.length!==0)return{op:t,value:s}}matchesFilterCondition(e,t){const s=this.normalizeFilterText(e).trim(),n=s.toLowerCase(),i=this.normalizeFilterText(t.value).trim().toLowerCase();switch(t.op){case"in":return new Set((t.values||[]).map(r=>this.normalizeFilterText(r).trim())).has(s);case"contains":return n.includes(i);case"notContains":return!n.includes(i);case"equals":return n===i;case"notEquals":return n!==i;case"isEmpty":return n.length===0;case"isNotEmpty":return n.length>0;default:return!0}}async rowMatchesFilters(e,t){for(const[s,n]of this.filterColumns){if(s===t)continue;const i=await this.getCell({r:e,c:s}),r=this.normalizeFilterText(i==null?void 0:i.v);if(!this.matchesFilterCondition(r,n))return!1}return!0}async recomputeFilterHiddenRows(){if(!this.filterRange){this.hiddenRows.clear(),await this.store.setFilterState(void 0);return}if(this.filterRange=G({r:Math.max(1,this.filterRange[0].r),c:Math.max(1,this.filterRange[0].c)},{r:Math.min(this.dimension.rows,this.filterRange[1].r),c:Math.min(this.dimension.columns,this.filterRange[1].c)}),this.filterRange[1].r<=this.filterRange[0].r){this.filterRange=void 0,this.filterColumns.clear(),this.hiddenRows.clear(),await this.store.setFilterState(void 0);return}this.normalizeFilterColumnsToRange();const e=new Set,t=this.filterRange[0].r+1,s=this.filterRange[1].r;if(this.filterColumns.size>0)for(let n=t;n<=s;n++)await this.rowMatchesFilters(n)||e.add(n);this.hiddenRows=e,this.ensureActiveCellVisibleAfterFiltering(),await this.store.setFilterState(this.buildFilterStatePayload())}shiftFilterBoundary(e,t,s){if(s>0)return e>=t?e+s:e;const n=Math.abs(s);return e>=t&&e<t+n?t:e>=t+n?e+s:e}shiftFilterState(e,t,s){if(!this.filterRange)return;if(e==="row"){const o=this.shiftFilterBoundary(this.filterRange[0].r,t,s),a=this.shiftFilterBoundary(this.filterRange[1].r,t,s);this.filterRange=G({r:Math.max(1,o),c:this.filterRange[0].c},{r:Math.max(1,a),c:this.filterRange[1].c});const h=new Map;for(const u of this.hiddenRows)h.set(u,1);const c=oe(h,t,s);this.hiddenRows=new Set(c.keys()),this.pruneHiddenRowsOutsideFilter();return}const n=this.shiftFilterBoundary(this.filterRange[0].c,t,s),i=this.shiftFilterBoundary(this.filterRange[1].c,t,s);this.filterRange=G({r:this.filterRange[0].r,c:Math.max(1,n)},{r:this.filterRange[1].r,c:Math.max(1,i)});const r=new Map;for(const[o,a]of this.filterColumns)r.set(o,a);this.filterColumns=oe(r,t,s),this.normalizeFilterColumnsToRange()}moveFilterState(e,t,s,n){if(!this.filterRange)return;if(e==="row"){const a=U(this.filterRange[0].r,t,s,n),h=U(this.filterRange[1].r,t,s,n);this.filterRange=G({r:a,c:this.filterRange[0].c},{r:h,c:this.filterRange[1].c});const c=new Map;for(const d of this.hiddenRows)c.set(d,1);const u=re(c,t,s,n);this.hiddenRows=new Set(u.keys()),this.pruneHiddenRowsOutsideFilter();return}const i=U(this.filterRange[0].c,t,s,n),r=U(this.filterRange[1].c,t,s,n);this.filterRange=G({r:this.filterRange[0].r,c:i},{r:this.filterRange[1].r,c:r});const o=new Map;for(const[a,h]of this.filterColumns)o.set(a,h);this.filterColumns=re(o,t,s,n),this.normalizeFilterColumnsToRange()}ensureActiveCellVisibleAfterFiltering(){if(!this.hiddenRows.has(this.activeCell.r))return;let e;if(this.filterRange&&this.activeCell.r>this.filterRange[0].r&&this.activeCell.r<=this.filterRange[1].r)e=this.filterRange[0].r;else{for(let t=this.activeCell.r+1;t<=this.dimension.rows;t++)if(!this.hiddenRows.has(t)){e=t;break}if(e===void 0){for(let t=this.activeCell.r-1;t>=1;t--)if(!this.hiddenRows.has(t)){e=t;break}}}e!==void 0&&(this.range=void 0,this.setActiveCell({r:e,c:this.activeCell.c}))}findNextVisibleRow(e,t){const s=t==="down"?1:-1;let n=e;for(;n>=1&&n<=this.dimension.rows;){if(!this.hiddenRows.has(n))return n;n+=s}}async fetchGrid(e){return this.store.getGrid(e)}hasCellContent(e){const t=e.v!==void 0&&e.v!==""&&e.v!==null,s=!!e.f;return t||s}isEmptyCell(e){const t=this.hasCellContent(e),s=e.s!==void 0&&Object.keys(e.s).length>0;return!t&&!s}normalizeStylePatch(e){return xt(e)}mergeStylePatch(e,t){return At(e,t)}rangesIntersect(e,t){return e[0].r<=t[1].r&&e[1].r>=t[0].r&&e[0].c<=t[1].c&&e[1].c>=t[0].c}hasConflictingStyleSourceForKey(e,t,s,n){var r;const i=(r=this.sheetStyle)==null?void 0:r[t];if(i!==void 0&&i!==s)return!0;for(const[o,a]of this.colStyles){if(o<e[0].c||o>e[1].c)continue;const h=a[t];if(h!==void 0&&h!==s)return!0}for(const[o,a]of this.rowStyles){if(o<e[0].r||o>e[1].r)continue;const h=a[t];if(h!==void 0&&h!==s)return!0}for(let o=0;o<this.rangeStyles.length;o++){if(n!==void 0&&o===n)continue;const a=this.rangeStyles[o],h=a.style[t];if(!(h===void 0||h===s)&&this.rangesIntersect(e,a.range))return!0}return!1}pruneRedundantDefaultStyleKeys(e,t,s){const n={};for(const i of Object.keys(t)){const r=t[i];if(r===void 0)continue;const o=Us[i];o!==void 0&&r===o&&!this.hasConflictingStyleSourceForKey(e,i,r,s)||(n[i]=r)}return Object.keys(n).length>0?n:void 0}sameRangeStylePatchList(e,t){if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(!se(e[s].range,t[s].range)||!Re(e[s].style,t[s].style))return!1;return!0}compactShadowedRangeStyles(){const e=qe(this.rangeStyles);return this.sameRangeStylePatchList(e,this.rangeStyles)?!1:(this.rangeStyles=e,!0)}containsRange(e,t){return e[0].r<=t[0].r&&e[0].c<=t[0].c&&e[1].r>=t[1].r&&e[1].c>=t[1].c}mergeableColBand(e,t){return e[0].r!==t[0].r||e[1].r!==t[1].r?!1:t[0].c<=e[1].c+1&&e[0].c<=t[1].c+1}mergeableRowBand(e,t){return e[0].c!==t[0].c||e[1].c!==t[1].c?!1:t[0].r<=e[1].r+1&&e[0].r<=t[1].r+1}tryMergeRangeStylePatches(e,t){if(Re(e.style,t.style)){if(se(e.range,t.range)||this.containsRange(e.range,t.range))return e;if(this.containsRange(t.range,e.range))return t;if(this.mergeableColBand(e.range,t.range))return{range:[{r:e.range[0].r,c:Math.min(e.range[0].c,t.range[0].c)},{r:e.range[1].r,c:Math.max(e.range[1].c,t.range[1].c)}],style:{...e.style}};if(this.mergeableRowBand(e.range,t.range))return{range:[{r:Math.min(e.range[0].r,t.range[0].r),c:e.range[0].c},{r:Math.max(e.range[1].r,t.range[1].r),c:e.range[1].c}],style:{...e.style}}}}async addRangeStylePatch(e,t){const s=this.normalizeStylePatch(t);if(!s)return;const n=ee({range:q(e),style:s});if(!n)return;const i=this.rangeStyles,r=this.pruneRedundantDefaultStyleKeys(n.range,n.style);if(!r)return;n.style=r;const o=i[i.length-1];if(o&&se(o.range,n.range)){const c=this.mergeStylePatch(o.style,n.style);if(!c)return;const u=this.pruneRedundantDefaultStyleKeys(o.range,c,i.length-1);if(!u){this.rangeStyles=i.slice(0,-1),this.compactShadowedRangeStyles(),await this.store.setRangeStyles(this.rangeStyles);return}if(Re(u,o.style))return;o.style={...u},this.compactShadowedRangeStyles(),await this.store.setRangeStyles(this.rangeStyles);return}let a=n,h=i.length;for(let c=i.length-1;c>=0;c--){const u=i[c],d=this.tryMergeRangeStylePatches(u,a);if(!d)break;if(se(d.range,u.range)){if(c===i.length-1)return;this.rangeStyles=i.slice(0,c+1),this.compactShadowedRangeStyles(),await this.store.setRangeStyles(this.rangeStyles);return}a=d,h=c}if(h===i.length){this.rangeStyles.push(a),await this.store.addRangeStyle(a),this.compactShadowedRangeStyles()&&await this.store.setRangeStyles(this.rangeStyles);return}this.rangeStyles=[...i.slice(0,h),a],this.compactShadowedRangeStyles(),await this.store.setRangeStyles(this.rangeStyles)}async applyStylePatchToExistingCells(e,t){const s=this.normalizeStylePatch(t);if(!s)return;const n=await this.store.getGrid(e),i=new Set;for(const[r]of n){const o=H(r),a=this.normalizeRefToAnchor(o),h=M(a);if(i.has(h))continue;i.add(h);const c=await this.store.get(a);if(!(c!=null&&c.s))continue;const u={};for(const d of Object.keys(s)){const f=c.s[d],C=s[d];f===void 0||f===C||(u[d]=C)}Object.keys(u).length!==0&&await this.setStyle(a,u)}}async clearCellStylesInRange(e){const t=await this.store.getGrid(e),s=new Set;for(const[n]of t){const i=H(n),r=this.normalizeRefToAnchor(i),o=M(r);if(s.has(o))continue;s.add(o);const a=await this.store.get(r);if(!(a!=null&&a.s))continue;const h=this.compactCell(a);this.isEmptyCell(h)?await this.store.delete(r):await this.store.set(r,h)}}compactCell(e,t){const s={};return e.v!==void 0&&(s.v=e.v),e.f!==void 0&&(s.f=e.f),t&&Object.keys(t).length>0&&(s.s=t),s}getCopyRange(){var e;return(e=this.copyBuffer)==null?void 0:e.sourceRange}clearCopyBuffer(){this.copyBuffer=void 0}async copy(){const e=this.getRangeOrActiveCell(),t=await this.fetchGrid(e),s=ws(this.rangeStyles,e),n=Is(t);return this.copyBuffer={sourceRange:e,grid:t,rangeStyles:s,text:n},{text:n}}async paste(e){const{text:t,html:s}=e;let n,i=[],r=!1;if(this.copyBuffer&&t===this.copyBuffer.text){n=this.relocateGrid(this.copyBuffer.grid,this.copyBuffer.sourceRange,this.activeCell);const o=this.activeCell.r-this.copyBuffer.sourceRange[0].r,a=this.activeCell.c-this.copyBuffer.sourceRange[0].c;i=vs(this.copyBuffer.rangeStyles,o,a)}else if(s&&xs(s))n=As(s,this.activeCell),r=!0;else if(t)n=Ms(this.activeCell,t),r=!0;else return;r&&(n=this.applyInputInferenceToGrid(n)),this.store.beginBatch();try{await this.setGrid(n);for(const a of i)await this.addRangeStylePatch(a.range,a.style),await this.applyStylePatchToExistingCells(a.range,a.style);const o=new Set;for(const[a]of n)o.add(a);if(o.size>0){const a=this.expandChangedSrefsWithMergeAliases(o),h=await this.store.buildDependantsMap(a);await te(this,h,a)}this.filterRange&&await this.recomputeFilterHiddenRows()}finally{this.store.endBatch()}this.selectPastedRange(n)}selectPastedRange(e){if(e.size===0)return;let t=1/0,s=-1/0,n=1/0,i=-1/0;for(const r of e.keys()){const o=H(r);o.r<t&&(t=o.r),o.r>s&&(s=o.r),o.c<n&&(n=o.c),o.c>i&&(i=o.c)}t===s&&n===i?this.selectStart({r:t,c:n}):(this.selectionType="cell",this.activeCell={r:t,c:n},this.range=[{r:t,c:n},{r:s,c:i}],this.store.updateActiveCell(this.activeCell))}relocateGrid(e,t,s){const n=s.r-t[0].r,i=s.c-t[0].c,r=new Map;for(const[o,a]of e){const h=H(o),c={r:h.r+n,c:h.c+i},u=M(c);if(a.f){const d=nt(a.f,n,i);r.set(u,{f:d,s:a.s})}else r.set(u,{...a})}return r}computeAutofillRange(e,t){if(!Z(t,e))return We(e,[t,t])}getAutofillPreviewRange(e){if(this.selectionType!=="cell")return;const t=this.getRangeOrActiveCell();return this.computeAutofillRange(t,e)}positiveMod(e,t){return(e%t+t)%t}cloneCellForAutofill(e,t,s){if(e.f){const i=nt(e.f,t,s);return e.s?{f:i,s:{...e.s}}:{f:i}}const n={};return e.v!==void 0&&(n.v=e.v),e.s&&(n.s={...e.s}),n}async autofill(e){if(this.selectionType!=="cell")return!1;const t=q(this.getRangeOrActiveCell()),s=this.computeAutofillRange(t,e);if(!s||this.getMergesIntersecting(s).length>0)return!1;const n=await this.store.getGrid(t),i=t[1].r-t[0].r+1,r=t[1].c-t[0].c+1,o=new Set;this.store.beginBatch();try{for(let a=s[0].r;a<=s[1].r;a++)for(let h=s[0].c;h<=s[1].c;h++){const c={r:a,c:h};if(Z(c,t))continue;const u={r:t[0].r+this.positiveMod(c.r-t[0].r,i),c:t[0].c+this.positiveMod(c.c-t[0].c,r)},d=n.get(M(u)),f=this.normalizeRefToAnchor(c),C=M(f);if(!d){await this.store.delete(f),o.add(C);continue}const y=c.r-u.r,v=c.c-u.c,x=this.cloneCellForAutofill(d,y,v);this.isEmptyCell(x)?await this.store.delete(f):await this.store.set(f,x),o.add(C)}if(o.size>0){const a=this.expandChangedSrefsWithMergeAliases(o),h=await this.store.buildDependantsMap(a);await te(this,h,a)}this.filterRange&&await this.recomputeFilterHiddenRows()}finally{this.store.endBatch()}return o.size===0?!1:(this.selectionType="cell",this.range=s,!0)}async hasContents(e){const t=await this.store.getGrid(e);for(const s of t.values())if(this.hasCellContent(s))return!0;return!1}async fetchGridByReferences(e){const t=new Map,s=new Map;for(const n of Ft(e))if(He(n)){const{sheetName:i,localRef:r}=bt(n);s.has(i.toUpperCase())||s.set(i.toUpperCase(),new Set),s.get(i.toUpperCase()).add(r)}else{const i=this.normalizeRefToAnchor(H(n)),r=await this.store.get(i);r&&t.set(n,r)}if(this.gridResolver&&s.size>0)for(const[n,i]of s){const r=this.gridResolver(n,i);if(r)for(const[o,a]of r)t.set(`${n}!${o}`,a)}return t}setGridResolver(e){this.gridResolver=e}async recalculateCrossSheetFormulas(){const e=await this.store.getFormulaGrid(),t=new Set;for(const[s,n]of e)!n.f||!Array.from(_e(n.f)).some(r=>He(r))||t.add(s);if(t.size!==0){this.store.beginBatch();try{const s=await this.store.buildDependantsMap(t);await te(this,s,t),this.filterRange&&await this.recomputeFilterHiddenRows()}finally{this.store.endBatch()}}}getActiveCell(){return this.activeCell}setActiveCell(e){const t=this.normalizeRefToAnchor(e);this.activeCell=t,this.store.updateActiveCell(t)}getRange(){return this.range}getPresences(){return this.store.getPresences()}getRangeOrActiveCell(){if(this.range)return this.expandRangeToMergedBoundaries(this.range);const e=this.getMergeForRef(this.activeCell);return e?e.range:[this.activeCell,this.activeCell]}getSelectionType(){return this.selectionType}selectRow(e){this.selectionType="row",this.activeCell={r:e,c:1},this.range=[{r:e,c:1},{r:e,c:this.dimension.columns}],this.store.updateActiveCell(this.activeCell)}selectColumn(e){this.selectionType="column",this.activeCell={r:1,c:e},this.range=[{r:1,c:e},{r:this.dimension.rows,c:e}],this.store.updateActiveCell(this.activeCell)}selectRowRange(e,t){this.selectionType="row";const s=Math.min(e,t),n=Math.max(e,t);this.range=[{r:s,c:1},{r:n,c:this.dimension.columns}]}selectColumnRange(e,t){this.selectionType="column";const s=Math.min(e,t),n=Math.max(e,t);this.range=[{r:1,c:s},{r:this.dimension.rows,c:n}]}selectAllCells(){this.selectionType="all",this.activeCell={r:1,c:1},this.range=q(this.dimensionRange),this.store.updateActiveCell(this.activeCell)}getSelectedIndices(){return this.selectionType==="cell"||this.selectionType==="all"||!this.range?null:this.selectionType==="row"?{axis:"row",from:this.range[0].r,to:this.range[1].r}:{axis:"column",from:this.range[0].c,to:this.range[1].c}}async createFilterFromSelection(){if(this.selectionType!=="cell")return!1;const e=this.getRangeOrActiveCell(),t=await this.expandFilterRangeForHeaderOnlySelection(e);return await this.setFilterRange(t)?(this.selectionType="cell",this.range=q(G(t[0],t[1])),!0):!1}async expandFilterRangeForHeaderOnlySelection(e){const t=G(e[0],e[1]);if(t[0].r!==t[1].r)return t;const s=t[0].r;if(s>=this.dimension.rows)return t;const n=[{r:s+1,c:t[0].c},{r:this.dimension.rows,c:t[1].c}],i=await this.store.getGrid(n);if(i.size===0)return t;const r=new Set;for(const[a,h]of i)this.hasCellContent(h)&&r.add(H(a).r);let o=s;for(;r.has(o+1);)o+=1;return G(t[0],{r:o,c:t[1].c})}async setFilterRange(e){const t=G(e[0],e[1]);if(t[1].r<=t[0].r)return!1;this.store.beginBatch();try{this.filterRange=t,this.normalizeFilterColumnsToRange(),await this.recomputeFilterHiddenRows()}finally{this.store.endBatch()}return!0}async clearFilter(){this.store.beginBatch();try{this.filterRange=void 0,this.filterColumns.clear(),this.hiddenRows.clear(),await this.store.setFilterState(void 0)}finally{this.store.endBatch()}}async setColumnFilter(e,t){if(!this.filterRange||!this.isColumnInFilter(e))return!1;this.store.beginBatch();try{const s=this.normalizeFilterCondition(t);s?this.filterColumns.set(e,s):this.filterColumns.delete(e),await this.recomputeFilterHiddenRows()}finally{this.store.endBatch()}return!0}async filterColumnByValue(e,t){return this.setColumnFilter(e,{op:"equals",value:t})}async clearColumnFilter(e){if(!this.filterRange||!this.isColumnInFilter(e)||!this.filterColumns.has(e))return!1;this.store.beginBatch();try{this.filterColumns.delete(e),await this.recomputeFilterHiddenRows()}finally{this.store.endBatch()}return!0}async getFilterColumnValues(e){if(!this.filterRange||!this.isColumnInFilter(e))return;const t=new Set,s=this.filterRange[0].r+1,n=this.filterRange[1].r;for(let o=s;o<=n;o++){if(!await this.rowMatchesFilters(o,e))continue;const a=await this.getCell({r:o,c:e}),h=this.normalizeFilterText(a==null?void 0:a.v);t.add(h.trim())}const i=Array.from(t).sort((o,a)=>o.localeCompare(a,void 0,{sensitivity:"base"})),r=this.filterColumns.get(e);return r?r.op==="in"?{values:i,selected:new Set((r.values||[]).map(o=>this.normalizeFilterText(o).trim()))}:{values:i,selected:new Set(i.filter(o=>this.matchesFilterCondition(o,r)))}:{values:i,selected:new Set(i)}}async setColumnIncludedValues(e,t){if(!this.filterRange||!this.isColumnInFilter(e))return!1;const s=Array.from(new Set(t.map(o=>this.normalizeFilterText(o).trim()))).sort((o,a)=>o.localeCompare(a,void 0,{sensitivity:"base"})),n=await this.getFilterColumnValues(e);if(!n)return!1;const i=new Set(n.values),r=s.filter(o=>i.has(o));this.store.beginBatch();try{r.length===n.values.length?this.filterColumns.delete(e):this.filterColumns.set(e,{op:"in",values:r}),await this.recomputeFilterHiddenRows()}finally{this.store.endBatch()}return!0}async sortFilterByColumn(e,t){if(!this.filterRange||!this.isColumnInFilter(e))return!1;const s=this.filterRange[0].r+1,n=this.filterRange[1].r;if(n<=s)return!1;const i=[{r:s,c:1},{r:n,c:this.dimension.columns}];if(this.getMergesIntersecting(i).length>0)return!1;const r=[];for(let c=s;c<=n;c++){const u=await this.getCell({r:c,c:e}),d=this.normalizeFilterText(u==null?void 0:u.v).trim(),f=d.length>0&&Number.isFinite(Number(d))?Number(d):null;r.push({row:c,text:d,lower:d.toLowerCase(),numeric:f})}r.sort((c,u)=>{const d=c.text.length===0,f=u.text.length===0;if(d&&!f)return 1;if(!d&&f)return-1;let C=0;return c.numeric!==null&&u.numeric!==null?C=c.numeric-u.numeric:C=c.lower.localeCompare(u.lower,void 0,{sensitivity:"base"}),C===0&&(C=c.row-u.row),t==="asc"?C:-C});const o=r.map(c=>c.row),a=Array.from({length:n-s+1},(c,u)=>s+u),h=[];for(let c=0;c<o.length;c++){const u=o[c],d=a.indexOf(u);if(d===-1||d===c)continue;const f=s+d,C=s+c;h.push({srcIndex:f,dstIndex:C}),a.splice(d,1),a.splice(c,0,u)}if(h.length===0)return!0;this.store.beginBatch();try{for(const c of h)await this.moveCells("row",c.srcIndex,1,c.dstIndex,{skipPostRecalculate:!0});await this.recalculateAllFormulaCells(),await this.recomputeFilterHiddenRows()}finally{this.store.endBatch()}return!0}selectStart(e){Z(e,this.dimensionRange)&&(this.selectionType="cell",this.setActiveCell(this.normalizeRefToAnchor(e)),this.range=void 0)}selectEnd(e){if(!Z(e,this.dimensionRange))return;const t=this.normalizeRefToAnchor(e);if(ve(this.activeCell,t)){this.range=void 0;return}this.range=this.expandRangeToMergedBoundaries(G(this.activeCell,t))}hasRange(){return!!this.range}async selectAll(){let e=this.getRangeOrActiveCell(),t=q(e),s=!0;for(;s;){s=!1;for(const n of ss(t,this.dimensionRange))await this.hasContents(n)&&(t=We(t,n),s=!0)}if(se(e,t)){this.range=q(this.dimensionRange);return}this.range=t}async moveToEdge(e){const t=this.getMergeForRef(this.activeCell),s={...this.activeCell};t&&(e==="right"?s.c=t.range[1].c:e==="down"&&(s.r=t.range[1].r));const n=await this.store.findEdge(s,e,this.dimensionRange);let i=this.normalizeRefToAnchor(n);if((e==="up"||e==="down")&&this.hiddenRows.has(i.r)){const r=this.findNextVisibleRow(i.r,e);if(r===void 0)return!1;i=this.normalizeRefToAnchor({r,c:i.c})}return ve(this.activeCell,i)?!1:(this.range=void 0,this.setActiveCell(i),!0)}move(e){const t=e==="up"?-1:e==="down"?1:0,s=e==="left"?-1:e==="right"?1:0;let n=this.activeCell.r,i=this.activeCell.c;const r=this.getMergeForRef(this.activeCell);if(r?e==="right"?i=r.range[1].c+1:e==="down"?n=r.range[1].r+1:e==="left"?i-=1:n-=1:(n+=t,i+=s),(e==="up"||e==="down")&&this.hiddenRows.has(n)){const a=this.findNextVisibleRow(n,e);if(a===void 0)return!1;n=a}if(!Z({r:n,c:i},this.dimensionRange))return!1;const o=this.normalizeRefToAnchor({r:n,c:i});return ve(this.activeCell,o)?!1:(this.range=void 0,this.setActiveCell(o),!0)}resizeRange(e){const t=e==="up"?-1:e==="down"?1:0,s=e==="left"?-1:e==="right"?1:0;let n=q(this.getRangeOrActiveCell());if(t!==0){const i=t>0?"down":"up",r=o=>this.hiddenRows.has(o)?this.findNextVisibleRow(o,i):o;if(this.activeCell.r===n[1].r){const o=r(n[0].r+t);if(o===void 0)return!1;n[0].r=o}else{const o=r(n[1].r+t);if(o===void 0)return!1;n[1].r=o}}return s!==0&&(this.activeCell.c===n[1].c?n[0].c+=s:n[1].c+=s),n=G(n[0],n[1]),ts(n,this.dimensionRange)?(this.range=this.expandRangeToMergedBoundaries(n),!0):!1}async getStyle(e){const t=this.normalizeRefToAnchor(e),s=await this.store.get(t);return this.resolveEffectiveStyle(t.r,t.c,s==null?void 0:s.s)}async setStyle(e,t){const s=this.normalizeStylePatch(t);if(!s)return;const n=this.normalizeRefToAnchor(e),i=await this.store.get(n)||{},r=this.mergeStylePatch(i.s,s),o=this.compactCell(i,r);if(this.isEmptyCell(o)){await this.store.delete(n);return}await this.store.set(n,o)}async setRangeStyle(e){this.store.beginBatch();try{if(this.selectionType==="column"){const s=this.getRangeOrActiveCell();for(let n=s[0].c;n<=s[1].c;n++){const i=this.mergeStylePatch(this.colStyles.get(n),e);i&&(this.colStyles.set(n,i),await this.store.setColumnStyle(n,i))}return}if(this.selectionType==="row"){const s=this.getRangeOrActiveCell();for(let n=s[0].r;n<=s[1].r;n++){const i=this.mergeStylePatch(this.rowStyles.get(n),e);i&&(this.rowStyles.set(n,i),await this.store.setRowStyle(n,i))}return}if(this.selectionType==="all"){const s=this.mergeStylePatch(this.sheetStyle,e);if(!s)return;this.sheetStyle=s,await this.store.setSheetStyle(s);return}const t=this.getRangeOrActiveCell();await this.addRangeStylePatch(t,e),await this.applyStylePatchToExistingCells(t,e)}finally{this.store.endBatch()}}async resetRangeStyleToDefault(){if(this.selectionType!=="cell")return!1;const e=this.getRangeOrActiveCell();this.store.beginBatch();try{await this.addRangeStylePatch(e,Ys),await this.clearCellStylesInRange(e)}finally{this.store.endBatch()}return!0}async setConditionalFormats(e){const t=e.map(s=>De(s)).filter(s=>!!s).map(s=>pe(s));this.conditionalFormats=t,await this.store.setConditionalFormats(this.conditionalFormats)}async setRangeBorders(e){if(this.selectionType!=="cell")return!1;const t=this.getRangeOrActiveCell(),s=t[1].r-t[0].r+1,n=t[1].c-t[0].c+1;if(s*n>Ks)return!1;const i=this.collectBorderTargets(t);this.store.beginBatch();try{for(const{anchor:r,range:o}of i){const a=this.toBorderPatchForPreset(e,t,o);await this.setStyle(r,a)}}finally{this.store.endBatch()}return!0}async toggleRangeStyle(e){const t=await this.getStyle(this.activeCell),s=!(t!=null&&t[e]);await this.setRangeStyle({[e]:s})}collectBorderTargets(e){const t=[],s=new Set;for(let n=e[0].r;n<=e[1].r;n++)for(let i=e[0].c;i<=e[1].c;i++){const r=this.normalizeRefToAnchor({r:n,c:i}),o=M(r);if(s.has(o))continue;s.add(o);const a=this.merges.get(o),h=a?we(r,a):G(r,r);t.push({anchor:r,range:h})}return t}toBorderPatchForPreset(e,t,s){const n=s[0].r===t[0].r,i=s[1].r===t[1].r,r=s[0].c===t[0].c,o=s[1].c===t[1].c;switch(e){case"all":return{bt:!0,bl:!0,br:o,bb:i};case"outer":return{bt:n,bl:r,br:o,bb:i};case"inner":return{bt:!n,bl:!r,br:!1,bb:!1};case"top":return{bt:n};case"bottom":return{bb:i};case"left":return{bl:r};case"right":return{br:o};case"clear":default:return{bt:!1,bl:!1,br:!1,bb:!1}}}isSelectionMerged(){if(this.selectionType!=="cell")return!1;const e=this.getRangeOrActiveCell(),t=this.getMergesIntersecting(e);return t.length===1&&se(t[0].range,e)}canMergeSelection(){if(this.selectionType!=="cell")return!1;const e=this.getRangeOrActiveCell();if(e[0].r===e[1].r&&e[0].c===e[1].c)return!1;const s=this.frozenRows>0&&e[0].r<=this.frozenRows&&e[1].r>this.frozenRows,n=this.frozenCols>0&&e[0].c<=this.frozenCols&&e[1].c>this.frozenCols;return s||n?!1:this.getMergesIntersecting(e).length===0}async toggleMergeSelection(){return this.isSelectionMerged()?this.unmergeSelection():this.mergeSelection()}async mergeSelection(){if(!this.canMergeSelection())return!1;const e=this.getRangeOrActiveCell(),t=e[0],s={rs:e[1].r-e[0].r+1,cs:e[1].c-e[0].c+1},n=new Set;for(const i of this.mergeCoveredSrefs(t,s))n.add(i);this.store.beginBatch();try{for(let o=e[0].r;o<=e[1].r;o++)for(let a=e[0].c;a<=e[1].c;a++){if(o===t.r&&a===t.c)continue;const h={r:o,c:a},c=await this.store.get(h);c&&(c.s&&Object.keys(c.s).length>0?await this.store.set(h,{s:c.s}):await this.store.delete(h))}await this.store.setMerge(t,s),this.merges.set(M(t),s),this.rebuildMergeCoverMap();const i=this.expandChangedSrefsWithMergeAliases(n),r=await this.store.buildDependantsMap(i);await te(this,r,i)}finally{this.store.endBatch()}return this.selectionType="cell",this.setActiveCell(t),this.range=we(t,s),!0}async unmergeSelection(){if(this.selectionType!=="cell")return!1;const e=this.getRangeOrActiveCell(),t=this.getMergesIntersecting(e);if(t.length===0)return!1;const s=new Set;for(const n of t)for(const i of this.mergeCoveredSrefs(n.anchor,n.span))s.add(i);this.store.beginBatch();try{for(const r of t)await this.store.deleteMerge(r.anchor),this.merges.delete(r.anchorSref);this.rebuildMergeCoverMap();const n=this.expandChangedSrefsWithMergeAliases(s),i=await this.store.buildDependantsMap(n);await te(this,i,n)}finally{this.store.endBatch()}return this.selectionType="cell",this.range=void 0,!0}async getActiveDecimalPlaces(){const e=await this.getStyle(this.activeCell);return(e==null?void 0:e.dp)??2}async undo(){const e=await this.store.undo();if(e.success&&(await this.loadDimensions(),await this.loadStyles(),await this.loadMerges(),await this.loadFreezePane(),await this.loadFilterState(),e.affectedRange)){const[t,s]=e.affectedRange;this.selectionType="cell",this.activeCell=t,t.r===s.r&&t.c===s.c?this.range=void 0:this.range=e.affectedRange,this.store.updateActiveCell(this.activeCell)}return e.success}async redo(){const e=await this.store.redo();if(e.success&&(await this.loadDimensions(),await this.loadStyles(),await this.loadMerges(),await this.loadFreezePane(),await this.loadFilterState(),e.affectedRange)){const[t,s]=e.affectedRange;this.selectionType="cell",this.activeCell=t,t.r===s.r&&t.c===s.c?this.range=void 0:this.range=e.affectedRange,this.store.updateActiveCell(this.activeCell)}return e.success}moveInRange(e,t){const s=this.range||this.dimensionRange;let n=this.activeCell.r,i=this.activeCell.c;const r=this.getMergeForRef(this.activeCell),o=s[1].r-s[0].r+1,a=s[1].c-s[0].c+1;if(e!==0){const h=e>0?r?r.span.rs:e:e<0?-1:0;n+h>s[1].r?(n=s[0].r,i=(i+1-s[0].c+a)%a+s[0].c):n+h<s[0].r?(n=s[1].r,i=(i-1-s[0].c+a)%a+s[0].c):n+=h}if(t!==0){const h=t>0?r?r.span.cs:t:t<0?-1:0;i+h>s[1].c?(i=s[0].c,n=(n+1-s[0].r+o)%o+s[0].r):i+h<s[0].c?(i=s[1].c,n=(n-1-s[0].r+o)%o+s[0].r):i+=h}this.setActiveCell(this.normalizeRefToAnchor({r:n,c:i}))}}const Xs={cellBorderColor:"#D3D3D3",customBorderColor:"#000000",cellBGColor:"#FFFFFF",cellTextColor:"#000000",activeCellColor:"#E6C746",selectionBGColor:"rgba(230, 199, 70, 0.1)",headerBGColor:"#F0F0F0",headerActiveBGColor:"#E6C746","tokens.REFERENCE":"#E6C746","tokens.NUM":"#4DA6FF",peerCursor1:"#FF6B6B",peerCursor2:"#4ECDC4",peerCursor3:"#45B7D1",peerCursor4:"#96CEB4",peerCursor5:"#FFEAA7",peerCursor6:"#DDA0DD",peerCursor7:"#98D8C8",peerCursor8:"#F7DC6F",resizeHandleColor:"#1A73E8",headerSelectedBGColor:"rgba(26, 115, 232, 0.3)",dropIndicatorColor:"#1A73E8",freezeLineColor:"#BBBBBB",freezeHandleColor:"#9E9E9E",freezeHandleHoverColor:"#5F6368",formulaRange1:"#1A73E8",formulaRange2:"#E84C3D",formulaRange3:"#9B59B6",formulaRange4:"#27AE60",formulaRange5:"#F39C12",formulaRange6:"#00ACC1",filterRangeBorderColor:"#1A73E8"},qs={cellBorderColor:"#4A4A4A",customBorderColor:"#FFFFFF",cellBGColor:"#1E1E1E",cellTextColor:"#FFFFFF",activeCellColor:"#D4B73E",selectionBGColor:"rgba(212, 183, 62, 0.1)",headerBGColor:"#2D2D2D",headerActiveBGColor:"#D4B73E","tokens.REFERENCE":"#D4B73E","tokens.NUM":"#4DA6FF",peerCursor1:"#FF7979",peerCursor2:"#55EFC4",peerCursor3:"#74B9FF",peerCursor4:"#A4D4C4",peerCursor5:"#FDCB6E",peerCursor6:"#E17055",peerCursor7:"#81ECEC",peerCursor8:"#F8D84F",resizeHandleColor:"#8AB4F8",headerSelectedBGColor:"rgba(138, 180, 248, 0.3)",dropIndicatorColor:"#8AB4F8",freezeLineColor:"#5A5A5A",freezeHandleColor:"#8E8E8E",freezeHandleHoverColor:"#CCCCCC",formulaRange1:"#8AB4F8",formulaRange2:"#FF7979",formulaRange3:"#BB86FC",formulaRange4:"#66BB6A",formulaRange5:"#FFB74D",formulaRange6:"#4DD0E1",filterRangeBorderColor:"#8AB4F8"};function k(l,e){return l==="light"?Xs[e]:qs[e]}const mt=["formulaRange1","formulaRange2","formulaRange3","formulaRange4","formulaRange5","formulaRange6"];function Oe(l,e){return k(l,mt[e%mt.length])}function yt(l,e){const t=["peerCursor1","peerCursor2","peerCursor3","peerCursor4","peerCursor5","peerCursor6","peerCursor7","peerCursor8"];let s=0;for(let i=0;i<e.length;i++){const r=e.charCodeAt(i);s=(s<<5)-s+r,s=s&s}const n=Math.abs(s)%t.length;return k(l,t[n])}function J(l){const e=window.getSelection();if(e.rangeCount===0)return;const t=e.getRangeAt(0);if(!l.contains(t.commonAncestorContainer))return;let s=0,n=0,i=0;function r(o){if(o.nodeType===Node.TEXT_NODE){const a=o.textContent;o===t.startContainer&&(n=s+t.startOffset),o===t.endContainer&&(i=s+t.endOffset),s+=a.length}for(const a of o.childNodes)r(a)}return r(l),{start:n,end:i}}function ne(l,e){let t=0,s=null,n=null;const i=document.createRange();function r(a){if(a.nodeType===Node.TEXT_NODE){const h=a.textContent;s===null&&t+h.length>=e.start&&(s=a,i.setStart(a,e.start-t)),n===null&&t+h.length>=e.end&&(n=a,i.setEnd(a,e.end-t)),t+=h.length}for(const h of a.childNodes)r(h)}if(r(l),s===null||n===null){const a=l.childNodes.length,h=Math.max(0,Math.min(e.start,a)),c=Math.max(h,Math.min(e.end,a));i.setStart(l,h),i.setEnd(l,c)}const o=window.getSelection();o.removeAllRanges(),o.addRange(i),l.focus()}function Gt(l){return l=l.replace(/&/g,"&amp;"),l=l.replace(/</g,"&lt;"),l=l.replace(/>/g,"&gt;"),l=l.replace(/"/g,"&quot;"),l=l.replace(/'/g,"&#039;"),l=l.replace(/\n/g,"<br>"),l=l.replace(/ /g,"&nbsp;"),l}const Kt=23,Ut=10;class js{constructor(e="light",t=!1){p(this,"sheet");p(this,"theme");p(this,"readOnly");p(this,"container");p(this,"cellLabel");p(this,"formulaInput");p(this,"boundHandleInput");p(this,"boundHandleCompositionStart");p(this,"boundHandleCompositionEnd");p(this,"composing",!1);this.theme=e,this.readOnly=t,this.container=document.createElement("div"),this.container.style.height=`${Kt}px`,this.container.style.margin=`${Ut}px 0px`,this.container.style.display="flex",this.container.style.alignItems="center",this.container.style.borderTop=`1px solid ${k(this.theme,"cellBorderColor")}`,this.container.style.borderBottom=`1px solid ${k(this.theme,"cellBorderColor")}`,this.container.style.justifyContent="flex-start",this.cellLabel=document.createElement("div"),this.cellLabel.style.width="120px",this.cellLabel.style.textAlign="center",this.cellLabel.style.font="12px Arial",this.cellLabel.style.borderRight=`1px solid ${k(this.theme,"cellBorderColor")}`,this.container.appendChild(this.cellLabel),this.formulaInput=document.createElement("div"),this.formulaInput.contentEditable=this.readOnly?"false":"true",this.formulaInput.style.margin="0 20px",this.formulaInput.style.width="100%",this.formulaInput.style.height="12px",this.formulaInput.style.border="none",this.formulaInput.style.font="12px Arial",this.formulaInput.style.outline="none",this.formulaInput.style.overflow="hidden",this.formulaInput.style.whiteSpace="nowrap",this.formulaInput.style.lineHeight="12px",this.container.appendChild(this.formulaInput),this.boundHandleInput=this.handleInput.bind(this),this.boundHandleCompositionStart=this.handleCompositionStart.bind(this),this.boundHandleCompositionEnd=this.handleCompositionEnd.bind(this),this.formulaInput.addEventListener("input",this.boundHandleInput),this.formulaInput.addEventListener("compositionstart",this.boundHandleCompositionStart),this.formulaInput.addEventListener("compositionend",this.boundHandleCompositionEnd)}getContainer(){return this.container}initialize(e){this.sheet=e}cleanup(){this.formulaInput.removeEventListener("input",this.boundHandleInput),this.formulaInput.removeEventListener("compositionstart",this.boundHandleCompositionStart),this.formulaInput.removeEventListener("compositionend",this.boundHandleCompositionEnd),this.sheet=void 0,this.container.remove()}async render(){if(!this.sheet)return;const e=this.sheet.getActiveCell(),t=this.sheet.getSelectionType(),s=this.sheet.getSelectedIndices();let n;if(t==="row"&&s)n=`${s.from}:${s.to}`;else if(t==="column"&&s){const i=fe(s.from),r=fe(s.to);n=`${i}:${r}`}else{const i=this.sheet.getRange();n=i?is(i):M(e)}this.cellLabel.textContent=n,this.formulaInput.innerText=await this.sheet.toInputString(e),this.renderInput()}getFormulaInput(){return this.formulaInput}getValue(){return this.formulaInput.innerText}setValue(e){this.formulaInput.innerText=e,this.renderInput()}focus(){this.formulaInput.focus()}blur(){this.formulaInput.blur()}isFocused(){return document.activeElement===this.formulaInput}isComposing(){return this.composing}handleInput(){this.composing||this.renderInput()}handleCompositionStart(){this.composing=!0}handleCompositionEnd(){this.composing=!1,this.renderInput()}renderInput(){if(this.composing)return;const e=this.formulaInput.innerText;if(!e.startsWith("="))return;const t=Fe(e),s=[];let n=0;for(const r of t){if(r.type==="REFERENCE"){s.push(`<span style="color: ${Oe(this.theme,n)}">${r.text}</span>`),n++;continue}if(r.type==="NUM"){s.push(`<span style="color: ${this.getThemeColor("tokens.NUM")}">${r.text}</span>`);continue}s.push(Gt(r.text))}const i=J(this.formulaInput);this.formulaInput.innerHTML="="+s.join(""),i&&ne(this.formulaInput,i)}getThemeColor(e){return k(this.theme,e)}}const X=100,S=23,R=50,ie=13,Le=1.5,xe=4,Ue=5,$e=.5,Qs=1.5,Zs="center",Yt=4,Js=10;function N(l,e={left:0,top:0},t,s){const n=s?s.getOffset(l.c):(l.c-1)*X,i=t?t.getOffset(l.r):(l.r-1)*S,r=s?s.getSize(l.c):X,o=t?t.getSize(l.r):S;return{left:n+R-e.left,top:i+S-e.top,width:r,height:o}}function Q(l,e){const t=Math.min(l.left,e.left),s=Math.min(l.top,e.top),n=Math.max(l.left+l.width,e.left+e.width),i=Math.max(l.top+l.height,e.top+e.height);return{left:t,top:s,width:n-t,height:i-s}}const le={frozenRows:0,frozenCols:0,frozenWidth:0,frozenHeight:0};function en(l,e,t,s){return l===0&&e===0?le:{frozenRows:l,frozenCols:e,frozenWidth:e>0?s.getOffset(e+1):0,frozenHeight:l>0?t.getOffset(l+1):0}}function tn(l,e,t,s){const n=t?t.findIndex(e-S):Math.floor(e/S),i=s?s.findIndex(l-R):Math.floor((l+R)/X);return{r:n,c:i}}function sn(l,e,t,s,n,i){const r=i.frozenCols>0&&l<R+i.frozenWidth,o=i.frozenRows>0&&e<S+i.frozenHeight,a=r?l-R:l-R-i.frozenWidth+n.getOffset(i.frozenCols+1)+t.left,h=o?e-S:e-S-i.frozenHeight+s.getOffset(i.frozenRows+1)+t.top,c=n.findIndex(a),u=s.findIndex(h);return{r:Math.max(1,u),c:Math.max(1,c)}}function be(l,e,t,s,n){const i=s.getOffset(l.c),r=t.getOffset(l.r),o=s.getSize(l.c),a=t.getSize(l.r),h=n.frozenCols>0&&l.c<=n.frozenCols,c=n.frozenRows>0&&l.r<=n.frozenRows,u=h?i+R:i+R-e.left-s.getOffset(n.frozenCols+1)+n.frozenWidth,d=c?r+S:r+S-e.top-t.getOffset(n.frozenRows+1)+n.frozenHeight;return{left:u,top:d,width:o,height:a}}class nn{constructor(e="light"){p(this,"container");p(this,"input");p(this,"cellPositionHint");p(this,"theme");p(this,"boundHandleInput");p(this,"minWidth",X);p(this,"minHeight",S);p(this,"maxWidth",1/0);p(this,"maxHeight",1/0);p(this,"composing",!1);p(this,"primed",!1);p(this,"boundHandleCompositionStart");p(this,"boundHandleCompositionEnd");p(this,"onPrimedActivate");this.theme=e,this.container=document.createElement("div"),this.container.style.position="absolute",this.container.style.left="-1000px",this.container.style.width=X+"px",this.container.style.height=S+"px",this.container.style.zIndex="1",this.container.style.margin="0px",this.container.style.pointerEvents="none",this.input=document.createElement("div"),this.input.contentEditable="true",this.input.style.border="none",this.input.style.outline=`2px solid ${this.getThemeColor("activeCellColor")}`,this.input.style.fontFamily="Arial, sans-serif",this.input.style.fontSize=ie+"px",this.input.style.fontWeight="normal",this.input.style.lineHeight=String(Le),this.input.style.color=this.getThemeColor("cellTextColor"),this.input.style.backgroundColor=this.getThemeColor("cellBGColor"),this.input.style.whiteSpace="pre",this.input.style.overflow="hidden",this.container.appendChild(this.input),this.cellPositionHint=document.createElement("div"),this.cellPositionHint.style.position="absolute",this.cellPositionHint.style.right="4px",this.cellPositionHint.style.top="4px",this.cellPositionHint.style.padding="0 4px",this.cellPositionHint.style.borderRadius="3px",this.cellPositionHint.style.border=`1px solid ${this.getThemeColor("cellBorderColor")}`,this.cellPositionHint.style.backgroundColor=this.getThemeColor("headerBGColor"),this.cellPositionHint.style.color=this.getThemeColor("cellTextColor"),this.cellPositionHint.style.fontSize="10px",this.cellPositionHint.style.lineHeight="14px",this.cellPositionHint.style.fontFamily="Arial, sans-serif",this.cellPositionHint.style.pointerEvents="none",this.cellPositionHint.style.display="none",this.cellPositionHint.style.zIndex="2",this.container.appendChild(this.cellPositionHint),this.boundHandleInput=this.handleInput.bind(this),this.boundHandleCompositionStart=this.handleCompositionStart.bind(this),this.boundHandleCompositionEnd=this.handleCompositionEnd.bind(this),this.input.addEventListener("input",this.boundHandleInput),this.input.addEventListener("compositionstart",this.boundHandleCompositionStart),this.input.addEventListener("compositionend",this.boundHandleCompositionEnd)}cleanup(){this.input.removeEventListener("input",this.boundHandleInput),this.input.removeEventListener("compositionstart",this.boundHandleCompositionStart),this.input.removeEventListener("compositionend",this.boundHandleCompositionEnd),this.container.remove()}getContainer(){return this.container}getInput(){return this.input}show(e,t,s="",n=!0,i,r,o,a,h=!0){this.primed=!1,this.applyEditingAppearance(),this.updateFrame(e,t,i??X,r??S,o??1/0,a??1/0),this.input.innerText=s,this.renderInput(),this.adjustSize(),n&&(this.input.focus(),h&&ne(this.input,{start:this.input.innerText.length,end:this.input.innerText.length}))}prime(e,t,s,n,i,r){this.primed=!0,this.updateFrame(e,t,s??X,n??S,i??1/0,r??1/0),this.input.innerText="",this.renderInput(),this.adjustSize(),this.applyPrimedAppearance(),this.input.focus()}hide(){this.primed=!1,this.applyEditingAppearance(),this.container.style.left="-1000px",this.container.style.pointerEvents="none",this.setCellPositionHint(),this.input.innerText="",this.input.blur()}isShown(){return this.container.style.left!=="-1000px"}isFocused(){return document.activeElement===this.input}isComposing(){return this.composing}isPrimed(){return this.primed}setOnPrimedActivate(e){this.onPrimedActivate=e}getValue(){return this.input.innerText}setValue(e){this.input.innerText=e,this.renderInput(),this.adjustSize()}hasFormula(){return this.input.innerText.startsWith("=")}updatePlacement(e,t,s=X,n=S,i=1/0,r=1/0){this.updateFrame(e,t,s,n,i,r),this.adjustSize()}setCellPositionHint(e){if(!e){this.cellPositionHint.style.display="none",this.cellPositionHint.innerText="";return}this.cellPositionHint.innerText=e,this.cellPositionHint.style.display="block"}applyStyle(e){this.input.style.fontWeight=e!=null&&e.b?"bold":"normal",this.input.style.fontStyle=e!=null&&e.i?"italic":"normal";const t=[];e!=null&&e.u&&t.push("underline"),e!=null&&e.st&&t.push("line-through"),this.input.style.textDecoration=t.length?t.join(" "):"none",this.input.style.color=(e==null?void 0:e.tc)||this.getThemeColor("cellTextColor"),this.input.style.backgroundColor=(e==null?void 0:e.bg)||this.getThemeColor("cellBGColor"),this.input.style.textAlign=(e==null?void 0:e.al)||"left";const s=(e==null?void 0:e.va)||"top";this.container.style.display="flex",this.container.style.alignItems=s==="middle"?"center":s==="bottom"?"flex-end":"flex-start"}handleInput(){if(this.activatePrimedInput(),this.composing){this.adjustSize();return}this.renderInput(),this.adjustSize()}handleCompositionStart(){this.activatePrimedInput(),this.composing=!0}handleCompositionEnd(){this.composing=!1,this.renderInput(),this.adjustSize()}updateFrame(e,t,s,n,i,r){this.minWidth=s,this.minHeight=n,this.maxWidth=i,this.maxHeight=r,this.container.style.left=e+"px",this.container.style.top=t+"px"}adjustSize(){this.input.style.width=this.minWidth+"px",this.input.style.height=this.minHeight+"px";const e=Math.min(Math.max(this.minWidth,this.input.scrollWidth),this.maxWidth),t=Math.min(Math.max(this.minHeight,this.input.scrollHeight),this.maxHeight);this.container.style.width=e+"px",this.container.style.height=t+"px",this.input.style.width=e+"px",this.input.style.height=t+"px",this.input.style.overflowY=this.input.scrollHeight>this.maxHeight?"auto":"hidden"}renderInput(){if(this.composing)return;const e=this.input.innerText;if(!e.startsWith("="))return;const t=Fe(e),s=[];let n=0;for(const r of t){if(r.type==="REFERENCE"){s.push(`<span style="color: ${Oe(this.theme,n)}">${r.text}</span>`),n++;continue}if(r.type==="NUM"){s.push(`<span style="color: ${this.getThemeColor("tokens.NUM")}">${r.text}</span>`);continue}s.push(Gt(r.text))}const i=J(this.input);this.input.innerHTML="="+s.join(""),i&&ne(this.input,i)}getThemeColor(e){return k(this.theme,e)}activatePrimedInput(){var e;this.primed&&(this.primed=!1,this.applyEditingAppearance(),(e=this.onPrimedActivate)==null||e.call(this))}applyEditingAppearance(){this.container.style.pointerEvents="auto",this.input.style.outline=`2px solid ${this.getThemeColor("activeCellColor")}`,this.input.style.color=this.getThemeColor("cellTextColor"),this.input.style.backgroundColor=this.getThemeColor("cellBGColor"),this.input.style.caretColor=this.getThemeColor("cellTextColor")}applyPrimedAppearance(){this.container.style.pointerEvents="none",this.input.style.outline="none",this.input.style.color="transparent",this.input.style.backgroundColor="transparent",this.input.style.caretColor="transparent"}}class rn{constructor(e="light"){p(this,"canvas");p(this,"theme");this.theme=e,this.canvas=document.createElement("canvas"),this.canvas.style.position="absolute",this.canvas.style.zIndex="1",this.canvas.style.pointerEvents="none"}cleanup(){this.canvas.remove()}getContainer(){return this.canvas}render(e,t,s,n,i,r,o,a,h,c,u,d=le,f,C,y,v=!0,x,E){this.canvas.width=0,this.canvas.height=0;const m=this.canvas.getContext("2d"),z=window.devicePixelRatio||1;this.canvas.width=e.width*z,this.canvas.height=e.height*z,this.canvas.style.width=e.width+"px",this.canvas.style.height=e.height+"px",m.scale(z,z);const F=d.frozenRows>0||d.frozenCols>0,P=this.buildMergeRenderData(x),A=this.resolveAutofillSelectionRange(i,s,P);if(!F)this.renderActiveCellSimple(m,s,t,r,o,P),this.renderSelectionSimple(m,e,t,i,h,r,o),this.renderPeerCursorsSimple(m,e,n,t,r,o,P),this.renderFilterRangeSimple(m,E,t,r,o),this.renderFormulaRangesSimple(m,u,t,r,o),this.renderCopyRangeSimple(m,C,t,r,o);else{const b=this.buildQuadrants(e,t,d,r,o);this.renderSelectionFrozen(m,e,t,i,h,r,o,d,b);for(const g of b){m.save(),m.beginPath(),m.rect(g.x,g.y,g.width,g.height),m.clip();const w=this.toCellRect(s,{left:g.scrollLeft,top:g.scrollTop},r,o,P);m.strokeStyle=this.getThemeColor("activeCellColor"),m.lineWidth=2,m.strokeRect(w.left,w.top,w.width,w.height),m.restore()}for(const{clientID:g,presence:w}of n){if(!w.activeCell)continue;const B=H(w.activeCell),I=yt(this.theme,g);for(const O of b){m.save(),m.beginPath(),m.rect(O.x,O.y,O.width,O.height),m.clip();const T=this.toCellRect(B,{left:O.scrollLeft,top:O.scrollTop},r,o,P);T.left>=-T.width&&T.left<e.width&&T.top>=-T.height&&T.top<e.height&&(m.strokeStyle=I,m.lineWidth=2,m.strokeRect(T.left,T.top,T.width,T.height)),m.restore()}}if(E)for(const g of b){m.save(),m.beginPath(),m.rect(g.x,g.y,g.width,g.height),m.clip();const w={left:g.scrollLeft,top:g.scrollTop},B=Q(N(E[0],w,r,o),N(E[1],w,r,o));m.strokeStyle=this.getThemeColor("filterRangeBorderColor"),m.lineWidth=1,m.strokeRect(B.left,B.top,B.width,B.height),m.restore()}if(u&&u.length>0)for(let g=0;g<u.length;g++){const w=u[g],B=Oe(this.theme,g);for(const I of b){m.save(),m.beginPath(),m.rect(I.x,I.y,I.width,I.height),m.clip();const O={left:I.scrollLeft,top:I.scrollTop},T=Q(N(w[0],O,r,o),N(w[1],O,r,o));m.strokeStyle=B,m.lineWidth=2,m.strokeRect(T.left,T.top,T.width,T.height),m.fillStyle=B+"20",m.fillRect(T.left,T.top,T.width,T.height),m.restore()}}if(C)for(const g of b){m.save(),m.beginPath(),m.rect(g.x,g.y,g.width,g.height),m.clip();const w={left:g.scrollLeft,top:g.scrollTop};this.drawCopyRangeBorder(m,C,w,r,o),m.restore()}}y&&!se(y,A)&&this.renderAutofillPreview(m,y,t,r,o,d),v&&this.renderAutofillHandle(m,A,h,t,r,o,d),a&&o&&r&&this.renderResizeHover(m,e,t,a,r,o,d),c&&o&&r&&this.renderDragMoveIndicator(m,e,t,c,r,o,d),f&&o&&r&&this.renderFreezeDragPreview(m,e,f,r,o)}buildQuadrants(e,t,s,n,i){const r=s.frozenWidth,o=s.frozenHeight,a=n?n.getOffset(s.frozenRows+1):0,h=i?i.getOffset(s.frozenCols+1):0,c=[];return c.push({x:R+r,y:S+o,width:e.width-R-r,height:e.height-S-o,scrollLeft:t.left+h-r,scrollTop:t.top+a-o}),s.frozenRows>0&&c.push({x:R+r,y:S,width:e.width-R-r,height:o,scrollLeft:t.left+h-r,scrollTop:0}),s.frozenCols>0&&c.push({x:R,y:S+o,width:r,height:e.height-S-o,scrollLeft:0,scrollTop:t.top+a-o}),s.frozenRows>0&&s.frozenCols>0&&c.push({x:R,y:S,width:r,height:o,scrollLeft:0,scrollTop:0}),c}renderActiveCellSimple(e,t,s,n,i,r){const o=this.toCellRect(t,s,n,i,r);e.strokeStyle=this.getThemeColor("activeCellColor"),e.lineWidth=2,e.strokeRect(o.left,o.top,o.width,o.height)}renderSelectionSimple(e,t,s,n,i,r,o){if(i==="all")e.fillStyle=this.getThemeColor("selectionBGColor"),e.fillRect(R,S,t.width-R,t.height-S);else if(n)if(i==="row"){const a=N(n[0],s,r,o),h=N(n[1],s,r,o),c=a.top,u=h.top+h.height-a.top;e.fillStyle=this.getThemeColor("selectionBGColor"),e.fillRect(R,c,t.width-R,u),e.strokeStyle=this.getThemeColor("activeCellColor"),e.lineWidth=1,e.strokeRect(R,c,t.width-R,u)}else if(i==="column"){const a=N(n[0],s,r,o),h=N(n[1],s,r,o),c=a.left,u=h.left+h.width-a.left;e.fillStyle=this.getThemeColor("selectionBGColor"),e.fillRect(c,S,u,t.height-S),e.strokeStyle=this.getThemeColor("activeCellColor"),e.lineWidth=1,e.strokeRect(c,S,u,t.height-S)}else{const a=Q(N(n[0],s,r,o),N(n[1],s,r,o));e.fillStyle=this.getThemeColor("selectionBGColor"),e.fillRect(a.left,a.top,a.width,a.height),e.strokeStyle=this.getThemeColor("activeCellColor"),e.lineWidth=1,e.strokeRect(a.left,a.top,a.width,a.height)}}renderPeerCursorsSimple(e,t,s,n,i,r,o){for(const{clientID:a,presence:h}of s){if(!h.activeCell)continue;const c=H(h.activeCell),u=this.toCellRect(c,n,i,r,o);if(u.left>=-u.width&&u.left<t.width&&u.top>=-u.height&&u.top<t.height){const d=yt(this.theme,a);e.strokeStyle=d,e.lineWidth=2,e.strokeRect(u.left,u.top,u.width,u.height)}}}renderFilterRangeSimple(e,t,s,n,i){if(!t)return;const r=Q(N(t[0],s,n,i),N(t[1],s,n,i));e.strokeStyle=this.getThemeColor("filterRangeBorderColor"),e.lineWidth=1,e.strokeRect(r.left,r.top,r.width,r.height)}renderFormulaRangesSimple(e,t,s,n,i){if(!(!t||t.length===0))for(let r=0;r<t.length;r++){const o=t[r],a=Q(N(o[0],s,n,i),N(o[1],s,n,i)),h=Oe(this.theme,r);e.strokeStyle=h,e.lineWidth=2,e.strokeRect(a.left,a.top,a.width,a.height),e.fillStyle=h+"20",e.fillRect(a.left,a.top,a.width,a.height)}}renderCopyRangeSimple(e,t,s,n,i){t&&this.drawCopyRangeBorder(e,t,s,n,i)}drawCopyRangeBorder(e,t,s,n,i){const r=Q(N(t[0],s,n,i),N(t[1],s,n,i));e.strokeStyle=this.getThemeColor("activeCellColor"),e.lineWidth=2,e.setLineDash([5,3]),e.strokeRect(r.left,r.top,r.width,r.height),e.setLineDash([])}renderSelectionFrozen(e,t,s,n,i,r,o,a,h){if(i==="all"){e.fillStyle=this.getThemeColor("selectionBGColor"),e.fillRect(R,S,t.width-R,t.height-S);return}if(n)for(const c of h){e.save(),e.beginPath(),e.rect(c.x,c.y,c.width,c.height),e.clip();const u={left:c.scrollLeft,top:c.scrollTop};if(i==="row"){const d=N(n[0],u,r,o),f=N(n[1],u,r,o),C=d.top,y=f.top+f.height-d.top;e.fillStyle=this.getThemeColor("selectionBGColor"),e.fillRect(R,C,t.width-R,y),e.strokeStyle=this.getThemeColor("activeCellColor"),e.lineWidth=1,e.strokeRect(R,C,t.width-R,y)}else if(i==="column"){const d=N(n[0],u,r,o),f=N(n[1],u,r,o),C=d.left,y=f.left+f.width-d.left;e.fillStyle=this.getThemeColor("selectionBGColor"),e.fillRect(C,S,y,t.height-S),e.strokeStyle=this.getThemeColor("activeCellColor"),e.lineWidth=1,e.strokeRect(C,S,y,t.height-S)}else{const d=Q(N(n[0],u,r,o),N(n[1],u,r,o));e.fillStyle=this.getThemeColor("selectionBGColor"),e.fillRect(d.left,d.top,d.width,d.height),e.strokeStyle=this.getThemeColor("activeCellColor"),e.lineWidth=1,e.strokeRect(d.left,d.top,d.width,d.height)}e.restore()}}renderResizeHover(e,t,s,n,i,r,o){if(e.strokeStyle=this.getThemeColor("resizeHandleColor"),e.lineWidth=2,n.axis==="column"){const h=o.frozenCols>0&&n.index<=o.frozenCols?0:s.left+r.getOffset(o.frozenCols+1)-o.frozenWidth,c=R+r.getOffset(n.index)+r.getSize(n.index)-h;e.beginPath(),e.moveTo(c,0),e.lineTo(c,t.height),e.stroke()}else{const h=o.frozenRows>0&&n.index<=o.frozenRows?0:s.top+i.getOffset(o.frozenRows+1)-o.frozenHeight,c=S+i.getOffset(n.index)+i.getSize(n.index)-h;e.beginPath(),e.moveTo(0,c),e.lineTo(t.width,c),e.stroke()}}renderDragMoveIndicator(e,t,s,n,i,r,o){if(e.strokeStyle=this.getThemeColor("dropIndicatorColor"),e.lineWidth=3,n.axis==="column"){const h=o.frozenCols>0&&n.dropIndex<=o.frozenCols?0:s.left+r.getOffset(o.frozenCols+1)-o.frozenWidth,c=R+r.getOffset(n.dropIndex)-h;e.beginPath(),e.moveTo(c,0),e.lineTo(c,t.height),e.stroke()}else{const h=o.frozenRows>0&&n.dropIndex<=o.frozenRows?0:s.top+i.getOffset(o.frozenRows+1)-o.frozenHeight,c=S+i.getOffset(n.dropIndex)-h;e.beginPath(),e.moveTo(0,c),e.lineTo(t.width,c),e.stroke()}}renderFreezeDragPreview(e,t,s,n,i){if(e.strokeStyle=this.getThemeColor("freezeLineColor"),e.lineWidth=2,s.axis==="row"){const r=s.targetIndex===0?S:S+n.getOffset(s.targetIndex+1);e.beginPath(),e.moveTo(0,r),e.lineTo(t.width,r),e.stroke()}else{const r=s.targetIndex===0?R:R+i.getOffset(s.targetIndex+1);e.beginPath(),e.moveTo(r,0),e.lineTo(r,t.height),e.stroke()}}toRangeRect(e,t,s,n,i=le){if(!s||!n)return;const r=i.frozenRows>0||i.frozenCols>0,o=r?be(e[0],t,s,n,i):N(e[0],t,s,n),a=r?be(e[1],t,s,n,i):N(e[1],t,s,n);return Q(o,a)}renderAutofillPreview(e,t,s,n,i,r=le){const o=this.toRangeRect(t,s,n,i,r);o&&(e.strokeStyle=this.getThemeColor("activeCellColor"),e.lineWidth=1,e.setLineDash([4,2]),e.strokeRect(o.left,o.top,o.width,o.height),e.setLineDash([]))}renderAutofillHandle(e,t,s,n,i,r,o=le){if(s!=="cell"||!t)return;const a=this.toRangeRect(t,n,i,r,o);if(!a)return;const h=8,c=a.left+a.width-h/2,u=a.top+a.height-h/2;e.fillStyle=this.getThemeColor("activeCellColor"),e.fillRect(c,u,h,h),e.strokeStyle=this.getThemeColor("cellBGColor"),e.lineWidth=1,e.strokeRect(c+.5,u+.5,h,h)}resolveAutofillSelectionRange(e,t,s){if(e)return[e[0],e[1]];const n=M(t),i=(s==null?void 0:s.coverToAnchor.get(n))||n,r=H(i),o=s==null?void 0:s.anchors.get(i);return!o||o.rs===1&&o.cs===1?[r,r]:[r,{r:r.r+o.rs-1,c:r.c+o.cs-1}]}getThemeColor(e){return k(this.theme,e)}buildMergeRenderData(e){if(!e||e.size===0)return;const t=new Map,s=new Map;for(const[n,i]of e){t.set(n,i);const r=H(n);for(let o=r.r;o<r.r+i.rs;o++)for(let a=r.c;a<r.c+i.cs;a++){const h=M({r:o,c:a});h!==n&&s.set(h,n)}}return{anchors:t,coverToAnchor:s}}toCellRect(e,t,s,n,i){const r=M(e),o=(i==null?void 0:i.coverToAnchor.get(r))||r,a=H(o),h=i==null?void 0:i.anchors.get(o),c=N(a,t,s,n);if(!h||h.rs===1&&h.cs===1)return c;const u=N({r:a.r+h.rs-1,c:a.c+h.cs-1},t,s,n);return{left:c.left,top:c.top,width:u.left+u.width-c.left,height:u.top+u.height-c.top}}}const Ae=1e7;class on{constructor(e="light"){p(this,"container");p(this,"scrollContainer");p(this,"dummyContainer");p(this,"actualWidth",0);p(this,"actualHeight",0);this.createContainers()}createContainers(){this.container=document.createElement("div"),this.container.style.position="relative",this.container.style.width="100%",this.container.style.height=`calc(100% - ${Kt+Ut*2}px)`,this.scrollContainer=document.createElement("div"),this.scrollContainer.style.position="absolute",this.scrollContainer.style.overflow="auto",this.scrollContainer.style.width="100%",this.scrollContainer.style.height="100%",this.scrollContainer.style.zIndex="1",this.dummyContainer=document.createElement("div"),this.dummyContainer.style.margin="0px",this.dummyContainer.style.padding="0px",this.dummyContainer.style.pointerEvents="none",this.scrollContainer.appendChild(this.dummyContainer),this.container.appendChild(this.scrollContainer)}getContainer(){return this.container}getScrollContainer(){return this.scrollContainer}getDummyContainer(){return this.dummyContainer}updateDummySize(e,t){this.actualWidth=e,this.actualHeight=t;const s=Math.min(e,Ae),n=Math.min(t,Ae);this.dummyContainer.style.width=s+"px",this.dummyContainer.style.height=n+"px"}appendChild(e){this.container.appendChild(e)}getViewport(){return this.scrollContainer.getBoundingClientRect()}getScrollPosition(){const e=this.scrollContainer.scrollLeft,t=this.scrollContainer.scrollTop,s=this.scrollContainer.getBoundingClientRect();return{left:this.toLogical(e,this.actualWidth,s.width),top:this.toLogical(t,this.actualHeight,s.height)}}setScrollPosition(e){const t=this.scrollContainer.getBoundingClientRect();e.left!==void 0&&(this.scrollContainer.scrollLeft=this.toPhysical(e.left,this.actualWidth,t.width)),e.top!==void 0&&(this.scrollContainer.scrollTop=this.toPhysical(e.top,this.actualHeight,t.height))}scrollBy(e,t){const s=this.scrollContainer.getBoundingClientRect(),n=this.needsRemap(this.actualWidth,s.width)?e*this.physicalMax(this.actualWidth,s.width)/this.logicalMax(this.actualWidth,s.width):e,i=this.needsRemap(this.actualHeight,s.height)?t*this.physicalMax(this.actualHeight,s.height)/this.logicalMax(this.actualHeight,s.height):t;this.scrollContainer.scrollBy(n,i)}addEventListener(e,t,s){this.scrollContainer.addEventListener(e,t,s)}removeEventListener(e,t,s){this.scrollContainer.removeEventListener(e,t,s)}cleanup(){this.container.remove()}needsRemap(e,t){return e>Ae&&t<e}cappedSize(e){return Math.min(e,Ae)}physicalMax(e,t){return Math.max(0,this.cappedSize(e)-t)}logicalMax(e,t){return Math.max(0,e-t)}clamp(e,t,s){return s<=t?t:Math.min(s,Math.max(t,e))}toLogical(e,t,s){const n=this.logicalMax(t,s);if(!this.needsRemap(t,s))return this.clamp(e,0,n);const i=this.physicalMax(t,s);return i<=0||n<=0?0:this.clamp(e,0,i)*n/i}toPhysical(e,t,s){const n=this.logicalMax(t,s);if(!this.needsRemap(t,s))return this.clamp(e,0,n);if(n<=0)return 0;const i=this.physicalMax(t,s);return this.clamp(e,0,n)*i/n}}const ln="M4 6h16 M6 12h12 M9 18h6",de=class de{constructor(e="light"){p(this,"canvas");p(this,"theme");this.theme=e,this.canvas=document.createElement("canvas"),this.canvas.style.position="absolute",this.canvas.style.pointerEvents="none"}getCanvas(){return this.canvas}render(e,t,s,n,i,r,o,a,h,c=le,u=null,d,f,C,y,v,x,E,m,z=null){this.canvas.width=0,this.canvas.height=0;const F=this.canvas.getContext("2d"),P=window.devicePixelRatio||1;this.canvas.width=e.width*P,this.canvas.height=e.height*P,this.canvas.style.width=e.width+"px",this.canvas.style.height=e.height+"px",F.scale(P,P);const[A,b]=s,g=this.buildMergeRenderData(x);if(!(c.frozenRows>0||c.frozenCols>0))this.renderQuadrantCells(F,A.r,b.r+1,A.c,b.c+1,i,t,r,o,d,f,C,y,v,g,E,m,z),this.renderColumnHeaders(F,A.c,b.c,t.left,R,e.width,n,a,h,r,o),this.renderRowHeaders(F,A.r,b.r,t.top,S,e.height,n,a,h,r,o);else{const I=c.frozenWidth,O=c.frozenHeight,T=c.frozenRows,L=c.frozenCols,W=T+1,$=L+1,K=Math.max(W,A.r),he=Math.max($,A.c),V=r?r.getOffset(W):T*S,Y=o?o.getOffset($):L*X;F.save(),F.beginPath(),F.rect(R+I,S+O,e.width-R-I,e.height-S-O),F.clip(),this.renderQuadrantCells(F,K,b.r+1,he,b.c+1,i,{left:t.left+Y-I,top:t.top+V-O},r,o,d,f,C,y,v,g,E,m,z),F.restore(),T>0&&(F.save(),F.beginPath(),F.rect(R+I,S,e.width-R-I,O),F.clip(),this.renderQuadrantCells(F,1,T+1,he,b.c+1,i,{left:t.left+Y-I,top:0},r,o,d,f,C,y,v,g,E,m,z),F.restore()),L>0&&(F.save(),F.beginPath(),F.rect(R,S+O,I,e.height-S-O),F.clip(),this.renderQuadrantCells(F,K,b.r+1,1,L+1,i,{left:0,top:t.top+V-O},r,o,d,f,C,y,v,g,E,m,z),F.restore()),T>0&&L>0&&(F.save(),F.beginPath(),F.rect(R,S,I,O),F.clip(),this.renderQuadrantCells(F,1,T+1,1,L+1,i,{left:0,top:0},r,o,d,f,C,y,v,g,E,m,z),F.restore()),L>0&&this.renderColumnHeaders(F,1,L,0,R,R+I,n,a,h,r,o),this.renderColumnHeaders(F,he,b.c,t.left+Y-I,R+I,e.width,n,a,h,r,o),T>0&&this.renderRowHeaders(F,1,T,0,S,S+O,n,a,h,r,o),this.renderRowHeaders(F,K,b.r,t.top+V-O,S+O,e.height,n,a,h,r,o),this.renderFreezeLines(F,e,I,O)}const B=a==="all";F.fillStyle=B?this.getThemeColor("headerSelectedBGColor"):this.getThemeColor("headerBGColor"),F.fillRect(0,0,R,S),F.strokeStyle=this.getThemeColor("cellBorderColor"),F.lineWidth=$e,F.strokeRect(0,0,R,S),this.renderFreezeHandles(F,c,u)}renderQuadrantCells(e,t,s,n,i,r,o,a,h,c,u,d,f,C,y,v,x,E=null){const m=new Map,z=(A,b,g)=>{const w=M({r:A,c:b});if(m.has(w))return m.get(w)||void 0;const B=this.resolveEffectiveStyle(A,b,g,d,c,u,f,C);return m.set(w,B||null),B},F=this.buildTextOverflowRenderData(e,t,s,n,i,r,h,y,z),P=this.buildRenderableRefs(t,s,n,i,y);for(const{r:A,c:b}of P){const g=M({r:A,c:b}),w=r==null?void 0:r.get(g),B=y==null?void 0:y.anchors.get(g),I=z(A,b,w),O=F==null?void 0:F.hiddenVerticalBoundaries.has(this.verticalBoundaryKey(A,b-1)),T=F==null?void 0:F.hiddenVerticalBoundaries.has(this.verticalBoundaryKey(A,b));this.renderCellBackground(e,{r:A,c:b},w,o,a,h,I,B,O,T)}for(const{r:A,c:b}of P){const g=M({r:A,c:b}),w=r==null?void 0:r.get(g),B=y==null?void 0:y.anchors.get(g),I=z(A,b,w);this.renderCellCustomBorders(e,{r:A,c:b},o,a,h,I,B)}for(const{r:A,c:b}of P){const g=M({r:A,c:b}),w=r==null?void 0:r.get(g),B=y==null?void 0:y.anchors.get(g),I=z(A,b,w),O=F==null?void 0:F.anchorToEndCol.get(g);this.renderCellContent(e,{r:A,c:b},w,o,a,h,I,r,i,B,O)}if(v){const A=v[0].r;if(A>=t&&A<=s){const b=Math.max(n,v[0].c),g=Math.min(i,v[1].c);for(let w=b;w<=g;w++){const B=M({r:A,c:w});if(y!=null&&y.coverToAnchor.has(B))continue;const I=y==null?void 0:y.anchors.get(B);this.renderCellFilterButton(e,{r:A,c:w},o,a,h,I,!!(x!=null&&x.has(w)),E===w)}}}}buildRenderableRefs(e,t,s,n,i){const r=[],o=new Set;for(let a=e;a<=t;a++)for(let h=s;h<=n;h++){const c=M({r:a,c:h});i!=null&&i.coverToAnchor.has(c)||(r.push({r:a,c:h}),o.add(c))}if(!i)return r;for(const[a,h]of i.anchors){if(o.has(a))continue;const c=H(a),u=c.r+h.rs-1,d=c.c+h.cs-1;c.r<=t&&u>=e&&c.c<=n&&d>=s&&r.push(c)}return r}renderColumnHeaders(e,t,s,n,i,r,o,a,h,c,u){e.save(),e.beginPath(),e.rect(i,0,r-i,S),e.clip();for(let d=t;d<=s;d++){const f=u?u.getOffset(d):X*(d-1),C=u?u.getSize(d):X,y=R+f-n,v=0,x=a==="all"||a==="column"&&h&&d>=h[0].c&&d<=h[1].c;this.renderHeader(e,y,v,C,S,fe(d),o.c===d,x||!1)}e.restore()}renderCellFilterButton(e,t,s,n,i,r,o=!1,a=!1){const h=this.toCellRect(t,s,n,i,r),c=h.width,u=h.height;if(c<=6||u<=6)return;const d=Math.min(16,Math.max(12,c-4)),f=Math.min(16,Math.max(12,u-6)),C=h.left+c-d-2,y=h.top+Math.max(3,(u-f)/2);(o||a)&&(e.fillStyle=o?this.getThemeColor("selectionBGColor"):this.getThemeColor("headerSelectedBGColor"),e.fillRect(C,y,d,f));const v=o||a?this.getThemeColor("resizeHandleColor"):this.getThemeColor("cellTextColor"),x=Math.max(9,Math.min(12,Math.min(d,f)-3)),E=C+(d-x)/2,m=y+(f-x)/2;e.save(),e.translate(E,m),e.scale(x/24,x/24),e.strokeStyle=v,e.lineCap="round",e.lineJoin="round";const z=this.getFilterIconPath2D();z?(e.lineWidth=2,e.stroke(z)):(e.lineWidth=2,e.beginPath(),e.moveTo(4,6),e.lineTo(20,6),e.moveTo(6,12),e.lineTo(18,12),e.moveTo(9,18),e.lineTo(15,18),e.stroke()),e.restore()}getFilterIconPath2D(){return typeof Path2D>"u"?null:(de.filterIconPath2D===void 0&&(de.filterIconPath2D=new Path2D(ln)),de.filterIconPath2D)}renderRowHeaders(e,t,s,n,i,r,o,a,h,c,u){e.save(),e.beginPath(),e.rect(0,i,R,r-i),e.clip();for(let d=t;d<=s;d++){const f=c?c.getOffset(d):S*(d-1),C=c?c.getSize(d):S;if(C<=0)continue;const y=0,v=f+S-n,x=a==="all"||a==="row"&&h&&d>=h[0].r&&d<=h[1].r;this.renderHeader(e,y,v,R,C,String(d),o.r===d,x||!1)}e.restore()}renderFreezeLines(e,t,s,n){if(e.strokeStyle=this.getThemeColor("freezeLineColor"),e.lineWidth=2,n>0){const i=S+n;e.beginPath(),e.moveTo(0,i),e.lineTo(t.width,i),e.stroke()}if(s>0){const i=R+s;e.beginPath(),e.moveTo(i,0),e.lineTo(i,t.height),e.stroke()}}renderFreezeHandles(e,t,s){const n=t.frozenRows>0||t.frozenCols>0,i=Yt,r=n&&t.frozenRows>0?S+t.frozenHeight-i/2:S-i,o=s==="row";e.fillStyle=o?this.getThemeColor("freezeHandleHoverColor"):this.getThemeColor("freezeHandleColor"),e.fillRect(0,r,R,i);const a=n&&t.frozenCols>0?R+t.frozenWidth-i/2:R-i,h=s==="column";e.fillStyle=h?this.getThemeColor("freezeHandleHoverColor"):this.getThemeColor("freezeHandleColor"),e.fillRect(a,0,i,S)}renderHeader(e,t,s,n,i,r,o,a=!1){n<=0||i<=0||(e.fillStyle=a?this.getThemeColor("headerSelectedBGColor"):o?this.getThemeColor("headerActiveBGColor"):this.getThemeColor("headerBGColor"),e.fillRect(t,s,n,i),e.strokeStyle=this.getThemeColor("cellBorderColor"),e.lineWidth=$e,e.strokeRect(t,s,n,i),e.fillStyle=this.getThemeColor("cellTextColor"),e.textAlign=Zs,e.font=o||a?"bold 10px Arial":"10px Arial",e.fillText(r,t+n/2,s+Math.min(15,i-4)))}renderCellBackground(e,t,s,n,i,r,o,a,h=!1,c=!1){const u=this.toCellRect(t,n,i,r,a),d=o??(s==null?void 0:s.s);if(e.fillStyle=(d==null?void 0:d.bg)||this.getThemeColor("cellBGColor"),e.fillRect(u.left,u.top,u.width,u.height),e.beginPath(),e.strokeStyle=this.getThemeColor("cellBorderColor"),e.lineWidth=$e,h||(e.moveTo(u.left,u.top),e.lineTo(u.left,u.top+u.height)),!c){const f=u.left+u.width;e.moveTo(f,u.top),e.lineTo(f,u.top+u.height)}e.moveTo(u.left,u.top),e.lineTo(u.left+u.width,u.top),e.moveTo(u.left,u.top+u.height),e.lineTo(u.left+u.width,u.top+u.height),e.stroke()}renderCellCustomBorders(e,t,s,n,i,r,o){if(!r||!r.bt&&!r.br&&!r.bb&&!r.bl)return;const a=this.toCellRect(t,s,n,i,o);if(e.beginPath(),e.strokeStyle=this.getThemeColor("customBorderColor"),e.lineWidth=Qs,r.bt&&(e.moveTo(a.left,a.top),e.lineTo(a.left+a.width,a.top)),r.br){const h=a.left+a.width;e.moveTo(h,a.top),e.lineTo(h,a.top+a.height)}if(r.bb){const h=a.top+a.height;e.moveTo(a.left,h),e.lineTo(a.left+a.width,h)}r.bl&&(e.moveTo(a.left,a.top),e.lineTo(a.left,a.top+a.height)),e.stroke()}renderCellContent(e,t,s,n,i,r,o,a,h,c,u){const d=this.toCellRect(t,n,i,r,c),f=o??(s==null?void 0:s.s),C=(s==null?void 0:s.v)||"";if(C){const y=Ke(C,f==null?void 0:f.nf,f==null?void 0:f.dp),v=y.split(`
`),x=this.toCellFont(f);let E=d.width;const m=(f==null?void 0:f.al)||"left";if(!c&&u&&r&&u>t.c){let b=0;for(let g=t.c+1;g<=u;g++)b+=r.getSize(g);E=d.width+b}else if(!c&&v.length===1&&m==="left"&&a&&r&&h){e.save(),e.font=x;const b=e.measureText(y).width+xe*2;if(e.restore(),b>d.width){let g=0;for(let w=t.c+1;w<=h;w++){const B=a.get(M({r:t.r,c:w}));if(B&&(B.v||B.f))break;const I=r.getSize(w);if(g+=I,d.width+g>=b)break}E=d.width+g}}e.save(),e.beginPath(),e.rect(d.left,d.top,E,d.height),e.clip(),e.fillStyle=(f==null?void 0:f.tc)||this.getThemeColor("cellTextColor"),e.font=x,e.textBaseline="top";let z;m==="center"?(e.textAlign="center",z=d.left+d.width/2):m==="right"?(e.textAlign="right",z=d.left+d.width-xe):(e.textAlign="left",z=d.left+xe);const F=(f==null?void 0:f.va)||"top",P=v.length*ie*Le;let A;F==="middle"?A=d.top+(d.height-P)/2:F==="bottom"?A=d.top+d.height-P-Ue:A=d.top+Ue;for(let b=0;b<v.length;b++){const g=A+b*(ie*Le);if(e.fillText(v[b],z,g),f!=null&&f.u){const w=e.measureText(v[b]),B=g+ie+1;let I;m==="center"?I=z-w.width/2:m==="right"?I=z-w.width:I=z,e.beginPath(),e.strokeStyle=(f==null?void 0:f.tc)||this.getThemeColor("cellTextColor"),e.lineWidth=1,e.moveTo(I,B),e.lineTo(I+w.width,B),e.stroke()}if(f!=null&&f.st){const w=e.measureText(v[b]),B=g+ie/2;let I;m==="center"?I=z-w.width/2:m==="right"?I=z-w.width:I=z,e.beginPath(),e.strokeStyle=(f==null?void 0:f.tc)||this.getThemeColor("cellTextColor"),e.lineWidth=1,e.moveTo(I,B),e.lineTo(I+w.width,B),e.stroke()}}e.restore()}}buildTextOverflowRenderData(e,t,s,n,i,r,o,a,h){if(!r||!o)return;const c=new Map,u=new Set;e.save();for(let d=t;d<=s;d++)for(let f=n;f<=i;f++){const C=M({r:d,c:f});if(a!=null&&a.coverToAnchor.has(C)||a!=null&&a.anchors.has(C))continue;const y=r.get(C),v=(y==null?void 0:y.v)||"";if(!v)continue;const x=h==null?void 0:h(d,f,y);if(((x==null?void 0:x.al)||"left")!=="left")continue;const m=Ke(v,x==null?void 0:x.nf,x==null?void 0:x.dp);if(m.split(`
`).length!==1)continue;const F=o.getSize(f);e.font=this.toCellFont(x);const P=e.measureText(m).width+xe*2;if(P<=F)continue;let A=F,b=f;for(let g=f+1;g<=i;g++){const w=h==null?void 0:h(d,g-1,r.get(M({r:d,c:g-1}))),B=h==null?void 0:h(d,g,r.get(M({r:d,c:g})));if(w!=null&&w.br||B!=null&&B.bl)break;const I=M({r:d,c:g});if(a!=null&&a.coverToAnchor.has(I)||a!=null&&a.anchors.has(I))break;const O=r.get(I);if(O&&(O.v||O.f)||(A+=o.getSize(g),b=g,A>=P))break}if(b>f){c.set(C,b);for(let g=f;g<b;g++)u.add(this.verticalBoundaryKey(d,g))}}if(e.restore(),c.size!==0)return{anchorToEndCol:c,hiddenVerticalBoundaries:u}}resolveEffectiveStyle(e,t,s,n,i,r,o,a){const h=i==null?void 0:i.get(t),c=r==null?void 0:r.get(e),u=o?Ht(o,e,t):void 0,d=a?ys(a,e,t,s):void 0;if(!(!n&&!h&&!c&&!u&&!(s!=null&&s.s)&&!d))return{...n,...h,...c,...u,...s==null?void 0:s.s,...d}}buildMergeRenderData(e){if(!e||e.size===0)return;const t=new Map,s=new Map;for(const[n,i]of e){t.set(n,i);const r=H(n);for(let o=r.r;o<r.r+i.rs;o++)for(let a=r.c;a<r.c+i.cs;a++){const h=M({r:o,c:a});h!==n&&s.set(h,n)}}return{anchors:t,coverToAnchor:s}}toCellRect(e,t,s,n,i){const r=N(e,t,s,n);if(!i||i.rs===1&&i.cs===1)return r;const o=N({r:e.r+i.rs-1,c:e.c+i.cs-1},t,s,n);return{left:r.left,top:r.top,width:o.left+o.width-r.left,height:o.top+o.height-r.top}}toCellFont(e){const t=[];return e!=null&&e.b&&t.push("bold"),e!=null&&e.i&&t.push("italic"),t.push(`${ie}px Arial`),t.join(" ")}verticalBoundaryKey(e,t){return`${e}:${t}`}getThemeColor(e){return k(this.theme,e)}cleanup(){this.canvas.remove()}};p(de,"filterIconPath2D");let Ye=de;class an{constructor(e="light"){p(this,"container");p(this,"theme");this.theme=e,this.container=document.createElement("div"),this.container.style.position="fixed",this.container.style.display="none",this.container.style.zIndex="1000",this.container.style.minWidth="160px",this.container.style.borderRadius="4px",this.container.style.boxShadow="0 2px 8px rgba(0,0,0,0.2)",this.container.style.padding="4px 0",this.container.style.fontSize="13px",this.container.style.fontFamily='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',this.applyTheme(),this.handleDocumentClick=this.handleDocumentClick.bind(this)}getContainer(){return this.container}show(e,t,s){this.container.innerHTML="";for(const n of s){const i=document.createElement("div");i.textContent=n.label,i.style.padding="6px 16px",i.style.cursor="pointer",i.style.color=k(this.theme,"cellTextColor"),i.addEventListener("mouseenter",()=>{i.style.backgroundColor=k(this.theme,"selectionBGColor")}),i.addEventListener("mouseleave",()=>{i.style.backgroundColor="transparent"}),i.addEventListener("mousedown",r=>{r.preventDefault(),r.stopPropagation(),this.hide(),n.action()}),this.container.appendChild(i)}this.container.style.left=`${e}px`,this.container.style.top=`${t}px`,this.container.style.display="block",document.addEventListener("mousedown",this.handleDocumentClick)}hide(){this.container.style.display="none",document.removeEventListener("mousedown",this.handleDocumentClick)}cleanup(){this.hide(),this.container.remove()}handleDocumentClick(e){this.container.contains(e.target)||this.hide()}applyTheme(){this.container.style.backgroundColor=k(this.theme,"cellBGColor"),this.container.style.border=`1px solid ${k(this.theme,"cellBorderColor")}`}}function hn(l,e){if(!l.startsWith("="))return{type:"none"};const t=l.slice(1,e);let s=0,n=0;for(let r=t.length-1;r>=0;r--){const o=t[r];if(o===")")s++;else if(o==="(")if(s>0)s--;else{const a=t.slice(0,r).match(/([A-Za-z_]\w*)$/);return a?{type:"argument",funcName:a[1].toUpperCase(),argIndex:n}:{type:"none"}}else o===","&&s===0&&n++}const i=t.match(/([A-Za-z_]\w*)$/);return i?{type:"function-name",prefix:i[1]}:{type:"none"}}class cn{constructor(e="light"){p(this,"container");p(this,"theme");p(this,"selectedIndex",0);p(this,"matches",[]);p(this,"mode","hidden");p(this,"currentHint",null);this.theme=e,this.container=document.createElement("div"),this.container.style.position="fixed",this.container.style.display="none",this.container.style.zIndex="1000",this.container.style.minWidth="220px",this.container.style.maxWidth="360px",this.container.style.borderRadius="4px",this.container.style.boxShadow="0 2px 8px rgba(0,0,0,0.2)",this.container.style.padding="4px 0",this.container.style.fontSize="13px",this.container.style.fontFamily='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',this.container.style.overflow="hidden",this.applyTheme()}getContainer(){return this.container}showList(e,t){if(this.matches=jt(e),this.matches.length===0){this.hide();return}this.mode="list",this.selectedIndex=0,this.renderList(),this.positionAt(t),this.container.style.display="block"}showHint(e,t,s){const n=Qt(e);if(!n){this.hide();return}this.mode="hint",this.currentHint={info:n,argIndex:t},this.renderHint(),this.positionAt(s),this.container.style.display="block"}hide(){this.mode="hidden",this.matches=[],this.currentHint=null,this.container.style.display="none",this.container.innerHTML=""}reposition(e){this.mode!=="hidden"&&this.positionAt(e)}moveUp(){this.mode!=="list"||this.matches.length===0||(this.selectedIndex=(this.selectedIndex-1+this.matches.length)%this.matches.length,this.renderList())}moveDown(){this.mode!=="list"||this.matches.length===0||(this.selectedIndex=(this.selectedIndex+1)%this.matches.length,this.renderList())}getSelectedFunction(){if(this.mode==="list")return this.matches[this.selectedIndex]}isListVisible(){return this.mode==="list"}isHintVisible(){return this.mode==="hint"}cleanup(){this.hide(),this.container.remove()}positionAt(e){this.container.style.left=`${e.left}px`,this.container.style.top=`${e.top}px`}renderList(){this.container.innerHTML="";const e=k(this.theme,"cellBGColor"),t=k(this.theme,"cellTextColor"),s=k(this.theme,"selectionBGColor"),n=k(this.theme,"activeCellColor");for(let i=0;i<this.matches.length;i++){const r=this.matches[i],o=document.createElement("div");o.style.padding="4px 10px",o.style.cursor="pointer",o.style.display="flex",o.style.flexDirection="column",o.style.gap="1px",o.style.backgroundColor=i===this.selectedIndex?s:e;const a=document.createElement("div");a.style.fontWeight="600",a.style.color=i===this.selectedIndex?n:t,a.textContent=r.name;const h=document.createElement("div");h.style.fontSize="11px",h.style.opacity="0.7",h.style.color=t,h.textContent=r.description,o.appendChild(a),o.appendChild(h),o.addEventListener("mouseenter",()=>{this.selectedIndex=i,this.renderList()}),o.addEventListener("mousedown",c=>{c.preventDefault(),c.stopPropagation()}),this.container.appendChild(o)}}renderHint(){if(this.container.innerHTML="",!this.currentHint)return;const{info:e,argIndex:t}=this.currentHint,s=k(this.theme,"cellTextColor"),n=k(this.theme,"activeCellColor"),i=document.createElement("div");i.style.padding="6px 10px",i.style.color=s,i.style.whiteSpace="nowrap";const r=document.createElement("span");r.style.fontWeight="600",r.textContent=e.name+"(",i.appendChild(r);for(let a=0;a<e.args.length;a++){a>0&&i.appendChild(document.createTextNode(", "));const h=e.args[a];let c=h.optional?`[${h.name}]`:h.name;h.repeating&&(c+=", ...");const u=document.createElement("span");(a===t||a===e.args.length-1&&h.repeating&&t>=a)&&(u.style.fontWeight="700",u.style.color=n),u.textContent=c,i.appendChild(u)}i.appendChild(document.createTextNode(")"));const o=document.createElement("div");o.style.fontSize="11px",o.style.opacity="0.7",o.style.color=s,o.style.padding="2px 10px 4px",o.textContent=Ge(e)+" — "+e.description,this.container.appendChild(i),this.container.appendChild(o)}applyTheme(){this.container.style.backgroundColor=k(this.theme,"cellBGColor"),this.container.style.border=`1px solid ${k(this.theme,"cellBorderColor")}`}}class un{constructor(e="light"){p(this,"theme");p(this,"container");p(this,"panel");p(this,"searchInput");p(this,"status");p(this,"list");p(this,"rows",[]);p(this,"matches",[...Ne]);p(this,"selectedIndex",0);p(this,"listTextColor","");p(this,"listSelectedBG","");p(this,"listActiveColor","");p(this,"onInsert");p(this,"onClose");p(this,"boundHandleBackdropMouseDown");p(this,"boundHandleSearchInput");p(this,"boundHandleSearchKeydown");p(this,"boundHandleListPointerDown");p(this,"boundHandleListClick");p(this,"boundHandleListMouseOver");this.theme=e,this.container=document.createElement("div"),this.container.style.position="fixed",this.container.style.inset="0",this.container.style.display="none",this.container.style.zIndex="1100",this.container.style.backgroundColor="rgba(0, 0, 0, 0.18)",this.container.style.padding="40px 16px 16px",this.container.style.boxSizing="border-box",this.panel=document.createElement("div"),this.panel.style.margin="0 auto",this.panel.style.maxWidth="720px",this.panel.style.height="min(560px, calc(100vh - 72px))",this.panel.style.display="flex",this.panel.style.flexDirection="column",this.panel.style.backgroundColor=k(this.theme,"cellBGColor"),this.panel.style.border=`1px solid ${k(this.theme,"cellBorderColor")}`,this.panel.style.borderRadius="8px",this.panel.style.boxShadow="0 10px 30px rgba(0, 0, 0, 0.2)",this.panel.style.color=k(this.theme,"cellTextColor"),this.panel.style.overflow="hidden";const t=document.createElement("div");t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="space-between",t.style.padding="12px 14px",t.style.borderBottom=`1px solid ${k(this.theme,"cellBorderColor")}`;const s=document.createElement("div");s.textContent="Functions",s.style.font="600 14px Arial",t.appendChild(s);const n=document.createElement("button");n.type="button",n.textContent="Close",n.style.border=`1px solid ${k(this.theme,"cellBorderColor")}`,n.style.borderRadius="4px",n.style.backgroundColor=k(this.theme,"cellBGColor"),n.style.color=k(this.theme,"cellTextColor"),n.style.padding="4px 8px",n.style.font="12px Arial",n.style.cursor="pointer",n.addEventListener("click",()=>this.hide()),t.appendChild(n);const i=document.createElement("div");i.style.display="flex",i.style.flexDirection="column",i.style.gap="6px",i.style.padding="12px 14px 10px",i.style.borderBottom=`1px solid ${k(this.theme,"cellBorderColor")}`,this.searchInput=document.createElement("input"),this.searchInput.type="text",this.searchInput.placeholder="Search by name or description",this.searchInput.style.width="100%",this.searchInput.style.boxSizing="border-box",this.searchInput.style.padding="7px 10px",this.searchInput.style.border=`1px solid ${k(this.theme,"cellBorderColor")}`,this.searchInput.style.borderRadius="4px",this.searchInput.style.outline="none",this.searchInput.style.font="13px Arial",this.searchInput.style.color=k(this.theme,"cellTextColor"),this.searchInput.style.backgroundColor=k(this.theme,"cellBGColor"),i.appendChild(this.searchInput),this.status=document.createElement("div"),this.status.style.font="12px Arial",this.status.style.opacity="0.75",i.appendChild(this.status),this.list=document.createElement("div"),this.list.style.flex="1",this.list.style.overflow="auto",this.list.style.padding="6px 0",this.panel.appendChild(t),this.panel.appendChild(i),this.panel.appendChild(this.list),this.container.appendChild(this.panel),this.boundHandleBackdropMouseDown=r=>{r.target===this.container&&this.hide()},this.boundHandleSearchInput=()=>{this.selectedIndex=0,this.filterAndRender()},this.boundHandleSearchKeydown=r=>{if(r.key==="ArrowDown"){r.preventDefault(),this.matches.length>0&&(this.setSelectedIndex((this.selectedIndex+1)%this.matches.length),this.scrollSelectedIntoView());return}if(r.key==="ArrowUp"){r.preventDefault(),this.matches.length>0&&(this.setSelectedIndex((this.selectedIndex-1+this.matches.length)%this.matches.length),this.scrollSelectedIntoView());return}if(r.key==="Enter"){r.preventDefault(),this.insertSelected();return}r.key==="Escape"&&(r.preventDefault(),this.hide())},this.boundHandleListPointerDown=r=>{if(r.button!==0)return;const o=this.getRowIndexFromTarget(r.target);o!==null&&(r.preventDefault(),this.setSelectedIndex(o),this.insertSelected())},this.boundHandleListClick=r=>{if(r.button!==0||!this.isVisible())return;const o=this.getRowIndexFromTarget(r.target);o!==null&&(r.preventDefault(),this.setSelectedIndex(o),this.insertSelected())},this.boundHandleListMouseOver=r=>{const o=this.getRowIndexFromTarget(r.target);o===null||o===this.selectedIndex||this.setSelectedIndex(o)},this.container.addEventListener("mousedown",this.boundHandleBackdropMouseDown),this.searchInput.addEventListener("input",this.boundHandleSearchInput),this.searchInput.addEventListener("keydown",this.boundHandleSearchKeydown),this.list.addEventListener("pointerdown",this.boundHandleListPointerDown),this.list.addEventListener("click",this.boundHandleListClick),this.list.addEventListener("mouseover",this.boundHandleListMouseOver),this.filterAndRender()}getContainer(){return this.container}setOnInsert(e){this.onInsert=e}setOnClose(e){this.onClose=e}contains(e){return e instanceof Node&&this.container.contains(e)}isVisible(){return this.container.style.display!=="none"}show(){this.searchInput.value="",this.selectedIndex=0,this.filterAndRender(),this.container.style.display="block",requestAnimationFrame(()=>this.searchInput.focus())}hide(){var e;this.isVisible()&&(this.container.style.display="none",(e=this.onClose)==null||e.call(this))}cleanup(){this.container.removeEventListener("mousedown",this.boundHandleBackdropMouseDown),this.searchInput.removeEventListener("input",this.boundHandleSearchInput),this.searchInput.removeEventListener("keydown",this.boundHandleSearchKeydown),this.list.removeEventListener("pointerdown",this.boundHandleListPointerDown),this.list.removeEventListener("click",this.boundHandleListClick),this.list.removeEventListener("mouseover",this.boundHandleListMouseOver),this.container.remove()}filterAndRender(){const e=this.searchInput.value.trim().toUpperCase(),t=e.length===0?Ne:Ne.filter(n=>{const i=n.name.toUpperCase(),r=n.description.toUpperCase(),o=Ge(n).toUpperCase();return i.includes(e)||r.includes(e)||o.includes(e)}),s=new Map(Zt.map((n,i)=>[n,i]));this.matches=[...t].sort((n,i)=>{const r=s.get(n.category)??Number.MAX_SAFE_INTEGER,o=s.get(i.category)??Number.MAX_SAFE_INTEGER;return r!==o?r-o:n.name.localeCompare(i.name)}),this.selectedIndex>=this.matches.length&&(this.selectedIndex=Math.max(0,this.matches.length-1)),this.renderList()}renderList(){this.list.innerHTML="",this.rows=[];const e=Jt(this.matches);if(this.status.textContent=`${this.matches.length} functions in ${e.length} categories`,this.matches.length===0){const n=document.createElement("div");n.textContent="No matching functions",n.style.padding="16px 14px",n.style.font="13px Arial",n.style.opacity="0.8",this.list.appendChild(n);return}const t=k(this.theme,"cellBorderColor");this.listTextColor=k(this.theme,"cellTextColor"),this.listSelectedBG=k(this.theme,"selectionBGColor"),this.listActiveColor=k(this.theme,"activeCellColor");let s=null;for(let n=0;n<this.matches.length;n++){const i=this.matches[n];if(i.category!==s){const f=document.createElement("div");f.dataset.funcCategoryHeader=i.category,f.textContent=i.category,f.style.padding="8px 14px 4px",f.style.font="600 11px Arial",f.style.letterSpacing="0.04em",f.style.textTransform="uppercase",f.style.opacity="0.68",f.style.borderBottom=`1px solid ${t}`,f.style.backgroundColor=k(this.theme,"headerBGColor"),this.list.appendChild(f),s=i.category}const r=document.createElement("div");r.dataset.funcName=i.name,r.dataset.funcIndex=String(n),r.style.display="flex",r.style.gap="10px",r.style.alignItems="flex-start",r.style.justifyContent="flex-start",r.style.padding="10px 14px",r.style.cursor="pointer",r.style.borderBottom=`1px solid ${t}`,r.style.backgroundColor="transparent";const o=document.createElement("div");o.style.minWidth="0",o.style.flex="1";const a=document.createElement("div");a.style.display="flex",a.style.alignItems="center",a.style.justifyContent="space-between",a.style.gap="8px";const h=document.createElement("div");h.textContent=i.name,h.style.font="600 13px Arial",h.style.color=this.listTextColor,h.style.flex="1";const c=document.createElement("div");c.textContent=i.category,c.style.font="11px Arial",c.style.opacity="0.66",c.style.whiteSpace="nowrap";const u=document.createElement("div");u.textContent=Ge(i),u.style.font="12px Arial",u.style.opacity="0.82",u.style.marginTop="2px",u.style.wordBreak="break-word";const d=document.createElement("div");d.textContent=i.description,d.style.font="12px Arial",d.style.opacity="0.72",d.style.marginTop="2px",d.style.wordBreak="break-word",a.appendChild(h),a.appendChild(c),o.appendChild(a),o.appendChild(u),o.appendChild(d),r.appendChild(o),this.list.appendChild(r),this.rows.push({row:r,name:h})}this.updateRowSelection(this.selectedIndex)}scrollSelectedIntoView(){var t;const e=(t=this.rows[this.selectedIndex])==null?void 0:t.row;e&&e.scrollIntoView({block:"nearest"})}getRowIndexFromTarget(e){if(!(e instanceof Element))return null;const t=e.closest("[data-func-index]");if(!(t instanceof HTMLDivElement)||!this.list.contains(t))return null;const s=Number(t.dataset.funcIndex);return Number.isInteger(s)?s:null}setSelectedIndex(e){if(e===this.selectedIndex||e<0||e>=this.matches.length)return;const t=this.selectedIndex;this.selectedIndex=e,this.updateRowSelection(t),this.updateRowSelection(e)}updateRowSelection(e){const t=this.rows[e];if(!t)return;const s=e===this.selectedIndex;t.row.style.backgroundColor=s?this.listSelectedBG:"transparent",t.name.style.color=s?this.listActiveColor:this.listTextColor}insertSelected(){var t;const e=this.matches[this.selectedIndex];e&&((t=this.onInsert)==null||t.call(this,e),this.hide())}}const Ct=l=>l.length===1?l.toLowerCase():l,ke=l=>l.metaKey||l.ctrlKey,D=(l,e)=>Ct(l.key)===Ct(e),_=(l,e)=>!(!D(l,e.key)||e.mod!==void 0&&ke(l)!==e.mod||e.shift!==void 0&&l.shiftKey!==e.shift||e.alt!==void 0&&l.altKey!==e.alt),wt=async(l,e)=>{for(const t of e)if(t.match(l))return await t.run(l),!0;return!1},Te=6,dn=10,vt=20,St=120,Rt=300,fn=1800,ce=8,Be=4,pn=200,ue=8;function Ee(l){return l.isComposing||l.key==="Process"||l.keyCode===229}class gn{constructor(e,t="light",s=!1){p(this,"sheet");p(this,"theme");p(this,"container");p(this,"formulaBar");p(this,"cellInput");p(this,"overlay");p(this,"gridContainer");p(this,"gridCanvas");p(this,"contextMenu");p(this,"autocomplete");p(this,"functionBrowser");p(this,"resizeTooltip");p(this,"filterPanel");p(this,"filterPanelState",null);p(this,"filterPanelOutsideClickUnsub",null);p(this,"filterPanelKeyboardUnsub",null);p(this,"rowDim");p(this,"colDim");p(this,"hiddenRows",new Set);p(this,"hiddenRowSizeBackup",new Map);p(this,"listeners",[]);p(this,"interactionCleanups",new Set);p(this,"resizeObserver");p(this,"preventDocumentSelectStart",e=>{e.preventDefault()});p(this,"resizeHover",null);p(this,"dragMove",null);p(this,"editMode",!1);p(this,"manuallyResizedRows",new Set);p(this,"formulaRanges",[]);p(this,"freezeState",le);p(this,"freezeHandleHover",null);p(this,"filterButtonHoverCol",null);p(this,"freezeDrag",null);p(this,"autofillPreview");p(this,"onRenderCallback");p(this,"readOnly");p(this,"formulaRangeAnchor",null);p(this,"activeFormulaInput",null);p(this,"formulaRefInsertPos",null);p(this,"lastFormulaRefTarget",null);p(this,"nativeSelectionBlockDepth",0);p(this,"previousBodyUserSelect","");p(this,"previousBodyWebkitUserSelect","");p(this,"pendingRenderFrame",null);p(this,"renderInFlight",!1);p(this,"renderQueued",!1);p(this,"renderVersion",0);this.container=e,this.theme=t,this.readOnly=s,this.formulaBar=new js(t,s),this.gridContainer=new on(t),this.overlay=new rn(t),this.gridCanvas=new Ye(t),this.cellInput=new nn(t),this.cellInput.setOnPrimedActivate(()=>{this.syncCellInputStyleForActiveCell()}),this.contextMenu=new an(t),this.autocomplete=new cn(t),this.functionBrowser=new un(t),this.resizeTooltip=document.createElement("div"),this.filterPanel=document.createElement("div"),this.rowDim=new at(S),this.colDim=new at(X),this.gridContainer.appendChild(this.overlay.getContainer()),this.gridContainer.appendChild(this.gridCanvas.getCanvas()),this.gridContainer.appendChild(this.cellInput.getContainer()),this.container.appendChild(this.formulaBar.getContainer()),this.container.appendChild(this.gridContainer.getContainer()),this.container.appendChild(this.contextMenu.getContainer()),this.container.appendChild(this.autocomplete.getContainer()),document.body.appendChild(this.functionBrowser.getContainer()),this.resizeTooltip.style.position="fixed",this.resizeTooltip.style.display="none",this.resizeTooltip.style.pointerEvents="none",this.resizeTooltip.style.zIndex="1001",this.resizeTooltip.style.padding="4px 8px",this.resizeTooltip.style.borderRadius="4px",this.resizeTooltip.style.border=`1px solid ${k(t,"cellBorderColor")}`,this.resizeTooltip.style.backgroundColor=k(t,"cellBGColor"),this.resizeTooltip.style.color=k(t,"cellTextColor"),this.resizeTooltip.style.fontSize="11px",this.resizeTooltip.style.fontFamily='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',this.resizeTooltip.style.boxShadow="0 2px 8px rgba(0, 0, 0, 0.15)",document.body.appendChild(this.resizeTooltip),this.filterPanel.style.position="fixed",this.filterPanel.style.display="none",this.filterPanel.style.zIndex="1002",this.filterPanel.style.width="260px",this.filterPanel.style.maxHeight="360px",this.filterPanel.style.overflow="hidden",this.filterPanel.style.borderRadius="6px",this.filterPanel.style.border=`1px solid ${k(t,"cellBorderColor")}`,this.filterPanel.style.backgroundColor=k(t,"cellBGColor"),this.filterPanel.style.color=k(t,"cellTextColor"),this.filterPanel.style.fontSize="12px",this.filterPanel.style.fontFamily='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',this.filterPanel.style.boxShadow="0 4px 14px rgba(0, 0, 0, 0.2)",document.body.appendChild(this.filterPanel),this.functionBrowser.setOnInsert(n=>{this.readOnly||this.insertFunctionFromBrowser(n.name)}),this.resizeObserver=new ResizeObserver(()=>this.render())}async initialize(e){this.sheet=e,this.sheet.setDimensions(this.rowDim,this.colDim),await this.sheet.loadDimensions(),await this.sheet.loadStyles(),await this.sheet.loadMerges(),await this.sheet.loadFreezePane(),await this.sheet.loadFilterState(),this.hiddenRows.clear(),this.hiddenRowSizeBackup.clear(),this.syncHiddenRowsFromSheet(),this.updateFreezeState(),this.formulaBar.initialize(e),this.addEventListeners(),this.resizeObserver.observe(this.container),this.render(),this.primeCellInputForSelection()}updateFreezeState(){const{frozenRows:e,frozenCols:t}=this.sheet.getFreezePane();this.freezeState=en(e,t,this.rowDim,this.colDim)}async setFreezePane(e,t){await this.sheet.setFreezePane(e,t),this.updateFreezeState(),this.render()}async reloadFreezePane(){await this.sheet.loadFreezePane(),this.updateFreezeState()}panBy(e,t){this.gridContainer.scrollBy(e,t)}handleMobileDoubleTap(e,t){const{x:s,y:n}=this.clampClientPointToViewport(e,t);this.handleDblClickAt(s,n)}async focusCell(e){await this.finishEditing(),this.focusGrid(),this.sheet.selectStart(e),this.render(),this.scrollIntoView(),this.primeCellInputForSelection()}cleanup(){this.pendingRenderFrame!==null&&(cancelAnimationFrame(this.pendingRenderFrame),this.pendingRenderFrame=null),this.cancelActiveInteractions(),this.removeAllEventListeners(),this.forceEndNativeSelectionBlock(),this.resizeObserver.disconnect(),this.formulaBar.cleanup(),this.cellInput.cleanup(),this.overlay.cleanup(),this.gridCanvas.cleanup(),this.gridContainer.cleanup(),this.contextMenu.cleanup(),this.autocomplete.cleanup(),this.functionBrowser.cleanup(),this.resizeTooltip.remove(),this.hideFilterPanel(),this.filterPanel.remove(),this.sheet=void 0,this.container.innerHTML=""}beginNativeSelectionBlock(){if(this.nativeSelectionBlockDepth+=1,this.nativeSelectionBlockDepth!==1)return;const e=document.body.style;this.previousBodyUserSelect=e.userSelect,this.previousBodyWebkitUserSelect=e.webkitUserSelect,e.userSelect="none",e.webkitUserSelect="none",document.addEventListener("selectstart",this.preventDocumentSelectStart)}endNativeSelectionBlock(){if(this.nativeSelectionBlockDepth===0||(this.nativeSelectionBlockDepth-=1,this.nativeSelectionBlockDepth>0))return;const e=document.body.style;e.userSelect=this.previousBodyUserSelect,e.webkitUserSelect=this.previousBodyWebkitUserSelect,document.removeEventListener("selectstart",this.preventDocumentSelectStart)}forceEndNativeSelectionBlock(){this.nativeSelectionBlockDepth!==0&&(this.nativeSelectionBlockDepth=1,this.endNativeSelectionBlock())}showResizeTooltip(e,t,s,n,i){const r=e==="column"?"Width":"Height",o=i>1?` (${i} ${e==="column"?"columns":"rows"})`:"";this.resizeTooltip.textContent=`${r}: ${Math.round(t)}px${o}`,this.resizeTooltip.style.left=`${s+12}px`,this.resizeTooltip.style.top=`${n+12}px`,this.resizeTooltip.style.display="block"}hideResizeTooltip(){this.resizeTooltip.style.display="none"}bindEventListener(e,t,s,n){e.addEventListener(t,s,n);let i=!0;return()=>{i&&(i=!1,e.removeEventListener(t,s,n))}}addEventListener(e,t,s,n){const i=this.bindEventListener(e,t,s,n);return this.listeners.push(i),i}registerInteractionCleanup(e){let t=!0;const s=()=>{t&&(t=!1,this.interactionCleanups.delete(s),e())};return this.interactionCleanups.add(s),s}addInteractionEventListener(e,t,s,n){const i=this.bindEventListener(e,t,s,n);return this.registerInteractionCleanup(i)}startMouseDragSession({onMove:e,onComplete:t,onCleanup:s}){let n=()=>{};const i=()=>{try{t==null||t()}finally{n()}},r=this.addInteractionEventListener(document,"mousemove",e),o=this.addInteractionEventListener(document,"mouseup",i);return n=this.registerInteractionCleanup(()=>{r(),o(),s==null||s()}),n}cancelActiveInteractions(){for(const e of Array.from(this.interactionCleanups))e()}removeAllEventListeners(){for(const e of this.listeners)e();this.listeners=[]}focusGrid(){var e;this.formulaBar.blur(),this.cellInput.hide(),this.autocomplete.hide(),this.functionBrowser.hide(),this.formulaRanges=[],this.resetFormulaRangeState(),(e=window.getSelection())==null||e.removeAllRanges()}async finishEditing(){this.autocomplete.hide(),this.functionBrowser.hide();const e=this.sheet.getActiveCell();let t=!1;if(this.formulaBar.isFocused())this.readOnly||(await this.sheet.setData(e,this.formulaBar.getValue()),t=!0),this.formulaBar.blur(),this.cellInput.hide();else if(this.cellInput.isFocused())this.cellInput.isPrimed()?this.cellInput.hide():(this.readOnly||(await this.sheet.setData(e,this.cellInput.getValue()),t=!0),this.cellInput.hide());else return;this.formulaRanges=[],this.resetFormulaRangeState(),t&&await this.autoResizeRow(e.r)}isExternalInput(e){if(this.functionBrowser.contains(e))return!0;if(!(e instanceof Element)||this.container.contains(e))return!1;const t=e.tagName;return!!(t==="INPUT"||t==="TEXTAREA"||t==="SELECT"||e.isContentEditable)}handleKeyDown(e){if(this.functionBrowser.isVisible()){e.key==="Escape"&&(e.preventDefault(),this.functionBrowser.hide());return}if(!this.isExternalInput(e.target)){if(this.formulaBar.isFocused()){this.handleFormulaKeydown(e);return}else if(this.cellInput.isFocused()){if(this.cellInput.isPrimed()){this.handleGridKeydown(e);return}this.handleCellInputKeydown(e);return}this.handleGridKeydown(e)}}handleDocumentCompositionStart(e){this.readOnly||this.functionBrowser.isVisible()||this.isExternalInput(e.target)||this.formulaBar.isFocused()||this.cellInput.isFocused()||this.showCellInput(!0,!1,!0)}handleKeyUp(e){if(this.functionBrowser.isVisible()||Ee(e)||this.formulaBar.isComposing()||this.cellInput.isComposing()||this.isExternalInput(e.target))return;const s=(e.key==="ArrowDown"||e.key==="ArrowUp"||e.key==="Escape"||e.key==="Enter"||e.key==="Tab")&&(this.autocomplete.isListVisible()||this.autocomplete.isHintVisible());let n,i;this.formulaBar.isFocused()?(n=this.formulaBar.getValue(),i=this.formulaBar.getFormulaInput(),this.cellInput.setValue(n)):this.cellInput.isFocused()&&!this.cellInput.isPrimed()&&(n=this.cellInput.getValue(),i=this.cellInput.getInput(),this.formulaBar.setValue(n)),n!==void 0&&n.startsWith("=")?(this.formulaRanges=ye(n).map(r=>r.range),this.renderOverlay()):n!==void 0&&(this.formulaRanges=[],this.renderOverlay()),!s&&(i&&n!==void 0?this.updateAutocomplete(n,i):this.autocomplete.hide())}updateAutocomplete(e,t){if(!e.startsWith("=")){this.autocomplete.hide();return}const s=J(t);if(!s){this.autocomplete.hide();return}const n=s.end,i=hn(e,n),r=t.getBoundingClientRect(),o={left:r.left,top:r.bottom+2};i.type==="function-name"?this.autocomplete.showList(i.prefix,o):i.type==="argument"?this.autocomplete.showHint(i.funcName,i.argIndex,o):this.autocomplete.hide()}toggleFunctionBrowser(){if(this.functionBrowser.isVisible()){this.functionBrowser.hide();return}this.autocomplete.hide(),this.functionBrowser.show()}insertFunctionCompletion(e,t){const s=t.innerText,n=J(t);if(!n)return;const i=n.end,o=s.slice(0,i).match(/([A-Za-z_]\w*)$/);if(!o)return;const a=i-o[1].length,h=s.slice(i),c=s.slice(0,a)+e+"("+h;this.formulaBar.setValue(c),this.cellInput.setValue(c);const u=a+e.length+1;ne(t,{start:u,end:u}),this.autocomplete.hide(),this.updateAutocomplete(c,t)}async insertFunctionFromBrowser(e){const t=await this.getInputForFunctionInsert(),s=t.innerText,n=J(t);let i,r;if(!s.startsWith("="))i=`=${e}(`,r=i.length;else{const o=(n==null?void 0:n.start)??s.length,a=(n==null?void 0:n.end)??s.length;i=s.slice(0,o)+e+"("+s.slice(a),r=o+e.length+1}this.formulaBar.setValue(i),this.cellInput.setValue(i),ne(t,{start:r,end:r}),t.focus(),this.formulaRanges=ye(i).map(o=>o.range),this.renderOverlay(),this.autocomplete.hide(),this.updateAutocomplete(i,t)}async getInputForFunctionInsert(){if(this.cellInput.isFocused())return this.cellInput.getInput();const e=this.cellInput.getInput(),t=this.formulaBar.getFormulaInput(),s=t.innerText,n=J(t);this.cellInput.isShown()||await this.showCellInput(!0,!0),this.cellInput.setValue(s);const i=(n==null?void 0:n.end)??s.length;return ne(e,{start:i,end:i}),this.cellInput.isFocused()||e.focus(),e}isInFormulaRangeMode(){let e,t;if(this.cellInput.isFocused()?(e=this.cellInput.getValue(),t=this.cellInput.getInput()):this.formulaBar.isFocused()&&(e=this.formulaBar.getValue(),t=this.formulaBar.getFormulaInput()),!e||!t||!e.startsWith("="))return!1;const s=J(t);return s?es(e,s.end):!1}insertReferenceAtCursor(e,t){const s=this.cellInput.isFocused(),n=this.formulaBar.isFocused();if(!s&&!n)return;const i=s?this.cellInput.getInput():this.formulaBar.getFormulaInput(),r=i.innerText,o=J(i);if(!o)return;const a=t&&(e.r!==t.r||e.c!==t.c)?M(e)+":"+M(t):M(e);let h,c;if(this.formulaRefInsertPos){const{start:u,end:d}=this.formulaRefInsertPos;h=r.slice(0,u)+a+r.slice(d),c=u+a.length,this.formulaRefInsertPos={start:u,end:c}}else{const u=Je(r,o.end);u?(h=r.slice(0,u.start)+a+r.slice(u.end),c=u.start+a.length,this.formulaRefInsertPos={start:u.start,end:c}):o.start!==o.end?(h=r.slice(0,o.start)+a+r.slice(o.end),c=o.start+a.length,this.formulaRefInsertPos={start:o.start,end:c}):(h=r.slice(0,o.end)+a+r.slice(o.end),c=o.end+a.length,this.formulaRefInsertPos={start:o.end,end:c})}this.formulaBar.setValue(h),this.cellInput.setValue(h),ne(i,{start:c,end:c}),h.startsWith("=")&&(this.formulaRanges=ye(h).map(u=>u.range),this.renderOverlay()),this.lastFormulaRefTarget=t||e}toggleAbsoluteReference(e){const t=e.innerText;if(!t.startsWith("="))return;const s=J(e);if(!s)return;const n=Je(t,s.end);if(!n)return;const i=n.text,r=i.startsWith("$"),o=i.replace(/\$/g,"");let a=0;for(let v=0;v<o.length;v++)if(o.charCodeAt(v)>=48&&o.charCodeAt(v)<=57){a=v;break}const h=o.slice(0,a),c=o.slice(a),u=i.indexOf(c,i.lastIndexOf(h)+h.length),d=u>0&&i[u-1]==="$";let f;!r&&!d?f="$"+h+"$"+c:r&&d?f=h+"$"+c:!r&&d?f="$"+h+c:f=h+c;const C=t.slice(0,n.start)+f+t.slice(n.end),y=n.start+f.length;this.formulaBar.setValue(C),this.cellInput.setValue(C),ne(e,{start:y,end:y}),C.startsWith("=")&&(this.formulaRanges=ye(C).map(v=>v.range),this.renderOverlay())}resetFormulaRangeState(){this.formulaRangeAnchor=null,this.activeFormulaInput=null,this.formulaRefInsertPos=null,this.lastFormulaRefTarget=null}handleDblClick(e){e.preventDefault(),this.handleDblClickAt(e.offsetX,e.offsetY)}handleDblClickAt(e,t){if(this.readOnly)return;const s=this.detectFreezeHandle(e,t);if(s){const i=this.sheet.getFreezePane();s==="row"?this.setFreezePane(i.frozenRows>0?0:1,i.frozenCols):this.setFreezePane(i.frozenRows,i.frozenCols>0?0:1);return}const n=this.detectResizeEdge(e,t);if(n){this.autoFitSize(n.axis,n.index);return}this.showCellInput()}handleContextMenu(e){if(this.readOnly)return;const t=e.offsetX,s=e.offsetY,n=t<R,i=s<S;if(!(!n&&!i)){if(e.preventDefault(),n){const r=this.toRowFromMouse(s);if(r<1)return;const o=this.sheet.getSelectedIndices(),a=o&&o.axis==="row"&&r>=o.from&&r<=o.to,h=a?o.from:r,c=a?o.to-o.from+1:1,u=c>1?`${c} rows`:"row";this.contextMenu.show(e.clientX,e.clientY,[{label:`Insert ${u} above`,action:()=>{this.sheet.insertRows(h,c).then(()=>this.render())}},{label:`Insert ${u} below`,action:()=>{this.sheet.insertRows(h+c,c).then(()=>this.render())}},{label:`Delete ${u}`,action:()=>{this.sheet.deleteRows(h,c).then(()=>this.render())}}])}else if(i){const r=this.toColFromMouse(t);if(r<1)return;const o=this.sheet.getSelectedIndices(),a=o&&o.axis==="column"&&r>=o.from&&r<=o.to,h=a?o.from:r,c=a?o.to-o.from+1:1,u=c>1?`${c} columns`:"column",d=[{label:`Insert ${u} left`,action:()=>{this.sheet.insertColumns(h,c).then(()=>this.render())}},{label:`Insert ${u} right`,action:()=>{this.sheet.insertColumns(h+c,c).then(()=>this.render())}},{label:`Delete ${u}`,action:()=>{this.sheet.deleteColumns(h,c).then(()=>this.render())}}];this.contextMenu.show(e.clientX,e.clientY,d)}}}getFilterButtonRect(e){var o;const t=(o=this.sheet)==null?void 0:o.getFilterRange();if(!t)return null;const s=t[0].r,n=this.getCellRect({r:s,c:e});if(n.width<=6||n.height<=6)return null;const i=Math.min(16,Math.max(12,n.width-4)),r=Math.min(16,Math.max(12,n.height-6));return{left:n.left+n.width-i-2,top:n.top+Math.max(3,(n.height-r)/2),width:i,height:r}}detectFilterButton(e,t){if(!this.sheet||!this.sheet.hasFilter()||e<=R||t<=S)return null;const s=this.sheet.getFilterRange();if(!s)return null;const n=this.toRefFromMouse(e,t);if(n.r!==s[0].r||!this.sheet.isColumnInFilter(n.c))return null;const i=this.getFilterButtonRect(n.c);return!i||e<i.left-2||e>i.left+i.width+2||t<i.top-2||t>i.top+i.height+2?null:n.c}async showFilterPanel(e,t){var C,y;if(!this.sheet||!this.sheet.isColumnInFilter(e))return;const s=await this.sheet.getFilterColumnValues(e);if(!s)return;const n=this.sheet.getColumnFilterCondition(e),i=n&&n.op!=="in"&&n.op!=="isEmpty"&&n.op!=="isNotEmpty",r=t==="condition"||i?"condition":"values",o=n?{...n,values:n.values?[...n.values]:void 0}:{op:"contains",value:""};this.filterPanelState={col:e,values:s.values,selected:new Set(s.selected),initialSelected:new Set(s.selected),search:"",mode:r,condition:{...o,values:o.values?[...o.values]:void 0},initialCondition:o,hasExistingCondition:!!n},this.renderFilterPanel();const a=this.getFilterButtonRect(e);if(!a)return;const h=this.viewport,u=Math.min(h.left+Math.max(R,a.left-6),h.left+Math.max(0,h.width-260-4)),d=h.top+a.top+a.height+4;this.filterPanel.style.left=`${u}px`,this.filterPanel.style.top=`${d}px`,this.filterPanel.style.display="block",(C=this.filterPanelKeyboardUnsub)==null||C.call(this);const f=v=>{if(!this.filterPanelState)return;const x=v.target,E=x?this.filterPanel.contains(x):!1;if(v.key==="Escape"){v.preventDefault(),v.stopPropagation(),this.hideFilterPanel();return}v.key==="Enter"&&E&&(v.preventDefault(),v.stopPropagation(),this.applyFilterPanel())};document.addEventListener("keydown",f,!0),this.filterPanelKeyboardUnsub=()=>{document.removeEventListener("keydown",f,!0)},(y=this.filterPanelOutsideClickUnsub)==null||y.call(this),requestAnimationFrame(()=>{if(!this.filterPanelState)return;const v=x=>{this.filterPanel.contains(x.target)||this.hideFilterPanel()};document.addEventListener("mousedown",v),this.filterPanelOutsideClickUnsub=()=>{document.removeEventListener("mousedown",v)}})}hideFilterPanel(){var e,t;this.filterPanel.style.display="none",this.filterPanel.innerHTML="",this.filterPanelState=null,(e=this.filterPanelOutsideClickUnsub)==null||e.call(this),this.filterPanelOutsideClickUnsub=null,(t=this.filterPanelKeyboardUnsub)==null||t.call(this),this.filterPanelKeyboardUnsub=null}areStringSetsEqual(e,t){if(e.size!==t.size)return!1;for(const s of e)if(!t.has(s))return!1;return!0}areFilterConditionsEqual(e,t){if(e.op!==t.op)return!1;if(e.op==="in"){const s=Array.from(new Set(e.values||[])).sort(),n=Array.from(new Set(t.values||[])).sort();if(s.length!==n.length)return!1;for(let i=0;i<s.length;i++)if(s[i]!==n[i])return!1;return!0}return e.op==="isEmpty"||e.op==="isNotEmpty"?!0:(e.value||"").trim()===(t.value||"").trim()}isFilterPanelDirty(e){return e.mode==="values"?!this.areStringSetsEqual(e.selected,e.initialSelected):!this.areFilterConditionsEqual(e.condition,e.initialCondition)}async applyFilterPanel(){const e=this.filterPanelState;if(!(!e||!this.sheet)&&this.isFilterPanelDirty(e)){if(e.mode==="values"){await this.sheet.setColumnIncludedValues(e.col,Array.from(e.selected)),this.hideFilterPanel(),this.render();return}await this.sheet.setColumnFilter(e.col,e.condition),this.hideFilterPanel(),this.render()}}syncFilterPanelApplyButtonState(){const e=this.filterPanelState;if(!e)return;const t=this.filterPanel.querySelector('button[data-wb-filter-apply="true"]');if(!t)return;const s=this.isFilterPanelDirty(e);t.disabled=!s,t.style.opacity=s?"1":"0.5",t.style.cursor=s?"pointer":"not-allowed"}syncFilterPanelValuesSelectionState(e){const t=this.filterPanelState;if(!t)return;const s=this.filterPanel.querySelector('[data-wb-filter-summary="true"]');if(s){const i=t.values.filter(r=>t.selected.has(r)).length;s.textContent=`Selected ${i} / ${t.values.length}`}const n=this.filterPanel.querySelector('input[data-wb-filter-select-all="true"]');if(n){const i=e.filter(r=>t.selected.has(r)).length;n.checked=e.length>0&&i===e.length,n.indeterminate=i>0&&i<e.length}this.syncFilterPanelApplyButtonState()}renderFilterPanel(){var b;const e=this.filterPanelState;if(!e)return;const t=document.activeElement,s=t instanceof HTMLInputElement&&t.dataset.wbFilterSearch==="true",n=s?t.selectionStart:null,i=s?t.selectionEnd:null,r=k(this.theme,"cellBorderColor"),o=k(this.theme,"selectionBGColor"),a=g=>{const w=document.createElement("button");return w.type="button",w.textContent=g,w.style.height="26px",w.style.padding="0 8px",w.style.border=`1px solid ${r}`,w.style.borderRadius="4px",w.style.background="transparent",w.style.color="inherit",w.style.cursor="pointer",w};this.filterPanel.innerHTML="";const h=document.createElement("div");h.style.display="flex",h.style.flexDirection="column",h.style.maxHeight="360px",h.style.height=e.mode==="values"?"360px":"auto",h.style.overflow="hidden";const c=document.createElement("div");c.style.padding="8px 10px",c.style.borderBottom=`1px solid ${r}`,c.style.fontWeight="600",c.textContent=`Filter ${fe(e.col)}`,h.appendChild(c);const u=document.createElement("div");u.textContent="Sort",u.style.padding="8px 10px 4px",u.style.fontSize="11px",u.style.opacity="0.7",h.appendChild(u);const d=document.createElement("div");d.style.display="flex",d.style.flexWrap="wrap",d.style.gap="6px",d.style.padding="8px 10px 6px";const f=a("Sort A to Z");f.onclick=()=>{this.sheet.sortFilterByColumn(e.col,"asc").then(g=>{g&&(this.hideFilterPanel(),this.render())})};const C=a("Sort Z to A");C.onclick=()=>{this.sheet.sortFilterByColumn(e.col,"desc").then(g=>{g&&(this.hideFilterPanel(),this.render())})},d.append(f,C),h.appendChild(d);const y=document.createElement("div");y.textContent="Filter",y.style.padding="0 10px 4px",y.style.fontSize="11px",y.style.opacity="0.7",h.appendChild(y);const v=document.createElement("div");v.style.display="flex",v.style.flexWrap="wrap",v.style.gap="6px",v.style.padding="0 10px 8px";const x=(g,w)=>{const B=a(g);return e.mode===w&&(B.style.background=o),B.onclick=()=>{this.filterPanelState&&(this.filterPanelState.mode=w,this.renderFilterPanel())},B};v.append(x("Filter by values","values"),x("Filter by condition","condition")),h.appendChild(v);const E=document.createElement("div");if(E.style.flex="1",E.style.minHeight="0",E.style.padding="0 10px",E.style.display="flex",E.style.flexDirection="column",h.appendChild(E),e.mode==="values"){const g=document.createElement("input");g.type="text",g.dataset.wbFilterSearch="true",g.value=e.search,g.placeholder="Search values",g.style.width="100%",g.style.margin="0 0 8px",g.style.height="28px",g.style.padding="0 8px",g.style.border=`1px solid ${r}`,g.style.borderRadius="4px",g.style.background="transparent",g.style.color="inherit",g.oninput=()=>{this.filterPanelState&&(this.filterPanelState.search=g.value,this.renderFilterPanel())},E.appendChild(g);const w=e.values,B=w.filter(V=>e.selected.has(V)).length,I=document.createElement("div");I.dataset.wbFilterSummary="true",I.textContent=`Selected ${B} / ${w.length}`,I.style.margin="0 0 8px",I.style.fontSize="11px",I.style.opacity="0.7",E.appendChild(I);const O=e.search.trim().toLowerCase(),T=w.filter(V=>O?(V===""?"(Blanks)":V).toLowerCase().includes(O):!0).slice(0,pn),L=document.createElement("div");L.style.flex="1",L.style.minHeight="0",L.style.border=`1px solid ${r}`,L.style.borderRadius="4px",L.style.overflow="auto";const W=T.filter(V=>e.selected.has(V)).length,$=document.createElement("label");$.style.display="flex",$.style.alignItems="center",$.style.gap="8px",$.style.padding="6px 8px",$.style.borderBottom=`1px solid ${r}`,$.style.cursor="pointer";const K=document.createElement("input");K.type="checkbox",K.dataset.wbFilterSelectAll="true",K.checked=T.length>0&&W===T.length,K.indeterminate=W>0&&W<T.length,K.onchange=()=>{if(this.filterPanelState){if(K.checked)for(const V of T)this.filterPanelState.selected.add(V);else for(const V of T)this.filterPanelState.selected.delete(V);this.renderFilterPanel()}};const he=document.createElement("span");if(he.textContent="Select all",$.append(K,he),L.appendChild($),T.length===0){const V=document.createElement("div");V.style.padding="10px",V.style.opacity="0.7",V.textContent="No values",L.appendChild(V)}else for(const V of T){const Y=document.createElement("label");Y.style.display="flex",Y.style.alignItems="center",Y.style.gap="8px",Y.style.padding="6px 8px",Y.style.cursor="pointer";const ge=document.createElement("input");ge.type="checkbox",ge.checked=e.selected.has(V),ge.onchange=()=>{this.filterPanelState&&(ge.checked?this.filterPanelState.selected.add(V):this.filterPanelState.selected.delete(V),this.syncFilterPanelValuesSelectionState(T))};const me=document.createElement("span");me.textContent=V===""?"(Blanks)":V,me.style.overflow="hidden",me.style.textOverflow="ellipsis",me.style.whiteSpace="nowrap",Y.append(ge,me),L.appendChild(Y)}E.appendChild(L)}else{const g=document.createElement("div");g.style.display="grid",g.style.gap="8px";const w=document.createElement("select");w.style.height="30px",w.style.border=`1px solid ${r}`,w.style.borderRadius="4px",w.style.background="transparent",w.style.color="inherit";const B=[{value:"contains",label:"Contains"},{value:"notContains",label:"Does not contain"},{value:"equals",label:"Equals"},{value:"notEquals",label:"Does not equal"},{value:"isEmpty",label:"Is empty"},{value:"isNotEmpty",label:"Is not empty"}],I=e.condition.op==="in"?"contains":e.condition.op;for(const T of B){const L=document.createElement("option");L.value=T.value,L.textContent=T.label,L.selected=I===T.value,w.appendChild(L)}if(w.onchange=()=>{if(!this.filterPanelState)return;const T=w.value;this.filterPanelState.condition={op:T,value:this.filterPanelState.condition.value||""},this.renderFilterPanel()},g.appendChild(w),I!=="isEmpty"&&I!=="isNotEmpty"){const T=document.createElement("input");T.type="text",T.value=((b=this.filterPanelState)==null?void 0:b.condition.value)||"",T.placeholder="Enter value",T.style.height="30px",T.style.padding="0 8px",T.style.border=`1px solid ${r}`,T.style.borderRadius="4px",T.style.background="transparent",T.style.color="inherit",T.oninput=()=>{this.filterPanelState&&(this.filterPanelState.condition={...this.filterPanelState.condition,value:T.value},this.syncFilterPanelApplyButtonState())},g.appendChild(T)}E.appendChild(g)}const m=document.createElement("div");m.style.display="flex",m.style.justifyContent="flex-end",m.style.gap="6px",m.style.padding="8px 10px";const z=g=>{g.disabled=!0,g.style.opacity="0.5",g.style.cursor="not-allowed"},F=a("Clear");F.onclick=()=>{this.sheet.clearColumnFilter(e.col).then(()=>{this.hideFilterPanel(),this.render()})},e.hasExistingCondition||z(F);const P=a("Cancel");P.onclick=()=>this.hideFilterPanel();const A=a("Apply");if(A.dataset.wbFilterApply="true",A.onclick=()=>{this.applyFilterPanel()},this.isFilterPanelDirty(e)||z(A),m.append(F,P,A),h.appendChild(m),this.filterPanel.appendChild(h),s&&e.mode==="values"){const g=this.filterPanel.querySelector('input[data-wb-filter-search="true"]');if(g){g.focus();const w=g.value.length,B=Math.max(0,Math.min(w,n??w)),I=Math.max(B,Math.min(w,i??B));g.setSelectionRange(B,I)}}}addEventListeners(){const e=this.gridContainer.getScrollContainer();this.addEventListener(window,"resize",()=>{this.updateCellInputPosition(),this.render()}),this.addEventListener(e,"scroll",()=>{this.hideFilterPanel(),this.updateCellInputPosition(),this.render()}),this.addEventListener(e,"mousedown",t=>{this.handleMouseDown(t)}),this.addEventListener(e,"mousemove",t=>{this.handleMouseMove(t)}),this.addEventListener(e,"mouseleave",()=>{this.handleScrollContainerMouseLeave()}),this.addEventListener(e,"dblclick",t=>{this.handleDblClick(t)}),this.addEventListener(e,"contextmenu",t=>{this.handleContextMenu(t)}),this.addEventListener(document,"keydown",t=>{this.handleKeyDown(t)}),this.addEventListener(document,"keyup",t=>{this.handleKeyUp(t)}),this.addEventListener(document,"compositionstart",t=>{this.handleDocumentCompositionStart(t)})}detectResizeEdge(e,t){const s=this.scroll,n=this.freezeState;if(t<S&&e>R){const r=n.frozenCols>0&&e<R+n.frozenWidth?e-R:e-R-n.frozenWidth+this.colDim.getOffset(n.frozenCols+1)+s.left,o=this.colDim.findIndex(r),a=this.colDim.getOffset(o)+this.colDim.getSize(o);if(Math.abs(r-a)<Te)return{axis:"column",index:o};if(o>1){const h=this.colDim.getOffset(o-1)+this.colDim.getSize(o-1);if(Math.abs(r-h)<Te)return{axis:"column",index:o-1}}}if(e<R&&t>S){const r=n.frozenRows>0&&t<S+n.frozenHeight?t-S:t-S-n.frozenHeight+this.rowDim.getOffset(n.frozenRows+1)+s.top,o=this.rowDim.findIndex(r),a=this.rowDim.getOffset(o)+this.rowDim.getSize(o);if(Math.abs(r-a)<Te)return{axis:"row",index:o};if(o>1){const h=this.rowDim.getOffset(o-1)+this.rowDim.getSize(o-1);if(Math.abs(r-h)<Te)return{axis:"row",index:o-1}}}return null}detectFreezeHandle(e,t){const s=this.freezeState,n=s.frozenRows>0||s.frozenCols>0,i=Yt,r=Js,o=n&&s.frozenRows>0?S+s.frozenHeight-i/2:S-i;if(e>=0&&e<=R&&t>=o-r&&t<=o+i+r)return"row";const a=n&&s.frozenCols>0?R+s.frozenWidth-i/2:R-i;return e>=a-r&&e<=a+i+r&&t>=0&&t<=S?"column":null}startFreezeDrag(e,t){const s=this.gridContainer.getScrollContainer();s.style.cursor="grabbing";const n=r=>{const o=this.viewport;if(e==="row"){const a=r.target!==s?Math.max(0,Math.min(o.height,r.clientY-o.top)):r.offsetY;if(a<=S)return 0;const h=a-S,c=this.rowDim.findIndex(h),d=this.rowDim.getOffset(c)+this.rowDim.getSize(c)/2;return h<d?Math.max(0,c-1):c}else{const a=r.target!==s?Math.max(0,Math.min(o.width,r.clientX-o.left)):r.offsetX;if(a<=R)return 0;const h=a-R,c=this.colDim.findIndex(h),d=this.colDim.getOffset(c)+this.colDim.getSize(c)/2;return h<d?Math.max(0,c-1):c}};this.freezeDrag={axis:e,targetIndex:n(t)},this.renderOverlay();const i=r=>{const o=n(r);this.freezeDrag&&this.freezeDrag.targetIndex!==o&&(this.freezeDrag={axis:e,targetIndex:o},this.renderOverlay())};this.startMouseDragSession({onMove:i,onComplete:()=>{var a;const r=((a=this.freezeDrag)==null?void 0:a.targetIndex)??0,o=this.sheet.getFreezePane();e==="row"?this.setFreezePane(r,o.frozenCols):this.setFreezePane(o.frozenRows,r)},onCleanup:()=>{s.style.cursor="",this.freezeDrag=null,this.freezeHandleHover=null,this.renderOverlay()}})}toRefFromMouse(e,t){const s=this.freezeState;return s.frozenRows>0||s.frozenCols>0?sn(e,t,this.scroll,this.rowDim,this.colDim,s):tn(e+this.scroll.left,t+this.scroll.top,this.rowDim,this.colDim)}toRowFromMouse(e){const t=this.freezeState,n=t.frozenRows>0&&e<S+t.frozenHeight?e-S:e-S-t.frozenHeight+this.rowDim.getOffset(t.frozenRows+1)+this.scroll.top;return this.rowDim.findIndex(n)}toColFromMouse(e){const t=this.freezeState,n=t.frozenCols>0&&e<R+t.frozenWidth?e-R:e-R-t.frozenWidth+this.colDim.getOffset(t.frozenCols+1)+this.scroll.left;return this.colDim.findIndex(n)}getAutofillSelectionRect(e){if(!this.sheet||this.sheet.getSelectionType()!=="cell")return;const t=e||this.sheet.getRangeOrActiveCell(),s=be(t[0],this.scroll,this.rowDim,this.colDim,this.freezeState),n=be(t[1],this.scroll,this.rowDim,this.colDim,this.freezeState),i=Math.min(s.left,n.left),r=Math.min(s.top,n.top),o=Math.max(s.left+s.width,n.left+n.width),a=Math.max(s.top+s.height,n.top+n.height);return{left:i,top:r,width:o-i,height:a-r}}detectAutofillHandle(e,t){if(this.readOnly||!this.sheet||this.sheet.getSelectionType()!=="cell")return!1;const s=this.sheet.getRangeOrActiveCell(),n=this.getAutofillSelectionRect(s);if(!n||this.isAutofillHandleHiddenByFreeze(s,n))return!1;const i=n.left+n.width-ce/2,r=n.top+n.height-ce/2;return e>=i-Be&&e<=i+ce+Be&&t>=r-Be&&t<=r+ce+Be}shouldShowAutofillHandle(){if(this.readOnly||!this.sheet||this.sheet.getSelectionType()!=="cell")return!1;const e=this.sheet.getRangeOrActiveCell(),t=this.getAutofillSelectionRect(e);return t?!this.isAutofillHandleHiddenByFreeze(e,t):!1}isAutofillHandleHiddenByFreeze(e,t){const s=this.freezeState;if(s.frozenRows===0&&s.frozenCols===0)return!1;const n=Math.max(e[0].r,e[1].r),i=Math.max(e[0].c,e[1].c);if(!(n>s.frozenRows&&i>s.frozenCols))return!1;const o=t.left+t.width-ce/2,a=t.top+t.height-ce/2,h=R+s.frozenWidth,c=S+s.frozenHeight;return o<h||a<c}clampClientPointToViewport(e,t){const s=this.viewport;return{x:Math.max(0,Math.min(s.width,e-s.left)),y:Math.max(0,Math.min(s.height,t-s.top))}}getAutoScrollSpeed(e){const s=Math.min(St,Math.max(0,e))/St;return Rt+(fn-Rt)*s}getAutoScrollVelocity(e,t,s){return e<t?-this.getAutoScrollSpeed(t-e):e>s?this.getAutoScrollSpeed(e-s):0}handleMouseMove(e){var r,o,a;const t=this.gridContainer.getScrollContainer();if((e.buttons&1)===1){this.resizeHover&&(this.resizeHover=null,this.renderOverlay());return}const s=this.detectFreezeHandle(e.offsetX,e.offsetY);if(s!==this.freezeHandleHover&&(this.freezeHandleHover=s,this.render()),s){t.style.cursor="grab",this.setFilterButtonHoverCol(null),this.resizeHover&&(this.resizeHover=null,this.renderOverlay());return}const n=this.detectResizeEdge(e.offsetX,e.offsetY),i=(n==null?void 0:n.axis)!==((r=this.resizeHover)==null?void 0:r.axis)||(n==null?void 0:n.index)!==((o=this.resizeHover)==null?void 0:o.index);if(i&&(this.resizeHover=n),n)t.style.cursor=n.axis==="column"?"col-resize":"row-resize",this.setFilterButtonHoverCol(null);else{if(this.detectAutofillHandle(e.offsetX,e.offsetY)){t.style.cursor="crosshair",this.setFilterButtonHoverCol(null),i&&this.renderOverlay();return}const h=e.offsetX,c=e.offsetY,u=this.detectFilterButton(h,c);if(u!==null){t.style.cursor="pointer",this.setFilterButtonHoverCol(u),i&&this.renderOverlay();return}this.setFilterButtonHoverCol(null);const d=(a=this.sheet)==null?void 0:a.getSelectedIndices();if(d){const f=d.axis==="column"?c<S&&h>R&&(()=>{const C=this.toColFromMouse(h);return C>=d.from&&C<=d.to})():h<R&&c>S&&(()=>{const C=this.toRowFromMouse(c);return C>=d.from&&C<=d.to})();t.style.cursor=f?"grab":""}else t.style.cursor=""}i&&this.renderOverlay()}handleScrollContainerMouseLeave(){const e=this.gridContainer.getScrollContainer();e.style.cursor="";const t=this.filterButtonHoverCol!==null||this.resizeHover!==null||this.freezeHandleHover!==null;this.filterButtonHoverCol=null,this.resizeHover=null,this.freezeHandleHover=null,t&&this.render()}setFilterButtonHoverCol(e){this.filterButtonHoverCol!==e&&(this.filterButtonHoverCol=e,this.render())}async handleMouseDown(e){const t=this.detectFreezeHandle(e.offsetX,e.offsetY);if(t&&!this.readOnly){e.preventDefault(),this.startFreezeDrag(t,e);return}const s=this.detectResizeEdge(e.offsetX,e.offsetY);if(s&&!this.readOnly){e.preventDefault(),this.startResize(s.axis,s.index,e);return}const n=e.offsetX,i=e.offsetY,r=this.detectFilterButton(n,i);if(r!==null){e.preventDefault(),await this.finishEditing(),await this.showFilterPanel(r);return}if(n<R&&i<S){e.preventDefault(),await this.finishEditing(),this.sheet.selectAllCells(),this.render();return}const a=i<S&&n>R,h=n<R&&i>S;if(a){e.preventDefault(),await this.finishEditing();const m=this.toColFromMouse(n);if(m<1)return;if(e.shiftKey){this.sheet.selectColumnRange(this.sheet.getActiveCell().c,m),this.render();return}const z=this.sheet.getSelectedIndices();if(!this.readOnly&&z&&z.axis==="column"&&m>=z.from&&m<=z.to){this.startDragMove("column",z.from,z.to-z.from+1,e);return}this.sheet.selectColumn(m),this.render();const F=m;let P=m,A=e.clientX,b=null,g=null;const w=()=>{const{x:L}=this.clampClientPointToViewport(A,0),W=this.toColFromMouse(L);W>=1&&W!==P&&(P=W,this.sheet.selectColumnRange(F,P))},B=()=>{b!==null&&(cancelAnimationFrame(b),b=null),g=null},I=L=>{const W=this.viewport,$=this.getAutoScrollVelocity(A,W.left,W.left+W.width);if($===0){b=null,g=null;return}const K=Math.min(50,g===null?16:L-g);g=L,this.gridContainer.scrollBy($*K/1e3,0),w(),this.render(),b=requestAnimationFrame(I)},O=()=>{b===null&&(b=requestAnimationFrame(I))},T=L=>{A=L.clientX,w(),this.render();const W=this.viewport;this.getAutoScrollVelocity(A,W.left,W.left+W.width)===0?B():O()};this.beginNativeSelectionBlock(),this.startMouseDragSession({onMove:T,onCleanup:()=>{B(),this.endNativeSelectionBlock()}});return}if(h){e.preventDefault(),await this.finishEditing();const m=this.toRowFromMouse(i);if(m<1)return;if(e.shiftKey){this.sheet.selectRowRange(this.sheet.getActiveCell().r,m),this.render();return}const z=this.sheet.getSelectedIndices();if(!this.readOnly&&z&&z.axis==="row"&&m>=z.from&&m<=z.to){this.startDragMove("row",z.from,z.to-z.from+1,e);return}this.sheet.selectRow(m),this.render();const F=m;let P=m,A=e.clientY,b=null,g=null;const w=()=>{const{y:L}=this.clampClientPointToViewport(0,A),W=this.toRowFromMouse(L);W>=1&&W!==P&&(P=W,this.sheet.selectRowRange(F,P))},B=()=>{b!==null&&(cancelAnimationFrame(b),b=null),g=null},I=L=>{const W=this.viewport,$=this.getAutoScrollVelocity(A,W.top,W.top+W.height);if($===0){b=null,g=null;return}const K=Math.min(50,g===null?16:L-g);g=L,this.gridContainer.scrollBy(0,$*K/1e3),w(),this.render(),b=requestAnimationFrame(I)},O=()=>{b===null&&(b=requestAnimationFrame(I))},T=L=>{A=L.clientY,w(),this.render();const W=this.viewport;this.getAutoScrollVelocity(A,W.top,W.top+W.height)===0?B():O()};this.beginNativeSelectionBlock(),this.startMouseDragSession({onMove:T,onCleanup:()=>{B(),this.endNativeSelectionBlock()}});return}if(this.isInFormulaRangeMode()){e.preventDefault();const m=this.toRefFromMouse(e.offsetX,e.offsetY);if(this.activeFormulaInput=this.cellInput.isFocused()?"cellInput":"formulaBar",e.shiftKey&&this.formulaRangeAnchor){const P={r:Math.min(this.formulaRangeAnchor.r,m.r),c:Math.min(this.formulaRangeAnchor.c,m.c)},A={r:Math.max(this.formulaRangeAnchor.r,m.r),c:Math.max(this.formulaRangeAnchor.c,m.c)};this.insertReferenceAtCursor(P,A)}else this.formulaRangeAnchor=m,this.formulaRefInsertPos=null,this.insertReferenceAtCursor(m);const z=this.gridContainer.getScrollContainer(),F=P=>{const A=this.viewport,b=P.target!==z?Math.max(0,Math.min(A.width,P.clientX-A.left)):P.offsetX,g=P.target!==z?Math.max(0,Math.min(A.height,P.clientY-A.top)):P.offsetY,w=this.toRefFromMouse(b,g),B={r:Math.min(this.formulaRangeAnchor.r,w.r),c:Math.min(this.formulaRangeAnchor.c,w.c)},I={r:Math.max(this.formulaRangeAnchor.r,w.r),c:Math.max(this.formulaRangeAnchor.c,w.c)};this.insertReferenceAtCursor(B,I)};this.beginNativeSelectionBlock(),this.startMouseDragSession({onMove:F,onComplete:()=>{this.scrollIntoView(),this.updateCellInputPosition(),this.activeFormulaInput==="cellInput"?this.cellInput.getInput().focus():this.activeFormulaInput==="formulaBar"&&this.formulaBar.getFormulaInput().focus()},onCleanup:()=>{this.endNativeSelectionBlock(),this.formulaRefInsertPos=null}});return}if(this.detectAutofillHandle(e.offsetX,e.offsetY)){e.preventDefault(),await this.finishEditing(),this.startAutofillDrag(e);return}if(await this.finishEditing(),e.shiftKey){const m=this.toRefFromMouse(e.offsetX,e.offsetY);this.sheet.selectEnd(m),this.render();return}this.sheet.selectStart(this.toRefFromMouse(e.offsetX,e.offsetY)),this.render();let c=e.clientX,u=e.clientY,d=null,f=null;const C=()=>{const{x:m,y:z}=this.clampClientPointToViewport(c,u);this.sheet.selectEnd(this.toRefFromMouse(m,z))},y=()=>{d!==null&&(cancelAnimationFrame(d),d=null),f=null},v=m=>{const z=this.viewport,F=this.getAutoScrollVelocity(c,z.left,z.left+z.width),P=this.getAutoScrollVelocity(u,z.top,z.top+z.height);if(F===0&&P===0){d=null,f=null;return}const A=Math.min(50,f===null?16:m-f);f=m,this.gridContainer.scrollBy(F*A/1e3,P*A/1e3),C(),this.render(),d=requestAnimationFrame(v)},x=()=>{d===null&&(d=requestAnimationFrame(v))},E=m=>{c=m.clientX,u=m.clientY,C(),this.renderOverlay();const z=this.viewport,F=this.getAutoScrollVelocity(c,z.left,z.left+z.width),P=this.getAutoScrollVelocity(u,z.top,z.top+z.height);F===0&&P===0?y():x()};this.beginNativeSelectionBlock(),this.startMouseDragSession({onMove:E,onComplete:()=>{this.render(),this.primeCellInputForSelection()},onCleanup:()=>{y(),this.endNativeSelectionBlock()}})}startAutofillDrag(e){let t=e.clientX,s=e.clientY,n=null,i=null;const r=()=>{const{x:u,y:d}=this.clampClientPointToViewport(t,s),f=this.toRefFromMouse(u,d);this.autofillPreview=this.sheet.getAutofillPreviewRange(f),this.renderOverlay()},o=()=>{n!==null&&(cancelAnimationFrame(n),n=null),i=null},a=u=>{const d=this.viewport,f=this.getAutoScrollVelocity(t,d.left,d.left+d.width),C=this.getAutoScrollVelocity(s,d.top,d.top+d.height);if(f===0&&C===0){n=null,i=null;return}const y=Math.min(50,i===null?16:u-i);i=u,this.gridContainer.scrollBy(f*y/1e3,C*y/1e3),r(),n=requestAnimationFrame(a)},h=()=>{n===null&&(n=requestAnimationFrame(a))},c=u=>{t=u.clientX,s=u.clientY,r();const d=this.viewport,f=this.getAutoScrollVelocity(t,d.left,d.left+d.width),C=this.getAutoScrollVelocity(s,d.top,d.top+d.height);f===0&&C===0?o():h()};this.beginNativeSelectionBlock(),r(),this.startMouseDragSession({onMove:c,onComplete:()=>{const{x:u,y:d}=this.clampClientPointToViewport(t,s),f=this.toRefFromMouse(u,d),C=this.sheet;(async()=>{const y=await C.autofill(f);this.autofillPreview=void 0,this.sheet&&(y?this.render():this.renderOverlay())})()},onCleanup:()=>{o(),this.endNativeSelectionBlock(),this.autofillPreview=void 0,this.sheet&&this.renderOverlay()}})}startResize(e,t,s){const n=e==="column"?s.clientX:s.clientY,i=e==="column"?this.colDim.getSize(t):this.rowDim.getSize(t),r=this.gridContainer.getScrollContainer();r.style.cursor=e==="column"?"col-resize":"row-resize";const o=e==="column"?this.colDim:this.rowDim,a=this.sheet.getSelectedIndices(),c=a&&a.axis===e&&t>=a.from&&t<=a.to?Array.from({length:a.to-a.from+1},(y,v)=>a.from+v):[t],u=c.length;let d=i,f=null;this.beginNativeSelectionBlock(),this.showResizeTooltip(e,i,s.clientX,s.clientY,u);const C=y=>{const x=(e==="column"?y.clientX:y.clientY)-n;d=Math.max(e==="column"?vt:dn,i+x),f===null&&(f=requestAnimationFrame(()=>{f=null,o.setSize(t,d),this.render()})),this.showResizeTooltip(e,d,y.clientX,y.clientY,u)};this.startMouseDragSession({onMove:C,onComplete:()=>{const y=d;o.setSize(t,y);for(const v of c)o.setSize(v,y),e==="column"?this.sheet.setColumnWidth(v,y):(this.manuallyResizedRows.add(v),this.sheet.setRowHeight(v,y));this.render()},onCleanup:()=>{r.style.cursor="",this.hideResizeTooltip(),this.endNativeSelectionBlock(),f!==null&&(cancelAnimationFrame(f),f=null)}})}async autoFitSize(e,t){const n=document.createElement("canvas").getContext("2d"),i=6;if(e==="column"){n.font=`${ie}px Arial`;const r=fe(t);let o=n.measureText(r).width+i;const[a,h]=this.viewRange,c=[{r:a.r,c:t},{r:h.r,c:t}],u=await this.sheet.fetchGrid(c);for(const[,f]of u)if(f.v){const C=n.measureText(f.v).width+i;C>o&&(o=C)}const d=Math.max(vt,Math.ceil(o));this.sheet.setColumnWidth(t,d)}else{this.manuallyResizedRows.delete(t);const r=await this.computeContentHeight(t);this.sheet.setRowHeight(t,r)}this.render()}async computeContentHeight(e){const[t,s]=this.viewRange,n=[{r:e,c:t.c},{r:e,c:s.c}],i=await this.sheet.fetchGrid(n);let r=1;for(const[,o]of i)if(o.v){const a=o.v.split(`
`).length;a>r&&(r=a)}return r<=1?S:Math.max(S,Math.ceil(r*ie*Le+2*Ue))}async autoResizeRow(e){if(this.manuallyResizedRows.has(e))return;const t=await this.computeContentHeight(e),s=this.rowDim.getSize(e);t!==s&&(this.sheet.setRowHeight(e,t),this.render())}startDragMove(e,t,s,n){const i=this.gridContainer.getScrollContainer();i.style.cursor="grabbing";const r=e==="column"?this.colDim:this.rowDim,o=h=>{const c=this.viewport;if(e==="column"){const u=h.target!==i?Math.max(0,Math.min(c.width,h.clientX-c.left)):h.offsetX,d=this.toColFromMouse(u),f=this.freezeState,y=f.frozenCols>0&&u<R+f.frozenWidth?u-R:u-R-f.frozenWidth+this.colDim.getOffset(f.frozenCols+1)+this.scroll.left,x=r.getOffset(d)+r.getSize(d)/2;return y<x?d:d+1}else{const u=h.target!==i?Math.max(0,Math.min(c.height,h.clientY-c.top)):h.offsetY,d=this.toRowFromMouse(u),f=this.freezeState,y=f.frozenRows>0&&u<S+f.frozenHeight?u-S:u-S-f.frozenHeight+this.rowDim.getOffset(f.frozenRows+1)+this.scroll.top,x=r.getOffset(d)+r.getSize(d)/2;return y<x?d:d+1}};this.dragMove={axis:e,srcIndex:t,count:s,dropIndex:o(n)},this.renderOverlay();const a=h=>{const c=o(h);this.dragMove&&this.dragMove.dropIndex!==c&&(this.dragMove={axis:e,srcIndex:t,count:s,dropIndex:c},this.renderOverlay())};this.startMouseDragSession({onMove:a,onComplete:()=>{var u;const h=(u=this.dragMove)==null?void 0:u.dropIndex;if(h===void 0||h>=t&&h<=t+s)return;(e==="row"?this.sheet.moveRows(t,s,h):this.sheet.moveColumns(t,s,h)).then(()=>{const d=h<t?h:h-s;e==="row"?(this.sheet.selectRow(d),s>1&&this.sheet.selectRowRange(d,d+s-1)):(this.sheet.selectColumn(d),s>1&&this.sheet.selectColumnRange(d,d+s-1)),this.render()})},onCleanup:()=>{i.style.cursor="",this.dragMove=null,this.renderOverlay()}})}async handleFormulaKeydown(e){await this.handleEditorKeydown(e,"formulaBar")}async handleCellInputKeydown(e){await this.handleEditorKeydown(e,"cellInput")}async handleEditorKeydown(e,t){if(Ee(e))return;const s=t==="formulaBar"?this.formulaBar.getFormulaInput():this.cellInput.getInput();if(this.handleAutocompleteKeydown(e,s))return;const n=r=>{D(r,"ArrowDown")?this.sheet.move("down"):D(r,"ArrowUp")?this.sheet.move("up"):D(r,"ArrowLeft")?this.sheet.move("left"):D(r,"ArrowRight")&&this.sheet.move("right")};!await wt(e,[{match:r=>_(r,{key:"Enter",alt:!0}),run:r=>{r.preventDefault(),document.execCommand("insertLineBreak")}},{match:r=>D(r,"Enter"),run:async r=>{r.preventDefault(),await this.finishEditing(),t==="formulaBar"?(this.focusGrid(),this.sheet.move("down")):this.sheet.moveInRange(r.shiftKey?-1:1,0),this.render(),this.scrollIntoView(),this.primeCellInputForSelection()}},{match:r=>D(r,"Tab"),run:async r=>{r.preventDefault(),await this.finishEditing(),t==="formulaBar"&&this.focusGrid(),this.sheet.moveInRange(0,r.shiftKey?-1:1),this.render(),this.scrollIntoView(),this.primeCellInputForSelection()}},{match:r=>this.isArrowKey(r)&&!this.editMode&&(t==="formulaBar"||this.cellInput.hasFormula())&&this.isInFormulaRangeMode(),run:r=>{r.preventDefault();const o=this.applyFormulaRangeArrowKey(r);this.scrollIntoView(o)}},{match:r=>t==="cellInput"&&this.isArrowKey(r)&&!this.cellInput.hasFormula()&&!this.editMode,run:async r=>{r.preventDefault(),await this.finishEditing(),n(r),this.render(),this.scrollIntoView(),this.primeCellInputForSelection()}},{match:r=>D(r,"F4"),run:r=>{r.preventDefault(),this.toggleAbsoluteReference(s)}},{match:r=>D(r,"Escape"),run:r=>{r.preventDefault(),this.focusGrid(),this.render()}}])&&t==="formulaBar"&&!this.cellInput.isShown()&&this.showCellInput(!0,!0)}handleAutocompleteKeydown(e,t){if(this.autocomplete.isListVisible()){if(D(e,"ArrowDown"))return e.preventDefault(),this.autocomplete.moveDown(),!0;if(D(e,"ArrowUp"))return e.preventDefault(),this.autocomplete.moveUp(),!0;if(D(e,"Tab")||D(e,"Enter")){const s=this.autocomplete.getSelectedFunction();if(s)return e.preventDefault(),this.insertFunctionCompletion(s.name,t),!0}else D(e,"Escape")&&this.autocomplete.hide()}else this.autocomplete.isHintVisible()&&D(e,"Escape")&&this.autocomplete.hide();return!1}isArrowKey(e){return D(e,"ArrowDown")||D(e,"ArrowUp")||D(e,"ArrowLeft")||D(e,"ArrowRight")}applyFormulaRangeArrowKey(e){const s={...this.lastFormulaRefTarget||this.sheet.getActiveCell()};if(D(e,"ArrowDown")?s.r=Math.max(1,s.r+1):D(e,"ArrowUp")?s.r=Math.max(1,s.r-1):D(e,"ArrowLeft")?s.c=Math.max(1,s.c-1):D(e,"ArrowRight")&&(s.c=s.c+1),e.shiftKey&&this.formulaRangeAnchor){const n={r:Math.min(this.formulaRangeAnchor.r,s.r),c:Math.min(this.formulaRangeAnchor.c,s.c)},i={r:Math.max(this.formulaRangeAnchor.r,s.r),c:Math.max(this.formulaRangeAnchor.c,s.c)};this.insertReferenceAtCursor(n,i),this.lastFormulaRefTarget=s}else this.formulaRangeAnchor=s,this.formulaRefInsertPos=null,this.insertReferenceAtCursor(s);return s}async copy(){const{text:e}=await this.sheet.copy();await navigator.clipboard.writeText(e)}async paste(){try{let e,t;if(navigator.clipboard.read)try{const s=await navigator.clipboard.read();for(const n of s)n.types.includes("text/html")&&(t=await(await n.getType("text/html")).text()),n.types.includes("text/plain")&&(e=await(await n.getType("text/plain")).text())}catch{e=await navigator.clipboard.readText()}else e=await navigator.clipboard.readText();await this.sheet.paste({text:e,html:t}),this.sheet.clearCopyBuffer(),this.render()}catch(e){console.error("Failed to paste cell content: ",e)}}async handleGridKeydown(e){const t=async(s,n)=>{if(s.preventDefault(),s.shiftKey?this.sheet.resizeRange(n):ke(s)?await this.sheet.moveToEdge(n):this.sheet.move(n)){this.render();const r=s.shiftKey&&this.sheet.getSelectionType()==="cell"?this.getRangeExtentRef():void 0;this.scrollIntoView(r),this.primeCellInputForSelection()}};await wt(e,[{match:s=>D(s,"ArrowDown"),run:s=>t(s,"down")},{match:s=>D(s,"ArrowUp"),run:s=>t(s,"up")},{match:s=>D(s,"ArrowLeft"),run:s=>t(s,"left")},{match:s=>D(s,"ArrowRight"),run:s=>t(s,"right")},{match:s=>_(s,{key:"a",mod:!0}),run:async s=>{s.preventDefault(),await this.sheet.selectAll(),this.render()}},{match:s=>D(s,"Tab"),run:s=>{s.preventDefault(),this.sheet.moveInRange(0,s.shiftKey?-1:1),this.render(),this.scrollIntoView(),this.primeCellInputForSelection()}},{match:s=>D(s,"Enter"),run:s=>{s.preventDefault(),this.sheet.hasRange()?(this.sheet.moveInRange(s.shiftKey?-1:1,0),this.render(),this.scrollIntoView(),this.primeCellInputForSelection()):this.readOnly||this.showCellInput()}},{match:s=>D(s,"Delete")||D(s,"Backspace"),run:async s=>{this.readOnly||(s.preventDefault(),await this.sheet.removeData()&&this.render())}},{match:s=>!ke(s)&&Ee(s),run:()=>{this.readOnly||this.cellInput.isFocused()&&this.cellInput.isPrimed()||this.showCellInput(!0,!1,!0)}},{match:s=>!ke(s)&&!Ee(s)&&this.isValidCellInput(s.key),run:()=>{this.readOnly||this.cellInput.isFocused()&&this.cellInput.isPrimed()||this.showCellInput(!0,!1,!0)}},{match:s=>_(s,{key:"z",mod:!0,shift:!1}),run:async s=>{this.readOnly||(s.preventDefault(),await this.sheet.undo()&&(this.render(),this.scrollIntoView()))}},{match:s=>_(s,{key:"z",mod:!0,shift:!0})||_(s,{key:"y",mod:!0}),run:async s=>{this.readOnly||(s.preventDefault(),await this.sheet.redo()&&(this.render(),this.scrollIntoView()))}},{match:s=>D(s,"Escape"),run:s=>{s.preventDefault(),this.sheet.getCopyRange()&&(this.sheet.clearCopyBuffer(),this.renderOverlay())}},{match:s=>_(s,{key:"c",mod:!0}),run:async s=>{s.preventDefault(),await this.copy()}},{match:s=>_(s,{key:"v",mod:!0}),run:async s=>{this.readOnly||(s.preventDefault(),await this.paste())}},{match:s=>_(s,{key:"b",mod:!0}),run:async s=>{this.readOnly||(s.preventDefault(),await this.sheet.toggleRangeStyle("b"),this.render())}},{match:s=>_(s,{key:"i",mod:!0}),run:async s=>{this.readOnly||(s.preventDefault(),await this.sheet.toggleRangeStyle("i"),this.render())}},{match:s=>_(s,{key:"u",mod:!0}),run:async s=>{this.readOnly||(s.preventDefault(),await this.sheet.toggleRangeStyle("u"),this.render())}},{match:s=>_(s,{key:"s",mod:!0,shift:!0}),run:async s=>{this.readOnly||(s.preventDefault(),await this.sheet.toggleRangeStyle("st"),this.render())}},{match:s=>_(s,{key:"m",mod:!0,shift:!0}),run:async s=>{this.readOnly||(s.preventDefault(),await this.sheet.toggleMergeSelection()&&this.render())}}])}getRangeExtentRef(){const e=this.sheet.getActiveCell(),t=this.sheet.getRange();if(!t)return e;const s=Math.abs(e.r-t[0].r)>Math.abs(t[1].r-e.r)?t[0].r:t[1].r,n=Math.abs(e.c-t[0].c)>Math.abs(t[1].c-e.c)?t[0].c:t[1].c;return{r:s,c:n}}async reloadDimensions(){await this.sheet.loadDimensions(),await this.sheet.loadStyles(),await this.sheet.loadMerges(),await this.sheet.loadFreezePane(),await this.sheet.loadFilterState(),this.hiddenRows.clear(),this.hiddenRowSizeBackup.clear(),this.syncHiddenRowsFromSheet(),this.updateFreezeState()}getGridViewportRect(){const e=this.viewport,t=this.container.getBoundingClientRect();return{left:e.left-t.left,top:e.top-t.top,width:e.width,height:e.height}}getScrollableGridViewportRect(){const e=this.getGridViewportRect(),t=this.freezeState,s=R+t.frozenWidth,n=S+t.frozenHeight;return{left:e.left+s,top:e.top+n,width:Math.max(0,e.width-s),height:Math.max(0,e.height-n)}}getCellRect(e){const t=this.freezeState;return t.frozenRows>0||t.frozenCols>0?be(e,this.scroll,this.rowDim,this.colDim,t):N(e,this.scroll,this.rowDim,this.colDim)}getCellRectInScrollableViewport(e){const t=this.freezeState,s=this.scroll,n=s.left+this.colDim.getOffset(t.frozenCols+1)-t.frozenWidth,i=s.top+this.rowDim.getOffset(t.frozenRows+1)-t.frozenHeight;return N(e,{left:n,top:i},this.rowDim,this.colDim)}getRangeRect(e){return Q(this.getCellRect(e[0]),this.getCellRect(e[1]))}setOnRender(e){this.onRenderCallback=e}render(){this.renderVersion+=1,this.requestRenderFrame()}requestRenderFrame(){this.pendingRenderFrame===null&&(this.pendingRenderFrame=requestAnimationFrame(()=>{this.pendingRenderFrame=null,this.handleRenderFrame()}))}handleRenderFrame(){if(this.renderInFlight){this.renderQueued=!0;return}this.renderInFlight=!0;const e=this.renderVersion;this.performRender(e).finally(()=>{this.renderInFlight=!1,(this.renderQueued||this.renderVersion!==e)&&(this.renderQueued=!1,this.requestRenderFrame())})}async performRender(e){var t;this.sheet&&(this.formulaBar.render(),await this.renderSheet(e),!(!this.sheet||e!==this.renderVersion)&&(this.renderOverlay(),(t=this.onRenderCallback)==null||t.call(this)))}renderOverlay(){this.overlay.render(this.viewport,this.scroll,this.sheet.getActiveCell(),this.sheet.getPresences(),this.sheet.getRange(),this.rowDim,this.colDim,this.resizeHover,this.sheet.getSelectionType(),this.dragMove?{axis:this.dragMove.axis,dropIndex:this.dragMove.dropIndex}:null,this.formulaRanges,this.freezeState,this.freezeDrag,this.sheet.getCopyRange(),this.autofillPreview,this.shouldShowAutofillHandle(),this.sheet.getMerges(),this.sheet.getFilterRange())}get viewRange(){const e=this.scroll,t=this.viewport,s=this.freezeState,n=this.rowDim.getOffset(s.frozenRows+1),i=this.colDim.getOffset(s.frozenCols+1),r=Math.max(s.frozenRows+1,this.rowDim.findIndex(n+e.top)),o=Math.max(r,this.rowDim.findIndex(n+e.top+t.height)+1),a=Math.max(s.frozenCols+1,this.colDim.findIndex(i+e.left)),h=Math.max(a,this.colDim.findIndex(i+e.left+t.width)+1);return[{r,c:a},{r:o,c:h}]}scrollIntoView(e=this.sheet.getActiveCell()){const t=this.scroll,s=this.freezeState,n=s.frozenRows>0&&e.r<=s.frozenRows,i=s.frozenCols>0&&e.c<=s.frozenCols,r=N(e,{left:0,top:0},this.rowDim,this.colDim),o=this.sheet.getMerges().get(M(e));if(o){const f=N({r:e.r+o.rs-1,c:e.c+o.cs-1},{left:0,top:0},this.rowDim,this.colDim);r.width=f.left+f.width-r.left,r.height=f.top+f.height-r.top}const a=this.colDim.getOffset(s.frozenCols+1),h=this.rowDim.getOffset(s.frozenRows+1),c=this.viewport.width-R-s.frozenWidth,u=this.viewport.height-S-s.frozenHeight;let d=!1;if(!i){const f=a+t.left,C=f+c,y=r.left-R,v=y+r.width;y<f?(this.scroll={left:y-a},d=!0):v>C&&(this.scroll={left:v-c-a},d=!0)}if(!n){const f=h+t.top,C=f+u,y=r.top-S,v=y+r.height;y<f?(this.scroll={top:y-h},d=!0):v>C&&(this.scroll={top:v-u-h},d=!0)}d&&this.render()}getCellInputRect(e){const t=this.getCellRect(e),s=this.sheet.getMerges().get(M(e));if(!s)return t;const n=this.getCellRect({r:e.r+s.rs-1,c:e.c+s.cs-1});return t.width=n.left+n.width-t.left,t.height=n.top+n.height-t.top,t}resolveCellInputLayout(e){const t=this.getCellInputRect(e),s=this.viewport,n=R,i=S,r=s.width,o=s.height;if(t.left<r&&t.left+t.width>n&&t.top<o&&t.top+t.height>i)return{left:t.left,top:t.top,width:t.width,height:t.height,maxWidth:Math.max(t.width,s.width-t.left),maxHeight:Math.max(t.height,s.height-t.top),pinned:!1};const h=n+ue,c=i+ue,u=Math.max(h,s.width-t.width-ue),d=Math.max(c,s.height-t.height-ue),f=Math.min(u,Math.max(h,t.left)),C=Math.min(d,Math.max(c,t.top));return{left:f,top:C,width:t.width,height:t.height,maxWidth:Math.max(t.width,s.width-f-ue),maxHeight:Math.max(t.height,s.height-C-ue),pinned:!0}}updateAutocompletePositionForActiveInput(){if(!this.autocomplete.isListVisible()&&!this.autocomplete.isHintVisible())return;let e;if(this.cellInput.isFocused()?e=this.cellInput.getInput():this.formulaBar.isFocused()&&(e=this.formulaBar.getFormulaInput()),!e)return;const t=e.getBoundingClientRect();this.autocomplete.reposition({left:t.left,top:t.bottom+2})}updateCellInputPosition(){if(!this.sheet||!this.cellInput.isShown())return;const e=this.sheet.getActiveCell(),t=this.resolveCellInputLayout(e);this.cellInput.updatePlacement(t.left,t.top,t.width,t.height,t.maxWidth,t.maxHeight),this.cellInput.setCellPositionHint(t.pinned?M(e):void 0),this.updateAutocompletePositionForActiveInput()}primeCellInputForSelection(){if(this.readOnly||!this.sheet||this.formulaBar.isFocused()||this.sheet.getSelectionType()!=="cell"||this.sheet.hasRange())return;this.editMode=!1;const e=this.sheet.getActiveCell(),t=this.resolveCellInputLayout(e);this.cellInput.prime(t.left,t.top,t.width,t.height,t.maxWidth,t.maxHeight),this.cellInput.setCellPositionHint(t.pinned?M(e):void 0)}async syncCellInputStyleForActiveCell(){if(!this.sheet||!this.cellInput.isFocused()||this.cellInput.isPrimed())return;const e=this.sheet.getActiveCell(),t=await this.sheet.getStyle(e);if(!this.sheet||!this.cellInput.isFocused()||this.cellInput.isPrimed())return;const s=this.sheet.getActiveCell();s.r!==e.r||s.c!==e.c||this.cellInput.applyStyle(t)}async showCellInput(e=!1,t=!1,s=!1){t||(this.editMode=!e);const n=this.sheet.getActiveCell(),i=this.resolveCellInputLayout(n),r=e?"":await this.sheet.toInputString(n);this.cellInput.show(i.left,i.top,r,!t,i.width,i.height,i.maxWidth,i.maxHeight,!s),this.cellInput.setCellPositionHint(i.pinned?M(n):void 0);const o=await this.sheet.getStyle(n);this.cellInput.applyStyle(o),r.startsWith("=")&&(this.formulaRanges=ye(r).map(a=>a.range),this.renderOverlay())}isValidCellInput(e){return e.length===1}async renderSheet(e=this.renderVersion){const t=this.sheet;if(!t)return;this.syncHiddenRowsFromSheet();const s=this.gridSize,n=this.freezeState;this.gridContainer.updateDummySize(s.width+R,s.height+S);const i=this.viewport,r=this.scroll,o=this.viewRange,a=[{r:1,c:1},{r:o[1].r,c:o[1].c}],h=await t.fetchGrid(a);t!==this.sheet||e!==this.renderVersion||this.gridCanvas.render(i,r,o,t.getActiveCell(),h,this.rowDim,this.colDim,t.getSelectionType(),t.getRange(),n,this.freezeHandleHover,t.getColStyles(),t.getRowStyles(),t.getSheetStyle(),t.getRangeStyles(),t.getConditionalFormats(),t.getMerges(),t.getFilterRange(),t.getFilteredColumns(),this.filterButtonHoverCol)}syncHiddenRowsFromSheet(){const e=this.sheet;if(!e)return;const t=e.getHiddenRows();for(const s of this.hiddenRows){if(t.has(s))continue;const n=this.hiddenRowSizeBackup.get(s)??this.rowDim.getDefaultSize();this.rowDim.setSize(s,n),this.hiddenRowSizeBackup.delete(s)}for(const s of t)this.hiddenRows.has(s)||(this.hiddenRowSizeBackup.set(s,this.rowDim.getSize(s)),this.rowDim.setSize(s,0));this.hiddenRows=t}get gridSize(){const e=this.sheet.getDimension();return{width:this.colDim.getOffset(e.columns+1),height:this.rowDim.getOffset(e.rows+1)}}get viewport(){return this.gridContainer.getViewport()}get scroll(){return this.gridContainer.getScrollPosition()}set scroll(e){this.gridContainer.setScrollPosition(e)}}async function Sn(l,e){const t=new mn(l,e),s=(e==null?void 0:e.store)||new Fs;return await t.initialize(s),t}class mn{constructor(e,t){p(this,"container");p(this,"worksheet");p(this,"sheet");p(this,"theme");p(this,"_readOnly");p(this,"selectionChangeCallbacks",[]);this.container=e,this.container.style.position="relative",this.container.style.overflow="hidden",this.theme=(t==null?void 0:t.theme)||"light",this._readOnly=(t==null?void 0:t.readOnly)||!1,this.worksheet=new gn(this.container,this.theme,this._readOnly)}get readOnly(){return this._readOnly}async initialize(e){this.sheet=new _s(e),this.worksheet.setOnRender(()=>this.notifySelectionChange()),await this.worksheet.initialize(this.sheet)}async reloadDimensions(){await this.worksheet.reloadDimensions()}async setFreezePane(e,t){this._readOnly||await this.worksheet.setFreezePane(e,t)}render(){this.worksheet.render()}renderOverlay(){this.worksheet.renderOverlay()}panBy(e,t){this.worksheet.panBy(e,t)}handleMobileDoubleTap(e,t){this.worksheet.handleMobileDoubleTap(e,t)}async focusCell(e){this.sheet&&(await this.worksheet.focusCell(e),this.notifySelectionChange())}async applyStyle(e){!this.sheet||this._readOnly||(await this.sheet.setRangeStyle(e),this.worksheet.render(),this.notifySelectionChange())}async applyDefaultStyle(){!this.sheet||this._readOnly||await this.sheet.resetRangeStyleToDefault()&&(this.worksheet.render(),this.notifySelectionChange())}async applyBorders(e){!this.sheet||this._readOnly||await this.sheet.setRangeBorders(e)&&(this.worksheet.render(),this.notifySelectionChange())}async toggleStyle(e){!this.sheet||this._readOnly||(await this.sheet.toggleRangeStyle(e),this.worksheet.render(),this.notifySelectionChange())}async getActiveStyle(){if(this.sheet)return this.sheet.getStyle(this.sheet.getActiveCell())}getActiveCell(){var e;return(e=this.sheet)==null?void 0:e.getActiveCell()}getConditionalFormats(){var e;return((e=this.sheet)==null?void 0:e.getConditionalFormats())||[]}async setConditionalFormats(e){!this.sheet||this._readOnly||(await this.sheet.setConditionalFormats(e),this.worksheet.render(),this.notifySelectionChange())}onSelectionChange(e){return this.selectionChangeCallbacks.push(e),()=>{this.selectionChangeCallbacks=this.selectionChangeCallbacks.filter(t=>t!==e)}}notifySelectionChange(){for(const e of this.selectionChangeCallbacks)e()}getSelectionType(){var e;return(e=this.sheet)==null?void 0:e.getSelectionType()}getSelectionRangeOrActiveCell(){var e;return(e=this.sheet)==null?void 0:e.getRangeOrActiveCell()}getGridViewportRect(){return this.worksheet.getGridViewportRect()}getScrollableGridViewportRect(){return this.worksheet.getScrollableGridViewportRect()}getCellRect(e){return this.worksheet.getCellRect(e)}getCellRectInScrollableViewport(e){return this.worksheet.getCellRectInScrollableViewport(e)}async increaseDecimals(){if(!this.sheet||this._readOnly)return;const e=await this.sheet.getActiveDecimalPlaces();await this.sheet.setRangeStyle({dp:e+1}),this.worksheet.render(),this.notifySelectionChange()}async decreaseDecimals(){if(!this.sheet||this._readOnly)return;const e=await this.sheet.getActiveDecimalPlaces();await this.sheet.setRangeStyle({dp:Math.max(0,e-1)}),this.worksheet.render(),this.notifySelectionChange()}async toggleMergeCells(){!this.sheet||this._readOnly||await this.sheet.toggleMergeSelection()&&(this.worksheet.render(),this.notifySelectionChange())}isSelectionMerged(){return this.sheet?this.sheet.isSelectionMerged():!1}canMergeSelection(){return this.sheet?this.sheet.canMergeSelection():!1}hasFilter(){var e;return((e=this.sheet)==null?void 0:e.hasFilter())||!1}async createFilterFromSelection(){if(!this.sheet||this._readOnly)return!1;const e=await this.sheet.createFilterFromSelection();return e&&(this.worksheet.render(),this.notifySelectionChange()),e}async clearFilter(){!this.sheet||this._readOnly||(await this.sheet.clearFilter(),this.worksheet.render(),this.notifySelectionChange())}async setColumnFilter(e,t){if(!this.sheet||this._readOnly)return!1;const s=await this.sheet.setColumnFilter(e,t);return s&&(this.worksheet.render(),this.notifySelectionChange()),s}async clearColumnFilter(e){if(!this.sheet||this._readOnly)return!1;const t=await this.sheet.clearColumnFilter(e);return t&&(this.worksheet.render(),this.notifySelectionChange()),t}async undo(){!this.sheet||this._readOnly||await this.sheet.undo()&&(this.worksheet.render(),this.notifySelectionChange())}async redo(){!this.sheet||this._readOnly||await this.sheet.redo()&&(this.worksheet.render(),this.notifySelectionChange())}toggleFunctionBrowser(){this.worksheet.toggleFunctionBrowser()}cleanup(){this.worksheet.cleanup(),this.selectionChangeCallbacks=[]}setGridResolver(e){this.sheet&&this.sheet.setGridResolver(e)}async recalculateCrossSheetFormulas(){this.sheet&&(await this.sheet.recalculateCrossSheetFormulas(),this.worksheet.render())}}export{Dt as C,Fs as M,wn as R,He as a,st as b,M as c,H as d,Sn as e,vn as f,Nt as g,Se as h,ns as i,De as j,pe as k,as as l,Pt as m,ee as n,It as o,bt as p,Ot as q,ae as r,ls as s,Ft as t,rs as u,U as v,kt as w,Mt as x,Lt as y};
