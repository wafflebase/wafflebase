var z=Object.defineProperty;var I=(n,e,t)=>e in n?z(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var w=(n,e,t)=>I(n,typeof e!="symbol"?e+"":e,t);import{x as D,r as c,y as N,j as o,e as k}from"./index-l-AeDemK.js";import{C as F,t as g,f as P,p as q,w as Q,x as T}from"./use-mobile-sheet-gestures-Ba3SPrFA.js";import{B}from"./button-DscdbcCf.js";import{e as G}from"./datasources-DTSR1zVv.js";import{c as K}from"./IconDotsVertical-FN4RsnLz.js";import"./index-DF6n9vMq.js";import"./index-DSZJcG4A.js";import"./dropdown-menu-SnxPISaS.js";import"./index-BJAiCyqf.js";/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var A=K("outline","player-play","IconPlayerPlay",[["path",{d:"M7 4v16l13 -8z",key:"svg-0"}]]);class L{constructor(){w(this,"grid",new Map);w(this,"cellIndex",new F)}loadQueryResults(e,t){this.grid.clear();for(let s=0;s<e.length;s++){const l=g({r:1,c:s+1});this.grid.set(l,{v:e[s].name,s:{b:!0}})}for(let s=0;s<t.length;s++){const l=t[s];for(let i=0;i<e.length;i++){const r=l[e[i].name];if(r==null)continue;const m=g({r:s+2,c:i+1});this.grid.set(m,{v:String(r)})}}this.rebuildIndex()}async set(e,t){}async get(e){return this.grid.get(g(e))}async has(e){return this.grid.has(g(e))}async delete(e){return!1}async deleteRange(e){return new Set}async setGrid(e){}async getGrid(e){const t=new Map;for(const[s,l]of this.cellIndex.cellsInRange(e)){const i=g({r:s,c:l}),r=this.grid.get(i);r!==void 0&&t.set(i,r)}return t}async findEdge(e,t,s){return P(this.cellIndex,e,t,s,(l,i)=>{const r=this.grid.get(g({r:l,c:i}));return r!==void 0&&(!!r.v||!!r.f)})}async shiftCells(e,t,s){}async moveCells(e,t,s,l){}async buildDependantsMap(e){return new Map}async getFormulaGrid(){return new Map}getPresences(){return[]}updateActiveCell(e){}async setDimensionSize(e,t,s){}async getDimensionSizes(e){return new Map}async setColumnStyle(e,t){}async getColumnStyles(){return new Map}async setRowStyle(e,t){}async getRowStyles(){return new Map}async setSheetStyle(e){}async getSheetStyle(){}async addRangeStyle(e){}async setRangeStyles(e){}async getRangeStyles(){return[]}async setConditionalFormats(e){}async getConditionalFormats(){return[]}async setMerge(e,t){}async deleteMerge(e){return!1}async getMerges(){return new Map}async setFilterState(e){}async getFilterState(){}async setFreezePane(e,t){}async getFreezePane(){return{frozenRows:0,frozenCols:0}}beginBatch(){}endBatch(){}async undo(){return{success:!1}}async redo(){return{success:!1}}canUndo(){return!1}canRedo(){return!1}rebuildIndex(){this.cellIndex.rebuild(Array.from(this.grid.keys()).map(e=>{const t=q(e);return[t.r,t.c]}))}}function ee({tabId:n,readOnly:e=!1}){const{resolvedTheme:t}=D(),s=c.useRef(null),[l,i]=c.useState(!1),r=c.useRef(void 0),m=c.useRef(new L),{doc:f,loading:E,error:v}=N.useDocument(),[y,S]=c.useState(""),[R,C]=c.useState(!1),[x,b]=c.useState(null),[M,h]=c.useState(null);Q({containerRef:s,sheetRef:r}),c.useEffect(()=>{i(!0)},[]),c.useEffect(()=>{if(!f)return;const a=f.getRoot().tabs[n];a!=null&&a.query&&S(a.query)},[f,n]),c.useEffect(()=>{const u=s.current;if(!l||!u)return;let a,d=!1;return T(u,{theme:t,store:m.current,readOnly:!0}).then(_=>{if(d){_.cleanup();return}a=_,r.current=_}),()=>{d=!0,a&&a.cleanup(),r.current=void 0}},[l,t]);const p=c.useCallback(async()=>{if(!f||!y.trim()||e)return;const a=f.getRoot().tabs[n];if(!(a!=null&&a.datasourceId)){h("No datasource connected to this tab");return}f.update(d=>{d.tabs[n]&&(d.tabs[n].query=y)}),C(!0),h(null);try{const d=await G(a.datasourceId,y);b(d),m.current.loadQueryResults(d.columns,d.rows),r.current&&(await r.current.reloadDimensions(),r.current.render())}catch(d){h(d.message)}finally{C(!1)}},[f,n,y,e]),j=c.useCallback(u=>{if((u.metaKey||u.ctrlKey)&&u.key==="Enter"){if(e)return;u.preventDefault(),p()}},[p,e]);return E?o.jsx(k,{}):v?o.jsx("div",{className:"flex h-full w-full items-center justify-center",children:o.jsx("div",{className:"text-red-500",children:v.message})}):o.jsxs("div",{className:"flex h-full w-full flex-col",children:[o.jsx("div",{className:"border-b p-2 shrink-0",children:o.jsx("textarea",{className:"w-full h-24 p-2 font-mono text-sm border rounded resize-y bg-background text-foreground focus:outline-none focus:ring-1 focus:ring-primary",placeholder:"SELECT * FROM users LIMIT 100",value:y,onChange:u=>{e||S(u.target.value)},onKeyDown:j,readOnly:e})}),o.jsxs("div",{className:"flex items-center gap-3 px-3 py-1.5 border-b shrink-0",children:[o.jsxs(B,{size:"sm",onClick:p,disabled:e||R||!y.trim(),children:[o.jsx(A,{className:"size-4"}),R?"Executing...":"Execute"]}),x&&o.jsxs("span",{className:"text-xs text-muted-foreground",children:[x.rowCount," row",x.rowCount!==1?"s":"",x.truncated?" (truncated)":""," in ",x.executionTime,"ms"]}),M&&o.jsx("span",{className:"text-xs text-destructive truncate",children:M})]}),o.jsx("div",{ref:s,className:"flex-1 w-full",style:{touchAction:"manipulation"}})]})}export{ee as DataSourceView};
