var ts=Object.defineProperty;var ss=(l,e,t)=>e in l?ts(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var p=(l,e,t)=>ss(l,typeof e!="symbol"?e+"":e,t);import{e as ve,a as Qe,b as ns,n as st,s as is,f as rs,c as _e,F as Ge,S as os,l as ls,d as Se,i as as,g as nt}from"./sheet-formula-eval-CZqWTRhi.js";function*it(l){const[e,t]=l;for(let s=e.r;s<=t.r;s++)for(let n=e.c;n<=t.c;n++)yield{r:s,c:n}}function oe(l,e){const[t,s]=e;return t.r<=l.r&&l.r<=s.r&&t.c<=l.c&&l.c<=s.c}function hs(l,e){const[t,s]=l,[n,i]=e;return n.r<=t.r&&s.r<=i.r&&n.c<=t.c&&s.c<=i.c}function K(l,e){return[{r:Math.min(l.r,e.r),c:Math.min(l.c,e.c)},{r:Math.max(l.r,e.r),c:Math.max(l.c,e.c)}]}function q(l){return[rt(l[0]),rt(l[1])]}function ce(l,e){return Fe(l[0],e[0])&&Fe(l[1],e[1])}function cs(l,e){const t=[];return l[0].r>e[0].r&&t.push([{r:l[0].r-1,c:l[0].c},{r:l[0].r-1,c:l[1].c}]),l[1].r<e[1].r&&t.push([{r:l[1].r+1,c:l[0].c},{r:l[1].r+1,c:l[1].c}]),l[0].c>e[0].c&&t.push([{r:l[0].r,c:l[0].c-1},{r:l[1].r,c:l[0].c-1}]),l[1].c<e[1].c&&t.push([{r:l[0].r,c:l[1].c+1},{r:l[1].r,c:l[1].c+1}]),t}function Ue(l,e){const[t,s]=l,[n,i]=e;return[{r:Math.min(t.r,n.r),c:Math.min(t.c,n.c)},{r:Math.max(s.r,i.r),c:Math.max(s.c,i.c)}]}function Fe(l,e){return l.r===e.r&&l.c===e.c}function rt(l){return{r:l.r,c:l.c}}function ds(l){return l.includes(":")}function Le(l){return l.includes("!")}function Ht(l){const e=l.indexOf("!");if(e===-1)throw new Error(`Not a cross-sheet reference: ${l}`);let t=l.substring(0,e);t.startsWith("'")&&t.endsWith("'")&&(t=t.slice(1,-1));const s=l.substring(e+1);return{sheetName:t,localRef:s}}function*Bt(l){for(const e of l){if(Le(e)){const{sheetName:t,localRef:s}=Ht(e);if(s.includes(":")){const n=ot(s);for(const i of it(n))yield`${t}!${T(i)}`}else yield e;continue}if(ds(e)){const t=ot(e);for(const s of it(t))yield T(s);continue}yield e}}function T(l){return ae(l.c)+l.r}function us(l){const[e,t]=l;return`${T(e)}:${T(t)}`}function ae(l){let e="";for(;l>0;){const t=l%26;t===0?(e="Z"+e,l=Math.floor(l/26)-1):(e=String.fromCharCode(t+64)+e,l=Math.floor(l/26))}return e}function B(l){const e=l.replace(/\$/g,"");let t=0;for(let i=0;i<e.length;i++){const r=e.charCodeAt(i);if(48<=r&&r<=57){t=i;break}}if(t===0)throw new Error("Invalid Reference");const s=parseInt(e.substring(t)),n=e.substring(0,t).split("").reverse().reduce((i,r,o)=>i+Math.pow(26,o)*(r.charCodeAt(0)-65+1),0);if(isNaN(s)||isNaN(n))throw new Error("Invalid Reference");return{r:s,c:n}}function ot(l){const[e,t]=l.split(":");return[B(e),B(t)]}function _(l,e,t,s){const n=e+t;return s<=e?l>=e&&l<n?s+(l-e):l>=s&&l<e?l+t:l:l>=e&&l<n?s-t+(l-e):l>=n&&l<s?l-t:l}function ge(l,e,t,s,n){return e==="row"?{r:_(l.r,t,s,n),c:l.c}:{r:l.r,c:_(l.c,t,s,n)}}function fs(l,e,t,s,n){const i=ve(l);let r="=";for(const o of i)if(o.type==="REFERENCE"){const a=o.text;if(a.includes("!"))r+=a;else if(a.includes(":")){const[h,c]=a.split(":"),u=B(h.toUpperCase()),d=B(c.toUpperCase()),f=ge(u,e,t,s,n),m=ge(d,e,t,s,n);r+=T(f)+":"+T(m)}else{const h=B(a.toUpperCase()),c=ge(h,e,t,s,n);r+=T(c)}}else r+=o.text;return r}function ps(l,e,t,s,n){const i=new Map;for(const[r,o]of l){const a=B(r),h=ge(a,e,t,s,n),c=T(h);let u;o.f?u={...o,f:fs(o.f,e,t,s,n)}:u={...o},i.set(c,u)}return i}function Q(l,e,t,s){const n=new Map;for(const[i,r]of l)n.set(_(i,e,t,s),r);return n}function lt(l,e,t){const s=ve(l);let n="=";for(const i of s)if(i.type==="REFERENCE"){const r=i.text;if(r.includes("!"))n+=r;else if(r.includes(":")){const[o,a]=r.split(":"),h=B(o.toUpperCase()),c=B(a.toUpperCase()),u={r:h.r+e,c:h.c+t},d={r:c.r+e,c:c.c+t};u.r<1||u.c<1||d.r<1||d.c<1?n+="#REF!":n+=T(u)+":"+T(d)}else{const o=B(r.toUpperCase()),a={r:o.r+e,c:o.c+t};a.r<1||a.c<1?n+="#REF!":n+=T(a)}}else n+=i.text;return n}function gs(l,e){const t=ve(l);let s="=";for(const n of t)if(n.type==="REFERENCE"){const i=n.text;if(i.includes("!"))s+=i;else if(i.includes(":")){const[r,o]=i.split(":"),a=T(B(r.toUpperCase())),h=T(B(o.toUpperCase())),c=e.get(a),u=e.get(h);c&&u?s+=c+":"+u:s+=i}else{const r=T(B(i.toUpperCase())),o=e.get(r);s+=o??i}}else s+=n.text;return s}function ke(l,e,t,s){const n=e==="row"?l.r:l.c;if(s>0)return n>=t?e==="row"?{r:l.r+s,c:l.c}:{r:l.r,c:l.c+s}:l;const i=Math.abs(s);return n>=t&&n<t+i?null:n>=t+i?e==="row"?{r:l.r+s,c:l.c}:{r:l.r,c:l.c+s}:l}function ms(l,e,t,s){const n=B(l),i=ke(n,e,t,s);return i?T(i):null}function ys(l,e,t,s){const n=ve(l);let i="=";for(const r of n)if(r.type==="REFERENCE"){const o=r.text;if(o.includes("!"))i+=o;else if(o.includes(":")){const[a,h]=o.split(":"),c=B(a.toUpperCase()),u=B(h.toUpperCase()),d=ke(c,e,t,s),f=ke(u,e,t,s);!d||!f?i+="#REF!":i+=T(d)+":"+T(f)}else{const a=B(o.toUpperCase()),h=ke(a,e,t,s);h?i+=T(h):i+="#REF!"}}else i+=r.text;return i}function Z(l,e,t){const s=new Map;for(const[n,i]of l)if(t>0)n>=e?s.set(n+t,i):s.set(n,i);else{const r=Math.abs(t);n>=e&&n<e+r||(n>=e+r?s.set(n+t,i):s.set(n,i))}return s}function ws(l,e,t,s){const n=new Map;for(const[i,r]of l){const o=ms(i,e,t,s);if(o===null)continue;let a;r.f?a={...r,f:ys(r.f,e,t,s)}:a={...r},n.set(o,a)}return n}const Cs=new Set(["isEmpty","isNotEmpty","textContains","greaterThan","between","dateBefore","dateAfter"]),vs=new Set(["textContains","greaterThan","dateBefore","dateAfter"]);function Ss(l){return[{r:l[0].r,c:l[0].c},{r:l[1].r,c:l[1].c}]}function Rs(l){return Cs.has(l)}function ee(l){if(typeof l=="string")return l;if(l==null)return"";if(typeof l=="number"||typeof l=="boolean")return String(l);if(typeof l=="object"){const e=l;if(e.value!==void 0&&e.value!==l)return ee(e.value);if(typeof e.toJSON=="function")try{const t=e.toJSON.call(l);if(t!==l)return ee(t)}catch{}}return String(l)}function bs(l){return K(l[0],l[1])}function Re(l){if(!l)return;const e=l.trim().replace(/,/g,"");if(!e)return;const t=Number(e);return Number.isFinite(t)?t:void 0}function Ie(l){if(!l)return;const e=l.trim();if(!e)return;const t=e.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(t){const n=Number(t[1]),i=Number(t[2]),r=Number(t[3]),o=new Date(n,i-1,r);return o.getFullYear()!==n||o.getMonth()!==i-1||o.getDate()!==r?void 0:o.getTime()}const s=new Date(e);if(!Number.isNaN(s.getTime()))return new Date(s.getFullYear(),s.getMonth(),s.getDate()).getTime()}function Te(l,e,t){if(t>0)return l>=e?l+t:l;const s=Math.abs(t);return l>=e&&l<e+s?e:l>=e+s?l+t:l}function Et(l){return K({r:Math.max(1,l[0].r),c:Math.max(1,l[0].c)},{r:Math.max(1,l[1].r),c:Math.max(1,l[1].c)})}function at(l){if(typeof l!="string")return;const e=l.trim();return e.length>0?e:void 0}function Fs(l){const e={};l.b!==void 0&&(e.b=l.b),l.i!==void 0&&(e.i=l.i),l.u!==void 0&&(e.u=l.u);const t=at(l.tc);t!==void 0&&(e.tc=t);const s=at(l.bg);return s!==void 0&&(e.bg=s),Object.keys(e).length>0?e:void 0}function Ce(l){const e={id:l.id,range:Ss(l.range),op:l.op,style:{...l.style}};return l.value!==void 0&&(e.value=l.value),l.value2!==void 0&&(e.value2=l.value2),e}function Ve(l){const e=ee(l.id).trim();if(!e)return;const t=ee(l.op).trim();if(!Rs(t))return;const s=Fs(l.style||{});if(!s)return;const n={id:e,range:bs(l.range),op:t,style:s};if(vs.has(t)){const i=ee(l.value).trim();return i?(n.value=i,n):void 0}if(t==="between"){const i=ee(l.value).trim(),r=ee(l.value2).trim();return!i||!r?void 0:(n.value=i,n.value2=r,n)}return n}function zs(l,e){const s=ee(l).trim();switch(e.op){case"isEmpty":return s.length===0;case"isNotEmpty":return s.length>0;case"textContains":{const n=ee(e.value).trim().toLowerCase();return n?s.toLowerCase().includes(n):!1}case"greaterThan":{const n=Re(s),i=Re(e.value);return n!==void 0&&i!==void 0&&n>i}case"between":{const n=Re(s),i=Re(e.value),r=Re(e.value2);if(n===void 0||i===void 0||r===void 0)return!1;const o=Math.min(i,r),a=Math.max(i,r);return n>=o&&n<=a}case"dateBefore":{const n=Ie(s),i=Ie(e.value);return n!==void 0&&i!==void 0&&n<i}case"dateAfter":{const n=Ie(s),i=Ie(e.value);return n!==void 0&&i!==void 0&&n>i}default:return!1}}function Ms(l,e,t,s){if(l.length===0)return;const n={r:e,c:t},i=ee(s==null?void 0:s.v);let r;for(const o of l)oe(n,o.range)&&zs(i,o)&&(r={...r||{},...o.style});return r}function Pt(l,e,t,s){const n=[];for(const i of l){const r=Ve(i);if(!r)continue;const o=r.range,a=e==="row"?K({r:Te(o[0].r,t,s),c:o[0].c},{r:Te(o[1].r,t,s),c:o[1].c}):K({r:o[0].r,c:Te(o[0].c,t,s)},{r:o[1].r,c:Te(o[1].c,t,s)});n.push({...Ce(r),range:Et(a)})}return n}function kt(l,e,t,s,n){const i=[];for(const r of l){const o=Ve(r);if(!o)continue;const a=o.range,h=e==="row"?K({r:_(a[0].r,t,s,n),c:a[0].c},{r:_(a[1].r,t,s,n),c:a[1].c}):K({r:a[0].r,c:_(a[0].c,t,s,n)},{r:a[1].r,c:_(a[1].c,t,s,n)});i.push({...Ce(o),range:Et(h)})}return i}function Ot(l){const e={};for(const t of Object.keys(l)){const s=l[t];s!==void 0&&(e[t]=s)}return Object.keys(e).length>0?e:void 0}function Dt(l,e){const t=l?{...l}:{};let s=!1;for(const n of Object.keys(e)){const i=e[n];i!==void 0&&(t[n]=i,s=!0)}if(Object.keys(t).length!==0&&!(!l&&!s))return t}function Ze(l){const e=Math.min(l[0].r,l[1].r),t=Math.min(l[0].c,l[1].c),s=Math.max(l[0].r,l[1].r),n=Math.max(l[0].c,l[1].c);return[{r:e,c:t},{r:s,c:n}]}function ze(l){return{range:Ze(l.range),style:{...l.style}}}function he(l){const e=Ot(l.style);if(e)return{range:Ze(l.range),style:e}}function Oe(l,e){const t=Object.keys(l),s=Object.keys(e);if(t.length!==s.length)return!1;for(const n of t)if(l[n]!==e[n])return!1;return!0}function Is(l,e){return l[0].r<=e[0].r&&l[0].c<=e[0].c&&l[1].r>=e[1].r&&l[1].c>=e[1].c}function Je(l){const e=[];for(let t=l.length-1;t>=0;t--){const s=he(l[t]);if(!s)continue;const n={};for(const i of Object.keys(s.style)){let r=!1;for(const o of e)if(Is(o.range,s.range)&&i in o.style){r=!0;break}r||(n[i]=s.style[i])}Object.keys(n).length>0&&e.push(ze({range:s.range,style:n}))}return e.reverse()}function Lt(l){if(l.length<=1)return l;const e=[...l].sort((s,n)=>s[0]-n[0]),t=[];for(const s of e){const n=t[t.length-1];if(!n){t.push([s[0],s[1]]);continue}if(s[0]<=n[1]+1){n[1]=Math.max(n[1],s[1]);continue}t.push([s[0],s[1]])}return t}function ht(l,e,t,s){if(s===0)return[[l,e]];if(s>0)return e<t?[[l,e]]:l>=t?[[l+s,e+s]]:[[l,e+s]];const n=Math.abs(s),i=t+n-1,r=[];return l<t&&r.push([l,Math.min(e,t-1)]),e>i&&r.push([Math.max(l,i+1)+s,e+s]),Lt(r.filter(([o,a])=>o<=a))}function ct(l,e,t,s,n){const i=t+s,r=[];n<=t?(r.push({start:Number.NEGATIVE_INFINITY,end:n-1,delta:0}),r.push({start:n,end:t-1,delta:s}),r.push({start:t,end:i-1,delta:n-t}),r.push({start:i,end:Number.POSITIVE_INFINITY,delta:0})):(r.push({start:Number.NEGATIVE_INFINITY,end:t-1,delta:0}),r.push({start:t,end:i-1,delta:n-s-t}),r.push({start:i,end:n-1,delta:-s}),r.push({start:n,end:Number.POSITIVE_INFINITY,delta:0}));const o=[];for(const a of r){const h=Math.max(l,a.start),c=Math.min(e,a.end);h>c||o.push([h+a.delta,c+a.delta])}return Lt(o)}function Nt(l,e,t){const s=[];for(const[n,i]of t){if(e==="row"){s.push({range:[{r:n,c:l.range[0].c},{r:i,c:l.range[1].c}],style:{...l.style}});continue}s.push({range:[{r:l.range[0].r,c:n},{r:l.range[1].r,c:i}],style:{...l.style}})}return s}function Wt(l,e){if(l.length<=1)return l.map(ze);const t=[];for(const s of l){const n=he(s);if(!n)continue;const i=t[t.length-1];if(!i||!Oe(i.style,n.style)){t.push(n);continue}if(e==="row"){const a=i.range[0].c===n.range[0].c&&i.range[1].c===n.range[1].c,h=n.range[0].r<=i.range[1].r+1;if(!a||!h){t.push(n);continue}i.range[0].r=Math.min(i.range[0].r,n.range[0].r),i.range[1].r=Math.max(i.range[1].r,n.range[1].r);continue}const r=i.range[0].r===n.range[0].r&&i.range[1].r===n.range[1].r,o=n.range[0].c<=i.range[1].c+1;if(!r||!o){t.push(n);continue}i.range[0].c=Math.min(i.range[0].c,n.range[0].c),i.range[1].c=Math.max(i.range[1].c,n.range[1].c)}return t}function Vt(l,e,t,s){const n=[];for(const i of l){const r=he(i);if(!r)continue;const o=e==="row"?ht(r.range[0].r,r.range[1].r,t,s):ht(r.range[0].c,r.range[1].c,t,s);n.push(...Nt(r,e,o))}return Je(Wt(n,e))}function $t(l,e,t,s,n){const i=[];for(const r of l){const o=he(r);if(!o)continue;const a=e==="row"?ct(o.range[0].r,o.range[1].r,t,s,n):ct(o.range[0].c,o.range[1].c,t,s,n);i.push(...Nt(o,e,a))}return Je(Wt(i,e))}function dt(l,e){const t=Ze(e),s=[];for(const n of l){const i=he(n);if(!i)continue;const r=Math.max(i.range[0].r,t[0].r),o=Math.min(i.range[1].r,t[1].r),a=Math.max(i.range[0].c,t[0].c),h=Math.min(i.range[1].c,t[1].c);r>o||a>h||s.push({range:[{r,c:a},{r:o,c:h}],style:{...i.style}})}return s}function Ts(l,e,t){const s=[];for(const n of l){const i=he(n);if(!i)continue;const r=i.range[0].r+e,o=i.range[1].r+e,a=i.range[0].c+t,h=i.range[1].c+t;o<1||h<1||s.push({range:[{r:Math.max(1,r),c:Math.max(1,a)},{r:Math.max(1,o),c:Math.max(1,h)}],style:{...i.style}})}return s}function Gt(l,e,t){let s;for(const n of l)e<n.range[0].r||e>n.range[1].r||t<n.range[0].c||t>n.range[1].c||(s=Dt(s,n.style));return s}function be(l,e){return[{r:l.r,c:l.c},{r:l.r+e.rs-1,c:l.c+e.cs-1}]}function ut(l,e,t,s){if(s>0)return t<=l?[l+s,e+s]:t<=e?[l,e+s]:[l,e];const n=Math.abs(s),i=t,r=t+n-1;if(r<l)return[l+s,e+s];if(i>e)return[l,e];const o=Math.max(l,i),h=Math.min(e,r)-o+1,c=e-l+1-h;return c<=0?null:i<=l?[i,i+c-1]:[l,l+c-1]}function xs(l,e,t,s,n){const i=ut(l.r,l.r+e.rs-1,t==="row"?s:Number.NEGATIVE_INFINITY,t==="row"?n:0);if(!i)return null;const r=ut(l.c,l.c+e.cs-1,t==="column"?s:Number.NEGATIVE_INFINITY,t==="column"?n:0);if(!r)return null;const[o,a]=i,[h,c]=r,u=a-o+1,d=c-h+1;return u<=1&&d<=1?null:{anchor:{r:o,c:h},span:{rs:u,cs:d}}}function As(l,e,t,s,n,i){const r=t==="row"?l.r+e.rs-1:l.c+e.cs-1,o=t==="row"?l.r:l.c,a=_(o,s,n,i),h=_(r,s,n,i),c=Math.min(a,h),d=Math.max(a,h)-c+1;if(t==="row"){const g=d,y=e.cs;return g<=1&&y<=1?null:{anchor:{r:c,c:l.c},span:{rs:g,cs:y}}}const f=e.rs,m=d;return f<=1&&m<=1?null:{anchor:{r:l.r,c},span:{rs:f,cs:m}}}function Ut(l,e,t,s){const n=new Map;for(const[i,r]of l){const o=B(i),a=xs(o,r,e,t,s);a&&n.set(T(a.anchor),a.span)}return n}function Kt(l,e,t,s,n){const i=new Map;for(const[r,o]of l){const a=B(r),h=As(a,o,e,t,s,n);h&&i.set(T(h.anchor),h.span)}return i}function Hs(l,e,t,s,n){const i=t==="row"?l.r:l.c,r=t==="row"?l.r+e.rs-1:l.c+e.cs-1,o=s+n-1;return r<s||i>o?!1:!(i>=s&&r<=o)}class ft{constructor(e){p(this,"customSizes");p(this,"defaultSize");p(this,"cacheDirty",!0);p(this,"sortedIndices",[]);p(this,"sortedSizes",[]);p(this,"prefixDeltas",[]);p(this,"customStarts",[]);this.defaultSize=e,this.customSizes=new Map}getSize(e){return this.customSizes.get(e)??this.defaultSize}setSize(e,t){t===this.defaultSize?this.customSizes.delete(e):this.customSizes.set(e,t),this.cacheDirty=!0}getDefaultSize(){return this.defaultSize}getOffset(e){let t=(e-1)*this.defaultSize;if(this.customSizes.size===0)return t;this.ensureCache();const s=this.lowerBound(this.sortedIndices,e)-1;return s>=0&&(t+=this.prefixDeltas[s]),t}findIndex(e){if(e<0)return 1;if(this.customSizes.size===0)return Math.floor(e/this.defaultSize)+1;this.ensureCache();const t=this.customStarts[0];if(e<t)return Math.floor(e/this.defaultSize)+1;const s=this.upperBound(this.customStarts,e)-1,n=this.sortedIndices[s],i=this.customStarts[s],r=this.sortedSizes[s];if(e<i+r)return n;const o=e-(i+r);return n+1+Math.floor(o/this.defaultSize)}shift(e,t){const s=new Map;for(const[n,i]of this.customSizes)if(t>0)n>=e?s.set(n+t,i):s.set(n,i);else{const r=Math.abs(t);n>=e&&n<e+r||(n>=e+r?s.set(n+t,i):s.set(n,i))}this.customSizes=s,this.cacheDirty=!0}move(e,t,s){const n=new Map;for(const[i,r]of this.customSizes)n.set(_(i,e,t,s),r);this.customSizes=n,this.cacheDirty=!0}clear(){this.customSizes.clear(),this.cacheDirty=!0}hasCustomSizes(){return this.customSizes.size>0}ensureCache(){if(!this.cacheDirty)return;if(this.customSizes.size===0){this.sortedIndices=[],this.sortedSizes=[],this.prefixDeltas=[],this.customStarts=[],this.cacheDirty=!1;return}const e=Array.from(this.customSizes.entries()).sort((s,n)=>s[0]-n[0]);this.sortedIndices=[],this.sortedSizes=[],this.prefixDeltas=[],this.customStarts=[];let t=0;for(const[s,n]of e)this.sortedIndices.push(s),this.sortedSizes.push(n),this.customStarts.push((s-1)*this.defaultSize+t),t+=n-this.defaultSize,this.prefixDeltas.push(t);this.cacheDirty=!1}lowerBound(e,t){let s=0,n=e.length;for(;s<n;){const i=s+Math.floor((n-s)/2);e[i]<t?s=i+1:n=i}return s}upperBound(e,t){let s=0,n=e.length;for(;s<n;){const i=s+Math.floor((n-s)/2);e[i]<=t?s=i+1:n=i}return s}}class Yt{constructor(){p(this,"rowIndex",new Map);p(this,"colIndex",new Map)}add(e,t){let s=this.rowIndex.get(e);s||(s=new Set,this.rowIndex.set(e,s)),s.add(t);let n=this.colIndex.get(t);n||(n=new Set,this.colIndex.set(t,n)),n.add(e)}remove(e,t){const s=this.rowIndex.get(e);s&&(s.delete(t),s.size===0&&this.rowIndex.delete(e));const n=this.colIndex.get(t);n&&(n.delete(e),n.size===0&&this.colIndex.delete(t))}has(e,t){const s=this.rowIndex.get(e);return s!==void 0&&s.has(t)}clear(){this.rowIndex.clear(),this.colIndex.clear()}rebuild(e){this.clear();for(const[t,s]of e)this.add(t,s)}*cellsInRange(e){const[t,s]=e;for(const[n,i]of this.rowIndex)if(!(n<t.r||n>s.r))for(const r of i)r>=t.c&&r<=s.c&&(yield[n,r])}hasAnyInRange(e){return!this.cellsInRange(e).next().done}getOccupiedColsInRow(e){return this.rowIndex.get(e)}getOccupiedRowsInCol(e){return this.colIndex.get(e)}get size(){let e=0;for(const t of this.rowIndex.values())e+=t.size;return e}}function _t(l,e,t,s,n){const i=t==="left"||t==="right",r=t==="down"||t==="right",o=i?e.c:e.r,a=i?s[0].c:s[0].r,h=i?s[1].c:s[1].r,c=i?l.getOccupiedColsInRow(e.r):l.getOccupiedRowsInCol(e.c);let u;if(c&&n){const z=new Set;for(const I of c){const k=i?e.r:I,M=i?I:e.c;n(k,M)&&z.add(I)}u=z.size>0?z:void 0}else u=c;if(!u||u.size===0)return pt(e,t,s);const d=Array.from(u).sort((z,I)=>z-I);r||d.reverse();const f=r?d.filter(z=>z>o):d.filter(z=>z<o),m=u.has(o),g=r?o+1:o-1,y=oe(i?{r:e.r,c:g}:{r:g,c:e.c},s)&&u.has(g);if(m&&y){let z=o,I=g;for(;(r?I<=h:I>=a)&&u.has(I);)z=I,I=r?I+1:I-1;return i?{r:e.r,c:z}:{r:z,c:e.c}}if(f.length>0){const z=f[0];return i?{r:e.r,c:z}:{r:z,c:e.c}}return pt(e,t,s)}function pt(l,e,t){switch(e){case"up":return{r:t[0].r,c:l.c};case"down":return{r:t[1].r,c:l.c};case"left":return{r:l.r,c:t[0].c};case"right":return{r:l.r,c:t[1].c}}}class Bs{constructor(e){p(this,"grid");p(this,"cellIndex",new Yt);p(this,"rowHeights",new Map);p(this,"colWidths",new Map);p(this,"colStyles",new Map);p(this,"rowStyles",new Map);p(this,"sheetStyle");p(this,"rangeStyles",[]);p(this,"conditionalFormats",[]);p(this,"merges",new Map);p(this,"filterState");p(this,"hiddenState");p(this,"frozenRows",0);p(this,"frozenCols",0);this.grid=e||new Map,this.rebuildIndex()}async set(e,t){this.grid.set(T(e),t),this.cellIndex.add(e.r,e.c)}async get(e){return this.grid.get(T(e))}async has(e){return this.grid.has(T(e))}async delete(e){const t=this.grid.delete(T(e));return t&&this.cellIndex.remove(e.r,e.c),t}async deleteRange(e){const t=new Set,s=[];for(const[n,i]of this.cellIndex.cellsInRange(e)){const r=T({r:n,c:i});this.grid.delete(r),t.add(r),s.push([n,i])}for(const[n,i]of s)this.cellIndex.remove(n,i);return t}async setGrid(e){for(const[t,s]of e){this.grid.set(t,s);const n=B(t);this.cellIndex.add(n.r,n.c)}}async getGrid(e){const t=new Map;for(const[s,n]of this.cellIndex.cellsInRange(e)){const i=T({r:s,c:n}),r=this.grid.get(i);r!==void 0&&t.set(i,r)}return t}async findEdge(e,t,s){return _t(this.cellIndex,e,t,s,(n,i)=>{const r=this.grid.get(T({r:n,c:i}));return r!==void 0&&(!!r.v||!!r.f)})}async shiftCells(e,t,s){if(this.grid=ws(this.grid,e,t,s),this.rebuildIndex(),e==="row"?(this.rowHeights=Z(this.rowHeights,t,s),this.rowStyles=Z(this.rowStyles,t,s)):(this.colWidths=Z(this.colWidths,t,s),this.colStyles=Z(this.colStyles,t,s)),this.rangeStyles=Vt(this.rangeStyles,e,t,s),this.conditionalFormats=Pt(this.conditionalFormats,e,t,s),this.merges=Ut(this.merges,e,t,s),this.hiddenState){const n=e==="row"?"rows":"columns",i=new Map;for(const o of this.hiddenState[n])i.set(o,1);const r=Z(i,t,s);this.hiddenState[n]=Array.from(r.keys()).sort((o,a)=>o-a)}}async moveCells(e,t,s,n){if(this.grid=ps(this.grid,e,t,s,n),this.rebuildIndex(),e==="row"?(this.rowHeights=Q(this.rowHeights,t,s,n),this.rowStyles=Q(this.rowStyles,t,s,n)):(this.colWidths=Q(this.colWidths,t,s,n),this.colStyles=Q(this.colStyles,t,s,n)),this.rangeStyles=$t(this.rangeStyles,e,t,s,n),this.conditionalFormats=kt(this.conditionalFormats,e,t,s,n),this.merges=Kt(this.merges,e,t,s,n),this.hiddenState){const i=e==="row"?"rows":"columns",r=new Map;for(const a of this.hiddenState[i])r.set(a,1);const o=Q(r,t,s,n);this.hiddenState[i]=Array.from(o.keys()).sort((a,h)=>a-h)}}async getFormulaGrid(){const e=new Map;for(const[t,s]of this.grid)s.f&&e.set(t,s);return e}async buildDependantsMap(e){const t=Array.from(this.grid.entries()),s=new Map;for(const[n,i]of t)if(i.f)for(const r of Bt(Qe(i.f)))Le(r)||(s.has(r)||s.set(r,new Set),s.get(r).add(n));return s}getPresences(){return[]}async setDimensionSize(e,t,s){(e==="row"?this.rowHeights:this.colWidths).set(t,s)}async getDimensionSizes(e){return new Map(e==="row"?this.rowHeights:this.colWidths)}updateActiveCell(e){}async setColumnStyle(e,t){this.colStyles.set(e,t)}async getColumnStyles(){return new Map(this.colStyles)}async setRowStyle(e,t){this.rowStyles.set(e,t)}async getRowStyles(){return new Map(this.rowStyles)}async setSheetStyle(e){this.sheetStyle=e}async getSheetStyle(){return this.sheetStyle?{...this.sheetStyle}:void 0}async addRangeStyle(e){const t=he(e);t&&this.rangeStyles.push(ze(t))}async setRangeStyles(e){this.rangeStyles=e.map(t=>he(t)).filter(t=>!!t).map(t=>ze(t))}async getRangeStyles(){return this.rangeStyles.map(e=>ze(e))}async setConditionalFormats(e){this.conditionalFormats=e.map(t=>Ve(t)).filter(t=>!!t).map(t=>Ce(t))}async getConditionalFormats(){return this.conditionalFormats.map(e=>Ce(e))}async setMerge(e,t){this.merges.set(T(e),{...t})}async deleteMerge(e){return this.merges.delete(T(e))}async getMerges(){return new Map(this.merges)}async setFilterState(e){if(!e){this.filterState=void 0;return}this.filterState={range:[{...e.range[0]},{...e.range[1]}],columns:Object.fromEntries(Object.entries(e.columns).map(([t,s])=>[t,{...s}])),hiddenRows:[...e.hiddenRows]}}async getFilterState(){if(this.filterState)return{range:[{...this.filterState.range[0]},{...this.filterState.range[1]}],columns:Object.fromEntries(Object.entries(this.filterState.columns).map(([e,t])=>[e,{...t}])),hiddenRows:[...this.filterState.hiddenRows]}}async setHiddenState(e){if(!e){this.hiddenState=void 0;return}this.hiddenState={rows:[...e.rows],columns:[...e.columns]}}async getHiddenState(){if(this.hiddenState)return{rows:[...this.hiddenState.rows],columns:[...this.hiddenState.columns]}}async setFreezePane(e,t){this.frozenRows=e,this.frozenCols=t}async getFreezePane(){return{frozenRows:this.frozenRows,frozenCols:this.frozenCols}}beginBatch(){}endBatch(){}async undo(){return{success:!1}}async redo(){return{success:!1}}canUndo(){return!1}canRedo(){return!1}rebuildIndex(){this.cellIndex.rebuild(Array.from(this.grid.keys()).map(e=>{const t=B(e);return[t.r,t.c]}))}}class An{constructor(){p(this,"grid",new Map);p(this,"cellIndex",new Yt)}loadQueryResults(e,t){this.grid.clear();for(let s=0;s<e.length;s++){const n=T({r:1,c:s+1});this.grid.set(n,{v:e[s].name,s:{b:!0}})}for(let s=0;s<t.length;s++){const n=t[s];for(let i=0;i<e.length;i++){const r=n[e[i].name];if(r==null)continue;const o=T({r:s+2,c:i+1});this.grid.set(o,{v:String(r)})}}this.rebuildIndex()}async set(e,t){}async get(e){return this.grid.get(T(e))}async has(e){return this.grid.has(T(e))}async delete(e){return!1}async deleteRange(e){return new Set}async setGrid(e){}async getGrid(e){const t=new Map;for(const[s,n]of this.cellIndex.cellsInRange(e)){const i=T({r:s,c:n}),r=this.grid.get(i);r!==void 0&&t.set(i,r)}return t}async findEdge(e,t,s){return _t(this.cellIndex,e,t,s,(n,i)=>{const r=this.grid.get(T({r:n,c:i}));return r!==void 0&&(!!r.v||!!r.f)})}async shiftCells(e,t,s){}async moveCells(e,t,s,n){}async buildDependantsMap(e){return new Map}async getFormulaGrid(){return new Map}getPresences(){return[]}updateActiveCell(e){}async setDimensionSize(e,t,s){}async getDimensionSizes(e){return new Map}async setColumnStyle(e,t){}async getColumnStyles(){return new Map}async setRowStyle(e,t){}async getRowStyles(){return new Map}async setSheetStyle(e){}async getSheetStyle(){}async addRangeStyle(e){}async setRangeStyles(e){}async getRangeStyles(){return[]}async setConditionalFormats(e){}async getConditionalFormats(){return[]}async setMerge(e,t){}async deleteMerge(e){return!1}async getMerges(){return new Map}async setFilterState(e){}async getFilterState(){}async setHiddenState(e){}async getHiddenState(){}async setFreezePane(e,t){}async getFreezePane(){return{frozenRows:0,frozenCols:0}}beginBatch(){}endBatch(){}async undo(){return{success:!1}}async redo(){return{success:!1}}canUndo(){return!1}canRedo(){return!1}rebuildIndex(){this.cellIndex.rebuild(Array.from(this.grid.keys()).map(e=>{const t=B(e);return[t.r,t.c]}))}}function gt(l,e){if(l===e)return!0;if(!l||!e)return!1;const t=Object.keys(l),s=Object.keys(e);if(t.length!==s.length)return!1;for(const n of t)if(l[n]!==e[n])return!1;return!0}async function ie(l,e,t){const[s,n]=Es(e,t);for(const i of s){const r=B(i);if(!await l.hasFormula(r))continue;const o=await l.getCell(r);if(n.has(i)){const d={v:"#REF!",f:o.f,s:o.s};if(o.v===d.v&&o.f===d.f&&gt(o.s,d.s))continue;await l.setCell(r,d);continue}const a=Qe(o.f),h=await l.fetchGridByReferences(a),u={v:await ns(o.f,h),f:o.f,s:o.s};o.v===u.v&&o.f===u.f&&gt(o.s,u.s)||await l.setCell(r,u)}}function Es(l,e){const t=[],s=new Set,n=new Set,i=new Set,r=o=>{if(i.has(o))for(const a of i)s.add(a);if(i.add(o),!n.has(o)){if(n.add(o),l.has(o))for(const a of l.get(o))r(a);t.push(o)}i.delete(o)};for(const o of e)r(o);return[t.reverse(),s]}function mt(l){let e=1/0,t=1/0,s=0,n=0;for(const[r]of l.entries()){const{r:o,c:a}=B(r);e=Math.min(e,o),t=Math.min(t,a),s=Math.max(s,o),n=Math.max(n,a)}const i=Array.from({length:s-e+1},()=>Array(n-t+1).fill(""));for(const[r,o]of l.entries()){const{r:a,c:h}=B(r);i[a-e][h-t]=o.v||o.f||""}return i.map(r=>r.join("	")).join(`
`)}function Ps(l,e){let t=l.r,s=l.c;const n=new Map,i=e.split(`
`);for(const r of i){const o=r.split("	");for(const a of o)n.set(T({r:t,c:s}),{v:a}),s+=1;t+=1,s=l.c}return n}function yt(l){const e=l.match(/rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/);if(!e)return;const t=parseInt(e[1],10),s=parseInt(e[2],10),n=parseInt(e[3],10);if(!(t===255&&s===255&&n===255))return"#"+t.toString(16).padStart(2,"0")+s.toString(16).padStart(2,"0")+n.toString(16).padStart(2,"0")}function ks(l){return l.includes("google-sheets-html-origin")||l.includes("data-sheets-value")||l.includes("urn:schemas-microsoft-com:office:excel")||l.includes('xmlns:x="urn:schemas-microsoft-com:office:excel"')}function Os(l,e){const n=new DOMParser().parseFromString(l,"text/html").querySelector("table");if(!n)return new Map;const i=new Map,r=n.querySelectorAll("tr");for(let o=0;o<r.length;o++){const a=r[o].querySelectorAll("td, th");for(let h=0;h<a.length;h++){const c=a[h],u=c.textContent||"";if(!u&&!c.style.cssText)continue;const d={v:u},f={};let m=!1;const g=c.style.fontWeight;if((g==="bold"||g==="700")&&(f.b=!0,m=!0),c.style.fontStyle==="italic"&&(f.i=!0,m=!0),c.style.backgroundColor){const y=yt(c.style.backgroundColor);y&&(f.bg=y,m=!0)}if(c.style.color){const y=yt(c.style.color);y&&(f.tc=y,m=!0)}if(c.style.textAlign){const y=c.style.textAlign;(y==="left"||y==="center"||y==="right")&&(f.al=y,m=!0)}m&&(d.s=f),i.set(T({r:e.r+o,c:e.c+h}),d)}}return i}const Xt="en-US",wt="USD",Ds=new Set(["AT","BE","CY","DE","EE","ES","FI","FR","GR","HR","IE","IT","LT","LU","LV","MT","NL","PT","SI","SK"]),Ls={AE:"AED",AR:"ARS",AU:"AUD",BD:"BDT",BR:"BRL",CA:"CAD",CH:"CHF",CL:"CLP",CN:"CNY",CO:"COP",CZ:"CZK",DK:"DKK",EG:"EGP",GB:"GBP",HK:"HKD",HU:"HUF",ID:"IDR",IL:"ILS",IN:"INR",JP:"JPY",KE:"KES",KR:"KRW",KW:"KWD",MX:"MXN",MY:"MYR",NG:"NGN",NO:"NOK",NZ:"NZD",PE:"PEN",PH:"PHP",PK:"PKR",PL:"PLN",QA:"QAR",RO:"RON",RU:"RUB",SA:"SAR",SE:"SEK",SG:"SGD",TH:"THB",TR:"TRY",TW:"TWD",UA:"UAH",US:"USD",VN:"VND",ZA:"ZAR"},Ct=new Map;function et(l){return l&&l.trim()?l.trim():typeof navigator<"u"&&navigator.language?navigator.language:Intl.DateTimeFormat().resolvedOptions().locale||Xt}function Ns(l){const[e]=l.replace(/_/g,"-").split("-u-"),t=e.split("-").filter(Boolean);for(let s=1;s<t.length;s++){const n=t[s];if(/^[a-z]{2}$/i.test(n))return n.toUpperCase()}try{const s=new Intl.Locale(l).maximize().region;if(s)return s.toUpperCase()}catch{}}function Ke(l,e,t){try{return new Intl.NumberFormat(e,t).format(l)}catch{return new Intl.NumberFormat(Xt,t).format(l)}}function Ws(l,e){const t=String(l.getFullYear()).padStart(4,"0"),s=String(l.getMonth()+1).padStart(2,"0"),n=String(l.getDate()).padStart(2,"0");return`${t}-${s}-${n}`}function Vs(){return et()}function jt(l){const e=et(l),t=Ct.get(e);if(t)return t;const s=Ns(e);let n=wt;return s&&(n=Ds.has(s)?"EUR":Ls[s]??wt),Ct.set(e,n),n}function Hn(l){const e=et(l),t=jt(e);return{locale:e,currency:t,number:Ke(1234.56,e,{minimumFractionDigits:2,maximumFractionDigits:2}),currencyValue:Ke(1234.56,e,{style:"currency",currency:t,minimumFractionDigits:2,maximumFractionDigits:2}),percent:Ke(.1234,e,{style:"percent",minimumFractionDigits:2,maximumFractionDigits:2}),date:Ws(new Date(2026,1,18))}}function xe(l,e,t){try{return l.toLocaleString(e,t)}catch{return l.toLocaleString("en-US",t)}}function $s(l){const e=l.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(e){const s=Number(e[1]),n=Number(e[2]),i=Number(e[3]),r=new Date(s,n-1,i);return r.getFullYear()===s&&r.getMonth()===n-1&&r.getDate()===i?r:void 0}const t=new Date(l);if(!isNaN(t.getTime()))return t}function Gs(l,e){const t=$s(l);if(!t)return l;const s=String(t.getFullYear()).padStart(4,"0"),n=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0");return`${s}-${n}-${i}`}function Xe(l,e,t,s){if(!e||e==="plain"||l==="")return l;const n=t??2,i=(s==null?void 0:s.locale)??Vs(),r=(s==null?void 0:s.currency)??jt(i);switch(e){case"number":{const o=Number(l);return isNaN(o)?l:xe(o,i,{minimumFractionDigits:n,maximumFractionDigits:n})}case"currency":{const o=Number(l);return isNaN(o)?l:t===void 0?xe(o,i,{style:"currency",currency:r}):xe(o,i,{style:"currency",currency:r,minimumFractionDigits:n,maximumFractionDigits:n})}case"percent":{const o=Number(l);return isNaN(o)?l:xe(o,i,{style:"percent",minimumFractionDigits:n,maximumFractionDigits:n})}case"date":return Gs(l);default:return l}}const Us={$:"USD","₩":"KRW"};function vt(l){return l.length>1&&l.startsWith("0")}function Ks(l){if(!l.includes(","))return/^\d+$/.test(l)?l:void 0;const e=l.split(",");if(/^\d{1,3}$/.test(e[0])){for(let t=1;t<e.length;t++)if(!/^\d{3}$/.test(e[t]))return;return e.join("")}}function tt(l,e){if(l.length===0||/\s/.test(l))return;if(e.allowExponent&&/[eE]/.test(l)){const s=l.match(/^([+-])?(\d+(?:\.\d+)?|\.\d+)[eE]([+-]?\d+)$/);if(!s)return;const n=s[1]??"",i=s[2],r=s[3],o=i.startsWith(".")?"0":i.split(".")[0];if(!e.allowPaddedInteger&&vt(o))return;const a=+`${n}${i}e${r}`;return Number.isFinite(a)?a:void 0}const t=l.match(/^([+-])?(\d[\d,]*)(?:\.(\d*))?$/);if(t){const s=t[1]??"",n=t[2],i=t[3],r=Ks(n);if(!r||!e.allowPaddedInteger&&vt(r))return;const o=i!==void 0?`${s}${r}.${i}`:`${s}${r}`,a=Number(o);return Number.isFinite(a)?a:void 0}if(e.allowLeadingDot){const s=l.match(/^([+-])?\.(\d+)$/);if(!s)return;const n=s[1]??"",i=s[2],r=+`${n}0.${i}`;return Number.isFinite(r)?r:void 0}}function qt(l,e,t){const s=new Date(l,e-1,t);if(!(s.getFullYear()!==l||s.getMonth()!==e-1||s.getDate()!==t))return`${String(l).padStart(4,"0")}-${String(e).padStart(2,"0")}-${String(t).padStart(2,"0")}`}function Ys(l){const e=l.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(!e)return;const t=Number(e[1]),s=Number(e[2]),n=Number(e[3]);return qt(t,s,n)}function _s(l,e){const t=l.match(/^(\d{1,2})\/(\d{1,2})$/);if(!t)return;const s=Number(t[1]),n=Number(t[2]);return qt(e,s,n)}function Xs(l){const e=l.match(/^([+-])?\s*([$₩])\s*([0-9][0-9,]*(?:\.[0-9]+)?|\.\d+)$/);if(!e)return;const t=e[1]??"",s=e[2],n=e[3],i=tt(`${t}${n}`,{allowExponent:!1,allowLeadingDot:!0,allowPaddedInteger:!0});if(i!==void 0)return{code:Us[s],value:i}}function js(l){const e=l.match(/^([+-])?\s*([0-9][0-9,]*(?:\.[0-9]+)?|\.\d+)\s*%$/);if(!e)return;const t=e[1]??"",s=e[2],n=tt(`${t}${s}`,{allowExponent:!1,allowLeadingDot:!0,allowPaddedInteger:!0});if(n!==void 0)return n/100}function St(l,e){const t=l.trim();if(t.startsWith("="))return{type:"formula",value:t.slice(1).trimStart()};const s=t.toLowerCase();if(s==="true")return{type:"boolean",value:!0};if(s==="false")return{type:"boolean",value:!1};const n=Xs(t);if(n)return{type:"number",value:n.value,format:`currency:${n.code}`};const i=js(t);if(i!==void 0)return{type:"number",value:i,format:"percent"};const r=Ys(t);if(r)return{type:"date",value:r,format:"yyyy-mm-dd"};const o=new Date().getFullYear(),a=_s(t,o);if(a)return{type:"date",value:a,format:"yyyy-mm-dd"};const h=tt(t,{allowExponent:!0,allowLeadingDot:!0,allowPaddedInteger:!1});return h!==void 0?{type:"number",value:h}:{type:"text",value:t}}const qs={rows:1e6,columns:18278},Qs=5e4,Zs={b:!1,i:!1,u:!1,st:!1,bt:!1,br:!1,bb:!1,bl:!1,tc:"",bg:"",al:"left",va:"top",nf:"plain",dp:2},Js={b:!1,i:!1,u:!1,st:!1,bt:!1,br:!1,bb:!1,bl:!1,tc:"",bg:"",al:"left",va:"top",nf:"plain"};class en{constructor(e){p(this,"store");p(this,"dimension");p(this,"activeCell");p(this,"range");p(this,"selectionType","cell");p(this,"rowDimensions");p(this,"colDimensions");p(this,"frozenRows",0);p(this,"frozenCols",0);p(this,"colStyles",new Map);p(this,"rowStyles",new Map);p(this,"sheetStyle");p(this,"rangeStyles",[]);p(this,"conditionalFormats",[]);p(this,"merges",new Map);p(this,"mergeCoverMap",new Map);p(this,"filterRange");p(this,"filterColumns",new Map);p(this,"hiddenRows",new Set);p(this,"userHiddenRows",new Set);p(this,"userHiddenColumns",new Set);p(this,"copyBuffer");p(this,"gridResolver");this.store=e,this.dimension={...qs},this.activeCell={r:1,c:1}}get dimensionRange(){return[{r:1,c:1},{r:this.dimension.rows,c:this.dimension.columns}]}getDimension(){return this.dimension}setDimensions(e,t){this.rowDimensions=e,this.colDimensions=t}getRowDimensions(){return this.rowDimensions}getColDimensions(){return this.colDimensions}setRowHeight(e,t){var s;(s=this.rowDimensions)==null||s.setSize(e,t),this.store.setDimensionSize("row",e,t)}setColumnWidth(e,t){var s;(s=this.colDimensions)==null||s.setSize(e,t),this.store.setDimensionSize("column",e,t)}async loadDimensions(){if(this.rowDimensions){this.rowDimensions.clear();const e=await this.store.getDimensionSizes("row");for(const[t,s]of e)this.rowDimensions.setSize(t,s)}if(this.colDimensions){this.colDimensions.clear();const e=await this.store.getDimensionSizes("column");for(const[t,s]of e)this.colDimensions.setSize(t,s)}}getFreezePane(){return{frozenRows:this.frozenRows,frozenCols:this.frozenCols}}async setFreezePane(e,t){this.frozenRows=e,this.frozenCols=t,await this.store.setFreezePane(e,t)}async loadFreezePane(){const{frozenRows:e,frozenCols:t}=await this.store.getFreezePane();this.frozenRows=e,this.frozenCols=t}async loadStyles(){this.colStyles=await this.store.getColumnStyles(),this.rowStyles=await this.store.getRowStyles(),this.sheetStyle=await this.store.getSheetStyle(),this.rangeStyles=await this.store.getRangeStyles(),this.conditionalFormats=await this.store.getConditionalFormats()}async loadMerges(){this.merges=await this.store.getMerges(),this.rebuildMergeCoverMap()}async loadFilterState(){const e=await this.store.getFilterState();if(!e){this.filterRange=void 0,this.filterColumns.clear(),this.hiddenRows.clear();return}this.filterRange=K(e.range[0],e.range[1]),this.filterColumns=new Map;for(const[t,s]of Object.entries(e.columns)){const n=Number(t);Number.isFinite(n)&&this.filterColumns.set(n,{...s})}this.normalizeFilterColumnsToRange(),this.hiddenRows=new Set(e.hiddenRows.filter(t=>t>0)),this.pruneHiddenRowsOutsideFilter(),this.ensureActiveCellVisibleAfterFiltering()}async loadHiddenState(){const e=await this.store.getHiddenState();if(this.userHiddenRows.clear(),this.userHiddenColumns.clear(),!!e){for(const t of e.rows)t>=1&&this.userHiddenRows.add(t);for(const t of e.columns)t>=1&&this.userHiddenColumns.add(t)}}async hideRows(e){for(const t of e)t>=1&&this.userHiddenRows.add(t);await this.persistHiddenState(),this.ensureActiveCellVisibleAfterHiding()}async showRows(e){for(const t of e)this.userHiddenRows.delete(t);await this.persistHiddenState()}async hideColumns(e){for(const t of e)t>=1&&this.userHiddenColumns.add(t);await this.persistHiddenState(),this.ensureActiveCellVisibleAfterHiding()}async showColumns(e){for(const t of e)this.userHiddenColumns.delete(t);await this.persistHiddenState()}async persistHiddenState(){if(this.userHiddenRows.size===0&&this.userHiddenColumns.size===0){await this.store.setHiddenState(void 0);return}await this.store.setHiddenState({rows:Array.from(this.userHiddenRows).sort((e,t)=>e-t),columns:Array.from(this.userHiddenColumns).sort((e,t)=>e-t)})}hasFilter(){return!!this.filterRange}getFilterRange(){return this.filterRange?q(this.filterRange):void 0}getHiddenRows(){if(this.userHiddenRows.size===0)return new Set(this.hiddenRows);const e=new Set(this.hiddenRows);for(const t of this.userHiddenRows)e.add(t);return e}getHiddenColumns(){return new Set(this.userHiddenColumns)}getUserHiddenRows(){return new Set(this.userHiddenRows)}getFilteredColumns(){return new Set(this.filterColumns.keys())}getColumnFilterCondition(e){const t=this.filterColumns.get(e);if(t)return{...t,values:t.values?[...t.values]:void 0}}isColumnInFilter(e){return this.filterRange?e>=this.filterRange[0].c&&e<=this.filterRange[1].c:!1}getFilterState(){return this.buildFilterStatePayload()}getColStyles(){return this.colStyles}getRowStyles(){return this.rowStyles}getSheetStyle(){return this.sheetStyle}getRangeStyles(){return this.rangeStyles.map(e=>({range:q(e.range),style:{...e.style}}))}getConditionalFormats(){return this.conditionalFormats.map(e=>Ce(e))}getMerges(){return this.merges}rebuildMergeCoverMap(){this.mergeCoverMap.clear();for(const[e,t]of this.merges){const s=B(e);for(let n=s.r;n<s.r+t.rs;n++)for(let i=s.c;i<s.c+t.cs;i++){const r=T({r:n,c:i});r!==e&&this.mergeCoverMap.set(r,e)}}}getAnchorSrefForRef(e){const t=T(e);return this.merges.has(t)?t:this.mergeCoverMap.get(t)||t}normalizeRefToAnchor(e){return B(this.getAnchorSrefForRef(e))}getMergeForRef(e){const t=this.getAnchorSrefForRef(e),s=this.merges.get(t);if(!s)return;const n=B(t);return{anchorSref:t,anchor:n,span:s,range:be(n,s)}}expandRangeToMergedBoundaries(e){let t=q(e),s=!0;for(;s;){s=!1;for(const[n,i]of this.merges){const r=be(B(n),i);if(!oe(r[0],t)&&!oe(r[1],t)&&!(r[0].r<=t[1].r&&r[1].r>=t[0].r&&r[0].c<=t[1].c&&r[1].c>=t[0].c))continue;const o=Ue(t,r);ce(o,t)||(t=o,s=!0)}}return t}*mergeCoveredSrefs(e,t){for(let s=e.r;s<e.r+t.rs;s++)for(let n=e.c;n<e.c+t.cs;n++)yield T({r:s,c:n})}expandChangedSrefsWithMergeAliases(e){const t=new Set;for(const s of e){const n=this.getAnchorSrefForRef(B(s)),i=this.merges.get(n);if(!i){t.add(s);continue}const r=B(n);for(const o of this.mergeCoveredSrefs(r,i))t.add(o)}return t}getMergesIntersecting(e){const t=[];for(const[s,n]of this.merges){const i=B(s),r=be(i,n);r[0].r<=e[1].r&&r[1].r>=e[0].r&&r[0].c<=e[1].c&&r[1].c>=e[0].c&&t.push({anchorSref:s,anchor:i,span:n,range:r})}return t}resolveEffectiveStyle(e,t,s){const n=this.sheetStyle,i=this.colStyles.get(t),r=this.rowStyles.get(e),o=Gt(this.rangeStyles,e,t);if(!(!n&&!i&&!r&&!o&&!s))return{...n,...i,...r,...o,...s}}async getCell(e){return this.store.get(this.normalizeRefToAnchor(e))}async setCell(e,t){await this.store.set(this.normalizeRefToAnchor(e),t)}async setGrid(e){await this.store.setGrid(e)}async hasFormula(e){const t=await this.getCell(e);return!!(t&&t.f)}async toInputString(e){const t=await this.getCell(e);return t?t.f?t.f:t.v||"":""}async toDisplayString(e){const t=this.normalizeRefToAnchor(e),s=await this.store.get(t);if(!s||!s.v)return"";const n=this.resolveEffectiveStyle(t.r,t.c,s.s);return Xe(s.v,n==null?void 0:n.nf,n==null?void 0:n.dp,{currency:n==null?void 0:n.cu})}toStoredValue(e){switch(e.type){case"number":return e.value.toString();case"date":case"text":return e.value;case"boolean":return e.value?"TRUE":"FALSE"}}applyInferredFormat(e,t){var s;if(t.type==="date"){const n={...e||{},nf:"date"};return delete n.cu,n}if(t.type==="number"&&t.format==="percent"){const n={...e||{},nf:"percent"};return delete n.cu,n}return t.type==="number"&&((s=t.format)!=null&&s.startsWith("currency:"))?{...e||{},nf:"currency",cu:t.format.slice(9)}:e?{...e}:void 0}applyInputInferenceToGrid(e){const t=new Map;for(const[s,n]of e){if(n.f){t.set(s,{...n});continue}const i=St(n.v??""),r=this.applyInferredFormat(n.s,i),o=i.type==="formula"?{f:st(`=${i.value}`)}:{v:this.toStoredValue(i)};t.set(s,this.compactCell(o,r))}return t}async setData(e,t){const s=this.normalizeRefToAnchor(e);this.store.beginBatch();try{const n=await this.store.get(s),i=St(t),r=this.applyInferredFormat(n==null?void 0:n.s,i),o=i.type==="formula"?{f:st(`=${i.value}`)}:{v:this.toStoredValue(i)},a=this.compactCell(o,r);this.isEmptyCell(a)?await this.store.delete(s):await this.store.set(s,a);const h=this.expandChangedSrefsWithMergeAliases([T(s)]),c=await this.store.buildDependantsMap(h);await ie(this,c,h),this.filterRange&&await this.recomputeFilterHiddenRows()}finally{this.store.endBatch()}}async removeData(){this.store.beginBatch();try{const e=this.getRangeOrActiveCell(),t=await this.store.getGrid(e),s=new Set;for(const[r,o]of t){const a=B(r);o.s&&Object.keys(o.s).length>0?await this.store.set(a,{s:o.s}):await this.store.delete(a),s.add(r)}if(s.size===0)return!1;const n=this.expandChangedSrefsWithMergeAliases(s),i=await this.store.buildDependantsMap(n);return await ie(this,i,n),this.filterRange&&await this.recomputeFilterHiddenRows(),!0}finally{this.store.endBatch()}}async insertRows(e,t=1){await this.shiftCells("row",e,t)}async deleteRows(e,t=1){await this.shiftCells("row",e,-t)}async insertColumns(e,t=1){await this.shiftCells("column",e,t)}async deleteColumns(e,t=1){await this.shiftCells("column",e,-t)}async moveRows(e,t,s){await this.moveCells("row",e,t,s)}async moveColumns(e,t,s){await this.moveCells("column",e,t,s)}async shiftCells(e,t,s){var i,r;await this.store.shiftCells(e,t,s),e==="row"?((i=this.rowDimensions)==null||i.shift(t,s),this.rowStyles=Z(this.rowStyles,t,s)):((r=this.colDimensions)==null||r.shift(t,s),this.colStyles=Z(this.colStyles,t,s)),this.rangeStyles=Vt(this.rangeStyles,e,t,s),this.conditionalFormats=Pt(this.conditionalFormats,e,t,s),this.merges=Ut(this.merges,e,t,s),this.rebuildMergeCoverMap(),this.shiftFilterState(e,t,s),this.shiftUserHiddenState(e,t,s);const n=e==="row"?this.activeCell.r:this.activeCell.c;if(s>0&&n>=t)e==="row"?this.activeCell={r:this.activeCell.r+s,c:this.activeCell.c}:this.activeCell={r:this.activeCell.r,c:this.activeCell.c+s};else if(s<0){const o=Math.abs(s);n>=t&&n<t+o?e==="row"?this.activeCell={r:Math.max(1,t),c:this.activeCell.c}:this.activeCell={r:this.activeCell.r,c:Math.max(1,t)}:n>=t+o&&(e==="row"?this.activeCell={r:this.activeCell.r+s,c:this.activeCell.c}:this.activeCell={r:this.activeCell.r,c:this.activeCell.c+s})}this.activeCell=this.normalizeRefToAnchor(this.activeCell),this.store.beginBatch();try{const o=e==="row"?this.frozenRows:this.frozenCols;if(o>0){if(s>0&&t<=o){const a=o+s;e==="row"?this.frozenRows=a:this.frozenCols=a,await this.store.setFreezePane(this.frozenRows,this.frozenCols)}else if(s<0){const a=Math.abs(s);if(t<=o){const h=Math.min(a,o-t+1),c=Math.max(0,o-h);e==="row"?this.frozenRows=c:this.frozenCols=c,await this.store.setFreezePane(this.frozenRows,this.frozenCols)}}}await this.recalculateAllFormulaCells(),this.filterRange&&await this.recomputeFilterHiddenRows()}finally{this.store.endBatch()}}async moveCells(e,t,s,n,i){var r,o;if(!(n>=t&&n<=t+s)){for(const[a,h]of this.merges){const c=B(a);if(Hs(c,h,e,t,s))return}if(await this.store.moveCells(e,t,s,n),e==="row"?((r=this.rowDimensions)==null||r.move(t,s,n),this.rowStyles=Q(this.rowStyles,t,s,n)):((o=this.colDimensions)==null||o.move(t,s,n),this.colStyles=Q(this.colStyles,t,s,n)),this.rangeStyles=$t(this.rangeStyles,e,t,s,n),this.conditionalFormats=kt(this.conditionalFormats,e,t,s,n),this.merges=Kt(this.merges,e,t,s,n),this.rebuildMergeCoverMap(),this.moveFilterState(e,t,s,n),this.moveUserHiddenState(e,t,s,n),this.activeCell=this.normalizeRefToAnchor(ge(this.activeCell,e,t,s,n)),this.range&&(this.range=this.expandRangeToMergedBoundaries([ge(this.range[0],e,t,s,n),ge(this.range[1],e,t,s,n)])),!(i!=null&&i.skipPostRecalculate)){this.store.beginBatch();try{await this.recalculateAllFormulaCells(),this.filterRange&&await this.recomputeFilterHiddenRows()}finally{this.store.endBatch()}}}}async recalculateAllFormulaCells(){const e=new Set,t=[{r:1,c:1},{r:1e3,c:100}],s=await this.store.getGrid(t);for(const[n,i]of s)i.f&&e.add(n);if(e.size>0){const n=await this.store.buildDependantsMap(e);await ie(this,n,e)}}buildFilterStatePayload(){if(!this.filterRange)return;const e={},t=Array.from(this.filterColumns.entries()).sort((s,n)=>s[0]-n[0]);for(const[s,n]of t)this.isColumnInFilter(s)&&(e[String(s)]={...n});return{range:q(this.filterRange),columns:e,hiddenRows:Array.from(this.hiddenRows).sort((s,n)=>s-n)}}normalizeFilterColumnsToRange(){if(!this.filterRange){this.filterColumns.clear();return}for(const e of this.filterColumns.keys())this.isColumnInFilter(e)||this.filterColumns.delete(e)}pruneHiddenRowsOutsideFilter(){if(!this.filterRange){this.hiddenRows.clear();return}const e=this.filterRange[0].r+1,t=this.filterRange[1].r,s=new Set;for(const n of this.hiddenRows)n>=e&&n<=t&&s.add(n);this.hiddenRows=s}normalizeFilterText(e){if(typeof e=="string")return e;if(e==null)return"";if(typeof e=="number"||typeof e=="boolean")return String(e);if(typeof e=="object"){const t=e;if(t.value!==void 0&&t.value!==e)return this.normalizeFilterText(t.value);if(typeof t.toJSON=="function")try{const s=t.toJSON.call(e);if(s!==e)return this.normalizeFilterText(s)}catch{}}return String(e)}normalizeFilterCondition(e){const t=e.op;if(t==="in"){const n=Array.from(new Set((e.values||[]).map(i=>this.normalizeFilterText(i).trim())));return{op:t,values:n}}if(t==="isEmpty"||t==="isNotEmpty")return{op:t};const s=this.normalizeFilterText(e.value).trim();if(s.length!==0)return{op:t,value:s}}matchesFilterCondition(e,t){const s=this.normalizeFilterText(e).trim(),n=s.toLowerCase(),i=this.normalizeFilterText(t.value).trim().toLowerCase();switch(t.op){case"in":return new Set((t.values||[]).map(r=>this.normalizeFilterText(r).trim())).has(s);case"contains":return n.includes(i);case"notContains":return!n.includes(i);case"equals":return n===i;case"notEquals":return n!==i;case"isEmpty":return n.length===0;case"isNotEmpty":return n.length>0;default:return!0}}async rowMatchesFilters(e,t){for(const[s,n]of this.filterColumns){if(s===t)continue;const i=await this.getCell({r:e,c:s}),r=this.normalizeFilterText(i==null?void 0:i.v);if(!this.matchesFilterCondition(r,n))return!1}return!0}async recomputeFilterHiddenRows(){if(!this.filterRange){this.hiddenRows.clear(),await this.store.setFilterState(void 0);return}if(this.filterRange=K({r:Math.max(1,this.filterRange[0].r),c:Math.max(1,this.filterRange[0].c)},{r:Math.min(this.dimension.rows,this.filterRange[1].r),c:Math.min(this.dimension.columns,this.filterRange[1].c)}),this.filterRange[1].r<=this.filterRange[0].r){this.filterRange=void 0,this.filterColumns.clear(),this.hiddenRows.clear(),await this.store.setFilterState(void 0);return}this.normalizeFilterColumnsToRange();const e=new Set,t=this.filterRange[0].r+1,s=this.filterRange[1].r;if(this.filterColumns.size>0)for(let n=t;n<=s;n++)await this.rowMatchesFilters(n)||e.add(n);this.hiddenRows=e,this.ensureActiveCellVisibleAfterFiltering(),await this.store.setFilterState(this.buildFilterStatePayload())}shiftFilterBoundary(e,t,s){if(s>0)return e>=t?e+s:e;const n=Math.abs(s);return e>=t&&e<t+n?t:e>=t+n?e+s:e}shiftFilterState(e,t,s){if(!this.filterRange)return;if(e==="row"){const o=this.shiftFilterBoundary(this.filterRange[0].r,t,s),a=this.shiftFilterBoundary(this.filterRange[1].r,t,s);this.filterRange=K({r:Math.max(1,o),c:this.filterRange[0].c},{r:Math.max(1,a),c:this.filterRange[1].c});const h=new Map;for(const u of this.hiddenRows)h.set(u,1);const c=Z(h,t,s);this.hiddenRows=new Set(c.keys()),this.pruneHiddenRowsOutsideFilter();return}const n=this.shiftFilterBoundary(this.filterRange[0].c,t,s),i=this.shiftFilterBoundary(this.filterRange[1].c,t,s);this.filterRange=K({r:this.filterRange[0].r,c:Math.max(1,n)},{r:this.filterRange[1].r,c:Math.max(1,i)});const r=new Map;for(const[o,a]of this.filterColumns)r.set(o,a);this.filterColumns=Z(r,t,s),this.normalizeFilterColumnsToRange()}moveFilterState(e,t,s,n){if(!this.filterRange)return;if(e==="row"){const a=_(this.filterRange[0].r,t,s,n),h=_(this.filterRange[1].r,t,s,n);this.filterRange=K({r:a,c:this.filterRange[0].c},{r:h,c:this.filterRange[1].c});const c=new Map;for(const d of this.hiddenRows)c.set(d,1);const u=Q(c,t,s,n);this.hiddenRows=new Set(u.keys()),this.pruneHiddenRowsOutsideFilter();return}const i=_(this.filterRange[0].c,t,s,n),r=_(this.filterRange[1].c,t,s,n);this.filterRange=K({r:this.filterRange[0].r,c:i},{r:this.filterRange[1].r,c:r});const o=new Map;for(const[a,h]of this.filterColumns)o.set(a,h);this.filterColumns=Q(o,t,s,n),this.normalizeFilterColumnsToRange()}shiftUserHiddenState(e,t,s){if(e==="row"&&this.userHiddenRows.size>0){const n=new Map;for(const r of this.userHiddenRows)n.set(r,1);const i=Z(n,t,s);this.userHiddenRows=new Set(i.keys())}if(e==="column"&&this.userHiddenColumns.size>0){const n=new Map;for(const r of this.userHiddenColumns)n.set(r,1);const i=Z(n,t,s);this.userHiddenColumns=new Set(i.keys())}}moveUserHiddenState(e,t,s,n){if(e==="row"&&this.userHiddenRows.size>0){const i=new Map;for(const o of this.userHiddenRows)i.set(o,1);const r=Q(i,t,s,n);this.userHiddenRows=new Set(r.keys())}if(e==="column"&&this.userHiddenColumns.size>0){const i=new Map;for(const o of this.userHiddenColumns)i.set(o,1);const r=Q(i,t,s,n);this.userHiddenColumns=new Set(r.keys())}}isRowHidden(e){return this.hiddenRows.has(e)||this.userHiddenRows.has(e)}isColumnHidden(e){return this.userHiddenColumns.has(e)}ensureActiveCellVisibleAfterFiltering(){if(!this.isRowHidden(this.activeCell.r))return;let e;if(this.filterRange&&this.activeCell.r>this.filterRange[0].r&&this.activeCell.r<=this.filterRange[1].r)e=this.filterRange[0].r;else{for(let t=this.activeCell.r+1;t<=this.dimension.rows;t++)if(!this.isRowHidden(t)){e=t;break}if(e===void 0){for(let t=this.activeCell.r-1;t>=1;t--)if(!this.isRowHidden(t)){e=t;break}}}e!==void 0&&(this.range=void 0,this.setActiveCell({r:e,c:this.activeCell.c}))}ensureActiveCellVisibleAfterHiding(){let{r:e,c:t}=this.activeCell,s=!1;if(this.isRowHidden(e)){const n=this.findNextVisibleRow(e,"down")??this.findNextVisibleRow(e,"up");if(n===void 0)return;e=n,s=!0}if(this.isColumnHidden(t)){const n=this.findNextVisibleColumn(t,"right")??this.findNextVisibleColumn(t,"left");if(n===void 0)return;t=n,s=!0}s&&(this.range=void 0,this.setActiveCell({r:e,c:t}))}findNextVisibleRow(e,t){const s=t==="down"?1:-1;let n=e;for(;n>=1&&n<=this.dimension.rows;){if(!this.isRowHidden(n))return n;n+=s}}findNextVisibleColumn(e,t){const s=t==="right"?1:-1;let n=e;for(;n>=1&&n<=this.dimension.columns;){if(!this.isColumnHidden(n))return n;n+=s}}async fetchGrid(e){return this.store.getGrid(e)}hasCellContent(e){const t=e.v!==void 0&&e.v!==""&&e.v!==null,s=!!e.f;return t||s}isEmptyCell(e){const t=this.hasCellContent(e),s=e.s!==void 0&&Object.keys(e.s).length>0;return!t&&!s}normalizeStylePatch(e){return Ot(e)}mergeStylePatch(e,t){return Dt(e,t)}rangesIntersect(e,t){return e[0].r<=t[1].r&&e[1].r>=t[0].r&&e[0].c<=t[1].c&&e[1].c>=t[0].c}hasConflictingStyleSourceForKey(e,t,s,n){var r;const i=(r=this.sheetStyle)==null?void 0:r[t];if(i!==void 0&&i!==s)return!0;for(const[o,a]of this.colStyles){if(o<e[0].c||o>e[1].c)continue;const h=a[t];if(h!==void 0&&h!==s)return!0}for(const[o,a]of this.rowStyles){if(o<e[0].r||o>e[1].r)continue;const h=a[t];if(h!==void 0&&h!==s)return!0}for(let o=0;o<this.rangeStyles.length;o++){if(n!==void 0&&o===n)continue;const a=this.rangeStyles[o],h=a.style[t];if(!(h===void 0||h===s)&&this.rangesIntersect(e,a.range))return!0}return!1}pruneRedundantDefaultStyleKeys(e,t,s){const n={};for(const i of Object.keys(t)){const r=t[i];if(r===void 0)continue;const o=Zs[i];o!==void 0&&r===o&&!this.hasConflictingStyleSourceForKey(e,i,r,s)||(n[i]=r)}return Object.keys(n).length>0?n:void 0}sameRangeStylePatchList(e,t){if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(!ce(e[s].range,t[s].range)||!Oe(e[s].style,t[s].style))return!1;return!0}compactShadowedRangeStyles(){const e=Je(this.rangeStyles);return this.sameRangeStylePatchList(e,this.rangeStyles)?!1:(this.rangeStyles=e,!0)}containsRange(e,t){return e[0].r<=t[0].r&&e[0].c<=t[0].c&&e[1].r>=t[1].r&&e[1].c>=t[1].c}mergeableColBand(e,t){return e[0].r!==t[0].r||e[1].r!==t[1].r?!1:t[0].c<=e[1].c+1&&e[0].c<=t[1].c+1}mergeableRowBand(e,t){return e[0].c!==t[0].c||e[1].c!==t[1].c?!1:t[0].r<=e[1].r+1&&e[0].r<=t[1].r+1}tryMergeRangeStylePatches(e,t){if(Oe(e.style,t.style)){if(ce(e.range,t.range)||this.containsRange(e.range,t.range))return e;if(this.containsRange(t.range,e.range))return t;if(this.mergeableColBand(e.range,t.range))return{range:[{r:e.range[0].r,c:Math.min(e.range[0].c,t.range[0].c)},{r:e.range[1].r,c:Math.max(e.range[1].c,t.range[1].c)}],style:{...e.style}};if(this.mergeableRowBand(e.range,t.range))return{range:[{r:Math.min(e.range[0].r,t.range[0].r),c:e.range[0].c},{r:Math.max(e.range[1].r,t.range[1].r),c:e.range[1].c}],style:{...e.style}}}}async addRangeStylePatch(e,t){const s=this.normalizeStylePatch(t);if(!s)return;const n=he({range:q(e),style:s});if(!n)return;const i=this.rangeStyles,r=this.pruneRedundantDefaultStyleKeys(n.range,n.style);if(!r)return;n.style=r;const o=i[i.length-1];if(o&&ce(o.range,n.range)){const c=this.mergeStylePatch(o.style,n.style);if(!c)return;const u=this.pruneRedundantDefaultStyleKeys(o.range,c,i.length-1);if(!u){this.rangeStyles=i.slice(0,-1),this.compactShadowedRangeStyles(),await this.store.setRangeStyles(this.rangeStyles);return}if(Oe(u,o.style))return;o.style={...u},this.compactShadowedRangeStyles(),await this.store.setRangeStyles(this.rangeStyles);return}let a=n,h=i.length;for(let c=i.length-1;c>=0;c--){const u=i[c],d=this.tryMergeRangeStylePatches(u,a);if(!d)break;if(ce(d.range,u.range)){if(c===i.length-1)return;this.rangeStyles=i.slice(0,c+1),this.compactShadowedRangeStyles(),await this.store.setRangeStyles(this.rangeStyles);return}a=d,h=c}if(h===i.length){this.rangeStyles.push(a),await this.store.addRangeStyle(a),this.compactShadowedRangeStyles()&&await this.store.setRangeStyles(this.rangeStyles);return}this.rangeStyles=[...i.slice(0,h),a],this.compactShadowedRangeStyles(),await this.store.setRangeStyles(this.rangeStyles)}async applyStylePatchToExistingCells(e,t){const s=this.normalizeStylePatch(t);if(!s)return;const n=await this.store.getGrid(e),i=new Set;for(const[r]of n){const o=B(r),a=this.normalizeRefToAnchor(o),h=T(a);if(i.has(h))continue;i.add(h);const c=await this.store.get(a);if(!(c!=null&&c.s))continue;const u={};for(const d of Object.keys(s)){const f=c.s[d],m=s[d];f===void 0||f===m||(u[d]=m)}Object.keys(u).length!==0&&await this.setStyle(a,u)}}async clearCellStylesInRange(e){const t=await this.store.getGrid(e),s=new Set;for(const[n]of t){const i=B(n),r=this.normalizeRefToAnchor(i),o=T(r);if(s.has(o))continue;s.add(o);const a=await this.store.get(r);if(!(a!=null&&a.s))continue;const h=this.compactCell(a);this.isEmptyCell(h)?await this.store.delete(r):await this.store.set(r,h)}}compactCell(e,t){const s={};return e.v!==void 0&&(s.v=e.v),e.f!==void 0&&(s.f=e.f),t&&Object.keys(t).length>0&&(s.s=t),s}getCopyRange(){var e;return(e=this.copyBuffer)==null?void 0:e.sourceRange}isCutMode(){var e;return((e=this.copyBuffer)==null?void 0:e.isCut)===!0}clearCopyBuffer(){this.copyBuffer=void 0}async copy(){const e=this.getRangeOrActiveCell(),t=await this.fetchGrid(e),s=dt(this.rangeStyles,e),n=mt(t);return this.copyBuffer={sourceRange:e,grid:t,rangeStyles:s,text:n,isCut:!1},{text:n}}async cut(){const e=this.getRangeOrActiveCell(),t=await this.fetchGrid(e),s=dt(this.rangeStyles,e),n=mt(t);return this.copyBuffer={sourceRange:e,grid:t,rangeStyles:s,text:n,isCut:!0},{text:n}}async paste(e){const{text:t,html:s}=e;let n,i=[],r=!1,o=!1,a,h;if(this.copyBuffer&&t===this.copyBuffer.text){n=this.relocateGrid(this.copyBuffer.grid,this.copyBuffer.sourceRange,this.activeCell);const c=this.activeCell.r-this.copyBuffer.sourceRange[0].r,u=this.activeCell.c-this.copyBuffer.sourceRange[0].c;i=Ts(this.copyBuffer.rangeStyles,c,u),this.copyBuffer.isCut&&(o=!0,a=this.copyBuffer.sourceRange,h=this.buildCutRefMap(this.copyBuffer.sourceRange,c,u),this.copyBuffer=void 0)}else if(s&&ks(s))n=Os(s,this.activeCell),r=!0;else if(t)n=Ps(this.activeCell,t),r=!0;else return;r&&(n=this.applyInputInferenceToGrid(n)),this.store.beginBatch();try{await this.setGrid(n);for(const u of i)await this.addRangeStylePatch(u.range,u.style),await this.applyStylePatchToExistingCells(u.range,u.style);const c=new Set;for(const[u]of n)c.add(u);if(c.size>0){const u=this.expandChangedSrefsWithMergeAliases(c),d=await this.store.buildDependantsMap(u);await ie(this,d,u)}o&&a&&h&&(await this.store.deleteRange(a),this.removeRangeStylesOverlapping(a),await this.store.setRangeStyles(this.rangeStyles),await this.redirectFormulasForCut(h)),this.filterRange&&await this.recomputeFilterHiddenRows()}finally{this.store.endBatch()}this.selectPastedRange(n)}selectPastedRange(e){if(e.size===0)return;let t=1/0,s=-1/0,n=1/0,i=-1/0;for(const r of e.keys()){const o=B(r);o.r<t&&(t=o.r),o.r>s&&(s=o.r),o.c<n&&(n=o.c),o.c>i&&(i=o.c)}t===s&&n===i?this.selectStart({r:t,c:n}):(this.selectionType="cell",this.activeCell={r:t,c:n},this.range=[{r:t,c:n},{r:s,c:i}],this.store.updateActiveCell(this.activeCell))}buildCutRefMap(e,t,s){const n=new Map;for(let i=e[0].r;i<=e[1].r;i++)for(let r=e[0].c;r<=e[1].c;r++){const o=T({r:i,c:r}),a=T({r:i+t,c:r+s});n.set(o,a)}return n}removeRangeStylesOverlapping(e){this.rangeStyles=this.rangeStyles.filter(t=>!this.rangesIntersect(e,t.range))}async redirectFormulasForCut(e){const t=await this.store.getFormulaGrid(),s=new Map,n=new Set;for(const[i,r]of t){if(!r.f)continue;const o=gs(r.f,e);o!==r.f&&(s.set(i,{...r,f:o}),n.add(i))}if(s.size>0){await this.store.setGrid(s);const i=this.expandChangedSrefsWithMergeAliases(n),r=await this.store.buildDependantsMap(i);await ie(this,r,i)}}relocateGrid(e,t,s){const n=s.r-t[0].r,i=s.c-t[0].c,r=new Map;for(const[o,a]of e){const h=B(o),c={r:h.r+n,c:h.c+i},u=T(c);if(a.f){const d=lt(a.f,n,i);r.set(u,{f:d,s:a.s})}else r.set(u,{...a})}return r}computeAutofillRange(e,t){if(!oe(t,e))return Ue(e,[t,t])}getAutofillPreviewRange(e){if(this.selectionType!=="cell")return;const t=this.getRangeOrActiveCell();return this.computeAutofillRange(t,e)}positiveMod(e,t){return(e%t+t)%t}cloneCellForAutofill(e,t,s){if(e.f){const i=lt(e.f,t,s);return e.s?{f:i,s:{...e.s}}:{f:i}}const n={};return e.v!==void 0&&(n.v=e.v),e.s&&(n.s={...e.s}),n}async autofill(e){if(this.selectionType!=="cell")return!1;const t=q(this.getRangeOrActiveCell()),s=this.computeAutofillRange(t,e);if(!s||this.getMergesIntersecting(s).length>0)return!1;const n=await this.store.getGrid(t),i=t[1].r-t[0].r+1,r=t[1].c-t[0].c+1,o=new Set;this.store.beginBatch();try{for(let a=s[0].r;a<=s[1].r;a++)for(let h=s[0].c;h<=s[1].c;h++){const c={r:a,c:h};if(oe(c,t))continue;const u={r:t[0].r+this.positiveMod(c.r-t[0].r,i),c:t[0].c+this.positiveMod(c.c-t[0].c,r)},d=n.get(T(u)),f=this.normalizeRefToAnchor(c),m=T(f);if(!d){await this.store.delete(f),o.add(m);continue}const g=c.r-u.r,y=c.c-u.c,z=this.cloneCellForAutofill(d,g,y);this.isEmptyCell(z)?await this.store.delete(f):await this.store.set(f,z),o.add(m)}if(o.size>0){const a=this.expandChangedSrefsWithMergeAliases(o),h=await this.store.buildDependantsMap(a);await ie(this,h,a)}this.filterRange&&await this.recomputeFilterHiddenRows()}finally{this.store.endBatch()}return o.size===0?!1:(this.selectionType="cell",this.range=s,!0)}async hasContents(e){const t=await this.store.getGrid(e);for(const s of t.values())if(this.hasCellContent(s))return!0;return!1}async fetchGridByReferences(e){const t=new Map,s=new Map;for(const n of Bt(e))if(Le(n)){const{sheetName:i,localRef:r}=Ht(n);s.has(i.toUpperCase())||s.set(i.toUpperCase(),new Set),s.get(i.toUpperCase()).add(r)}else{const i=this.normalizeRefToAnchor(B(n)),r=await this.store.get(i);r&&t.set(n,r)}if(this.gridResolver&&s.size>0)for(const[n,i]of s){const r=this.gridResolver(n,i);if(r)for(const[o,a]of r)t.set(`${n}!${o}`,a)}return t}setGridResolver(e){this.gridResolver=e}async recalculateCrossSheetFormulas(){const e=await this.store.getFormulaGrid(),t=new Set;for(const[s,n]of e)!n.f||!Array.from(Qe(n.f)).some(r=>Le(r))||t.add(s);if(t.size!==0){this.store.beginBatch();try{const s=await this.store.buildDependantsMap(t);await ie(this,s,t),this.filterRange&&await this.recomputeFilterHiddenRows()}finally{this.store.endBatch()}}}getActiveCell(){return this.activeCell}setActiveCell(e){const t=this.normalizeRefToAnchor(e);this.activeCell=t,this.store.updateActiveCell(t)}getRange(){return this.range}getPresences(){return this.store.getPresences()}getRangeOrActiveCell(){if(this.range)return this.expandRangeToMergedBoundaries(this.range);const e=this.getMergeForRef(this.activeCell);return e?e.range:[this.activeCell,this.activeCell]}getSelectionType(){return this.selectionType}selectRow(e){this.selectionType="row",this.activeCell={r:e,c:1},this.range=[{r:e,c:1},{r:e,c:this.dimension.columns}],this.store.updateActiveCell(this.activeCell)}selectColumn(e){this.selectionType="column",this.activeCell={r:1,c:e},this.range=[{r:1,c:e},{r:this.dimension.rows,c:e}],this.store.updateActiveCell(this.activeCell)}selectRowRange(e,t){this.selectionType="row";const s=Math.min(e,t),n=Math.max(e,t);this.range=[{r:s,c:1},{r:n,c:this.dimension.columns}]}selectColumnRange(e,t){this.selectionType="column";const s=Math.min(e,t),n=Math.max(e,t);this.range=[{r:1,c:s},{r:this.dimension.rows,c:n}]}selectAllCells(){this.selectionType="all",this.activeCell={r:1,c:1},this.range=q(this.dimensionRange),this.store.updateActiveCell(this.activeCell)}getSelectedIndices(){return this.selectionType==="cell"||this.selectionType==="all"||!this.range?null:this.selectionType==="row"?{axis:"row",from:this.range[0].r,to:this.range[1].r}:{axis:"column",from:this.range[0].c,to:this.range[1].c}}async createFilterFromSelection(){if(this.selectionType!=="cell")return!1;const e=this.getRangeOrActiveCell(),t=await this.expandFilterRangeForHeaderOnlySelection(e);return await this.setFilterRange(t)?(this.selectionType="cell",this.range=q(K(t[0],t[1])),!0):!1}async expandFilterRangeForHeaderOnlySelection(e){const t=K(e[0],e[1]);if(t[0].r!==t[1].r)return t;const s=t[0].r;if(s>=this.dimension.rows)return t;const n=[{r:s+1,c:t[0].c},{r:this.dimension.rows,c:t[1].c}],i=await this.store.getGrid(n);if(i.size===0)return t;const r=new Set;for(const[a,h]of i)this.hasCellContent(h)&&r.add(B(a).r);let o=s;for(;r.has(o+1);)o+=1;return K(t[0],{r:o,c:t[1].c})}async setFilterRange(e){const t=K(e[0],e[1]);if(t[1].r<=t[0].r)return!1;this.store.beginBatch();try{this.filterRange=t,this.normalizeFilterColumnsToRange(),await this.recomputeFilterHiddenRows()}finally{this.store.endBatch()}return!0}async clearFilter(){this.store.beginBatch();try{this.filterRange=void 0,this.filterColumns.clear(),this.hiddenRows.clear(),await this.store.setFilterState(void 0)}finally{this.store.endBatch()}}async setColumnFilter(e,t){if(!this.filterRange||!this.isColumnInFilter(e))return!1;this.store.beginBatch();try{const s=this.normalizeFilterCondition(t);s?this.filterColumns.set(e,s):this.filterColumns.delete(e),await this.recomputeFilterHiddenRows()}finally{this.store.endBatch()}return!0}async filterColumnByValue(e,t){return this.setColumnFilter(e,{op:"equals",value:t})}async clearColumnFilter(e){if(!this.filterRange||!this.isColumnInFilter(e)||!this.filterColumns.has(e))return!1;this.store.beginBatch();try{this.filterColumns.delete(e),await this.recomputeFilterHiddenRows()}finally{this.store.endBatch()}return!0}async getFilterColumnValues(e){if(!this.filterRange||!this.isColumnInFilter(e))return;const t=new Set,s=this.filterRange[0].r+1,n=this.filterRange[1].r;for(let o=s;o<=n;o++){if(!await this.rowMatchesFilters(o,e))continue;const a=await this.getCell({r:o,c:e}),h=this.normalizeFilterText(a==null?void 0:a.v);t.add(h.trim())}const i=Array.from(t).sort((o,a)=>o.localeCompare(a,void 0,{sensitivity:"base"})),r=this.filterColumns.get(e);return r?r.op==="in"?{values:i,selected:new Set((r.values||[]).map(o=>this.normalizeFilterText(o).trim()))}:{values:i,selected:new Set(i.filter(o=>this.matchesFilterCondition(o,r)))}:{values:i,selected:new Set(i)}}async setColumnIncludedValues(e,t){if(!this.filterRange||!this.isColumnInFilter(e))return!1;const s=Array.from(new Set(t.map(o=>this.normalizeFilterText(o).trim()))).sort((o,a)=>o.localeCompare(a,void 0,{sensitivity:"base"})),n=await this.getFilterColumnValues(e);if(!n)return!1;const i=new Set(n.values),r=s.filter(o=>i.has(o));this.store.beginBatch();try{r.length===n.values.length?this.filterColumns.delete(e):this.filterColumns.set(e,{op:"in",values:r}),await this.recomputeFilterHiddenRows()}finally{this.store.endBatch()}return!0}async sortFilterByColumn(e,t){if(!this.filterRange||!this.isColumnInFilter(e))return!1;const s=this.filterRange[0].r+1,n=this.filterRange[1].r;if(n<=s)return!1;const i=[{r:s,c:1},{r:n,c:this.dimension.columns}];if(this.getMergesIntersecting(i).length>0)return!1;const r=[];for(let f=s;f<=n;f++){const m=await this.getCell({r:f,c:e}),g=this.normalizeFilterText(m==null?void 0:m.v).trim(),y=g.length>0&&Number.isFinite(Number(g))?Number(g):null;r.push({row:f,text:g,lower:g.toLowerCase(),numeric:y})}r.sort((f,m)=>{const g=f.text.length===0,y=m.text.length===0;if(g&&!y)return 1;if(!g&&y)return-1;let z=0;return f.numeric!==null&&m.numeric!==null?z=f.numeric-m.numeric:z=f.lower.localeCompare(m.lower,void 0,{sensitivity:"base"}),z===0&&(z=f.row-m.row),t==="asc"?z:-z});const o=r.map(f=>f.row);if(o.every((f,m)=>f===s+m))return!0;const h=new Map;for(let f=0;f<o.length;f++)h.set(o[f],s+f);const c=this.filterRange[0].c,u=this.filterRange[1].c,d=[{r:s,c},{r:n,c:u}];this.store.beginBatch();try{const f=await this.store.getGrid(d),m=new Map;for(const[g,y]of f){const z=B(g),I=h.get(z.r);I!==void 0&&m.set(T({r:I,c:z.c}),y)}await this.store.deleteRange(d),await this.store.setGrid(m),await this.recalculateAllFormulaCells(),await this.recomputeFilterHiddenRows()}finally{this.store.endBatch()}return!0}selectStart(e){oe(e,this.dimensionRange)&&(this.selectionType="cell",this.setActiveCell(this.normalizeRefToAnchor(e)),this.range=void 0)}selectEnd(e){if(!oe(e,this.dimensionRange))return;const t=this.normalizeRefToAnchor(e);if(Fe(this.activeCell,t)){this.range=void 0;return}this.range=this.expandRangeToMergedBoundaries(K(this.activeCell,t))}hasRange(){return!!this.range}async selectAll(){let e=this.getRangeOrActiveCell(),t=q(e),s=!0;for(;s;){s=!1;for(const n of cs(t,this.dimensionRange))await this.hasContents(n)&&(t=Ue(t,n),s=!0)}if(ce(e,t)){this.range=q(this.dimensionRange);return}this.range=t}async moveToEdge(e){const t=this.getMergeForRef(this.activeCell),s={...this.activeCell};t&&(e==="right"?s.c=t.range[1].c:e==="down"&&(s.r=t.range[1].r));const n=await this.store.findEdge(s,e,this.dimensionRange);let i=this.normalizeRefToAnchor(n);if((e==="up"||e==="down")&&this.isRowHidden(i.r)){const r=this.findNextVisibleRow(i.r,e);if(r===void 0)return!1;i=this.normalizeRefToAnchor({r,c:i.c})}if((e==="left"||e==="right")&&this.isColumnHidden(i.c)){const r=this.findNextVisibleColumn(i.c,e);if(r===void 0)return!1;i=this.normalizeRefToAnchor({r:i.r,c:r})}return Fe(this.activeCell,i)?!1:(this.range=void 0,this.setActiveCell(i),!0)}move(e){const t=e==="up"?-1:e==="down"?1:0,s=e==="left"?-1:e==="right"?1:0;let n=this.activeCell.r,i=this.activeCell.c;const r=this.getMergeForRef(this.activeCell);if(r?e==="right"?i=r.range[1].c+1:e==="down"?n=r.range[1].r+1:e==="left"?i-=1:n-=1:(n+=t,i+=s),(e==="up"||e==="down")&&this.isRowHidden(n)){const a=this.findNextVisibleRow(n,e);if(a===void 0)return!1;n=a}if((e==="left"||e==="right")&&this.isColumnHidden(i)){const a=this.findNextVisibleColumn(i,e);if(a===void 0)return!1;i=a}if(!oe({r:n,c:i},this.dimensionRange))return!1;const o=this.normalizeRefToAnchor({r:n,c:i});return Fe(this.activeCell,o)?!1:(this.range=void 0,this.setActiveCell(o),!0)}resizeRange(e){const t=e==="up"?-1:e==="down"?1:0,s=e==="left"?-1:e==="right"?1:0;let n=q(this.getRangeOrActiveCell());if(t!==0){const i=t>0?"down":"up",r=o=>this.isRowHidden(o)?this.findNextVisibleRow(o,i):o;if(this.activeCell.r===n[1].r){const o=r(n[0].r+t);if(o===void 0)return!1;n[0].r=o}else{const o=r(n[1].r+t);if(o===void 0)return!1;n[1].r=o}}if(s!==0){const i=s>0?"right":"left",r=o=>this.isColumnHidden(o)?this.findNextVisibleColumn(o,i):o;if(this.activeCell.c===n[1].c){const o=r(n[0].c+s);if(o===void 0)return!1;n[0].c=o}else{const o=r(n[1].c+s);if(o===void 0)return!1;n[1].c=o}}return n=K(n[0],n[1]),hs(n,this.dimensionRange)?(this.range=this.expandRangeToMergedBoundaries(n),!0):!1}async getStyle(e){const t=this.normalizeRefToAnchor(e),s=await this.store.get(t);return this.resolveEffectiveStyle(t.r,t.c,s==null?void 0:s.s)}async setStyle(e,t){const s=this.normalizeStylePatch(t);if(!s)return;const n=this.normalizeRefToAnchor(e),i=await this.store.get(n)||{},r=this.mergeStylePatch(i.s,s),o=this.compactCell(i,r);if(this.isEmptyCell(o)){await this.store.delete(n);return}await this.store.set(n,o)}async setRangeStyle(e){this.store.beginBatch();try{if(this.selectionType==="column"){const s=this.getRangeOrActiveCell();for(let n=s[0].c;n<=s[1].c;n++){const i=this.mergeStylePatch(this.colStyles.get(n),e);i&&(this.colStyles.set(n,i),await this.store.setColumnStyle(n,i))}return}if(this.selectionType==="row"){const s=this.getRangeOrActiveCell();for(let n=s[0].r;n<=s[1].r;n++){const i=this.mergeStylePatch(this.rowStyles.get(n),e);i&&(this.rowStyles.set(n,i),await this.store.setRowStyle(n,i))}return}if(this.selectionType==="all"){const s=this.mergeStylePatch(this.sheetStyle,e);if(!s)return;this.sheetStyle=s,await this.store.setSheetStyle(s);return}const t=this.getRangeOrActiveCell();await this.addRangeStylePatch(t,e),await this.applyStylePatchToExistingCells(t,e)}finally{this.store.endBatch()}}async resetRangeStyleToDefault(){if(this.selectionType!=="cell")return!1;const e=this.getRangeOrActiveCell();this.store.beginBatch();try{await this.addRangeStylePatch(e,Js),await this.clearCellStylesInRange(e)}finally{this.store.endBatch()}return!0}async setConditionalFormats(e){const t=e.map(s=>Ve(s)).filter(s=>!!s).map(s=>Ce(s));this.conditionalFormats=t,await this.store.setConditionalFormats(this.conditionalFormats)}async setRangeBorders(e){if(this.selectionType!=="cell")return!1;const t=this.getRangeOrActiveCell(),s=t[1].r-t[0].r+1,n=t[1].c-t[0].c+1;if(s*n>Qs)return!1;const i=this.collectBorderTargets(t);this.store.beginBatch();try{for(const{anchor:r,range:o}of i){const a=this.toBorderPatchForPreset(e,t,o);await this.setStyle(r,a)}}finally{this.store.endBatch()}return!0}async toggleRangeStyle(e){const t=await this.getStyle(this.activeCell),s=!(t!=null&&t[e]);await this.setRangeStyle({[e]:s})}collectBorderTargets(e){const t=[],s=new Set;for(let n=e[0].r;n<=e[1].r;n++)for(let i=e[0].c;i<=e[1].c;i++){const r=this.normalizeRefToAnchor({r:n,c:i}),o=T(r);if(s.has(o))continue;s.add(o);const a=this.merges.get(o),h=a?be(r,a):K(r,r);t.push({anchor:r,range:h})}return t}toBorderPatchForPreset(e,t,s){const n=s[0].r===t[0].r,i=s[1].r===t[1].r,r=s[0].c===t[0].c,o=s[1].c===t[1].c;switch(e){case"all":return{bt:!0,bl:!0,br:o,bb:i};case"outer":return{bt:n,bl:r,br:o,bb:i};case"inner":return{bt:!n,bl:!r,br:!1,bb:!1};case"top":return{bt:n};case"bottom":return{bb:i};case"left":return{bl:r};case"right":return{br:o};case"clear":default:return{bt:!1,bl:!1,br:!1,bb:!1}}}isSelectionMerged(){if(this.selectionType!=="cell")return!1;const e=this.getRangeOrActiveCell(),t=this.getMergesIntersecting(e);return t.length===1&&ce(t[0].range,e)}canMergeSelection(){if(this.selectionType!=="cell")return!1;const e=this.getRangeOrActiveCell();if(e[0].r===e[1].r&&e[0].c===e[1].c)return!1;const s=this.frozenRows>0&&e[0].r<=this.frozenRows&&e[1].r>this.frozenRows,n=this.frozenCols>0&&e[0].c<=this.frozenCols&&e[1].c>this.frozenCols;return s||n?!1:this.getMergesIntersecting(e).length===0}async toggleMergeSelection(){return this.isSelectionMerged()?this.unmergeSelection():this.mergeSelection()}async mergeSelection(){if(!this.canMergeSelection())return!1;const e=this.getRangeOrActiveCell(),t=e[0],s={rs:e[1].r-e[0].r+1,cs:e[1].c-e[0].c+1},n=new Set;for(const i of this.mergeCoveredSrefs(t,s))n.add(i);this.store.beginBatch();try{for(let o=e[0].r;o<=e[1].r;o++)for(let a=e[0].c;a<=e[1].c;a++){if(o===t.r&&a===t.c)continue;const h={r:o,c:a},c=await this.store.get(h);c&&(c.s&&Object.keys(c.s).length>0?await this.store.set(h,{s:c.s}):await this.store.delete(h))}await this.store.setMerge(t,s),this.merges.set(T(t),s),this.rebuildMergeCoverMap();const i=this.expandChangedSrefsWithMergeAliases(n),r=await this.store.buildDependantsMap(i);await ie(this,r,i)}finally{this.store.endBatch()}return this.selectionType="cell",this.setActiveCell(t),this.range=be(t,s),!0}async unmergeSelection(){if(this.selectionType!=="cell")return!1;const e=this.getRangeOrActiveCell(),t=this.getMergesIntersecting(e);if(t.length===0)return!1;const s=new Set;for(const n of t)for(const i of this.mergeCoveredSrefs(n.anchor,n.span))s.add(i);this.store.beginBatch();try{for(const r of t)await this.store.deleteMerge(r.anchor),this.merges.delete(r.anchorSref);this.rebuildMergeCoverMap();const n=this.expandChangedSrefsWithMergeAliases(s),i=await this.store.buildDependantsMap(n);await ie(this,i,n)}finally{this.store.endBatch()}return this.selectionType="cell",this.range=void 0,!0}async getActiveDecimalPlaces(){const e=await this.getStyle(this.activeCell);return(e==null?void 0:e.dp)??2}async undo(){const e=await this.store.undo();if(e.success&&(await this.loadDimensions(),await this.loadStyles(),await this.loadMerges(),await this.loadFreezePane(),await this.loadFilterState(),e.affectedRange)){const[t,s]=e.affectedRange;this.selectionType="cell",this.activeCell=t,t.r===s.r&&t.c===s.c?this.range=void 0:this.range=e.affectedRange,this.store.updateActiveCell(this.activeCell)}return e.success}async redo(){const e=await this.store.redo();if(e.success&&(await this.loadDimensions(),await this.loadStyles(),await this.loadMerges(),await this.loadFreezePane(),await this.loadFilterState(),e.affectedRange)){const[t,s]=e.affectedRange;this.selectionType="cell",this.activeCell=t,t.r===s.r&&t.c===s.c?this.range=void 0:this.range=e.affectedRange,this.store.updateActiveCell(this.activeCell)}return e.success}moveInRange(e,t){const s=this.range||this.dimensionRange;let n=this.activeCell.r,i=this.activeCell.c;const r=this.getMergeForRef(this.activeCell),o=s[1].r-s[0].r+1,a=s[1].c-s[0].c+1;if(e!==0){const h=e>0?r?r.span.rs:e:e<0?-1:0;n+h>s[1].r?(n=s[0].r,i=(i+1-s[0].c+a)%a+s[0].c):n+h<s[0].r?(n=s[1].r,i=(i-1-s[0].c+a)%a+s[0].c):n+=h}if(t!==0){const h=t>0?r?r.span.cs:t:t<0?-1:0;i+h>s[1].c?(i=s[0].c,n=(n+1-s[0].r+o)%o+s[0].r):i+h<s[0].c?(i=s[1].c,n=(n-1-s[0].r+o)%o+s[0].r):i+=h}this.setActiveCell(this.normalizeRefToAnchor({r:n,c:i}))}}const tn={cellBorderColor:"#D3D3D3",customBorderColor:"#000000",cellBGColor:"#FFFFFF",cellTextColor:"#000000",activeCellColor:"#E6C746",selectionBGColor:"rgba(230, 199, 70, 0.1)",headerBGColor:"#F0F0F0",headerActiveBGColor:"#E6C746","tokens.REFERENCE":"#E6C746","tokens.NUM":"#4DA6FF",peerCursor1:"#FF6B6B",peerCursor2:"#4ECDC4",peerCursor3:"#45B7D1",peerCursor4:"#96CEB4",peerCursor5:"#FFEAA7",peerCursor6:"#DDA0DD",peerCursor7:"#98D8C8",peerCursor8:"#F7DC6F",resizeHandleColor:"#1A73E8",headerSelectedBGColor:"rgba(26, 115, 232, 0.3)",dropIndicatorColor:"#1A73E8",freezeLineColor:"#BBBBBB",freezeHandleColor:"#9E9E9E",freezeHandleHoverColor:"#5F6368",formulaRange1:"#1A73E8",formulaRange2:"#E84C3D",formulaRange3:"#9B59B6",formulaRange4:"#27AE60",formulaRange5:"#F39C12",formulaRange6:"#00ACC1",filterRangeBorderColor:"#1A73E8"},sn={cellBorderColor:"#4A4A4A",customBorderColor:"#FFFFFF",cellBGColor:"#1E1E1E",cellTextColor:"#FFFFFF",activeCellColor:"#D4B73E",selectionBGColor:"rgba(212, 183, 62, 0.1)",headerBGColor:"#2D2D2D",headerActiveBGColor:"#D4B73E","tokens.REFERENCE":"#D4B73E","tokens.NUM":"#4DA6FF",peerCursor1:"#FF7979",peerCursor2:"#55EFC4",peerCursor3:"#74B9FF",peerCursor4:"#A4D4C4",peerCursor5:"#FDCB6E",peerCursor6:"#E17055",peerCursor7:"#81ECEC",peerCursor8:"#F8D84F",resizeHandleColor:"#8AB4F8",headerSelectedBGColor:"rgba(138, 180, 248, 0.3)",dropIndicatorColor:"#8AB4F8",freezeLineColor:"#5A5A5A",freezeHandleColor:"#8E8E8E",freezeHandleHoverColor:"#CCCCCC",formulaRange1:"#8AB4F8",formulaRange2:"#FF7979",formulaRange3:"#BB86FC",formulaRange4:"#66BB6A",formulaRange5:"#FFB74D",formulaRange6:"#4DD0E1",filterRangeBorderColor:"#8AB4F8"};function P(l,e){return l==="light"?tn[e]:sn[e]}const Rt=["formulaRange1","formulaRange2","formulaRange3","formulaRange4","formulaRange5","formulaRange6"];function Ne(l,e){return P(l,Rt[e%Rt.length])}function bt(l,e){const t=["peerCursor1","peerCursor2","peerCursor3","peerCursor4","peerCursor5","peerCursor6","peerCursor7","peerCursor8"];let s=0;for(let i=0;i<e.length;i++){const r=e.charCodeAt(i);s=(s<<5)-s+r,s=s&s}const n=Math.abs(s)%t.length;return P(l,t[n])}function le(l){const e=window.getSelection();if(e.rangeCount===0)return;const t=e.getRangeAt(0);if(!l.contains(t.commonAncestorContainer))return;let s=0,n=0,i=0;function r(o){if(o.nodeType===Node.TEXT_NODE){const a=o.textContent;o===t.startContainer&&(n=s+t.startOffset),o===t.endContainer&&(i=s+t.endOffset),s+=a.length}for(const a of o.childNodes)r(a)}return r(l),{start:n,end:i}}function ue(l,e){let t=0,s=null,n=null;const i=document.createRange();function r(a){if(a.nodeType===Node.TEXT_NODE){const h=a.textContent;s===null&&t+h.length>=e.start&&(s=a,i.setStart(a,e.start-t)),n===null&&t+h.length>=e.end&&(n=a,i.setEnd(a,e.end-t)),t+=h.length}for(const h of a.childNodes)r(h)}if(r(l),s===null||n===null){const a=l.childNodes.length,h=Math.max(0,Math.min(e.start,a)),c=Math.max(h,Math.min(e.end,a));i.setStart(l,h),i.setEnd(l,c)}const o=window.getSelection();o.removeAllRanges(),o.addRange(i),l.focus()}function Qt(l){return l=l.replace(/&/g,"&amp;"),l=l.replace(/</g,"&lt;"),l=l.replace(/>/g,"&gt;"),l=l.replace(/"/g,"&quot;"),l=l.replace(/'/g,"&#039;"),l=l.replace(/\n/g,"<br>"),l=l.replace(/ /g,"&nbsp;"),l}const Zt=23,Jt=10;class nn{constructor(e="light",t=!1){p(this,"sheet");p(this,"theme");p(this,"readOnly");p(this,"container");p(this,"cellLabel");p(this,"formulaInput");p(this,"boundHandleInput");p(this,"boundHandleCompositionStart");p(this,"boundHandleCompositionEnd");p(this,"composing",!1);this.theme=e,this.readOnly=t,this.container=document.createElement("div"),this.container.style.height=`${Zt}px`,this.container.style.margin=`${Jt}px 0px`,this.container.style.display="flex",this.container.style.alignItems="center",this.container.style.borderTop=`1px solid ${P(this.theme,"cellBorderColor")}`,this.container.style.borderBottom=`1px solid ${P(this.theme,"cellBorderColor")}`,this.container.style.justifyContent="flex-start",this.cellLabel=document.createElement("div"),this.cellLabel.style.width="120px",this.cellLabel.style.textAlign="center",this.cellLabel.style.font="12px Arial",this.cellLabel.style.borderRight=`1px solid ${P(this.theme,"cellBorderColor")}`,this.container.appendChild(this.cellLabel),this.formulaInput=document.createElement("div"),this.formulaInput.contentEditable=this.readOnly?"false":"true",this.formulaInput.style.margin="0 20px",this.formulaInput.style.width="100%",this.formulaInput.style.height="12px",this.formulaInput.style.border="none",this.formulaInput.style.font="12px Arial",this.formulaInput.style.outline="none",this.formulaInput.style.overflow="hidden",this.formulaInput.style.whiteSpace="nowrap",this.formulaInput.style.lineHeight="12px",this.container.appendChild(this.formulaInput),this.boundHandleInput=this.handleInput.bind(this),this.boundHandleCompositionStart=this.handleCompositionStart.bind(this),this.boundHandleCompositionEnd=this.handleCompositionEnd.bind(this),this.formulaInput.addEventListener("input",this.boundHandleInput),this.formulaInput.addEventListener("compositionstart",this.boundHandleCompositionStart),this.formulaInput.addEventListener("compositionend",this.boundHandleCompositionEnd)}getContainer(){return this.container}initialize(e){this.sheet=e}cleanup(){this.formulaInput.removeEventListener("input",this.boundHandleInput),this.formulaInput.removeEventListener("compositionstart",this.boundHandleCompositionStart),this.formulaInput.removeEventListener("compositionend",this.boundHandleCompositionEnd),this.sheet=void 0,this.container.remove()}async render(){if(!this.sheet)return;const e=this.sheet.getActiveCell(),t=this.sheet.getSelectionType(),s=this.sheet.getSelectedIndices();let n;if(t==="row"&&s)n=`${s.from}:${s.to}`;else if(t==="column"&&s){const i=ae(s.from),r=ae(s.to);n=`${i}:${r}`}else{const i=this.sheet.getRange();n=i?us(i):T(e)}this.cellLabel.textContent=n,this.formulaInput.innerText=await this.sheet.toInputString(e),this.renderInput()}getFormulaInput(){return this.formulaInput}getValue(){return this.formulaInput.innerText}setValue(e){this.formulaInput.innerText=e,this.renderInput()}focus(){this.formulaInput.focus()}blur(){this.formulaInput.blur()}isFocused(){return document.activeElement===this.formulaInput}isComposing(){return this.composing}handleInput(){this.composing||this.renderInput()}handleCompositionStart(){this.composing=!0}handleCompositionEnd(){this.composing=!1,this.renderInput()}renderInput(){if(this.composing)return;const e=this.formulaInput.innerText;if(!e.startsWith("="))return;const t=ve(e),s=[];let n=0;for(const r of t){if(r.type==="REFERENCE"){s.push(`<span style="color: ${Ne(this.theme,n)}">${r.text}</span>`),n++;continue}if(r.type==="NUM"){s.push(`<span style="color: ${this.getThemeColor("tokens.NUM")}">${r.text}</span>`);continue}s.push(Qt(r.text))}const i=le(this.formulaInput);this.formulaInput.innerHTML="="+s.join(""),i&&ue(this.formulaInput,i)}getThemeColor(e){return P(this.theme,e)}}const Y=100,S=23,b=50,fe=13,We=1.5,Ae=4,je=5,Ye=.5,rn=1.5,on="center",es=4,ln=10;function V(l,e={left:0,top:0},t,s){const n=s?s.getOffset(l.c):(l.c-1)*Y,i=t?t.getOffset(l.r):(l.r-1)*S,r=s?s.getSize(l.c):Y,o=t?t.getSize(l.r):S;return{left:n+b-e.left,top:i+S-e.top,width:r,height:o}}function re(l,e){const t=Math.min(l.left,e.left),s=Math.min(l.top,e.top),n=Math.max(l.left+l.width,e.left+e.width),i=Math.max(l.top+l.height,e.top+e.height);return{left:t,top:s,width:n-t,height:i-s}}const pe={frozenRows:0,frozenCols:0,frozenWidth:0,frozenHeight:0};function an(l,e,t,s){return l===0&&e===0?pe:{frozenRows:l,frozenCols:e,frozenWidth:e>0?s.getOffset(e+1):0,frozenHeight:l>0?t.getOffset(l+1):0}}function hn(l,e,t,s){const n=t?t.findIndex(e-S):Math.floor(e/S),i=s?s.findIndex(l-b):Math.floor((l+b)/Y);return{r:n,c:i}}function cn(l,e,t,s,n,i){const r=i.frozenCols>0&&l<b+i.frozenWidth,o=i.frozenRows>0&&e<S+i.frozenHeight,a=r?l-b:l-b-i.frozenWidth+n.getOffset(i.frozenCols+1)+t.left,h=o?e-S:e-S-i.frozenHeight+s.getOffset(i.frozenRows+1)+t.top,c=n.findIndex(a),u=s.findIndex(h);return{r:Math.max(1,u),c:Math.max(1,c)}}function Me(l,e,t,s,n){const i=s.getOffset(l.c),r=t.getOffset(l.r),o=s.getSize(l.c),a=t.getSize(l.r),h=n.frozenCols>0&&l.c<=n.frozenCols,c=n.frozenRows>0&&l.r<=n.frozenRows,u=h?i+b:i+b-e.left-s.getOffset(n.frozenCols+1)+n.frozenWidth,d=c?r+S:r+S-e.top-t.getOffset(n.frozenRows+1)+n.frozenHeight;return{left:u,top:d,width:o,height:a}}class dn{constructor(e="light"){p(this,"container");p(this,"input");p(this,"cellPositionHint");p(this,"theme");p(this,"boundHandleInput");p(this,"minWidth",Y);p(this,"minHeight",S);p(this,"maxWidth",1/0);p(this,"maxHeight",1/0);p(this,"composing",!1);p(this,"primed",!1);p(this,"boundHandleCompositionStart");p(this,"boundHandleCompositionEnd");p(this,"onPrimedActivate");this.theme=e,this.container=document.createElement("div"),this.container.style.position="absolute",this.container.style.left="-1000px",this.container.style.width=Y+"px",this.container.style.height=S+"px",this.container.style.zIndex="1",this.container.style.margin="0px",this.container.style.pointerEvents="none",this.input=document.createElement("div"),this.input.contentEditable="true",this.input.style.border="none",this.input.style.outline=`2px solid ${this.getThemeColor("activeCellColor")}`,this.input.style.fontFamily="Arial, sans-serif",this.input.style.fontSize=fe+"px",this.input.style.fontWeight="normal",this.input.style.lineHeight=String(We),this.input.style.color=this.getThemeColor("cellTextColor"),this.input.style.backgroundColor=this.getThemeColor("cellBGColor"),this.input.style.whiteSpace="pre",this.input.style.overflow="hidden",this.container.appendChild(this.input),this.cellPositionHint=document.createElement("div"),this.cellPositionHint.style.position="absolute",this.cellPositionHint.style.right="4px",this.cellPositionHint.style.top="4px",this.cellPositionHint.style.padding="0 4px",this.cellPositionHint.style.borderRadius="3px",this.cellPositionHint.style.border=`1px solid ${this.getThemeColor("cellBorderColor")}`,this.cellPositionHint.style.backgroundColor=this.getThemeColor("headerBGColor"),this.cellPositionHint.style.color=this.getThemeColor("cellTextColor"),this.cellPositionHint.style.fontSize="10px",this.cellPositionHint.style.lineHeight="14px",this.cellPositionHint.style.fontFamily="Arial, sans-serif",this.cellPositionHint.style.pointerEvents="none",this.cellPositionHint.style.display="none",this.cellPositionHint.style.zIndex="2",this.container.appendChild(this.cellPositionHint),this.boundHandleInput=this.handleInput.bind(this),this.boundHandleCompositionStart=this.handleCompositionStart.bind(this),this.boundHandleCompositionEnd=this.handleCompositionEnd.bind(this),this.input.addEventListener("input",this.boundHandleInput),this.input.addEventListener("compositionstart",this.boundHandleCompositionStart),this.input.addEventListener("compositionend",this.boundHandleCompositionEnd)}cleanup(){this.input.removeEventListener("input",this.boundHandleInput),this.input.removeEventListener("compositionstart",this.boundHandleCompositionStart),this.input.removeEventListener("compositionend",this.boundHandleCompositionEnd),this.container.remove()}getContainer(){return this.container}getInput(){return this.input}show(e,t,s="",n=!0,i,r,o,a,h=!0){this.primed=!1,this.applyEditingAppearance(),this.updateFrame(e,t,i??Y,r??S,o??1/0,a??1/0),this.input.innerText=s,this.renderInput(),this.adjustSize(),n&&(this.input.focus(),h&&ue(this.input,{start:this.input.innerText.length,end:this.input.innerText.length}))}prime(e,t,s,n,i,r){this.primed=!0,this.updateFrame(e,t,s??Y,n??S,i??1/0,r??1/0),this.input.innerText="",this.renderInput(),this.adjustSize(),this.applyPrimedAppearance(),this.input.focus()}hide(){this.primed=!1,this.applyEditingAppearance(),this.container.style.left="-1000px",this.container.style.pointerEvents="none",this.setCellPositionHint(),this.input.innerText="",this.input.blur()}isShown(){return this.container.style.left!=="-1000px"}isFocused(){return document.activeElement===this.input}isComposing(){return this.composing}isPrimed(){return this.primed}setOnPrimedActivate(e){this.onPrimedActivate=e}getValue(){return this.input.innerText}setValue(e){this.input.innerText=e,this.renderInput(),this.adjustSize()}hasFormula(){return this.input.innerText.startsWith("=")}updatePlacement(e,t,s=Y,n=S,i=1/0,r=1/0){this.updateFrame(e,t,s,n,i,r),this.adjustSize()}setCellPositionHint(e){if(!e){this.cellPositionHint.style.display="none",this.cellPositionHint.innerText="";return}this.cellPositionHint.innerText=e,this.cellPositionHint.style.display="block"}applyStyle(e){this.input.style.fontWeight=e!=null&&e.b?"bold":"normal",this.input.style.fontStyle=e!=null&&e.i?"italic":"normal";const t=[];e!=null&&e.u&&t.push("underline"),e!=null&&e.st&&t.push("line-through"),this.input.style.textDecoration=t.length?t.join(" "):"none",this.input.style.color=(e==null?void 0:e.tc)||this.getThemeColor("cellTextColor"),this.input.style.backgroundColor=(e==null?void 0:e.bg)||this.getThemeColor("cellBGColor"),this.input.style.textAlign=(e==null?void 0:e.al)||"left";const s=(e==null?void 0:e.va)||"top";this.container.style.display="flex",this.container.style.alignItems=s==="middle"?"center":s==="bottom"?"flex-end":"flex-start"}handleInput(){if(this.activatePrimedInput(),this.composing){this.adjustSize();return}this.renderInput(),this.adjustSize()}handleCompositionStart(){this.activatePrimedInput(),this.composing=!0}handleCompositionEnd(){this.composing=!1,this.renderInput(),this.adjustSize()}updateFrame(e,t,s,n,i,r){this.minWidth=s,this.minHeight=n,this.maxWidth=i,this.maxHeight=r,this.container.style.left=e+"px",this.container.style.top=t+"px"}adjustSize(){this.input.style.width=this.minWidth+"px",this.input.style.height=this.minHeight+"px";const e=Math.min(Math.max(this.minWidth,this.input.scrollWidth),this.maxWidth),t=Math.min(Math.max(this.minHeight,this.input.scrollHeight),this.maxHeight);this.container.style.width=e+"px",this.container.style.height=t+"px",this.input.style.width=e+"px",this.input.style.height=t+"px",this.input.style.overflowY=this.input.scrollHeight>this.maxHeight?"auto":"hidden"}renderInput(){if(this.composing)return;const e=this.input.innerText;if(!e.startsWith("="))return;const t=ve(e),s=[];let n=0;for(const r of t){if(r.type==="REFERENCE"){s.push(`<span style="color: ${Ne(this.theme,n)}">${r.text}</span>`),n++;continue}if(r.type==="NUM"){s.push(`<span style="color: ${this.getThemeColor("tokens.NUM")}">${r.text}</span>`);continue}s.push(Qt(r.text))}const i=le(this.input);this.input.innerHTML="="+s.join(""),i&&ue(this.input,i)}getThemeColor(e){return P(this.theme,e)}activatePrimedInput(){var e;this.primed&&(this.primed=!1,this.applyEditingAppearance(),(e=this.onPrimedActivate)==null||e.call(this))}applyEditingAppearance(){this.container.style.pointerEvents="auto",this.input.style.outline=`2px solid ${this.getThemeColor("activeCellColor")}`,this.input.style.color=this.getThemeColor("cellTextColor"),this.input.style.backgroundColor=this.getThemeColor("cellBGColor"),this.input.style.caretColor=this.getThemeColor("cellTextColor")}applyPrimedAppearance(){this.container.style.pointerEvents="none",this.input.style.outline="none",this.input.style.color="transparent",this.input.style.backgroundColor="transparent",this.input.style.caretColor="transparent"}}class un{constructor(e="light"){p(this,"canvas");p(this,"theme");this.theme=e,this.canvas=document.createElement("canvas"),this.canvas.style.position="absolute",this.canvas.style.zIndex="1",this.canvas.style.pointerEvents="none"}cleanup(){this.canvas.remove()}getContainer(){return this.canvas}render(e,t,s,n,i,r,o,a,h=!1,c,u,d,f=pe,m,g,y=!1,z,I=!0,k,M){this.canvas.width=0,this.canvas.height=0;const w=this.canvas.getContext("2d"),N=window.devicePixelRatio||1;this.canvas.width=e.width*N,this.canvas.height=e.height*N,this.canvas.style.width=e.width+"px",this.canvas.style.height=e.height+"px",w.scale(N,N);const A=f.frozenRows>0||f.frozenCols>0,C=this.buildMergeRenderData(k),v=this.resolveAutofillSelectionRange(i,s,C);if(!A)this.renderActiveCellSimple(w,s,t,r,o,C),this.renderSelectionSimple(w,e,t,i,c,r,o),this.renderPeerCursorsSimple(w,e,n,t,r,o,C),this.renderFilterRangeSimple(w,M,t,r,o),this.renderFormulaRangesSimple(w,d,t,r,o),this.renderCopyRangeSimple(w,g,y,t,r,o);else{const R=this.buildQuadrants(e,t,f,r,o);this.renderSelectionFrozen(w,e,t,i,c,r,o,f,R);for(const F of R){w.save(),w.beginPath(),w.rect(F.x,F.y,F.width,F.height),w.clip();const x=this.toCellRect(s,{left:F.scrollLeft,top:F.scrollTop},r,o,C);w.strokeStyle=this.getThemeColor("activeCellColor"),w.lineWidth=2,w.strokeRect(x.left,x.top,x.width,x.height),w.restore()}for(const{clientID:F,presence:x}of n){if(!x.activeCell)continue;const $=B(x.activeCell),E=bt(this.theme,F);for(const O of R){w.save(),w.beginPath(),w.rect(O.x,O.y,O.width,O.height),w.clip();const H=this.toCellRect($,{left:O.scrollLeft,top:O.scrollTop},r,o,C);H.left>=-H.width&&H.left<e.width&&H.top>=-H.height&&H.top<e.height&&(w.strokeStyle=E,w.lineWidth=2,w.strokeRect(H.left,H.top,H.width,H.height)),w.restore()}}if(M)for(const F of R){w.save(),w.beginPath(),w.rect(F.x,F.y,F.width,F.height),w.clip();const x={left:F.scrollLeft,top:F.scrollTop},$=re(V(M[0],x,r,o),V(M[1],x,r,o));w.strokeStyle=this.getThemeColor("filterRangeBorderColor"),w.lineWidth=1,w.strokeRect($.left,$.top,$.width,$.height),w.restore()}if(d&&d.length>0)for(let F=0;F<d.length;F++){const x=d[F],$=Ne(this.theme,F);for(const E of R){w.save(),w.beginPath(),w.rect(E.x,E.y,E.width,E.height),w.clip();const O={left:E.scrollLeft,top:E.scrollTop},H=re(V(x[0],O,r,o),V(x[1],O,r,o));w.strokeStyle=$,w.lineWidth=2,w.strokeRect(H.left,H.top,H.width,H.height),w.fillStyle=$+"20",w.fillRect(H.left,H.top,H.width,H.height),w.restore()}}if(g)for(const F of R){w.save(),w.beginPath(),w.rect(F.x,F.y,F.width,F.height),w.clip();const x={left:F.scrollLeft,top:F.scrollTop};this.drawCopyRangeBorder(w,g,y,x,r,o),w.restore()}}z&&!ce(z,v)&&this.renderAutofillPreview(w,z,t,r,o,f),I&&this.renderAutofillHandle(w,v,c,t,r,o,f),a&&o&&r&&this.renderResizeHover(w,e,t,a,r,o,f,h),u&&o&&r&&this.renderDragMoveIndicator(w,e,t,u,r,o,f),m&&o&&r&&this.renderFreezeDragPreview(w,e,m,r,o)}buildQuadrants(e,t,s,n,i){const r=s.frozenWidth,o=s.frozenHeight,a=n?n.getOffset(s.frozenRows+1):0,h=i?i.getOffset(s.frozenCols+1):0,c=[];return c.push({x:b+r,y:S+o,width:e.width-b-r,height:e.height-S-o,scrollLeft:t.left+h-r,scrollTop:t.top+a-o}),s.frozenRows>0&&c.push({x:b+r,y:S,width:e.width-b-r,height:o,scrollLeft:t.left+h-r,scrollTop:0}),s.frozenCols>0&&c.push({x:b,y:S+o,width:r,height:e.height-S-o,scrollLeft:0,scrollTop:t.top+a-o}),s.frozenRows>0&&s.frozenCols>0&&c.push({x:b,y:S,width:r,height:o,scrollLeft:0,scrollTop:0}),c}renderActiveCellSimple(e,t,s,n,i,r){const o=this.toCellRect(t,s,n,i,r);e.strokeStyle=this.getThemeColor("activeCellColor"),e.lineWidth=2,e.strokeRect(o.left,o.top,o.width,o.height)}renderSelectionSimple(e,t,s,n,i,r,o){if(i==="all")e.fillStyle=this.getThemeColor("selectionBGColor"),e.fillRect(b,S,t.width-b,t.height-S);else if(n)if(i==="row"){const a=V(n[0],s,r,o),h=V(n[1],s,r,o),c=a.top,u=h.top+h.height-a.top;e.fillStyle=this.getThemeColor("selectionBGColor"),e.fillRect(b,c,t.width-b,u),e.strokeStyle=this.getThemeColor("activeCellColor"),e.lineWidth=1,e.strokeRect(b,c,t.width-b,u)}else if(i==="column"){const a=V(n[0],s,r,o),h=V(n[1],s,r,o),c=a.left,u=h.left+h.width-a.left;e.fillStyle=this.getThemeColor("selectionBGColor"),e.fillRect(c,S,u,t.height-S),e.strokeStyle=this.getThemeColor("activeCellColor"),e.lineWidth=1,e.strokeRect(c,S,u,t.height-S)}else{const a=re(V(n[0],s,r,o),V(n[1],s,r,o));e.fillStyle=this.getThemeColor("selectionBGColor"),e.fillRect(a.left,a.top,a.width,a.height),e.strokeStyle=this.getThemeColor("activeCellColor"),e.lineWidth=1,e.strokeRect(a.left,a.top,a.width,a.height)}}renderPeerCursorsSimple(e,t,s,n,i,r,o){for(const{clientID:a,presence:h}of s){if(!h.activeCell)continue;const c=B(h.activeCell),u=this.toCellRect(c,n,i,r,o);if(u.left>=-u.width&&u.left<t.width&&u.top>=-u.height&&u.top<t.height){const d=bt(this.theme,a);e.strokeStyle=d,e.lineWidth=2,e.strokeRect(u.left,u.top,u.width,u.height)}}}renderFilterRangeSimple(e,t,s,n,i){if(!t)return;const r=re(V(t[0],s,n,i),V(t[1],s,n,i));e.strokeStyle=this.getThemeColor("filterRangeBorderColor"),e.lineWidth=1,e.strokeRect(r.left,r.top,r.width,r.height)}renderFormulaRangesSimple(e,t,s,n,i){if(!(!t||t.length===0))for(let r=0;r<t.length;r++){const o=t[r],a=re(V(o[0],s,n,i),V(o[1],s,n,i)),h=Ne(this.theme,r);e.strokeStyle=h,e.lineWidth=2,e.strokeRect(a.left,a.top,a.width,a.height),e.fillStyle=h+"20",e.fillRect(a.left,a.top,a.width,a.height)}}renderCopyRangeSimple(e,t,s,n,i,r){t&&this.drawCopyRangeBorder(e,t,s,n,i,r)}drawCopyRangeBorder(e,t,s,n,i,r){const o=re(V(t[0],n,i,r),V(t[1],n,i,r));e.strokeStyle=this.getThemeColor("activeCellColor"),e.lineWidth=2,e.setLineDash([5,3]),e.strokeRect(o.left,o.top,o.width,o.height),e.setLineDash([]),s&&(e.fillStyle=this.getThemeColor("activeCellColor")+"15",e.fillRect(o.left,o.top,o.width,o.height))}renderSelectionFrozen(e,t,s,n,i,r,o,a,h){if(i==="all"){e.fillStyle=this.getThemeColor("selectionBGColor"),e.fillRect(b,S,t.width-b,t.height-S);return}if(n)for(const c of h){e.save(),e.beginPath(),e.rect(c.x,c.y,c.width,c.height),e.clip();const u={left:c.scrollLeft,top:c.scrollTop};if(i==="row"){const d=V(n[0],u,r,o),f=V(n[1],u,r,o),m=d.top,g=f.top+f.height-d.top;e.fillStyle=this.getThemeColor("selectionBGColor"),e.fillRect(b,m,t.width-b,g),e.strokeStyle=this.getThemeColor("activeCellColor"),e.lineWidth=1,e.strokeRect(b,m,t.width-b,g)}else if(i==="column"){const d=V(n[0],u,r,o),f=V(n[1],u,r,o),m=d.left,g=f.left+f.width-d.left;e.fillStyle=this.getThemeColor("selectionBGColor"),e.fillRect(m,S,g,t.height-S),e.strokeStyle=this.getThemeColor("activeCellColor"),e.lineWidth=1,e.strokeRect(m,S,g,t.height-S)}else{const d=re(V(n[0],u,r,o),V(n[1],u,r,o));e.fillStyle=this.getThemeColor("selectionBGColor"),e.fillRect(d.left,d.top,d.width,d.height),e.strokeStyle=this.getThemeColor("activeCellColor"),e.lineWidth=1,e.strokeRect(d.left,d.top,d.width,d.height)}e.restore()}}renderResizeHover(e,t,s,n,i,r,o,a){const h=this.getThemeColor("freezeHandleHoverColor");if(n.axis==="column"){const u=o.frozenCols>0&&n.index<=o.frozenCols?0:s.left+r.getOffset(o.frozenCols+1)-o.frozenWidth,d=b+r.getOffset(n.index)+r.getSize(n.index)-u;a&&(e.strokeStyle=h,e.lineWidth=2,e.beginPath(),e.moveTo(d,0),e.lineTo(d,t.height),e.stroke()),this.drawResizeGrip(e,"column",d,h)}else{const u=o.frozenRows>0&&n.index<=o.frozenRows?0:s.top+i.getOffset(o.frozenRows+1)-o.frozenHeight,d=S+i.getOffset(n.index)+i.getSize(n.index)-u;a&&(e.strokeStyle=h,e.lineWidth=2,e.beginPath(),e.moveTo(0,d),e.lineTo(t.width,d),e.stroke()),this.drawResizeGrip(e,"row",d,h)}}drawResizeGrip(e,t,s,n){if(e.save(),e.strokeStyle=n,e.lineWidth=2,e.lineCap="round",t==="column"){const d=S/2,f=d-10/2,m=d+10/2,g=s-3/2,y=s+3/2;e.beginPath(),e.moveTo(g,f),e.lineTo(g,m),e.moveTo(y,f),e.lineTo(y,m),e.stroke(),e.restore();return}const o=b/2,a=o-10/2,h=o+10/2,c=s-3/2,u=s+3/2;e.beginPath(),e.moveTo(a,c),e.lineTo(h,c),e.moveTo(a,u),e.lineTo(h,u),e.stroke(),e.restore()}renderDragMoveIndicator(e,t,s,n,i,r,o){if(e.strokeStyle=this.getThemeColor("dropIndicatorColor"),e.lineWidth=3,n.axis==="column"){const h=o.frozenCols>0&&n.dropIndex<=o.frozenCols?0:s.left+r.getOffset(o.frozenCols+1)-o.frozenWidth,c=b+r.getOffset(n.dropIndex)-h;e.beginPath(),e.moveTo(c,0),e.lineTo(c,t.height),e.stroke()}else{const h=o.frozenRows>0&&n.dropIndex<=o.frozenRows?0:s.top+i.getOffset(o.frozenRows+1)-o.frozenHeight,c=S+i.getOffset(n.dropIndex)-h;e.beginPath(),e.moveTo(0,c),e.lineTo(t.width,c),e.stroke()}}renderFreezeDragPreview(e,t,s,n,i){if(e.strokeStyle=this.getThemeColor("freezeLineColor"),e.lineWidth=2,s.axis==="row"){const r=s.targetIndex===0?S:S+n.getOffset(s.targetIndex+1);e.beginPath(),e.moveTo(0,r),e.lineTo(t.width,r),e.stroke()}else{const r=s.targetIndex===0?b:b+i.getOffset(s.targetIndex+1);e.beginPath(),e.moveTo(r,0),e.lineTo(r,t.height),e.stroke()}}toRangeRect(e,t,s,n,i=pe){if(!s||!n)return;const r=i.frozenRows>0||i.frozenCols>0,o=r?Me(e[0],t,s,n,i):V(e[0],t,s,n),a=r?Me(e[1],t,s,n,i):V(e[1],t,s,n);return re(o,a)}renderAutofillPreview(e,t,s,n,i,r=pe){const o=this.toRangeRect(t,s,n,i,r);o&&(e.strokeStyle=this.getThemeColor("activeCellColor"),e.lineWidth=1,e.setLineDash([4,2]),e.strokeRect(o.left,o.top,o.width,o.height),e.setLineDash([]))}renderAutofillHandle(e,t,s,n,i,r,o=pe){if(s!=="cell"||!t)return;const a=this.toRangeRect(t,n,i,r,o);if(!a)return;const h=8,c=a.left+a.width-h/2,u=a.top+a.height-h/2;e.fillStyle=this.getThemeColor("activeCellColor"),e.fillRect(c,u,h,h),e.strokeStyle=this.getThemeColor("cellBGColor"),e.lineWidth=1,e.strokeRect(c+.5,u+.5,h,h)}resolveAutofillSelectionRange(e,t,s){if(e)return[e[0],e[1]];const n=T(t),i=(s==null?void 0:s.coverToAnchor.get(n))||n,r=B(i),o=s==null?void 0:s.anchors.get(i);return!o||o.rs===1&&o.cs===1?[r,r]:[r,{r:r.r+o.rs-1,c:r.c+o.cs-1}]}getThemeColor(e){return P(this.theme,e)}buildMergeRenderData(e){if(!e||e.size===0)return;const t=new Map,s=new Map;for(const[n,i]of e){t.set(n,i);const r=B(n);for(let o=r.r;o<r.r+i.rs;o++)for(let a=r.c;a<r.c+i.cs;a++){const h=T({r:o,c:a});h!==n&&s.set(h,n)}}return{anchors:t,coverToAnchor:s}}toCellRect(e,t,s,n,i){const r=T(e),o=(i==null?void 0:i.coverToAnchor.get(r))||r,a=B(o),h=i==null?void 0:i.anchors.get(o),c=V(a,t,s,n);if(!h||h.rs===1&&h.cs===1)return c;const u=V({r:a.r+h.rs-1,c:a.c+h.cs-1},t,s,n);return{left:c.left,top:c.top,width:u.left+u.width-c.left,height:u.top+u.height-c.top}}}const He=1e7;class fn{constructor(e="light"){p(this,"container");p(this,"scrollContainer");p(this,"dummyContainer");p(this,"actualWidth",0);p(this,"actualHeight",0);this.createContainers()}createContainers(){this.container=document.createElement("div"),this.container.style.position="relative",this.container.style.width="100%",this.container.style.height=`calc(100% - ${Zt+Jt*2}px)`,this.scrollContainer=document.createElement("div"),this.scrollContainer.style.position="absolute",this.scrollContainer.style.overflow="auto",this.scrollContainer.style.width="100%",this.scrollContainer.style.height="100%",this.scrollContainer.style.zIndex="1",this.dummyContainer=document.createElement("div"),this.dummyContainer.style.margin="0px",this.dummyContainer.style.padding="0px",this.dummyContainer.style.pointerEvents="none",this.scrollContainer.appendChild(this.dummyContainer),this.container.appendChild(this.scrollContainer)}getContainer(){return this.container}getScrollContainer(){return this.scrollContainer}getDummyContainer(){return this.dummyContainer}updateDummySize(e,t){this.actualWidth=e,this.actualHeight=t;const s=Math.min(e,He),n=Math.min(t,He);this.dummyContainer.style.width=s+"px",this.dummyContainer.style.height=n+"px"}appendChild(e){this.container.appendChild(e)}getViewport(){return this.scrollContainer.getBoundingClientRect()}getScrollPosition(){const e=this.scrollContainer.scrollLeft,t=this.scrollContainer.scrollTop,s=this.scrollContainer.getBoundingClientRect();return{left:this.toLogical(e,this.actualWidth,s.width),top:this.toLogical(t,this.actualHeight,s.height)}}setScrollPosition(e){const t=this.scrollContainer.getBoundingClientRect();e.left!==void 0&&(this.scrollContainer.scrollLeft=this.toPhysical(e.left,this.actualWidth,t.width)),e.top!==void 0&&(this.scrollContainer.scrollTop=this.toPhysical(e.top,this.actualHeight,t.height))}scrollBy(e,t){const s=this.scrollContainer.getBoundingClientRect(),n=this.needsRemap(this.actualWidth,s.width)?e*this.physicalMax(this.actualWidth,s.width)/this.logicalMax(this.actualWidth,s.width):e,i=this.needsRemap(this.actualHeight,s.height)?t*this.physicalMax(this.actualHeight,s.height)/this.logicalMax(this.actualHeight,s.height):t;this.scrollContainer.scrollBy(n,i)}addEventListener(e,t,s){this.scrollContainer.addEventListener(e,t,s)}removeEventListener(e,t,s){this.scrollContainer.removeEventListener(e,t,s)}cleanup(){this.container.remove()}needsRemap(e,t){return e>He&&t<e}cappedSize(e){return Math.min(e,He)}physicalMax(e,t){return Math.max(0,this.cappedSize(e)-t)}logicalMax(e,t){return Math.max(0,e-t)}clamp(e,t,s){return s<=t?t:Math.min(s,Math.max(t,e))}toLogical(e,t,s){const n=this.logicalMax(t,s);if(!this.needsRemap(t,s))return this.clamp(e,0,n);const i=this.physicalMax(t,s);return i<=0||n<=0?0:this.clamp(e,0,i)*n/i}toPhysical(e,t,s){const n=this.logicalMax(t,s);if(!this.needsRemap(t,s))return this.clamp(e,0,n);if(n<=0)return 0;const i=this.physicalMax(t,s);return this.clamp(e,0,n)*i/n}}const pn="M4 6h16 M6 12h12 M9 18h6",L=3,de=3,J=3,Ft=3,zt=1,we=class we{constructor(e="light"){p(this,"canvas");p(this,"theme");this.theme=e,this.canvas=document.createElement("canvas"),this.canvas.style.position="absolute",this.canvas.style.pointerEvents="none"}getCanvas(){return this.canvas}render(e,t,s,n,i,r,o,a,h,c=pe,u=null,d,f,m,g,y,z,I,k,M=null,w,N,A){this.canvas.width=0,this.canvas.height=0;const C=this.canvas.getContext("2d"),v=window.devicePixelRatio||1;this.canvas.width=e.width*v,this.canvas.height=e.height*v,this.canvas.style.width=e.width+"px",this.canvas.style.height=e.height+"px",C.scale(v,v);const[R,F]=s,x=this.buildMergeRenderData(z);if(!(c.frozenRows>0||c.frozenCols>0))this.renderQuadrantCells(C,R.r,F.r+1,R.c,F.c+1,i,t,r,o,d,f,m,g,y,x,I,k,M),this.renderColumnHeaders(C,R.c,F.c,t.left,b,e.width,n,a,h,r,o),this.renderRowHeaders(C,R.r,F.r,t.top,S,e.height,n,a,h,r,o);else{const O=c.frozenWidth,H=c.frozenHeight,D=c.frozenRows,G=c.frozenCols,te=D+1,U=G+1,j=Math.max(te,R.r),se=Math.max(U,R.c),ne=r?r.getOffset(te):D*S,$e=o?o.getOffset(U):G*Y;C.save(),C.beginPath(),C.rect(b+O,S+H,e.width-b-O,e.height-S-H),C.clip(),this.renderQuadrantCells(C,j,F.r+1,se,F.c+1,i,{left:t.left+$e-O,top:t.top+ne-H},r,o,d,f,m,g,y,x,I,k,M),C.restore(),D>0&&(C.save(),C.beginPath(),C.rect(b+O,S,e.width-b-O,H),C.clip(),this.renderQuadrantCells(C,1,D+1,se,F.c+1,i,{left:t.left+$e-O,top:0},r,o,d,f,m,g,y,x,I,k,M),C.restore()),G>0&&(C.save(),C.beginPath(),C.rect(b,S+H,O,e.height-S-H),C.clip(),this.renderQuadrantCells(C,j,F.r+1,1,G+1,i,{left:0,top:t.top+ne-H},r,o,d,f,m,g,y,x,I,k,M),C.restore()),D>0&&G>0&&(C.save(),C.beginPath(),C.rect(b,S,O,H),C.clip(),this.renderQuadrantCells(C,1,D+1,1,G+1,i,{left:0,top:0},r,o,d,f,m,g,y,x,I,k,M),C.restore()),G>0&&this.renderColumnHeaders(C,1,G,0,b,b+O,n,a,h,r,o),this.renderColumnHeaders(C,se,F.c,t.left+$e-O,b+O,e.width,n,a,h,r,o),D>0&&this.renderRowHeaders(C,1,D,0,S,S+H,n,a,h,r,o),this.renderRowHeaders(C,j,F.r,t.top+ne-H,S+H,e.height,n,a,h,r,o),this.renderFreezeLines(C,e,O,H)}const E=a==="all";C.fillStyle=E?this.getThemeColor("headerSelectedBGColor"):this.getThemeColor("headerBGColor"),C.fillRect(0,0,b,S),C.strokeStyle=this.getThemeColor("cellBorderColor"),C.lineWidth=Ye,C.strokeRect(0,0,b,S),this.renderFreezeHandles(C,c,u),w&&w.size>0&&this.renderHiddenRowIndicators(C,s[0].r,s[1].r,t.top,S,e.height,r,w,(A==null?void 0:A.axis)==="row"?A.boundary:null),N&&N.size>0&&this.renderHiddenColumnIndicators(C,s[0].c,s[1].c,t.left,b,e.width,o,N,(A==null?void 0:A.axis)==="column"?A.boundary:null)}renderQuadrantCells(e,t,s,n,i,r,o,a,h,c,u,d,f,m,g,y,z,I=null){const k=new Map,M=(A,C,v)=>{const R=T({r:A,c:C});if(k.has(R))return k.get(R)||void 0;const F=this.resolveEffectiveStyle(A,C,v,d,c,u,f,m);return k.set(R,F||null),F},w=this.buildTextOverflowRenderData(e,t,s,n,i,r,h,g,M),N=this.buildRenderableRefs(t,s,n,i,g);for(const{r:A,c:C}of N){const v=T({r:A,c:C}),R=r==null?void 0:r.get(v),F=g==null?void 0:g.anchors.get(v),x=M(A,C,R),$=w==null?void 0:w.hiddenVerticalBoundaries.has(this.verticalBoundaryKey(A,C-1)),E=w==null?void 0:w.hiddenVerticalBoundaries.has(this.verticalBoundaryKey(A,C));this.renderCellBackground(e,{r:A,c:C},R,o,a,h,x,F,$,E)}for(const{r:A,c:C}of N){const v=T({r:A,c:C}),R=r==null?void 0:r.get(v),F=g==null?void 0:g.anchors.get(v),x=M(A,C,R);this.renderCellCustomBorders(e,{r:A,c:C},o,a,h,x,F)}for(const{r:A,c:C}of N){const v=T({r:A,c:C}),R=r==null?void 0:r.get(v),F=g==null?void 0:g.anchors.get(v),x=M(A,C,R),$=w==null?void 0:w.anchorToEndCol.get(v);this.renderCellContent(e,{r:A,c:C},R,o,a,h,x,r,i,F,$)}if(y){const A=y[0].r;if(A>=t&&A<=s){const C=Math.max(n,y[0].c),v=Math.min(i,y[1].c);for(let R=C;R<=v;R++){const F=T({r:A,c:R});if(g!=null&&g.coverToAnchor.has(F))continue;const x=g==null?void 0:g.anchors.get(F);this.renderCellFilterButton(e,{r:A,c:R},o,a,h,x,!!(z!=null&&z.has(R)),I===R)}}}}buildRenderableRefs(e,t,s,n,i){const r=[],o=new Set;for(let a=e;a<=t;a++)for(let h=s;h<=n;h++){const c=T({r:a,c:h});i!=null&&i.coverToAnchor.has(c)||(r.push({r:a,c:h}),o.add(c))}if(!i)return r;for(const[a,h]of i.anchors){if(o.has(a))continue;const c=B(a),u=c.r+h.rs-1,d=c.c+h.cs-1;c.r<=t&&u>=e&&c.c<=n&&d>=s&&r.push(c)}return r}renderColumnHeaders(e,t,s,n,i,r,o,a,h,c,u){e.save(),e.beginPath(),e.rect(i,0,r-i,S),e.clip();for(let d=t;d<=s;d++){const f=u?u.getOffset(d):Y*(d-1),m=u?u.getSize(d):Y;if(m<=0)continue;const g=b+f-n,y=0,z=a==="all"||a==="column"&&h&&d>=h[0].c&&d<=h[1].c;this.renderHeader(e,g,y,m,S,ae(d),o.c===d,z||!1)}e.restore()}renderCellFilterButton(e,t,s,n,i,r,o=!1,a=!1){const h=this.toCellRect(t,s,n,i,r),c=h.width,u=h.height;if(c<=6||u<=6)return;const d=Math.min(16,Math.max(12,c-4)),f=Math.min(16,Math.max(12,u-6)),m=h.left+c-d-2,g=h.top+Math.max(3,(u-f)/2);(o||a)&&(e.fillStyle=o?this.getThemeColor("selectionBGColor"):this.getThemeColor("headerSelectedBGColor"),e.fillRect(m,g,d,f));const y=o||a?this.getThemeColor("resizeHandleColor"):this.getThemeColor("cellTextColor"),z=Math.max(9,Math.min(12,Math.min(d,f)-3)),I=m+(d-z)/2,k=g+(f-z)/2;e.save(),e.translate(I,k),e.scale(z/24,z/24),e.strokeStyle=y,e.lineCap="round",e.lineJoin="round";const M=this.getFilterIconPath2D();M?(e.lineWidth=2,e.stroke(M)):(e.lineWidth=2,e.beginPath(),e.moveTo(4,6),e.lineTo(20,6),e.moveTo(6,12),e.lineTo(18,12),e.moveTo(9,18),e.lineTo(15,18),e.stroke()),e.restore()}getFilterIconPath2D(){return typeof Path2D>"u"?null:(we.filterIconPath2D===void 0&&(we.filterIconPath2D=new Path2D(pn)),we.filterIconPath2D)}renderRowHeaders(e,t,s,n,i,r,o,a,h,c,u){e.save(),e.beginPath(),e.rect(0,i,b,r-i),e.clip();for(let d=t;d<=s;d++){const f=c?c.getOffset(d):S*(d-1),m=c?c.getSize(d):S;if(m<=0)continue;const g=0,y=f+S-n,z=a==="all"||a==="row"&&h&&d>=h[0].r&&d<=h[1].r;this.renderHeader(e,g,y,b,m,String(d),o.r===d,z||!1)}e.restore()}renderFreezeLines(e,t,s,n){if(e.strokeStyle=this.getThemeColor("freezeLineColor"),e.lineWidth=2,n>0){const i=S+n;e.beginPath(),e.moveTo(0,i),e.lineTo(t.width,i),e.stroke()}if(s>0){const i=b+s;e.beginPath(),e.moveTo(i,0),e.lineTo(i,t.height),e.stroke()}}renderFreezeHandles(e,t,s){const n=t.frozenRows>0||t.frozenCols>0,i=es,r=n&&t.frozenRows>0?S+t.frozenHeight-i/2:S-i,o=s==="row";e.fillStyle=o?this.getThemeColor("freezeHandleHoverColor"):this.getThemeColor("freezeHandleColor"),e.fillRect(0,r,b,i);const a=n&&t.frozenCols>0?b+t.frozenWidth-i/2:b-i,h=s==="column";e.fillStyle=h?this.getThemeColor("freezeHandleHoverColor"):this.getThemeColor("freezeHandleColor"),e.fillRect(a,0,i,S)}drawHiddenButton(e,t,s,n,i){const r=i?this.getThemeColor("resizeHandleColor"):this.getThemeColor("headerBGColor"),o=i?"#fff":this.getThemeColor("cellTextColor");if(n==="row"){const a=L*2+J*2,h=L*2+de+J*2,c=t-a/2,u=s-h/2;e.beginPath(),e.roundRect(c,u,a,h,Ft),e.fillStyle=r,e.fill(),i&&(e.strokeStyle=this.getThemeColor("resizeHandleColor"),e.lineWidth=1,e.stroke());const d=s-de/2-L/2;e.fillStyle=o,e.beginPath(),e.moveTo(t,d-L),e.lineTo(t-L,d+L/2),e.lineTo(t+L,d+L/2),e.closePath(),e.fill();const f=s+de/2+L/2;e.beginPath(),e.moveTo(t,f+L),e.lineTo(t-L,f-L/2),e.lineTo(t+L,f-L/2),e.closePath(),e.fill()}else{const a=L*2+de+J*2,h=L*2+J*2,c=t-a/2,u=s-h/2;e.beginPath(),e.roundRect(c,u,a,h,Ft),e.fillStyle=r,e.fill(),i&&(e.strokeStyle=this.getThemeColor("resizeHandleColor"),e.lineWidth=1,e.stroke());const d=t-de/2-L/2;e.fillStyle=o,e.beginPath(),e.moveTo(d-L,s),e.lineTo(d+L/2,s-L),e.lineTo(d+L/2,s+L),e.closePath(),e.fill();const f=t+de/2+L/2;e.beginPath(),e.moveTo(f+L,s),e.lineTo(f-L/2,s-L),e.lineTo(f-L/2,s+L),e.closePath(),e.fill()}}renderHiddenRowIndicators(e,t,s,n,i,r,o,a,h){e.save(),e.beginPath(),e.rect(0,i,b,r-i),e.clip();const u=(L*2+J*2)/2+1;for(let d=t;d<=s+1;d++){if(!a.has(d)&&d>1&&a.has(d-1)){const f=h===d,g=(o?o.getOffset(d):S*(d-1))+S-n;this.drawHiddenButton(e,u,g,"row",f)}if(!a.has(d)&&a.has(d+1)){const f=h===d,m=o?o.getOffset(d):S*(d-1),g=o?o.getSize(d):S,y=m+S-n+g;this.drawHiddenButton(e,u,y,"row",f)}}e.restore()}renderHiddenColumnIndicators(e,t,s,n,i,r,o,a,h){e.save(),e.beginPath(),e.rect(i,0,r-i,S),e.clip();const u=(L*2+J*2)/2+1;for(let d=t;d<=s+1;d++){if(!a.has(d)&&d>1&&a.has(d-1)){const f=h===d,m=o?o.getOffset(d):Y*(d-1),g=b+m-n;this.drawHiddenButton(e,g,u,"column",f)}if(!a.has(d)&&a.has(d+1)){const f=h===d,m=o?o.getOffset(d):Y*(d-1),g=o?o.getSize(d):Y,y=b+m-n+g;this.drawHiddenButton(e,y,u,"column",f)}}e.restore()}renderHeader(e,t,s,n,i,r,o,a=!1){n<=0||i<=0||(e.fillStyle=a?this.getThemeColor("headerSelectedBGColor"):o?this.getThemeColor("headerActiveBGColor"):this.getThemeColor("headerBGColor"),e.fillRect(t,s,n,i),e.strokeStyle=this.getThemeColor("cellBorderColor"),e.lineWidth=Ye,e.strokeRect(t,s,n,i),e.fillStyle=this.getThemeColor("cellTextColor"),e.textAlign=on,e.font=o||a?"bold 10px Arial":"10px Arial",e.fillText(r,t+n/2,s+Math.min(15,i-4)))}renderCellBackground(e,t,s,n,i,r,o,a,h=!1,c=!1){const u=this.toCellRect(t,n,i,r,a),d=o??(s==null?void 0:s.s);if(e.fillStyle=(d==null?void 0:d.bg)||this.getThemeColor("cellBGColor"),e.fillRect(u.left,u.top,u.width,u.height),e.beginPath(),e.strokeStyle=this.getThemeColor("cellBorderColor"),e.lineWidth=Ye,h||(e.moveTo(u.left,u.top),e.lineTo(u.left,u.top+u.height)),!c){const f=u.left+u.width;e.moveTo(f,u.top),e.lineTo(f,u.top+u.height)}e.moveTo(u.left,u.top),e.lineTo(u.left+u.width,u.top),e.moveTo(u.left,u.top+u.height),e.lineTo(u.left+u.width,u.top+u.height),e.stroke()}renderCellCustomBorders(e,t,s,n,i,r,o){if(!r||!r.bt&&!r.br&&!r.bb&&!r.bl)return;const a=this.toCellRect(t,s,n,i,o);if(e.beginPath(),e.strokeStyle=this.getThemeColor("customBorderColor"),e.lineWidth=rn,r.bt&&(e.moveTo(a.left,a.top),e.lineTo(a.left+a.width,a.top)),r.br){const h=a.left+a.width;e.moveTo(h,a.top),e.lineTo(h,a.top+a.height)}if(r.bb){const h=a.top+a.height;e.moveTo(a.left,h),e.lineTo(a.left+a.width,h)}r.bl&&(e.moveTo(a.left,a.top),e.lineTo(a.left,a.top+a.height)),e.stroke()}renderCellContent(e,t,s,n,i,r,o,a,h,c,u){const d=this.toCellRect(t,n,i,r,c),f=o??(s==null?void 0:s.s),m=(s==null?void 0:s.v)||"";if(m){const g=Xe(m,f==null?void 0:f.nf,f==null?void 0:f.dp),y=g.split(`
`),z=this.toCellFont(f);let I=d.width;const k=(f==null?void 0:f.al)||"left";if(!c&&u&&r&&u>t.c){let C=0;for(let v=t.c+1;v<=u;v++)C+=r.getSize(v);I=d.width+C}else if(!c&&y.length===1&&k==="left"&&a&&r&&h){e.save(),e.font=z;const C=e.measureText(g).width+Ae*2;if(e.restore(),C>d.width){let v=0;for(let R=t.c+1;R<=h;R++){const F=a.get(T({r:t.r,c:R}));if(F&&(F.v||F.f))break;const x=r.getSize(R);if(v+=x,d.width+v>=C)break}I=d.width+v}}e.save(),e.beginPath(),e.rect(d.left,d.top,I,d.height),e.clip(),e.fillStyle=(f==null?void 0:f.tc)||this.getThemeColor("cellTextColor"),e.font=z,e.textBaseline="top";let M;k==="center"?(e.textAlign="center",M=d.left+d.width/2):k==="right"?(e.textAlign="right",M=d.left+d.width-Ae):(e.textAlign="left",M=d.left+Ae);const w=(f==null?void 0:f.va)||"top",N=y.length*fe*We;let A;w==="middle"?A=d.top+(d.height-N)/2:w==="bottom"?A=d.top+d.height-N-je:A=d.top+je;for(let C=0;C<y.length;C++){const v=A+C*(fe*We);if(e.fillText(y[C],M,v),f!=null&&f.u){const R=e.measureText(y[C]),F=v+fe+1;let x;k==="center"?x=M-R.width/2:k==="right"?x=M-R.width:x=M,e.beginPath(),e.strokeStyle=(f==null?void 0:f.tc)||this.getThemeColor("cellTextColor"),e.lineWidth=1,e.moveTo(x,F),e.lineTo(x+R.width,F),e.stroke()}if(f!=null&&f.st){const R=e.measureText(y[C]),F=v+fe/2;let x;k==="center"?x=M-R.width/2:k==="right"?x=M-R.width:x=M,e.beginPath(),e.strokeStyle=(f==null?void 0:f.tc)||this.getThemeColor("cellTextColor"),e.lineWidth=1,e.moveTo(x,F),e.lineTo(x+R.width,F),e.stroke()}}e.restore()}}buildTextOverflowRenderData(e,t,s,n,i,r,o,a,h){if(!r||!o)return;const c=new Map,u=new Set;e.save();for(let d=t;d<=s;d++)for(let f=n;f<=i;f++){const m=T({r:d,c:f});if(a!=null&&a.coverToAnchor.has(m)||a!=null&&a.anchors.has(m))continue;const g=r.get(m),y=(g==null?void 0:g.v)||"";if(!y)continue;const z=h==null?void 0:h(d,f,g);if(((z==null?void 0:z.al)||"left")!=="left")continue;const k=Xe(y,z==null?void 0:z.nf,z==null?void 0:z.dp);if(k.split(`
`).length!==1)continue;const w=o.getSize(f);e.font=this.toCellFont(z);const N=e.measureText(k).width+Ae*2;if(N<=w)continue;let A=w,C=f;for(let v=f+1;v<=i;v++){const R=h==null?void 0:h(d,v-1,r.get(T({r:d,c:v-1}))),F=h==null?void 0:h(d,v,r.get(T({r:d,c:v})));if(R!=null&&R.br||F!=null&&F.bl)break;const x=T({r:d,c:v});if(a!=null&&a.coverToAnchor.has(x)||a!=null&&a.anchors.has(x))break;const $=r.get(x);if($&&($.v||$.f)||(A+=o.getSize(v),C=v,A>=N))break}if(C>f){c.set(m,C);for(let v=f;v<C;v++)u.add(this.verticalBoundaryKey(d,v))}}if(e.restore(),c.size!==0)return{anchorToEndCol:c,hiddenVerticalBoundaries:u}}resolveEffectiveStyle(e,t,s,n,i,r,o,a){const h=i==null?void 0:i.get(t),c=r==null?void 0:r.get(e),u=o?Gt(o,e,t):void 0,d=a?Ms(a,e,t,s):void 0;if(!(!n&&!h&&!c&&!u&&!(s!=null&&s.s)&&!d))return{...n,...h,...c,...u,...s==null?void 0:s.s,...d}}buildMergeRenderData(e){if(!e||e.size===0)return;const t=new Map,s=new Map;for(const[n,i]of e){t.set(n,i);const r=B(n);for(let o=r.r;o<r.r+i.rs;o++)for(let a=r.c;a<r.c+i.cs;a++){const h=T({r:o,c:a});h!==n&&s.set(h,n)}}return{anchors:t,coverToAnchor:s}}toCellRect(e,t,s,n,i){const r=V(e,t,s,n);if(!i||i.rs===1&&i.cs===1)return r;const o=V({r:e.r+i.rs-1,c:e.c+i.cs-1},t,s,n);return{left:r.left,top:r.top,width:o.left+o.width-r.left,height:o.top+o.height-r.top}}toCellFont(e){const t=[];return e!=null&&e.b&&t.push("bold"),e!=null&&e.i&&t.push("italic"),t.push(`${fe}px Arial`),t.join(" ")}verticalBoundaryKey(e,t){return`${e}:${t}`}getThemeColor(e){return P(this.theme,e)}cleanup(){this.canvas.remove()}};p(we,"filterIconPath2D");let qe=we;class gn{constructor(e="light"){p(this,"container");p(this,"theme");this.theme=e,this.container=document.createElement("div"),this.container.style.position="fixed",this.container.style.display="none",this.container.style.zIndex="1000",this.container.style.minWidth="160px",this.container.style.borderRadius="4px",this.container.style.boxShadow="0 2px 8px rgba(0,0,0,0.2)",this.container.style.padding="4px 0",this.container.style.fontSize="13px",this.container.style.fontFamily='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',this.applyTheme(),this.handleDocumentClick=this.handleDocumentClick.bind(this)}getContainer(){return this.container}show(e,t,s){this.container.innerHTML="";for(const n of s){const i=document.createElement("div");i.textContent=n.label,i.style.padding="6px 16px",i.style.cursor="pointer",i.style.color=P(this.theme,"cellTextColor"),i.addEventListener("mouseenter",()=>{i.style.backgroundColor=P(this.theme,"selectionBGColor")}),i.addEventListener("mouseleave",()=>{i.style.backgroundColor="transparent"}),i.addEventListener("mousedown",r=>{r.preventDefault(),r.stopPropagation(),this.hide(),n.action()}),this.container.appendChild(i)}this.container.style.left=`${e}px`,this.container.style.top=`${t}px`,this.container.style.display="block",document.addEventListener("mousedown",this.handleDocumentClick)}hide(){this.container.style.display="none",document.removeEventListener("mousedown",this.handleDocumentClick)}cleanup(){this.hide(),this.container.remove()}handleDocumentClick(e){this.container.contains(e.target)||this.hide()}applyTheme(){this.container.style.backgroundColor=P(this.theme,"cellBGColor"),this.container.style.border=`1px solid ${P(this.theme,"cellBorderColor")}`}}function mn(l,e){if(!l.startsWith("="))return{type:"none"};const t=l.slice(1,e);let s=0,n=0;for(let r=t.length-1;r>=0;r--){const o=t[r];if(o===")")s++;else if(o==="(")if(s>0)s--;else{const a=t.slice(0,r).match(/([A-Za-z_]\w*)$/);return a?{type:"argument",funcName:a[1].toUpperCase(),argIndex:n}:{type:"none"}}else o===","&&s===0&&n++}const i=t.match(/([A-Za-z_]\w*)$/);return i?{type:"function-name",prefix:i[1]}:{type:"none"}}class yn{constructor(e="light"){p(this,"container");p(this,"theme");p(this,"selectedIndex",0);p(this,"matches",[]);p(this,"mode","hidden");p(this,"currentHint",null);this.theme=e,this.container=document.createElement("div"),this.container.style.position="fixed",this.container.style.display="none",this.container.style.zIndex="1000",this.container.style.minWidth="220px",this.container.style.maxWidth="360px",this.container.style.borderRadius="4px",this.container.style.boxShadow="0 2px 8px rgba(0,0,0,0.2)",this.container.style.padding="4px 0",this.container.style.fontSize="13px",this.container.style.fontFamily='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',this.container.style.overflow="hidden",this.applyTheme()}getContainer(){return this.container}showList(e,t){if(this.matches=is(e),this.matches.length===0){this.hide();return}this.mode="list",this.selectedIndex=0,this.renderList(),this.positionAt(t),this.container.style.display="block"}showHint(e,t,s){const n=rs(e);if(!n){this.hide();return}this.mode="hint",this.currentHint={info:n,argIndex:t},this.renderHint(),this.positionAt(s),this.container.style.display="block"}hide(){this.mode="hidden",this.matches=[],this.currentHint=null,this.container.style.display="none",this.container.innerHTML=""}reposition(e){this.mode!=="hidden"&&this.positionAt(e)}moveUp(){this.mode!=="list"||this.matches.length===0||(this.selectedIndex=(this.selectedIndex-1+this.matches.length)%this.matches.length,this.renderList())}moveDown(){this.mode!=="list"||this.matches.length===0||(this.selectedIndex=(this.selectedIndex+1)%this.matches.length,this.renderList())}getSelectedFunction(){if(this.mode==="list")return this.matches[this.selectedIndex]}isListVisible(){return this.mode==="list"}isHintVisible(){return this.mode==="hint"}cleanup(){this.hide(),this.container.remove()}positionAt(e){this.container.style.left=`${e.left}px`,this.container.style.top=`${e.top}px`}renderList(){this.container.innerHTML="";const e=P(this.theme,"cellBGColor"),t=P(this.theme,"cellTextColor"),s=P(this.theme,"selectionBGColor"),n=P(this.theme,"activeCellColor");for(let i=0;i<this.matches.length;i++){const r=this.matches[i],o=document.createElement("div");o.style.padding="4px 10px",o.style.cursor="pointer",o.style.display="flex",o.style.flexDirection="column",o.style.gap="1px",o.style.backgroundColor=i===this.selectedIndex?s:e;const a=document.createElement("div");a.style.fontWeight="600",a.style.color=i===this.selectedIndex?n:t,a.textContent=r.name;const h=document.createElement("div");h.style.fontSize="11px",h.style.opacity="0.7",h.style.color=t,h.textContent=r.description,o.appendChild(a),o.appendChild(h),o.addEventListener("mouseenter",()=>{this.selectedIndex=i,this.renderList()}),o.addEventListener("mousedown",c=>{c.preventDefault(),c.stopPropagation()}),this.container.appendChild(o)}}renderHint(){if(this.container.innerHTML="",!this.currentHint)return;const{info:e,argIndex:t}=this.currentHint,s=P(this.theme,"cellTextColor"),n=P(this.theme,"activeCellColor"),i=document.createElement("div");i.style.padding="6px 10px",i.style.color=s,i.style.whiteSpace="nowrap";const r=document.createElement("span");r.style.fontWeight="600",r.textContent=e.name+"(",i.appendChild(r);for(let a=0;a<e.args.length;a++){a>0&&i.appendChild(document.createTextNode(", "));const h=e.args[a];let c=h.optional?`[${h.name}]`:h.name;h.repeating&&(c+=", ...");const u=document.createElement("span");(a===t||a===e.args.length-1&&h.repeating&&t>=a)&&(u.style.fontWeight="700",u.style.color=n),u.textContent=c,i.appendChild(u)}i.appendChild(document.createTextNode(")"));const o=document.createElement("div");o.style.fontSize="11px",o.style.opacity="0.7",o.style.color=s,o.style.padding="2px 10px 4px",o.textContent=_e(e)+" — "+e.description,this.container.appendChild(i),this.container.appendChild(o)}applyTheme(){this.container.style.backgroundColor=P(this.theme,"cellBGColor"),this.container.style.border=`1px solid ${P(this.theme,"cellBorderColor")}`}}class wn{constructor(e="light"){p(this,"theme");p(this,"container");p(this,"panel");p(this,"searchInput");p(this,"status");p(this,"list");p(this,"rows",[]);p(this,"matches",[...Ge]);p(this,"selectedIndex",0);p(this,"listTextColor","");p(this,"listSelectedBG","");p(this,"listActiveColor","");p(this,"onInsert");p(this,"onClose");p(this,"boundHandleBackdropMouseDown");p(this,"boundHandleSearchInput");p(this,"boundHandleSearchKeydown");p(this,"boundHandleListPointerDown");p(this,"boundHandleListClick");p(this,"boundHandleListMouseOver");this.theme=e,this.container=document.createElement("div"),this.container.style.position="fixed",this.container.style.inset="0",this.container.style.display="none",this.container.style.zIndex="1100",this.container.style.backgroundColor="rgba(0, 0, 0, 0.18)",this.container.style.padding="40px 16px 16px",this.container.style.boxSizing="border-box",this.panel=document.createElement("div"),this.panel.style.margin="0 auto",this.panel.style.maxWidth="720px",this.panel.style.height="min(560px, calc(100vh - 72px))",this.panel.style.display="flex",this.panel.style.flexDirection="column",this.panel.style.backgroundColor=P(this.theme,"cellBGColor"),this.panel.style.border=`1px solid ${P(this.theme,"cellBorderColor")}`,this.panel.style.borderRadius="8px",this.panel.style.boxShadow="0 10px 30px rgba(0, 0, 0, 0.2)",this.panel.style.color=P(this.theme,"cellTextColor"),this.panel.style.overflow="hidden";const t=document.createElement("div");t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="space-between",t.style.padding="12px 14px",t.style.borderBottom=`1px solid ${P(this.theme,"cellBorderColor")}`;const s=document.createElement("div");s.textContent="Functions",s.style.font="600 14px Arial",t.appendChild(s);const n=document.createElement("button");n.type="button",n.textContent="Close",n.style.border=`1px solid ${P(this.theme,"cellBorderColor")}`,n.style.borderRadius="4px",n.style.backgroundColor=P(this.theme,"cellBGColor"),n.style.color=P(this.theme,"cellTextColor"),n.style.padding="4px 8px",n.style.font="12px Arial",n.style.cursor="pointer",n.addEventListener("click",()=>this.hide()),t.appendChild(n);const i=document.createElement("div");i.style.display="flex",i.style.flexDirection="column",i.style.gap="6px",i.style.padding="12px 14px 10px",i.style.borderBottom=`1px solid ${P(this.theme,"cellBorderColor")}`,this.searchInput=document.createElement("input"),this.searchInput.type="text",this.searchInput.placeholder="Search by name or description",this.searchInput.style.width="100%",this.searchInput.style.boxSizing="border-box",this.searchInput.style.padding="7px 10px",this.searchInput.style.border=`1px solid ${P(this.theme,"cellBorderColor")}`,this.searchInput.style.borderRadius="4px",this.searchInput.style.outline="none",this.searchInput.style.font="13px Arial",this.searchInput.style.color=P(this.theme,"cellTextColor"),this.searchInput.style.backgroundColor=P(this.theme,"cellBGColor"),i.appendChild(this.searchInput),this.status=document.createElement("div"),this.status.style.font="12px Arial",this.status.style.opacity="0.75",i.appendChild(this.status),this.list=document.createElement("div"),this.list.style.flex="1",this.list.style.overflow="auto",this.list.style.padding="6px 0",this.panel.appendChild(t),this.panel.appendChild(i),this.panel.appendChild(this.list),this.container.appendChild(this.panel),this.boundHandleBackdropMouseDown=r=>{r.target===this.container&&this.hide()},this.boundHandleSearchInput=()=>{this.selectedIndex=0,this.filterAndRender()},this.boundHandleSearchKeydown=r=>{if(r.key==="ArrowDown"){r.preventDefault(),this.matches.length>0&&(this.setSelectedIndex((this.selectedIndex+1)%this.matches.length),this.scrollSelectedIntoView());return}if(r.key==="ArrowUp"){r.preventDefault(),this.matches.length>0&&(this.setSelectedIndex((this.selectedIndex-1+this.matches.length)%this.matches.length),this.scrollSelectedIntoView());return}if(r.key==="Enter"){r.preventDefault(),this.insertSelected();return}r.key==="Escape"&&(r.preventDefault(),this.hide())},this.boundHandleListPointerDown=r=>{if(r.button!==0)return;const o=this.getRowIndexFromTarget(r.target);o!==null&&(r.preventDefault(),this.setSelectedIndex(o),this.insertSelected())},this.boundHandleListClick=r=>{if(r.button!==0||!this.isVisible())return;const o=this.getRowIndexFromTarget(r.target);o!==null&&(r.preventDefault(),this.setSelectedIndex(o),this.insertSelected())},this.boundHandleListMouseOver=r=>{const o=this.getRowIndexFromTarget(r.target);o===null||o===this.selectedIndex||this.setSelectedIndex(o)},this.container.addEventListener("mousedown",this.boundHandleBackdropMouseDown),this.searchInput.addEventListener("input",this.boundHandleSearchInput),this.searchInput.addEventListener("keydown",this.boundHandleSearchKeydown),this.list.addEventListener("pointerdown",this.boundHandleListPointerDown),this.list.addEventListener("click",this.boundHandleListClick),this.list.addEventListener("mouseover",this.boundHandleListMouseOver),this.filterAndRender()}getContainer(){return this.container}setOnInsert(e){this.onInsert=e}setOnClose(e){this.onClose=e}contains(e){return e instanceof Node&&this.container.contains(e)}isVisible(){return this.container.style.display!=="none"}show(){this.searchInput.value="",this.selectedIndex=0,this.filterAndRender(),this.container.style.display="block",requestAnimationFrame(()=>this.searchInput.focus())}hide(){var e;this.isVisible()&&(this.container.style.display="none",(e=this.onClose)==null||e.call(this))}cleanup(){this.container.removeEventListener("mousedown",this.boundHandleBackdropMouseDown),this.searchInput.removeEventListener("input",this.boundHandleSearchInput),this.searchInput.removeEventListener("keydown",this.boundHandleSearchKeydown),this.list.removeEventListener("pointerdown",this.boundHandleListPointerDown),this.list.removeEventListener("click",this.boundHandleListClick),this.list.removeEventListener("mouseover",this.boundHandleListMouseOver),this.container.remove()}filterAndRender(){const e=this.searchInput.value.trim().toUpperCase(),t=e.length===0?Ge:Ge.filter(n=>{const i=n.name.toUpperCase(),r=n.description.toUpperCase(),o=_e(n).toUpperCase();return i.includes(e)||r.includes(e)||o.includes(e)}),s=new Map(os.map((n,i)=>[n,i]));this.matches=[...t].sort((n,i)=>{const r=s.get(n.category)??Number.MAX_SAFE_INTEGER,o=s.get(i.category)??Number.MAX_SAFE_INTEGER;return r!==o?r-o:n.name.localeCompare(i.name)}),this.selectedIndex>=this.matches.length&&(this.selectedIndex=Math.max(0,this.matches.length-1)),this.renderList()}renderList(){this.list.innerHTML="",this.rows=[];const e=ls(this.matches);if(this.status.textContent=`${this.matches.length} functions in ${e.length} categories`,this.matches.length===0){const n=document.createElement("div");n.textContent="No matching functions",n.style.padding="16px 14px",n.style.font="13px Arial",n.style.opacity="0.8",this.list.appendChild(n);return}const t=P(this.theme,"cellBorderColor");this.listTextColor=P(this.theme,"cellTextColor"),this.listSelectedBG=P(this.theme,"selectionBGColor"),this.listActiveColor=P(this.theme,"activeCellColor");let s=null;for(let n=0;n<this.matches.length;n++){const i=this.matches[n];if(i.category!==s){const f=document.createElement("div");f.dataset.funcCategoryHeader=i.category,f.textContent=i.category,f.style.padding="8px 14px 4px",f.style.font="600 11px Arial",f.style.letterSpacing="0.04em",f.style.textTransform="uppercase",f.style.opacity="0.68",f.style.borderBottom=`1px solid ${t}`,f.style.backgroundColor=P(this.theme,"headerBGColor"),this.list.appendChild(f),s=i.category}const r=document.createElement("div");r.dataset.funcName=i.name,r.dataset.funcIndex=String(n),r.style.display="flex",r.style.gap="10px",r.style.alignItems="flex-start",r.style.justifyContent="flex-start",r.style.padding="10px 14px",r.style.cursor="pointer",r.style.borderBottom=`1px solid ${t}`,r.style.backgroundColor="transparent";const o=document.createElement("div");o.style.minWidth="0",o.style.flex="1";const a=document.createElement("div");a.style.display="flex",a.style.alignItems="center",a.style.justifyContent="space-between",a.style.gap="8px";const h=document.createElement("div");h.textContent=i.name,h.style.font="600 13px Arial",h.style.color=this.listTextColor,h.style.flex="1";const c=document.createElement("div");c.textContent=i.category,c.style.font="11px Arial",c.style.opacity="0.66",c.style.whiteSpace="nowrap";const u=document.createElement("div");u.textContent=_e(i),u.style.font="12px Arial",u.style.opacity="0.82",u.style.marginTop="2px",u.style.wordBreak="break-word";const d=document.createElement("div");d.textContent=i.description,d.style.font="12px Arial",d.style.opacity="0.72",d.style.marginTop="2px",d.style.wordBreak="break-word",a.appendChild(h),a.appendChild(c),o.appendChild(a),o.appendChild(u),o.appendChild(d),r.appendChild(o),this.list.appendChild(r),this.rows.push({row:r,name:h})}this.updateRowSelection(this.selectedIndex)}scrollSelectedIntoView(){var t;const e=(t=this.rows[this.selectedIndex])==null?void 0:t.row;e&&e.scrollIntoView({block:"nearest"})}getRowIndexFromTarget(e){if(!(e instanceof Element))return null;const t=e.closest("[data-func-index]");if(!(t instanceof HTMLDivElement)||!this.list.contains(t))return null;const s=Number(t.dataset.funcIndex);return Number.isInteger(s)?s:null}setSelectedIndex(e){if(e===this.selectedIndex||e<0||e>=this.matches.length)return;const t=this.selectedIndex;this.selectedIndex=e,this.updateRowSelection(t),this.updateRowSelection(e)}updateRowSelection(e){const t=this.rows[e];if(!t)return;const s=e===this.selectedIndex;t.row.style.backgroundColor=s?this.listSelectedBG:"transparent",t.name.style.color=s?this.listActiveColor:this.listTextColor}insertSelected(){var t;const e=this.matches[this.selectedIndex];e&&((t=this.onInsert)==null||t.call(this,e),this.hide())}}const Mt=l=>l.length===1?l.toLowerCase():l,De=l=>l.metaKey||l.ctrlKey,W=(l,e)=>Mt(l.key)===Mt(e),X=(l,e)=>!(!W(l,e.key)||e.mod!==void 0&&De(l)!==e.mod||e.shift!==void 0&&l.shiftKey!==e.shift||e.alt!==void 0&&l.altKey!==e.alt),It=async(l,e)=>{for(const t of e)if(t.match(l))return await t.run(l),!0;return!1},Be=6,Cn=10,Tt=20,xt=120,At=300,vn=1800,me=8,Ee=4,Sn=200,ye=8;function Pe(l){return l.isComposing||l.key==="Process"||l.keyCode===229}function Rn(l,e){return!e.has(l)&&l>1&&e.has(l-1)}function bn(l,e){return!e.has(l)&&e.has(l+1)}function Fn(l,e){return!e.has(l)&&l>1&&e.has(l-1)}function zn(l,e){return!e.has(l)&&e.has(l+1)}class Mn{constructor(e,t="light",s=!1){p(this,"sheet");p(this,"theme");p(this,"container");p(this,"formulaBar");p(this,"cellInput");p(this,"overlay");p(this,"gridContainer");p(this,"gridCanvas");p(this,"contextMenu");p(this,"autocomplete");p(this,"functionBrowser");p(this,"resizeTooltip");p(this,"filterPanel");p(this,"filterPanelState",null);p(this,"filterPanelOutsideClickUnsub",null);p(this,"filterPanelKeyboardUnsub",null);p(this,"rowDim");p(this,"colDim");p(this,"hiddenRows",new Set);p(this,"hiddenRowSizeBackup",new Map);p(this,"hiddenColumns",new Set);p(this,"hiddenColSizeBackup",new Map);p(this,"listeners",[]);p(this,"interactionCleanups",new Set);p(this,"resizeObserver");p(this,"preventDocumentSelectStart",e=>{e.preventDefault()});p(this,"resizeHover",null);p(this,"resizeDragging",!1);p(this,"dragMove",null);p(this,"editMode",!1);p(this,"manuallyResizedRows",new Set);p(this,"formulaRanges",[]);p(this,"freezeState",pe);p(this,"freezeHandleHover",null);p(this,"filterButtonHoverCol",null);p(this,"hiddenIndicatorHover",null);p(this,"freezeDrag",null);p(this,"autofillPreview");p(this,"onRenderCallback");p(this,"readOnly");p(this,"formulaRangeAnchor",null);p(this,"activeFormulaInput",null);p(this,"formulaRefInsertPos",null);p(this,"lastFormulaRefTarget",null);p(this,"nativeSelectionBlockDepth",0);p(this,"previousBodyUserSelect","");p(this,"previousBodyWebkitUserSelect","");p(this,"pendingRenderFrame",null);p(this,"renderInFlight",!1);p(this,"renderQueued",!1);p(this,"renderVersion",0);this.container=e,this.theme=t,this.readOnly=s,this.formulaBar=new nn(t,s),this.gridContainer=new fn(t),this.overlay=new un(t),this.gridCanvas=new qe(t),this.cellInput=new dn(t),this.cellInput.setOnPrimedActivate(()=>{this.syncCellInputStyleForActiveCell()}),this.contextMenu=new gn(t),this.autocomplete=new yn(t),this.functionBrowser=new wn(t),this.resizeTooltip=document.createElement("div"),this.filterPanel=document.createElement("div"),this.rowDim=new ft(S),this.colDim=new ft(Y),this.gridContainer.appendChild(this.overlay.getContainer()),this.gridContainer.appendChild(this.gridCanvas.getCanvas()),this.gridContainer.appendChild(this.cellInput.getContainer()),this.container.appendChild(this.formulaBar.getContainer()),this.container.appendChild(this.gridContainer.getContainer()),this.container.appendChild(this.contextMenu.getContainer()),this.container.appendChild(this.autocomplete.getContainer()),document.body.appendChild(this.functionBrowser.getContainer()),this.resizeTooltip.style.position="fixed",this.resizeTooltip.style.display="none",this.resizeTooltip.style.pointerEvents="none",this.resizeTooltip.style.zIndex="1001",this.resizeTooltip.style.padding="4px 8px",this.resizeTooltip.style.borderRadius="4px",this.resizeTooltip.style.border=`1px solid ${P(t,"cellBorderColor")}`,this.resizeTooltip.style.backgroundColor=P(t,"cellBGColor"),this.resizeTooltip.style.color=P(t,"cellTextColor"),this.resizeTooltip.style.fontSize="11px",this.resizeTooltip.style.fontFamily='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',this.resizeTooltip.style.boxShadow="0 2px 8px rgba(0, 0, 0, 0.15)",document.body.appendChild(this.resizeTooltip),this.filterPanel.style.position="fixed",this.filterPanel.style.display="none",this.filterPanel.style.zIndex="1002",this.filterPanel.style.width="260px",this.filterPanel.style.maxHeight="360px",this.filterPanel.style.overflow="hidden",this.filterPanel.style.borderRadius="6px",this.filterPanel.style.border=`1px solid ${P(t,"cellBorderColor")}`,this.filterPanel.style.backgroundColor=P(t,"cellBGColor"),this.filterPanel.style.color=P(t,"cellTextColor"),this.filterPanel.style.fontSize="12px",this.filterPanel.style.fontFamily='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',this.filterPanel.style.boxShadow="0 4px 14px rgba(0, 0, 0, 0.2)",document.body.appendChild(this.filterPanel),this.functionBrowser.setOnInsert(n=>{this.readOnly||this.insertFunctionFromBrowser(n.name)}),this.resizeObserver=new ResizeObserver(()=>this.render())}async initialize(e){this.sheet=e,this.sheet.setDimensions(this.rowDim,this.colDim),await this.sheet.loadDimensions(),await this.sheet.loadStyles(),await this.sheet.loadMerges(),await this.sheet.loadFreezePane(),await this.sheet.loadFilterState(),await this.sheet.loadHiddenState(),this.hiddenRows.clear(),this.hiddenRowSizeBackup.clear(),this.hiddenColumns.clear(),this.hiddenColSizeBackup.clear(),this.syncHiddenRowsFromSheet(),this.syncHiddenColumnsFromSheet(),this.updateFreezeState(),this.formulaBar.initialize(e),this.addEventListeners(),this.resizeObserver.observe(this.container),this.render(),this.primeCellInputForSelection()}updateFreezeState(){const{frozenRows:e,frozenCols:t}=this.sheet.getFreezePane();this.freezeState=an(e,t,this.rowDim,this.colDim)}async setFreezePane(e,t){await this.sheet.setFreezePane(e,t),this.updateFreezeState(),this.render()}async reloadFreezePane(){await this.sheet.loadFreezePane(),this.updateFreezeState()}panBy(e,t){this.gridContainer.scrollBy(e,t)}handleMobileDoubleTap(e,t){const{x:s,y:n}=this.clampClientPointToViewport(e,t);this.handleDblClickAt(s,n)}async focusCell(e){await this.finishEditing(),this.focusGrid(),this.sheet.selectStart(e),this.render(),this.scrollIntoView(),this.primeCellInputForSelection()}cleanup(){this.pendingRenderFrame!==null&&(cancelAnimationFrame(this.pendingRenderFrame),this.pendingRenderFrame=null),this.cancelActiveInteractions(),this.removeAllEventListeners(),this.forceEndNativeSelectionBlock(),this.resizeObserver.disconnect(),this.formulaBar.cleanup(),this.cellInput.cleanup(),this.overlay.cleanup(),this.gridCanvas.cleanup(),this.gridContainer.cleanup(),this.contextMenu.cleanup(),this.autocomplete.cleanup(),this.functionBrowser.cleanup(),this.resizeTooltip.remove(),this.hideFilterPanel(),this.filterPanel.remove(),this.sheet=void 0,this.container.innerHTML=""}beginNativeSelectionBlock(){if(this.nativeSelectionBlockDepth+=1,this.nativeSelectionBlockDepth!==1)return;const e=document.body.style;this.previousBodyUserSelect=e.userSelect,this.previousBodyWebkitUserSelect=e.webkitUserSelect,e.userSelect="none",e.webkitUserSelect="none",document.addEventListener("selectstart",this.preventDocumentSelectStart)}endNativeSelectionBlock(){if(this.nativeSelectionBlockDepth===0||(this.nativeSelectionBlockDepth-=1,this.nativeSelectionBlockDepth>0))return;const e=document.body.style;e.userSelect=this.previousBodyUserSelect,e.webkitUserSelect=this.previousBodyWebkitUserSelect,document.removeEventListener("selectstart",this.preventDocumentSelectStart)}forceEndNativeSelectionBlock(){this.nativeSelectionBlockDepth!==0&&(this.nativeSelectionBlockDepth=1,this.endNativeSelectionBlock())}showResizeTooltip(e,t,s,n,i){const r=e==="column"?"Width":"Height",o=i>1?` (${i} ${e==="column"?"columns":"rows"})`:"";this.resizeTooltip.textContent=`${r}: ${Math.round(t)}px${o}`,this.resizeTooltip.style.left=`${s+12}px`,this.resizeTooltip.style.top=`${n+12}px`,this.resizeTooltip.style.display="block"}hideResizeTooltip(){this.resizeTooltip.style.display="none"}bindEventListener(e,t,s,n){e.addEventListener(t,s,n);let i=!0;return()=>{i&&(i=!1,e.removeEventListener(t,s,n))}}addEventListener(e,t,s,n){const i=this.bindEventListener(e,t,s,n);return this.listeners.push(i),i}registerInteractionCleanup(e){let t=!0;const s=()=>{t&&(t=!1,this.interactionCleanups.delete(s),e())};return this.interactionCleanups.add(s),s}addInteractionEventListener(e,t,s,n){const i=this.bindEventListener(e,t,s,n);return this.registerInteractionCleanup(i)}startMouseDragSession({onMove:e,onComplete:t,onCleanup:s}){let n=()=>{};const i=()=>{try{t==null||t()}finally{n()}},r=this.addInteractionEventListener(document,"mousemove",e),o=this.addInteractionEventListener(document,"mouseup",i);return n=this.registerInteractionCleanup(()=>{r(),o(),s==null||s()}),n}cancelActiveInteractions(){for(const e of Array.from(this.interactionCleanups))e()}removeAllEventListeners(){for(const e of this.listeners)e();this.listeners=[]}focusGrid(){var e;this.formulaBar.blur(),this.cellInput.hide(),this.autocomplete.hide(),this.functionBrowser.hide(),this.formulaRanges=[],this.resetFormulaRangeState(),(e=window.getSelection())==null||e.removeAllRanges()}async finishEditing(){this.autocomplete.hide(),this.functionBrowser.hide();const e=this.sheet.getActiveCell();let t=!1;if(this.formulaBar.isFocused())this.readOnly||(await this.sheet.setData(e,this.formulaBar.getValue()),t=!0),this.formulaBar.blur(),this.cellInput.hide();else if(this.cellInput.isFocused())this.cellInput.isPrimed()?this.cellInput.hide():(this.readOnly||(await this.sheet.setData(e,this.cellInput.getValue()),t=!0),this.cellInput.hide());else return;this.formulaRanges=[],this.resetFormulaRangeState(),t&&await this.autoResizeRow(e.r)}isExternalInput(e){if(this.functionBrowser.contains(e))return!0;if(!(e instanceof Element)||this.container.contains(e))return!1;const t=e.tagName;return!!(t==="INPUT"||t==="TEXTAREA"||t==="SELECT"||e.isContentEditable)}handleKeyDown(e){if(this.functionBrowser.isVisible()){e.key==="Escape"&&(e.preventDefault(),this.functionBrowser.hide());return}if(!this.isExternalInput(e.target)){if(this.formulaBar.isFocused()){this.handleFormulaKeydown(e);return}else if(this.cellInput.isFocused()){if(this.cellInput.isPrimed()){this.handleGridKeydown(e);return}this.handleCellInputKeydown(e);return}this.handleGridKeydown(e)}}handleDocumentCompositionStart(e){this.readOnly||this.functionBrowser.isVisible()||this.isExternalInput(e.target)||this.formulaBar.isFocused()||this.cellInput.isFocused()||this.showCellInput(!0,!1,!0)}handleKeyUp(e){if(this.functionBrowser.isVisible()||Pe(e)||this.formulaBar.isComposing()||this.cellInput.isComposing()||this.isExternalInput(e.target))return;const s=(e.key==="ArrowDown"||e.key==="ArrowUp"||e.key==="Escape"||e.key==="Enter"||e.key==="Tab")&&(this.autocomplete.isListVisible()||this.autocomplete.isHintVisible());let n,i;this.formulaBar.isFocused()?(n=this.formulaBar.getValue(),i=this.formulaBar.getFormulaInput(),this.cellInput.setValue(n)):this.cellInput.isFocused()&&!this.cellInput.isPrimed()&&(n=this.cellInput.getValue(),i=this.cellInput.getInput(),this.formulaBar.setValue(n)),n!==void 0&&n.startsWith("=")?(this.formulaRanges=Se(n).map(r=>r.range),this.renderOverlay()):n!==void 0&&(this.formulaRanges=[],this.renderOverlay()),!s&&(i&&n!==void 0?this.updateAutocomplete(n,i):this.autocomplete.hide())}updateAutocomplete(e,t){if(!e.startsWith("=")){this.autocomplete.hide();return}const s=le(t);if(!s){this.autocomplete.hide();return}const n=s.end,i=mn(e,n),r=t.getBoundingClientRect(),o={left:r.left,top:r.bottom+2};i.type==="function-name"?this.autocomplete.showList(i.prefix,o):i.type==="argument"?this.autocomplete.showHint(i.funcName,i.argIndex,o):this.autocomplete.hide()}toggleFunctionBrowser(){if(this.functionBrowser.isVisible()){this.functionBrowser.hide();return}this.autocomplete.hide(),this.functionBrowser.show()}insertFunctionCompletion(e,t){const s=t.innerText,n=le(t);if(!n)return;const i=n.end,o=s.slice(0,i).match(/([A-Za-z_]\w*)$/);if(!o)return;const a=i-o[1].length,h=s.slice(i),c=s.slice(0,a)+e+"("+h;this.formulaBar.setValue(c),this.cellInput.setValue(c);const u=a+e.length+1;ue(t,{start:u,end:u}),this.autocomplete.hide(),this.updateAutocomplete(c,t)}async insertFunctionFromBrowser(e){const t=await this.getInputForFunctionInsert(),s=t.innerText,n=le(t);let i,r;if(!s.startsWith("="))i=`=${e}(`,r=i.length;else{const o=(n==null?void 0:n.start)??s.length,a=(n==null?void 0:n.end)??s.length;i=s.slice(0,o)+e+"("+s.slice(a),r=o+e.length+1}this.formulaBar.setValue(i),this.cellInput.setValue(i),ue(t,{start:r,end:r}),t.focus(),this.formulaRanges=Se(i).map(o=>o.range),this.renderOverlay(),this.autocomplete.hide(),this.updateAutocomplete(i,t)}async getInputForFunctionInsert(){if(this.cellInput.isFocused())return this.cellInput.getInput();const e=this.cellInput.getInput(),t=this.formulaBar.getFormulaInput(),s=t.innerText,n=le(t);this.cellInput.isShown()||await this.showCellInput(!0,!0),this.cellInput.setValue(s);const i=(n==null?void 0:n.end)??s.length;return ue(e,{start:i,end:i}),this.cellInput.isFocused()||e.focus(),e}isInFormulaRangeMode(){let e,t;if(this.cellInput.isFocused()?(e=this.cellInput.getValue(),t=this.cellInput.getInput()):this.formulaBar.isFocused()&&(e=this.formulaBar.getValue(),t=this.formulaBar.getFormulaInput()),!e||!t||!e.startsWith("="))return!1;const s=le(t);return s?as(e,s.end):!1}insertReferenceAtCursor(e,t){const s=this.cellInput.isFocused(),n=this.formulaBar.isFocused();if(!s&&!n)return;const i=s?this.cellInput.getInput():this.formulaBar.getFormulaInput(),r=i.innerText,o=le(i);if(!o)return;const a=t&&(e.r!==t.r||e.c!==t.c)?T(e)+":"+T(t):T(e);let h,c;if(this.formulaRefInsertPos){const{start:u,end:d}=this.formulaRefInsertPos;h=r.slice(0,u)+a+r.slice(d),c=u+a.length,this.formulaRefInsertPos={start:u,end:c}}else{const u=nt(r,o.end);u?(h=r.slice(0,u.start)+a+r.slice(u.end),c=u.start+a.length,this.formulaRefInsertPos={start:u.start,end:c}):o.start!==o.end?(h=r.slice(0,o.start)+a+r.slice(o.end),c=o.start+a.length,this.formulaRefInsertPos={start:o.start,end:c}):(h=r.slice(0,o.end)+a+r.slice(o.end),c=o.end+a.length,this.formulaRefInsertPos={start:o.end,end:c})}this.formulaBar.setValue(h),this.cellInput.setValue(h),ue(i,{start:c,end:c}),h.startsWith("=")&&(this.formulaRanges=Se(h).map(u=>u.range),this.renderOverlay()),this.lastFormulaRefTarget=t||e}toggleAbsoluteReference(e){const t=e.innerText;if(!t.startsWith("="))return;const s=le(e);if(!s)return;const n=nt(t,s.end);if(!n)return;const i=n.text,r=i.startsWith("$"),o=i.replace(/\$/g,"");let a=0;for(let y=0;y<o.length;y++)if(o.charCodeAt(y)>=48&&o.charCodeAt(y)<=57){a=y;break}const h=o.slice(0,a),c=o.slice(a),u=i.indexOf(c,i.lastIndexOf(h)+h.length),d=u>0&&i[u-1]==="$";let f;!r&&!d?f="$"+h+"$"+c:r&&d?f=h+"$"+c:!r&&d?f="$"+h+c:f=h+c;const m=t.slice(0,n.start)+f+t.slice(n.end),g=n.start+f.length;this.formulaBar.setValue(m),this.cellInput.setValue(m),ue(e,{start:g,end:g}),m.startsWith("=")&&(this.formulaRanges=Se(m).map(y=>y.range),this.renderOverlay())}resetFormulaRangeState(){this.formulaRangeAnchor=null,this.activeFormulaInput=null,this.formulaRefInsertPos=null,this.lastFormulaRefTarget=null}handleDblClick(e){e.preventDefault(),this.handleDblClickAt(e.offsetX,e.offsetY)}handleDblClickAt(e,t){if(this.readOnly)return;const s=this.detectFreezeHandle(e,t);if(s){const r=this.sheet.getFreezePane();s==="row"?this.setFreezePane(r.frozenRows>0?0:1,r.frozenCols):this.setFreezePane(r.frozenRows,r.frozenCols>0?0:1);return}const n=this.detectHiddenIndicator(e,t);if(n){n.axis==="row"?this.sheet.showRows(n.indices).then(()=>this.render()):this.sheet.showColumns(n.indices).then(()=>this.render());return}const i=this.detectResizeEdge(e,t);if(i){this.autoFitSize(i.axis,i.index);return}this.showCellInput()}handleContextMenu(e){if(this.readOnly)return;const t=e.offsetX,s=e.offsetY,n=t<b,i=s<S;if(!(!n&&!i)){if(e.preventDefault(),n){const r=this.toRowFromMouse(s);if(r<1)return;const o=this.sheet.getSelectedIndices(),a=o&&o.axis==="row"&&r>=o.from&&r<=o.to,h=a?o.from:r,c=a?o.to-o.from+1:1,u=c>1?`${c} rows`:"row",d=[{label:`Insert ${u} above`,action:()=>{this.sheet.insertRows(h,c).then(()=>this.render())}},{label:`Insert ${u} below`,action:()=>{this.sheet.insertRows(h+c,c).then(()=>this.render())}},{label:`Delete ${u}`,action:()=>{this.sheet.deleteRows(h,c).then(()=>this.render())}},{label:`Hide ${u}`,action:()=>{const m=Array.from({length:c},(g,y)=>h+y);this.sheet.hideRows(m).then(()=>this.render())}}],f=this.findAdjacentHiddenRows(h,h+c-1);if(f.length>0){const m=Math.min(...f),g=Math.max(...f),y=m===g?`Show row ${m}`:`Show rows ${m}-${g}`;d.push({label:y,action:()=>{this.sheet.showRows(f).then(()=>this.render())}})}this.contextMenu.show(e.clientX,e.clientY,d)}else if(i){const r=this.toColFromMouse(t);if(r<1)return;const o=this.sheet.getSelectedIndices(),a=o&&o.axis==="column"&&r>=o.from&&r<=o.to,h=a?o.from:r,c=a?o.to-o.from+1:1,u=c>1?`${c} columns`:"column",d=[{label:`Insert ${u} left`,action:()=>{this.sheet.insertColumns(h,c).then(()=>this.render())}},{label:`Insert ${u} right`,action:()=>{this.sheet.insertColumns(h+c,c).then(()=>this.render())}},{label:`Delete ${u}`,action:()=>{this.sheet.deleteColumns(h,c).then(()=>this.render())}},{label:`Hide ${u}`,action:()=>{const m=Array.from({length:c},(g,y)=>h+y);this.sheet.hideColumns(m).then(()=>this.render())}}],f=this.findAdjacentHiddenColumns(h,h+c-1);if(f.length>0){const m=Math.min(...f),g=Math.max(...f),y=m===g?`Show column ${ae(m)}`:`Show columns ${ae(m)}-${ae(g)}`;d.push({label:y,action:()=>{this.sheet.showColumns(f).then(()=>this.render())}})}this.contextMenu.show(e.clientX,e.clientY,d)}}}getFilterButtonRect(e){var o;const t=(o=this.sheet)==null?void 0:o.getFilterRange();if(!t)return null;const s=t[0].r,n=this.getCellRect({r:s,c:e});if(n.width<=6||n.height<=6)return null;const i=Math.min(16,Math.max(12,n.width-4)),r=Math.min(16,Math.max(12,n.height-6));return{left:n.left+n.width-i-2,top:n.top+Math.max(3,(n.height-r)/2),width:i,height:r}}detectFilterButton(e,t){if(!this.sheet||!this.sheet.hasFilter()||e<=b||t<=S)return null;const s=this.sheet.getFilterRange();if(!s)return null;const n=this.toRefFromMouse(e,t);if(n.r!==s[0].r||!this.sheet.isColumnInFilter(n.c))return null;const i=this.getFilterButtonRect(n.c);return!i||e<i.left-2||e>i.left+i.width+2||t<i.top-2||t>i.top+i.height+2?null:n.c}async showFilterPanel(e,t){var m,g;if(!this.sheet||!this.sheet.isColumnInFilter(e))return;const s=await this.sheet.getFilterColumnValues(e);if(!s)return;const n=this.sheet.getColumnFilterCondition(e),i=n&&n.op!=="in"&&n.op!=="isEmpty"&&n.op!=="isNotEmpty",r=t==="condition"||i?"condition":"values",o=n?{...n,values:n.values?[...n.values]:void 0}:{op:"contains",value:""};this.filterPanelState={col:e,values:s.values,selected:new Set(s.selected),initialSelected:new Set(s.selected),search:"",mode:r,condition:{...o,values:o.values?[...o.values]:void 0},initialCondition:o,hasExistingCondition:!!n},this.renderFilterPanel();const a=this.getFilterButtonRect(e);if(!a)return;const h=this.viewport,u=Math.min(h.left+Math.max(b,a.left-6),h.left+Math.max(0,h.width-260-4)),d=h.top+a.top+a.height+4;this.filterPanel.style.left=`${u}px`,this.filterPanel.style.top=`${d}px`,this.filterPanel.style.display="block",(m=this.filterPanelKeyboardUnsub)==null||m.call(this);const f=y=>{if(!this.filterPanelState)return;const z=y.target,I=z?this.filterPanel.contains(z):!1;if(y.key==="Escape"){y.preventDefault(),y.stopPropagation(),this.hideFilterPanel();return}y.key==="Enter"&&I&&(y.preventDefault(),y.stopPropagation(),this.applyFilterPanel())};document.addEventListener("keydown",f,!0),this.filterPanelKeyboardUnsub=()=>{document.removeEventListener("keydown",f,!0)},(g=this.filterPanelOutsideClickUnsub)==null||g.call(this),requestAnimationFrame(()=>{if(!this.filterPanelState)return;const y=z=>{this.filterPanel.contains(z.target)||this.hideFilterPanel()};document.addEventListener("mousedown",y),this.filterPanelOutsideClickUnsub=()=>{document.removeEventListener("mousedown",y)}})}hideFilterPanel(){var e,t;this.filterPanel.style.display="none",this.filterPanel.innerHTML="",this.filterPanelState=null,(e=this.filterPanelOutsideClickUnsub)==null||e.call(this),this.filterPanelOutsideClickUnsub=null,(t=this.filterPanelKeyboardUnsub)==null||t.call(this),this.filterPanelKeyboardUnsub=null}areStringSetsEqual(e,t){if(e.size!==t.size)return!1;for(const s of e)if(!t.has(s))return!1;return!0}areFilterConditionsEqual(e,t){if(e.op!==t.op)return!1;if(e.op==="in"){const s=Array.from(new Set(e.values||[])).sort(),n=Array.from(new Set(t.values||[])).sort();if(s.length!==n.length)return!1;for(let i=0;i<s.length;i++)if(s[i]!==n[i])return!1;return!0}return e.op==="isEmpty"||e.op==="isNotEmpty"?!0:(e.value||"").trim()===(t.value||"").trim()}isFilterPanelDirty(e){return e.mode==="values"?!this.areStringSetsEqual(e.selected,e.initialSelected):!this.areFilterConditionsEqual(e.condition,e.initialCondition)}async applyFilterPanel(){const e=this.filterPanelState;if(!(!e||!this.sheet)&&this.isFilterPanelDirty(e)){if(e.mode==="values"){await this.sheet.setColumnIncludedValues(e.col,Array.from(e.selected)),this.hideFilterPanel(),this.render();return}await this.sheet.setColumnFilter(e.col,e.condition),this.hideFilterPanel(),this.render()}}syncFilterPanelApplyButtonState(){const e=this.filterPanelState;if(!e)return;const t=this.filterPanel.querySelector('button[data-wb-filter-apply="true"]');if(!t)return;const s=this.isFilterPanelDirty(e);t.disabled=!s,t.style.opacity=s?"1":"0.5",t.style.cursor=s?"pointer":"not-allowed"}syncFilterPanelValuesSelectionState(e){const t=this.filterPanelState;if(!t)return;const s=this.filterPanel.querySelector('[data-wb-filter-summary="true"]');if(s){const i=t.values.filter(r=>t.selected.has(r)).length;s.textContent=`Selected ${i} / ${t.values.length}`}const n=this.filterPanel.querySelector('input[data-wb-filter-select-all="true"]');if(n){const i=e.filter(r=>t.selected.has(r)).length;n.checked=e.length>0&&i===e.length,n.indeterminate=i>0&&i<e.length}this.syncFilterPanelApplyButtonState()}renderFilterPanel(){var C;const e=this.filterPanelState;if(!e)return;const t=document.activeElement,s=t instanceof HTMLInputElement&&t.dataset.wbFilterSearch==="true",n=s?t.selectionStart:null,i=s?t.selectionEnd:null,r=P(this.theme,"cellBorderColor"),o=P(this.theme,"selectionBGColor"),a=v=>{const R=document.createElement("button");return R.type="button",R.textContent=v,R.style.height="26px",R.style.padding="0 8px",R.style.border=`1px solid ${r}`,R.style.borderRadius="4px",R.style.background="transparent",R.style.color="inherit",R.style.cursor="pointer",R};this.filterPanel.innerHTML="";const h=document.createElement("div");h.style.display="flex",h.style.flexDirection="column",h.style.maxHeight="360px",h.style.height=e.mode==="values"?"360px":"auto",h.style.overflow="hidden";const c=document.createElement("div");c.style.padding="8px 10px",c.style.borderBottom=`1px solid ${r}`,c.style.fontWeight="600",c.textContent=`Filter ${ae(e.col)}`,h.appendChild(c);const u=document.createElement("div");u.textContent="Sort",u.style.padding="8px 10px 4px",u.style.fontSize="11px",u.style.opacity="0.7",h.appendChild(u);const d=document.createElement("div");d.style.display="flex",d.style.flexWrap="wrap",d.style.gap="6px",d.style.padding="8px 10px 6px";const f=a("Sort A to Z");f.onclick=()=>{this.sheet.sortFilterByColumn(e.col,"asc").then(v=>{v&&(this.hideFilterPanel(),this.render())})};const m=a("Sort Z to A");m.onclick=()=>{this.sheet.sortFilterByColumn(e.col,"desc").then(v=>{v&&(this.hideFilterPanel(),this.render())})},d.append(f,m),h.appendChild(d);const g=document.createElement("div");g.textContent="Filter",g.style.padding="0 10px 4px",g.style.fontSize="11px",g.style.opacity="0.7",h.appendChild(g);const y=document.createElement("div");y.style.display="flex",y.style.flexWrap="wrap",y.style.gap="6px",y.style.padding="0 10px 8px";const z=(v,R)=>{const F=a(v);return e.mode===R&&(F.style.background=o),F.onclick=()=>{this.filterPanelState&&(this.filterPanelState.mode=R,this.renderFilterPanel())},F};y.append(z("Filter by values","values"),z("Filter by condition","condition")),h.appendChild(y);const I=document.createElement("div");if(I.style.flex="1",I.style.minHeight="0",I.style.padding="0 10px",I.style.display="flex",I.style.flexDirection="column",h.appendChild(I),e.mode==="values"){const v=document.createElement("input");v.type="text",v.dataset.wbFilterSearch="true",v.value=e.search,v.placeholder="Search values",v.style.width="100%",v.style.margin="0 0 8px",v.style.height="28px",v.style.padding="0 8px",v.style.border=`1px solid ${r}`,v.style.borderRadius="4px",v.style.background="transparent",v.style.color="inherit",v.oninput=()=>{this.filterPanelState&&(this.filterPanelState.search=v.value,this.renderFilterPanel())},I.appendChild(v);const R=e.values,F=R.filter(U=>e.selected.has(U)).length,x=document.createElement("div");x.dataset.wbFilterSummary="true",x.textContent=`Selected ${F} / ${R.length}`,x.style.margin="0 0 8px",x.style.fontSize="11px",x.style.opacity="0.7",I.appendChild(x);const $=e.search.trim().toLowerCase(),E=R.filter(U=>$?(U===""?"(Blanks)":U).toLowerCase().includes($):!0).slice(0,Sn),O=document.createElement("div");O.style.flex="1",O.style.minHeight="0",O.style.border=`1px solid ${r}`,O.style.borderRadius="4px",O.style.overflow="auto";const H=E.filter(U=>e.selected.has(U)).length,D=document.createElement("label");D.style.display="flex",D.style.alignItems="center",D.style.gap="8px",D.style.padding="6px 8px",D.style.borderBottom=`1px solid ${r}`,D.style.cursor="pointer";const G=document.createElement("input");G.type="checkbox",G.dataset.wbFilterSelectAll="true",G.checked=E.length>0&&H===E.length,G.indeterminate=H>0&&H<E.length,G.onchange=()=>{if(this.filterPanelState){if(G.checked)for(const U of E)this.filterPanelState.selected.add(U);else for(const U of E)this.filterPanelState.selected.delete(U);this.renderFilterPanel()}};const te=document.createElement("span");if(te.textContent="Select all",D.append(G,te),O.appendChild(D),E.length===0){const U=document.createElement("div");U.style.padding="10px",U.style.opacity="0.7",U.textContent="No values",O.appendChild(U)}else for(const U of E){const j=document.createElement("label");j.style.display="flex",j.style.alignItems="center",j.style.gap="8px",j.style.padding="6px 8px",j.style.cursor="pointer";const se=document.createElement("input");se.type="checkbox",se.checked=e.selected.has(U),se.onchange=()=>{this.filterPanelState&&(se.checked?this.filterPanelState.selected.add(U):this.filterPanelState.selected.delete(U),this.syncFilterPanelValuesSelectionState(E))};const ne=document.createElement("span");ne.textContent=U===""?"(Blanks)":U,ne.style.overflow="hidden",ne.style.textOverflow="ellipsis",ne.style.whiteSpace="nowrap",j.append(se,ne),O.appendChild(j)}I.appendChild(O)}else{const v=document.createElement("div");v.style.display="grid",v.style.gap="8px";const R=document.createElement("select");R.style.height="30px",R.style.border=`1px solid ${r}`,R.style.borderRadius="4px",R.style.background="transparent",R.style.color="inherit";const F=[{value:"contains",label:"Contains"},{value:"notContains",label:"Does not contain"},{value:"equals",label:"Equals"},{value:"notEquals",label:"Does not equal"},{value:"isEmpty",label:"Is empty"},{value:"isNotEmpty",label:"Is not empty"}],x=e.condition.op==="in"?"contains":e.condition.op;for(const E of F){const O=document.createElement("option");O.value=E.value,O.textContent=E.label,O.selected=x===E.value,R.appendChild(O)}if(R.onchange=()=>{if(!this.filterPanelState)return;const E=R.value;this.filterPanelState.condition={op:E,value:this.filterPanelState.condition.value||""},this.renderFilterPanel()},v.appendChild(R),x!=="isEmpty"&&x!=="isNotEmpty"){const E=document.createElement("input");E.type="text",E.value=((C=this.filterPanelState)==null?void 0:C.condition.value)||"",E.placeholder="Enter value",E.style.height="30px",E.style.padding="0 8px",E.style.border=`1px solid ${r}`,E.style.borderRadius="4px",E.style.background="transparent",E.style.color="inherit",E.oninput=()=>{this.filterPanelState&&(this.filterPanelState.condition={...this.filterPanelState.condition,value:E.value},this.syncFilterPanelApplyButtonState())},v.appendChild(E)}I.appendChild(v)}const k=document.createElement("div");k.style.display="flex",k.style.justifyContent="flex-end",k.style.gap="6px",k.style.padding="8px 10px";const M=v=>{v.disabled=!0,v.style.opacity="0.5",v.style.cursor="not-allowed"},w=a("Clear");w.onclick=()=>{this.sheet.clearColumnFilter(e.col).then(()=>{this.hideFilterPanel(),this.render()})},e.hasExistingCondition||M(w);const N=a("Cancel");N.onclick=()=>this.hideFilterPanel();const A=a("Apply");if(A.dataset.wbFilterApply="true",A.onclick=()=>{this.applyFilterPanel()},this.isFilterPanelDirty(e)||M(A),k.append(w,N,A),h.appendChild(k),this.filterPanel.appendChild(h),s&&e.mode==="values"){const v=this.filterPanel.querySelector('input[data-wb-filter-search="true"]');if(v){v.focus();const R=v.value.length,F=Math.max(0,Math.min(R,n??R)),x=Math.max(F,Math.min(R,i??F));v.setSelectionRange(F,x)}}}addEventListeners(){const e=this.gridContainer.getScrollContainer();this.addEventListener(window,"resize",()=>{this.updateCellInputPosition(),this.render()}),this.addEventListener(e,"scroll",()=>{this.hideFilterPanel(),this.updateCellInputPosition(),this.render()}),this.addEventListener(e,"mousedown",t=>{this.handleMouseDown(t)}),this.addEventListener(e,"mousemove",t=>{this.handleMouseMove(t)}),this.addEventListener(e,"mouseleave",()=>{this.handleScrollContainerMouseLeave()}),this.addEventListener(e,"dblclick",t=>{this.handleDblClick(t)}),this.addEventListener(e,"contextmenu",t=>{this.handleContextMenu(t)}),this.addEventListener(document,"keydown",t=>{this.handleKeyDown(t)}),this.addEventListener(document,"keyup",t=>{this.handleKeyUp(t)}),this.addEventListener(document,"compositionstart",t=>{this.handleDocumentCompositionStart(t)})}detectResizeEdge(e,t){const s=this.scroll,n=this.freezeState;if(t<S&&e>b){const r=n.frozenCols>0&&e<b+n.frozenWidth?e-b:e-b-n.frozenWidth+this.colDim.getOffset(n.frozenCols+1)+s.left,o=this.colDim.findIndex(r),a=this.colDim.getOffset(o)+this.colDim.getSize(o);if(Math.abs(r-a)<Be)return{axis:"column",index:o};if(o>1){const h=this.colDim.getOffset(o-1)+this.colDim.getSize(o-1);if(Math.abs(r-h)<Be)return{axis:"column",index:o-1}}}if(e<b&&t>S){const r=n.frozenRows>0&&t<S+n.frozenHeight?t-S:t-S-n.frozenHeight+this.rowDim.getOffset(n.frozenRows+1)+s.top,o=this.rowDim.findIndex(r),a=this.rowDim.getOffset(o)+this.rowDim.getSize(o);if(Math.abs(r-a)<Be)return{axis:"row",index:o};if(o>1){const h=this.rowDim.getOffset(o-1)+this.rowDim.getSize(o-1);if(Math.abs(r-h)<Be)return{axis:"row",index:o-1}}}return null}detectHiddenIndicator(e,t){const s=this.sheet;if(!s)return null;const n=this.scroll,i=this.freezeState,r=L*2+J*2,o=L*2+de+J*2,a=r/2+zt;if(e<b&&t>S){const d=s.getUserHiddenRows();if(d.size===0)return null;const f=a-r/2,m=a+r/2;if(e<f||e>m)return null;const y=i.frozenRows>0&&t<S+i.frozenHeight?0:n.top+this.rowDim.getOffset(i.frozenRows+1)-i.frozenHeight,z=this.viewRange;for(let I=z[0].r;I<=z[1].r+1;I++){if(Rn(I,d)){const k=this.rowDim.getOffset(I)+S-y;if(this.hitTestButtonY(t,k,o)){const M=this.findAdjacentHiddenRows(I,I);if(M.length>0)return{axis:"row",boundary:I,indices:M}}}if(bn(I,d)){const k=this.rowDim.getOffset(I)+this.rowDim.getSize(I)+S-y;if(this.hitTestButtonY(t,k,o)){const M=this.findAdjacentHiddenRows(I,I);if(M.length>0)return{axis:"row",boundary:I,indices:M}}}}}const h=L*2+de+J*2,c=L*2+J*2,u=c/2+zt;if(t<S&&e>b){const d=s.getHiddenColumns();if(d.size===0)return null;const f=u-c/2,m=u+c/2;if(t<f||t>m)return null;const y=i.frozenCols>0&&e<b+i.frozenWidth?0:n.left+this.colDim.getOffset(i.frozenCols+1)-i.frozenWidth,z=this.viewRange;for(let I=z[0].c;I<=z[1].c+1;I++){if(Fn(I,d)){const k=b+this.colDim.getOffset(I)-y;if(this.hitTestButtonX(e,k,h)){const M=this.findAdjacentHiddenColumns(I,I);if(M.length>0)return{axis:"column",boundary:I,indices:M}}}if(zn(I,d)){const k=b+this.colDim.getOffset(I)+this.colDim.getSize(I)-y;if(this.hitTestButtonX(e,k,h)){const M=this.findAdjacentHiddenColumns(I,I);if(M.length>0)return{axis:"column",boundary:I,indices:M}}}}}return null}hitTestButtonY(e,t,s){return e>=t-s/2&&e<=t+s/2}hitTestButtonX(e,t,s){return e>=t-s/2&&e<=t+s/2}detectFreezeHandle(e,t){const s=this.freezeState,n=s.frozenRows>0||s.frozenCols>0,i=es,r=ln,o=n&&s.frozenRows>0?S+s.frozenHeight-i/2:S-i;if(e>=0&&e<=b&&t>=o-r&&t<=o+i+r)return"row";const a=n&&s.frozenCols>0?b+s.frozenWidth-i/2:b-i;return e>=a-r&&e<=a+i+r&&t>=0&&t<=S?"column":null}startFreezeDrag(e,t){const s=this.gridContainer.getScrollContainer();s.style.cursor="grabbing";const n=r=>{const o=this.viewport;if(e==="row"){const a=r.target!==s?Math.max(0,Math.min(o.height,r.clientY-o.top)):r.offsetY;if(a<=S)return 0;const h=a-S,c=this.rowDim.findIndex(h),d=this.rowDim.getOffset(c)+this.rowDim.getSize(c)/2;return h<d?Math.max(0,c-1):c}else{const a=r.target!==s?Math.max(0,Math.min(o.width,r.clientX-o.left)):r.offsetX;if(a<=b)return 0;const h=a-b,c=this.colDim.findIndex(h),d=this.colDim.getOffset(c)+this.colDim.getSize(c)/2;return h<d?Math.max(0,c-1):c}};this.freezeDrag={axis:e,targetIndex:n(t)},this.renderOverlay();const i=r=>{const o=n(r);this.freezeDrag&&this.freezeDrag.targetIndex!==o&&(this.freezeDrag={axis:e,targetIndex:o},this.renderOverlay())};this.startMouseDragSession({onMove:i,onComplete:()=>{var a;const r=((a=this.freezeDrag)==null?void 0:a.targetIndex)??0,o=this.sheet.getFreezePane();e==="row"?this.setFreezePane(r,o.frozenCols):this.setFreezePane(o.frozenRows,r)},onCleanup:()=>{s.style.cursor="",this.freezeDrag=null,this.freezeHandleHover=null,this.renderOverlay()}})}toRefFromMouse(e,t){const s=this.freezeState;return s.frozenRows>0||s.frozenCols>0?cn(e,t,this.scroll,this.rowDim,this.colDim,s):hn(e+this.scroll.left,t+this.scroll.top,this.rowDim,this.colDim)}toRowFromMouse(e){const t=this.freezeState,n=t.frozenRows>0&&e<S+t.frozenHeight?e-S:e-S-t.frozenHeight+this.rowDim.getOffset(t.frozenRows+1)+this.scroll.top;return this.rowDim.findIndex(n)}toColFromMouse(e){const t=this.freezeState,n=t.frozenCols>0&&e<b+t.frozenWidth?e-b:e-b-t.frozenWidth+this.colDim.getOffset(t.frozenCols+1)+this.scroll.left;return this.colDim.findIndex(n)}getAutofillSelectionRect(e){if(!this.sheet||this.sheet.getSelectionType()!=="cell")return;const t=e||this.sheet.getRangeOrActiveCell(),s=Me(t[0],this.scroll,this.rowDim,this.colDim,this.freezeState),n=Me(t[1],this.scroll,this.rowDim,this.colDim,this.freezeState),i=Math.min(s.left,n.left),r=Math.min(s.top,n.top),o=Math.max(s.left+s.width,n.left+n.width),a=Math.max(s.top+s.height,n.top+n.height);return{left:i,top:r,width:o-i,height:a-r}}detectAutofillHandle(e,t){if(this.readOnly||!this.sheet||this.sheet.getSelectionType()!=="cell")return!1;const s=this.sheet.getRangeOrActiveCell(),n=this.getAutofillSelectionRect(s);if(!n||this.isAutofillHandleHiddenByFreeze(s,n))return!1;const i=n.left+n.width-me/2,r=n.top+n.height-me/2;return e>=i-Ee&&e<=i+me+Ee&&t>=r-Ee&&t<=r+me+Ee}shouldShowAutofillHandle(){if(this.readOnly||!this.sheet||this.sheet.getSelectionType()!=="cell")return!1;const e=this.sheet.getRangeOrActiveCell(),t=this.getAutofillSelectionRect(e);return t?!this.isAutofillHandleHiddenByFreeze(e,t):!1}isAutofillHandleHiddenByFreeze(e,t){const s=this.freezeState;if(s.frozenRows===0&&s.frozenCols===0)return!1;const n=Math.max(e[0].r,e[1].r),i=Math.max(e[0].c,e[1].c);if(!(n>s.frozenRows&&i>s.frozenCols))return!1;const o=t.left+t.width-me/2,a=t.top+t.height-me/2,h=b+s.frozenWidth,c=S+s.frozenHeight;return o<h||a<c}clampClientPointToViewport(e,t){const s=this.viewport;return{x:Math.max(0,Math.min(s.width,e-s.left)),y:Math.max(0,Math.min(s.height,t-s.top))}}getAutoScrollSpeed(e){const s=Math.min(xt,Math.max(0,e))/xt;return At+(vn-At)*s}getAutoScrollVelocity(e,t,s){return e<t?-this.getAutoScrollSpeed(t-e):e>s?this.getAutoScrollSpeed(e-s):0}handleMouseMove(e){var o,a,h;const t=this.gridContainer.getScrollContainer();if((e.buttons&1)===1){!this.resizeDragging&&this.resizeHover&&(this.resizeHover=null,this.renderOverlay());return}const s=this.detectFreezeHandle(e.offsetX,e.offsetY);if(s!==this.freezeHandleHover&&(this.freezeHandleHover=s,this.render()),s){t.style.cursor="grab",this.setFilterButtonHoverCol(null),this.setHiddenIndicatorHover(null),this.resizeHover&&(this.resizeHover=null,this.renderOverlay());return}const n=this.detectHiddenIndicator(e.offsetX,e.offsetY);if(n){t.style.cursor="pointer",this.setFilterButtonHoverCol(null),this.setHiddenIndicatorHover({axis:n.axis,boundary:n.boundary}),this.resizeHover&&(this.resizeHover=null,this.renderOverlay());return}this.setHiddenIndicatorHover(null);const i=this.detectResizeEdge(e.offsetX,e.offsetY),r=(i==null?void 0:i.axis)!==((o=this.resizeHover)==null?void 0:o.axis)||(i==null?void 0:i.index)!==((a=this.resizeHover)==null?void 0:a.index);if(r&&(this.resizeHover=i),i)t.style.cursor=i.axis==="column"?"col-resize":"row-resize",this.setFilterButtonHoverCol(null);else{if(this.detectAutofillHandle(e.offsetX,e.offsetY)){t.style.cursor="crosshair",this.setFilterButtonHoverCol(null),r&&this.renderOverlay();return}const c=e.offsetX,u=e.offsetY,d=this.detectFilterButton(c,u);if(d!==null){t.style.cursor="pointer",this.setFilterButtonHoverCol(d),r&&this.renderOverlay();return}this.setFilterButtonHoverCol(null);const f=(h=this.sheet)==null?void 0:h.getSelectedIndices();if(f){const m=f.axis==="column"?u<S&&c>b&&(()=>{const g=this.toColFromMouse(c);return g>=f.from&&g<=f.to})():c<b&&u>S&&(()=>{const g=this.toRowFromMouse(u);return g>=f.from&&g<=f.to})();t.style.cursor=m?"grab":""}else t.style.cursor=""}r&&this.renderOverlay()}handleScrollContainerMouseLeave(){const e=this.gridContainer.getScrollContainer();e.style.cursor="";const t=this.filterButtonHoverCol!==null||this.resizeHover!==null||this.freezeHandleHover!==null||this.hiddenIndicatorHover!==null;this.filterButtonHoverCol=null,this.resizeHover=null,this.freezeHandleHover=null,this.hiddenIndicatorHover=null,t&&this.render()}setFilterButtonHoverCol(e){this.filterButtonHoverCol!==e&&(this.filterButtonHoverCol=e,this.render())}setHiddenIndicatorHover(e){var t,s;((t=this.hiddenIndicatorHover)==null?void 0:t.axis)===(e==null?void 0:e.axis)&&((s=this.hiddenIndicatorHover)==null?void 0:s.boundary)===(e==null?void 0:e.boundary)||(this.hiddenIndicatorHover=e,this.render())}async handleMouseDown(e){const t=this.detectFreezeHandle(e.offsetX,e.offsetY);if(t&&!this.readOnly){e.preventDefault(),this.startFreezeDrag(t,e);return}const s=this.detectHiddenIndicator(e.offsetX,e.offsetY);if(s&&!this.readOnly){e.preventDefault(),s.axis==="row"?this.sheet.showRows(s.indices).then(()=>this.render()):this.sheet.showColumns(s.indices).then(()=>this.render());return}const n=this.detectResizeEdge(e.offsetX,e.offsetY);if(n&&!this.readOnly){e.preventDefault(),this.startResize(n.axis,n.index,e);return}const i=e.offsetX,r=e.offsetY,o=this.detectFilterButton(i,r);if(o!==null){e.preventDefault(),await this.finishEditing(),await this.showFilterPanel(o);return}if(i<b&&r<S){e.preventDefault(),await this.finishEditing(),this.sheet.selectAllCells(),this.render();return}const h=r<S&&i>b,c=i<b&&r>S;if(h){e.preventDefault(),await this.finishEditing();const M=this.toColFromMouse(i);if(M<1)return;if(e.shiftKey){this.sheet.selectColumnRange(this.sheet.getActiveCell().c,M),this.render();return}const w=this.sheet.getSelectedIndices();if(!this.readOnly&&w&&w.axis==="column"&&M>=w.from&&M<=w.to){this.startDragMove("column",w.from,w.to-w.from+1,e);return}this.sheet.selectColumn(M),this.render();const N=M;let A=M,C=e.clientX,v=null,R=null;const F=()=>{const{x:H}=this.clampClientPointToViewport(C,0),D=this.toColFromMouse(H);D>=1&&D!==A&&(A=D,this.sheet.selectColumnRange(N,A))},x=()=>{v!==null&&(cancelAnimationFrame(v),v=null),R=null},$=H=>{const D=this.viewport,G=this.getAutoScrollVelocity(C,D.left,D.left+D.width);if(G===0){v=null,R=null;return}const te=Math.min(50,R===null?16:H-R);R=H,this.gridContainer.scrollBy(G*te/1e3,0),F(),this.render(),v=requestAnimationFrame($)},E=()=>{v===null&&(v=requestAnimationFrame($))},O=H=>{C=H.clientX,F(),this.render();const D=this.viewport;this.getAutoScrollVelocity(C,D.left,D.left+D.width)===0?x():E()};this.beginNativeSelectionBlock(),this.startMouseDragSession({onMove:O,onCleanup:()=>{x(),this.endNativeSelectionBlock()}});return}if(c){e.preventDefault(),await this.finishEditing();const M=this.toRowFromMouse(r);if(M<1)return;if(e.shiftKey){this.sheet.selectRowRange(this.sheet.getActiveCell().r,M),this.render();return}const w=this.sheet.getSelectedIndices();if(!this.readOnly&&w&&w.axis==="row"&&M>=w.from&&M<=w.to){this.startDragMove("row",w.from,w.to-w.from+1,e);return}this.sheet.selectRow(M),this.render();const N=M;let A=M,C=e.clientY,v=null,R=null;const F=()=>{const{y:H}=this.clampClientPointToViewport(0,C),D=this.toRowFromMouse(H);D>=1&&D!==A&&(A=D,this.sheet.selectRowRange(N,A))},x=()=>{v!==null&&(cancelAnimationFrame(v),v=null),R=null},$=H=>{const D=this.viewport,G=this.getAutoScrollVelocity(C,D.top,D.top+D.height);if(G===0){v=null,R=null;return}const te=Math.min(50,R===null?16:H-R);R=H,this.gridContainer.scrollBy(0,G*te/1e3),F(),this.render(),v=requestAnimationFrame($)},E=()=>{v===null&&(v=requestAnimationFrame($))},O=H=>{C=H.clientY,F(),this.render();const D=this.viewport;this.getAutoScrollVelocity(C,D.top,D.top+D.height)===0?x():E()};this.beginNativeSelectionBlock(),this.startMouseDragSession({onMove:O,onCleanup:()=>{x(),this.endNativeSelectionBlock()}});return}if(this.isInFormulaRangeMode()){e.preventDefault();const M=this.toRefFromMouse(e.offsetX,e.offsetY);if(this.activeFormulaInput=this.cellInput.isFocused()?"cellInput":"formulaBar",e.shiftKey&&this.formulaRangeAnchor){const A={r:Math.min(this.formulaRangeAnchor.r,M.r),c:Math.min(this.formulaRangeAnchor.c,M.c)},C={r:Math.max(this.formulaRangeAnchor.r,M.r),c:Math.max(this.formulaRangeAnchor.c,M.c)};this.insertReferenceAtCursor(A,C)}else this.formulaRangeAnchor=M,this.formulaRefInsertPos=null,this.insertReferenceAtCursor(M);const w=this.gridContainer.getScrollContainer(),N=A=>{const C=this.viewport,v=A.target!==w?Math.max(0,Math.min(C.width,A.clientX-C.left)):A.offsetX,R=A.target!==w?Math.max(0,Math.min(C.height,A.clientY-C.top)):A.offsetY,F=this.toRefFromMouse(v,R),x={r:Math.min(this.formulaRangeAnchor.r,F.r),c:Math.min(this.formulaRangeAnchor.c,F.c)},$={r:Math.max(this.formulaRangeAnchor.r,F.r),c:Math.max(this.formulaRangeAnchor.c,F.c)};this.insertReferenceAtCursor(x,$)};this.beginNativeSelectionBlock(),this.startMouseDragSession({onMove:N,onComplete:()=>{this.scrollIntoView(),this.updateCellInputPosition(),this.activeFormulaInput==="cellInput"?this.cellInput.getInput().focus():this.activeFormulaInput==="formulaBar"&&this.formulaBar.getFormulaInput().focus()},onCleanup:()=>{this.endNativeSelectionBlock(),this.formulaRefInsertPos=null}});return}if(this.detectAutofillHandle(e.offsetX,e.offsetY)){e.preventDefault(),await this.finishEditing(),this.startAutofillDrag(e);return}if(await this.finishEditing(),e.shiftKey){const M=this.toRefFromMouse(e.offsetX,e.offsetY);this.sheet.selectEnd(M),this.render();return}this.sheet.selectStart(this.toRefFromMouse(e.offsetX,e.offsetY)),this.render();let u=e.clientX,d=e.clientY,f=null,m=null;const g=()=>{const{x:M,y:w}=this.clampClientPointToViewport(u,d);this.sheet.selectEnd(this.toRefFromMouse(M,w))},y=()=>{f!==null&&(cancelAnimationFrame(f),f=null),m=null},z=M=>{const w=this.viewport,N=this.getAutoScrollVelocity(u,w.left,w.left+w.width),A=this.getAutoScrollVelocity(d,w.top,w.top+w.height);if(N===0&&A===0){f=null,m=null;return}const C=Math.min(50,m===null?16:M-m);m=M,this.gridContainer.scrollBy(N*C/1e3,A*C/1e3),g(),this.render(),f=requestAnimationFrame(z)},I=()=>{f===null&&(f=requestAnimationFrame(z))},k=M=>{u=M.clientX,d=M.clientY,g(),this.renderOverlay();const w=this.viewport,N=this.getAutoScrollVelocity(u,w.left,w.left+w.width),A=this.getAutoScrollVelocity(d,w.top,w.top+w.height);N===0&&A===0?y():I()};this.beginNativeSelectionBlock(),this.startMouseDragSession({onMove:k,onComplete:()=>{this.render(),this.primeCellInputForSelection()},onCleanup:()=>{y(),this.endNativeSelectionBlock()}})}startAutofillDrag(e){let t=e.clientX,s=e.clientY,n=null,i=null;const r=()=>{const{x:u,y:d}=this.clampClientPointToViewport(t,s),f=this.toRefFromMouse(u,d);this.autofillPreview=this.sheet.getAutofillPreviewRange(f),this.renderOverlay()},o=()=>{n!==null&&(cancelAnimationFrame(n),n=null),i=null},a=u=>{const d=this.viewport,f=this.getAutoScrollVelocity(t,d.left,d.left+d.width),m=this.getAutoScrollVelocity(s,d.top,d.top+d.height);if(f===0&&m===0){n=null,i=null;return}const g=Math.min(50,i===null?16:u-i);i=u,this.gridContainer.scrollBy(f*g/1e3,m*g/1e3),r(),n=requestAnimationFrame(a)},h=()=>{n===null&&(n=requestAnimationFrame(a))},c=u=>{t=u.clientX,s=u.clientY,r();const d=this.viewport,f=this.getAutoScrollVelocity(t,d.left,d.left+d.width),m=this.getAutoScrollVelocity(s,d.top,d.top+d.height);f===0&&m===0?o():h()};this.beginNativeSelectionBlock(),r(),this.startMouseDragSession({onMove:c,onComplete:()=>{const{x:u,y:d}=this.clampClientPointToViewport(t,s),f=this.toRefFromMouse(u,d),m=this.sheet;(async()=>{const g=await m.autofill(f);this.autofillPreview=void 0,this.sheet&&(g?this.render():this.renderOverlay())})()},onCleanup:()=>{o(),this.endNativeSelectionBlock(),this.autofillPreview=void 0,this.sheet&&this.renderOverlay()}})}startResize(e,t,s){const n=e==="column"?s.clientX:s.clientY,i=e==="column"?this.colDim.getSize(t):this.rowDim.getSize(t),r=this.gridContainer.getScrollContainer();r.style.cursor=e==="column"?"col-resize":"row-resize";const o=e==="column"?this.colDim:this.rowDim,a=this.sheet.getSelectedIndices(),c=a&&a.axis===e&&t>=a.from&&t<=a.to?Array.from({length:a.to-a.from+1},(g,y)=>a.from+y):[t],u=c.length;let d=i,f=null;this.resizeDragging=!0,this.renderOverlay(),this.beginNativeSelectionBlock(),this.showResizeTooltip(e,i,s.clientX,s.clientY,u);const m=g=>{const z=(e==="column"?g.clientX:g.clientY)-n;d=Math.max(e==="column"?Tt:Cn,i+z),f===null&&(f=requestAnimationFrame(()=>{f=null,o.setSize(t,d),this.render()})),this.showResizeTooltip(e,d,g.clientX,g.clientY,u)};this.startMouseDragSession({onMove:m,onComplete:()=>{const g=d;o.setSize(t,g);for(const y of c)o.setSize(y,g),e==="column"?this.sheet.setColumnWidth(y,g):(this.manuallyResizedRows.add(y),this.sheet.setRowHeight(y,g));this.render()},onCleanup:()=>{this.resizeDragging=!1,this.sheet&&this.renderOverlay(),r.style.cursor="",this.hideResizeTooltip(),this.endNativeSelectionBlock(),f!==null&&(cancelAnimationFrame(f),f=null)}})}async autoFitSize(e,t){const n=document.createElement("canvas").getContext("2d"),i=6;if(e==="column"){n.font=`${fe}px Arial`;const r=ae(t);let o=n.measureText(r).width+i;const[a,h]=this.viewRange,c=[{r:a.r,c:t},{r:h.r,c:t}],u=await this.sheet.fetchGrid(c);for(const[,f]of u)if(f.v){const m=n.measureText(f.v).width+i;m>o&&(o=m)}const d=Math.max(Tt,Math.ceil(o));this.sheet.setColumnWidth(t,d)}else{this.manuallyResizedRows.delete(t);const r=await this.computeContentHeight(t);this.sheet.setRowHeight(t,r)}this.render()}async computeContentHeight(e){const[t,s]=this.viewRange,n=[{r:e,c:t.c},{r:e,c:s.c}],i=await this.sheet.fetchGrid(n);let r=1;for(const[,o]of i)if(o.v){const a=o.v.split(`
`).length;a>r&&(r=a)}return r<=1?S:Math.max(S,Math.ceil(r*fe*We+2*je))}async autoResizeRow(e){if(this.manuallyResizedRows.has(e))return;const t=await this.computeContentHeight(e),s=this.rowDim.getSize(e);t!==s&&(this.sheet.setRowHeight(e,t),this.render())}startDragMove(e,t,s,n){const i=this.gridContainer.getScrollContainer();i.style.cursor="grabbing";const r=e==="column"?this.colDim:this.rowDim,o=h=>{const c=this.viewport;if(e==="column"){const u=h.target!==i?Math.max(0,Math.min(c.width,h.clientX-c.left)):h.offsetX,d=this.toColFromMouse(u),f=this.freezeState,g=f.frozenCols>0&&u<b+f.frozenWidth?u-b:u-b-f.frozenWidth+this.colDim.getOffset(f.frozenCols+1)+this.scroll.left,z=r.getOffset(d)+r.getSize(d)/2;return g<z?d:d+1}else{const u=h.target!==i?Math.max(0,Math.min(c.height,h.clientY-c.top)):h.offsetY,d=this.toRowFromMouse(u),f=this.freezeState,g=f.frozenRows>0&&u<S+f.frozenHeight?u-S:u-S-f.frozenHeight+this.rowDim.getOffset(f.frozenRows+1)+this.scroll.top,z=r.getOffset(d)+r.getSize(d)/2;return g<z?d:d+1}};this.dragMove={axis:e,srcIndex:t,count:s,dropIndex:o(n)},this.renderOverlay();const a=h=>{const c=o(h);this.dragMove&&this.dragMove.dropIndex!==c&&(this.dragMove={axis:e,srcIndex:t,count:s,dropIndex:c},this.renderOverlay())};this.startMouseDragSession({onMove:a,onComplete:()=>{var u;const h=(u=this.dragMove)==null?void 0:u.dropIndex;if(h===void 0||h>=t&&h<=t+s)return;(e==="row"?this.sheet.moveRows(t,s,h):this.sheet.moveColumns(t,s,h)).then(()=>{const d=h<t?h:h-s;e==="row"?(this.sheet.selectRow(d),s>1&&this.sheet.selectRowRange(d,d+s-1)):(this.sheet.selectColumn(d),s>1&&this.sheet.selectColumnRange(d,d+s-1)),this.render()})},onCleanup:()=>{i.style.cursor="",this.dragMove=null,this.renderOverlay()}})}async handleFormulaKeydown(e){await this.handleEditorKeydown(e,"formulaBar")}async handleCellInputKeydown(e){await this.handleEditorKeydown(e,"cellInput")}async handleEditorKeydown(e,t){if(Pe(e))return;const s=t==="formulaBar"?this.formulaBar.getFormulaInput():this.cellInput.getInput();if(this.handleAutocompleteKeydown(e,s))return;const n=r=>{W(r,"ArrowDown")?this.sheet.move("down"):W(r,"ArrowUp")?this.sheet.move("up"):W(r,"ArrowLeft")?this.sheet.move("left"):W(r,"ArrowRight")&&this.sheet.move("right")};!await It(e,[{match:r=>X(r,{key:"Enter",alt:!0}),run:r=>{r.preventDefault(),document.execCommand("insertLineBreak")}},{match:r=>W(r,"Enter"),run:async r=>{r.preventDefault(),await this.finishEditing(),t==="formulaBar"?(this.focusGrid(),this.sheet.move("down")):this.sheet.moveInRange(r.shiftKey?-1:1,0),this.render(),this.scrollIntoView(),this.primeCellInputForSelection()}},{match:r=>W(r,"Tab"),run:async r=>{r.preventDefault(),await this.finishEditing(),t==="formulaBar"&&this.focusGrid(),this.sheet.moveInRange(0,r.shiftKey?-1:1),this.render(),this.scrollIntoView(),this.primeCellInputForSelection()}},{match:r=>this.isArrowKey(r)&&!this.editMode&&(t==="formulaBar"||this.cellInput.hasFormula())&&this.isInFormulaRangeMode(),run:r=>{r.preventDefault();const o=this.applyFormulaRangeArrowKey(r);this.scrollIntoView(o)}},{match:r=>t==="cellInput"&&this.isArrowKey(r)&&!this.cellInput.hasFormula()&&!this.editMode,run:async r=>{r.preventDefault(),await this.finishEditing(),n(r),this.render(),this.scrollIntoView(),this.primeCellInputForSelection()}},{match:r=>W(r,"F4"),run:r=>{r.preventDefault(),this.toggleAbsoluteReference(s)}},{match:r=>W(r,"Escape"),run:r=>{r.preventDefault(),this.focusGrid(),this.render()}}])&&t==="formulaBar"&&!this.cellInput.isShown()&&this.showCellInput(!0,!0)}handleAutocompleteKeydown(e,t){if(this.autocomplete.isListVisible()){if(W(e,"ArrowDown"))return e.preventDefault(),this.autocomplete.moveDown(),!0;if(W(e,"ArrowUp"))return e.preventDefault(),this.autocomplete.moveUp(),!0;if(W(e,"Tab")||W(e,"Enter")){const s=this.autocomplete.getSelectedFunction();if(s)return e.preventDefault(),this.insertFunctionCompletion(s.name,t),!0}else W(e,"Escape")&&this.autocomplete.hide()}else this.autocomplete.isHintVisible()&&W(e,"Escape")&&this.autocomplete.hide();return!1}isArrowKey(e){return W(e,"ArrowDown")||W(e,"ArrowUp")||W(e,"ArrowLeft")||W(e,"ArrowRight")}applyFormulaRangeArrowKey(e){const s={...this.lastFormulaRefTarget||this.sheet.getActiveCell()};if(W(e,"ArrowDown")?s.r=Math.max(1,s.r+1):W(e,"ArrowUp")?s.r=Math.max(1,s.r-1):W(e,"ArrowLeft")?s.c=Math.max(1,s.c-1):W(e,"ArrowRight")&&(s.c=s.c+1),e.shiftKey&&this.formulaRangeAnchor){const n={r:Math.min(this.formulaRangeAnchor.r,s.r),c:Math.min(this.formulaRangeAnchor.c,s.c)},i={r:Math.max(this.formulaRangeAnchor.r,s.r),c:Math.max(this.formulaRangeAnchor.c,s.c)};this.insertReferenceAtCursor(n,i),this.lastFormulaRefTarget=s}else this.formulaRangeAnchor=s,this.formulaRefInsertPos=null,this.insertReferenceAtCursor(s);return s}async copy(){const{text:e}=await this.sheet.copy();await navigator.clipboard.writeText(e)}async cut(){if(this.readOnly)return;const{text:e}=await this.sheet.cut();await navigator.clipboard.writeText(e),this.renderOverlay()}async paste(){try{let e,t;if(navigator.clipboard.read)try{const s=await navigator.clipboard.read();for(const n of s)n.types.includes("text/html")&&(t=await(await n.getType("text/html")).text()),n.types.includes("text/plain")&&(e=await(await n.getType("text/plain")).text())}catch{e=await navigator.clipboard.readText()}else e=await navigator.clipboard.readText();await this.sheet.paste({text:e,html:t}),this.sheet.clearCopyBuffer(),this.render()}catch(e){console.error("Failed to paste cell content: ",e)}}async handleGridKeydown(e){const t=async(s,n)=>{if(s.preventDefault(),s.shiftKey?this.sheet.resizeRange(n):De(s)?await this.sheet.moveToEdge(n):this.sheet.move(n)){this.render();const r=s.shiftKey&&this.sheet.getSelectionType()==="cell"?this.getRangeExtentRef():void 0;this.scrollIntoView(r),this.primeCellInputForSelection()}};await It(e,[{match:s=>W(s,"ArrowDown"),run:s=>t(s,"down")},{match:s=>W(s,"ArrowUp"),run:s=>t(s,"up")},{match:s=>W(s,"ArrowLeft"),run:s=>t(s,"left")},{match:s=>W(s,"ArrowRight"),run:s=>t(s,"right")},{match:s=>X(s,{key:"a",mod:!0}),run:async s=>{s.preventDefault(),await this.sheet.selectAll(),this.render()}},{match:s=>W(s,"Tab"),run:s=>{s.preventDefault(),this.sheet.moveInRange(0,s.shiftKey?-1:1),this.render(),this.scrollIntoView(),this.primeCellInputForSelection()}},{match:s=>W(s,"Enter"),run:s=>{s.preventDefault(),this.sheet.hasRange()?(this.sheet.moveInRange(s.shiftKey?-1:1,0),this.render(),this.scrollIntoView(),this.primeCellInputForSelection()):this.readOnly||this.showCellInput()}},{match:s=>W(s,"Delete")||W(s,"Backspace"),run:async s=>{this.readOnly||(s.preventDefault(),await this.sheet.removeData()&&this.render())}},{match:s=>!De(s)&&Pe(s),run:()=>{this.readOnly||this.cellInput.isFocused()&&this.cellInput.isPrimed()||this.showCellInput(!0,!1,!0)}},{match:s=>!De(s)&&!Pe(s)&&this.isValidCellInput(s.key),run:()=>{this.readOnly||this.cellInput.isFocused()&&this.cellInput.isPrimed()||this.showCellInput(!0,!1,!0)}},{match:s=>X(s,{key:"z",mod:!0,shift:!1}),run:async s=>{this.readOnly||(s.preventDefault(),await this.sheet.undo()&&(this.render(),this.scrollIntoView()))}},{match:s=>X(s,{key:"z",mod:!0,shift:!0})||X(s,{key:"y",mod:!0}),run:async s=>{this.readOnly||(s.preventDefault(),await this.sheet.redo()&&(this.render(),this.scrollIntoView()))}},{match:s=>W(s,"Escape"),run:s=>{s.preventDefault(),this.sheet.getCopyRange()&&(this.sheet.clearCopyBuffer(),this.renderOverlay())}},{match:s=>X(s,{key:"c",mod:!0}),run:async s=>{s.preventDefault(),await this.copy()}},{match:s=>X(s,{key:"x",mod:!0}),run:async s=>{this.readOnly||(s.preventDefault(),await this.cut())}},{match:s=>X(s,{key:"v",mod:!0}),run:async s=>{this.readOnly||(s.preventDefault(),await this.paste())}},{match:s=>X(s,{key:"b",mod:!0}),run:async s=>{this.readOnly||(s.preventDefault(),await this.sheet.toggleRangeStyle("b"),this.render())}},{match:s=>X(s,{key:"i",mod:!0}),run:async s=>{this.readOnly||(s.preventDefault(),await this.sheet.toggleRangeStyle("i"),this.render())}},{match:s=>X(s,{key:"u",mod:!0}),run:async s=>{this.readOnly||(s.preventDefault(),await this.sheet.toggleRangeStyle("u"),this.render())}},{match:s=>X(s,{key:"s",mod:!0,shift:!0}),run:async s=>{this.readOnly||(s.preventDefault(),await this.sheet.toggleRangeStyle("st"),this.render())}},{match:s=>X(s,{key:"m",mod:!0,shift:!0}),run:async s=>{this.readOnly||(s.preventDefault(),await this.sheet.toggleMergeSelection()&&this.render())}}])}getRangeExtentRef(){const e=this.sheet.getActiveCell(),t=this.sheet.getRange();if(!t)return e;const s=Math.abs(e.r-t[0].r)>Math.abs(t[1].r-e.r)?t[0].r:t[1].r,n=Math.abs(e.c-t[0].c)>Math.abs(t[1].c-e.c)?t[0].c:t[1].c;return{r:s,c:n}}async reloadDimensions(){await this.sheet.loadDimensions(),await this.sheet.loadStyles(),await this.sheet.loadMerges(),await this.sheet.loadFreezePane(),await this.sheet.loadFilterState(),await this.sheet.loadHiddenState(),this.hiddenRows.clear(),this.hiddenRowSizeBackup.clear(),this.hiddenColumns.clear(),this.hiddenColSizeBackup.clear(),this.syncHiddenRowsFromSheet(),this.syncHiddenColumnsFromSheet(),this.updateFreezeState()}getGridViewportRect(){const e=this.viewport,t=this.container.getBoundingClientRect();return{left:e.left-t.left,top:e.top-t.top,width:e.width,height:e.height}}getScrollableGridViewportRect(){const e=this.getGridViewportRect(),t=this.freezeState,s=b+t.frozenWidth,n=S+t.frozenHeight;return{left:e.left+s,top:e.top+n,width:Math.max(0,e.width-s),height:Math.max(0,e.height-n)}}getCellRect(e){const t=this.freezeState;return t.frozenRows>0||t.frozenCols>0?Me(e,this.scroll,this.rowDim,this.colDim,t):V(e,this.scroll,this.rowDim,this.colDim)}getCellRectInScrollableViewport(e){const t=this.freezeState,s=this.scroll,n=s.left+this.colDim.getOffset(t.frozenCols+1)-t.frozenWidth,i=s.top+this.rowDim.getOffset(t.frozenRows+1)-t.frozenHeight;return V(e,{left:n,top:i},this.rowDim,this.colDim)}getRangeRect(e){return re(this.getCellRect(e[0]),this.getCellRect(e[1]))}setOnRender(e){this.onRenderCallback=e}render(){this.renderVersion+=1,this.requestRenderFrame()}requestRenderFrame(){this.pendingRenderFrame===null&&(this.pendingRenderFrame=requestAnimationFrame(()=>{this.pendingRenderFrame=null,this.handleRenderFrame()}))}handleRenderFrame(){if(this.renderInFlight){this.renderQueued=!0;return}this.renderInFlight=!0;const e=this.renderVersion;this.performRender(e).finally(()=>{this.renderInFlight=!1,(this.renderQueued||this.renderVersion!==e)&&(this.renderQueued=!1,this.requestRenderFrame())})}async performRender(e){var t;this.sheet&&(this.formulaBar.render(),await this.renderSheet(e),!(!this.sheet||e!==this.renderVersion)&&(this.renderOverlay(),(t=this.onRenderCallback)==null||t.call(this)))}renderOverlay(){this.overlay.render(this.viewport,this.scroll,this.sheet.getActiveCell(),this.sheet.getPresences(),this.sheet.getRange(),this.rowDim,this.colDim,this.resizeHover,this.resizeDragging,this.sheet.getSelectionType(),this.dragMove?{axis:this.dragMove.axis,dropIndex:this.dragMove.dropIndex}:null,this.formulaRanges,this.freezeState,this.freezeDrag,this.sheet.getCopyRange(),this.sheet.isCutMode(),this.autofillPreview,this.shouldShowAutofillHandle(),this.sheet.getMerges(),this.sheet.getFilterRange())}get viewRange(){const e=this.scroll,t=this.viewport,s=this.freezeState,n=this.rowDim.getOffset(s.frozenRows+1),i=this.colDim.getOffset(s.frozenCols+1),r=Math.max(s.frozenRows+1,this.rowDim.findIndex(n+e.top)),o=Math.max(r,this.rowDim.findIndex(n+e.top+t.height)+1),a=Math.max(s.frozenCols+1,this.colDim.findIndex(i+e.left)),h=Math.max(a,this.colDim.findIndex(i+e.left+t.width)+1);return[{r,c:a},{r:o,c:h}]}scrollIntoView(e=this.sheet.getActiveCell()){const t=this.scroll,s=this.freezeState,n=s.frozenRows>0&&e.r<=s.frozenRows,i=s.frozenCols>0&&e.c<=s.frozenCols,r=V(e,{left:0,top:0},this.rowDim,this.colDim),o=this.sheet.getMerges().get(T(e));if(o){const f=V({r:e.r+o.rs-1,c:e.c+o.cs-1},{left:0,top:0},this.rowDim,this.colDim);r.width=f.left+f.width-r.left,r.height=f.top+f.height-r.top}const a=this.colDim.getOffset(s.frozenCols+1),h=this.rowDim.getOffset(s.frozenRows+1),c=this.viewport.width-b-s.frozenWidth,u=this.viewport.height-S-s.frozenHeight;let d=!1;if(!i){const f=a+t.left,m=f+c,g=r.left-b,y=g+r.width;g<f?(this.scroll={left:g-a},d=!0):y>m&&(this.scroll={left:y-c-a},d=!0)}if(!n){const f=h+t.top,m=f+u,g=r.top-S,y=g+r.height;g<f?(this.scroll={top:g-h},d=!0):y>m&&(this.scroll={top:y-u-h},d=!0)}d&&this.render()}getCellInputRect(e){const t=this.getCellRect(e),s=this.sheet.getMerges().get(T(e));if(!s)return t;const n=this.getCellRect({r:e.r+s.rs-1,c:e.c+s.cs-1});return t.width=n.left+n.width-t.left,t.height=n.top+n.height-t.top,t}resolveCellInputLayout(e){const t=this.getCellInputRect(e),s=this.viewport,n=b,i=S,r=s.width,o=s.height;if(t.left<r&&t.left+t.width>n&&t.top<o&&t.top+t.height>i)return{left:t.left,top:t.top,width:t.width,height:t.height,maxWidth:Math.max(t.width,s.width-t.left),maxHeight:Math.max(t.height,s.height-t.top),pinned:!1};const h=n+ye,c=i+ye,u=Math.max(h,s.width-t.width-ye),d=Math.max(c,s.height-t.height-ye),f=Math.min(u,Math.max(h,t.left)),m=Math.min(d,Math.max(c,t.top));return{left:f,top:m,width:t.width,height:t.height,maxWidth:Math.max(t.width,s.width-f-ye),maxHeight:Math.max(t.height,s.height-m-ye),pinned:!0}}updateAutocompletePositionForActiveInput(){if(!this.autocomplete.isListVisible()&&!this.autocomplete.isHintVisible())return;let e;if(this.cellInput.isFocused()?e=this.cellInput.getInput():this.formulaBar.isFocused()&&(e=this.formulaBar.getFormulaInput()),!e)return;const t=e.getBoundingClientRect();this.autocomplete.reposition({left:t.left,top:t.bottom+2})}updateCellInputPosition(){if(!this.sheet||!this.cellInput.isShown())return;const e=this.sheet.getActiveCell(),t=this.resolveCellInputLayout(e);this.cellInput.updatePlacement(t.left,t.top,t.width,t.height,t.maxWidth,t.maxHeight),this.cellInput.setCellPositionHint(t.pinned?T(e):void 0),this.updateAutocompletePositionForActiveInput()}primeCellInputForSelection(){if(this.readOnly||!this.sheet||this.formulaBar.isFocused()||this.sheet.getSelectionType()!=="cell"||this.sheet.hasRange())return;this.editMode=!1;const e=this.sheet.getActiveCell(),t=this.resolveCellInputLayout(e);this.cellInput.prime(t.left,t.top,t.width,t.height,t.maxWidth,t.maxHeight),this.cellInput.setCellPositionHint(t.pinned?T(e):void 0)}async syncCellInputStyleForActiveCell(){if(!this.sheet||!this.cellInput.isFocused()||this.cellInput.isPrimed())return;const e=this.sheet.getActiveCell(),t=await this.sheet.getStyle(e);if(!this.sheet||!this.cellInput.isFocused()||this.cellInput.isPrimed())return;const s=this.sheet.getActiveCell();s.r!==e.r||s.c!==e.c||this.cellInput.applyStyle(t)}async showCellInput(e=!1,t=!1,s=!1){t||(this.editMode=!e);const n=this.sheet.getActiveCell(),i=this.resolveCellInputLayout(n),r=e?"":await this.sheet.toInputString(n);this.cellInput.show(i.left,i.top,r,!t,i.width,i.height,i.maxWidth,i.maxHeight,!s),this.cellInput.setCellPositionHint(i.pinned?T(n):void 0);const o=await this.sheet.getStyle(n);this.cellInput.applyStyle(o),r.startsWith("=")&&(this.formulaRanges=Se(r).map(a=>a.range),this.renderOverlay())}isValidCellInput(e){return e.length===1}async renderSheet(e=this.renderVersion){const t=this.sheet;if(!t)return;this.syncHiddenRowsFromSheet(),this.syncHiddenColumnsFromSheet();const s=this.gridSize,n=this.freezeState;this.gridContainer.updateDummySize(s.width+b,s.height+S);const i=this.viewport,r=this.scroll,o=this.viewRange,a=[{r:1,c:1},{r:o[1].r,c:o[1].c}],h=await t.fetchGrid(a);t!==this.sheet||e!==this.renderVersion||this.gridCanvas.render(i,r,o,t.getActiveCell(),h,this.rowDim,this.colDim,t.getSelectionType(),t.getRange(),n,this.freezeHandleHover,t.getColStyles(),t.getRowStyles(),t.getSheetStyle(),t.getRangeStyles(),t.getConditionalFormats(),t.getMerges(),t.getFilterRange(),t.getFilteredColumns(),this.filterButtonHoverCol,t.getHiddenRows().size>0?t.getHiddenRows():void 0,t.getHiddenColumns().size>0?t.getHiddenColumns():void 0,this.hiddenIndicatorHover)}syncHiddenRowsFromSheet(){const e=this.sheet;if(!e)return;const t=e.getHiddenRows();for(const s of this.hiddenRows){if(t.has(s))continue;const n=this.hiddenRowSizeBackup.get(s)??this.rowDim.getDefaultSize();this.rowDim.setSize(s,n),this.hiddenRowSizeBackup.delete(s)}for(const s of t)this.hiddenRows.has(s)||(this.hiddenRowSizeBackup.set(s,this.rowDim.getSize(s)),this.rowDim.setSize(s,0));this.hiddenRows=t}findAdjacentHiddenRows(e,t){const s=this.sheet;if(!s)return[];const n=s.getUserHiddenRows();if(n.size===0)return[];const i=[];for(let r=e-1;r>=1&&n.has(r);r--)i.push(r);for(let r=e;r<=t;r++)n.has(r)&&i.push(r);for(let r=t+1;r<=(s.getDimension().rows||1e6)&&n.has(r);r++)i.push(r);return i}findAdjacentHiddenColumns(e,t){const s=this.sheet;if(!s)return[];const n=s.getHiddenColumns();if(n.size===0)return[];const i=[];for(let r=e-1;r>=1&&n.has(r);r--)i.push(r);for(let r=e;r<=t;r++)n.has(r)&&i.push(r);for(let r=t+1;r<=(s.getDimension().columns||18278)&&n.has(r);r++)i.push(r);return i}syncHiddenColumnsFromSheet(){const e=this.sheet;if(!e)return;const t=e.getHiddenColumns();for(const s of this.hiddenColumns){if(t.has(s))continue;const n=this.hiddenColSizeBackup.get(s)??this.colDim.getDefaultSize();this.colDim.setSize(s,n),this.hiddenColSizeBackup.delete(s)}for(const s of t)this.hiddenColumns.has(s)||(this.hiddenColSizeBackup.set(s,this.colDim.getSize(s)),this.colDim.setSize(s,0));this.hiddenColumns=t}get gridSize(){const e=this.sheet.getDimension();return{width:this.colDim.getOffset(e.columns+1),height:this.rowDim.getOffset(e.rows+1)}}get viewport(){return this.gridContainer.getViewport()}get scroll(){return this.gridContainer.getScrollPosition()}set scroll(e){this.gridContainer.setScrollPosition(e)}}async function Bn(l,e){const t=new In(l,e),s=(e==null?void 0:e.store)||new Bs;return await t.initialize(s),t}class In{constructor(e,t){p(this,"container");p(this,"worksheet");p(this,"sheet");p(this,"theme");p(this,"_readOnly");p(this,"selectionChangeCallbacks",[]);this.container=e,this.container.style.position="relative",this.container.style.overflow="hidden",this.theme=(t==null?void 0:t.theme)||"light",this._readOnly=(t==null?void 0:t.readOnly)||!1,this.worksheet=new Mn(this.container,this.theme,this._readOnly)}get readOnly(){return this._readOnly}async initialize(e){this.sheet=new en(e),this.worksheet.setOnRender(()=>this.notifySelectionChange()),await this.worksheet.initialize(this.sheet)}async reloadDimensions(){await this.worksheet.reloadDimensions()}async setFreezePane(e,t){this._readOnly||await this.worksheet.setFreezePane(e,t)}render(){this.worksheet.render()}renderOverlay(){this.worksheet.renderOverlay()}panBy(e,t){this.worksheet.panBy(e,t)}handleMobileDoubleTap(e,t){this.worksheet.handleMobileDoubleTap(e,t)}async focusCell(e){this.sheet&&(await this.worksheet.focusCell(e),this.notifySelectionChange())}async applyStyle(e){!this.sheet||this._readOnly||(await this.sheet.setRangeStyle(e),this.worksheet.render(),this.notifySelectionChange())}async applyDefaultStyle(){!this.sheet||this._readOnly||await this.sheet.resetRangeStyleToDefault()&&(this.worksheet.render(),this.notifySelectionChange())}async applyBorders(e){!this.sheet||this._readOnly||await this.sheet.setRangeBorders(e)&&(this.worksheet.render(),this.notifySelectionChange())}async toggleStyle(e){!this.sheet||this._readOnly||(await this.sheet.toggleRangeStyle(e),this.worksheet.render(),this.notifySelectionChange())}async getActiveStyle(){if(this.sheet)return this.sheet.getStyle(this.sheet.getActiveCell())}getActiveCell(){var e;return(e=this.sheet)==null?void 0:e.getActiveCell()}getConditionalFormats(){var e;return((e=this.sheet)==null?void 0:e.getConditionalFormats())||[]}async setConditionalFormats(e){!this.sheet||this._readOnly||(await this.sheet.setConditionalFormats(e),this.worksheet.render(),this.notifySelectionChange())}onSelectionChange(e){return this.selectionChangeCallbacks.push(e),()=>{this.selectionChangeCallbacks=this.selectionChangeCallbacks.filter(t=>t!==e)}}notifySelectionChange(){for(const e of this.selectionChangeCallbacks)e()}getSelectionType(){var e;return(e=this.sheet)==null?void 0:e.getSelectionType()}getSelectionRangeOrActiveCell(){var e;return(e=this.sheet)==null?void 0:e.getRangeOrActiveCell()}getGridViewportRect(){return this.worksheet.getGridViewportRect()}getScrollableGridViewportRect(){return this.worksheet.getScrollableGridViewportRect()}getCellRect(e){return this.worksheet.getCellRect(e)}getCellRectInScrollableViewport(e){return this.worksheet.getCellRectInScrollableViewport(e)}async increaseDecimals(){if(!this.sheet||this._readOnly)return;const e=await this.sheet.getActiveDecimalPlaces();await this.sheet.setRangeStyle({dp:e+1}),this.worksheet.render(),this.notifySelectionChange()}async decreaseDecimals(){if(!this.sheet||this._readOnly)return;const e=await this.sheet.getActiveDecimalPlaces();await this.sheet.setRangeStyle({dp:Math.max(0,e-1)}),this.worksheet.render(),this.notifySelectionChange()}async toggleMergeCells(){!this.sheet||this._readOnly||await this.sheet.toggleMergeSelection()&&(this.worksheet.render(),this.notifySelectionChange())}isSelectionMerged(){return this.sheet?this.sheet.isSelectionMerged():!1}canMergeSelection(){return this.sheet?this.sheet.canMergeSelection():!1}hasFilter(){var e;return((e=this.sheet)==null?void 0:e.hasFilter())||!1}async createFilterFromSelection(){if(!this.sheet||this._readOnly)return!1;const e=await this.sheet.createFilterFromSelection();return e&&(this.worksheet.render(),this.notifySelectionChange()),e}async clearFilter(){!this.sheet||this._readOnly||(await this.sheet.clearFilter(),this.worksheet.render(),this.notifySelectionChange())}async setColumnFilter(e,t){if(!this.sheet||this._readOnly)return!1;const s=await this.sheet.setColumnFilter(e,t);return s&&(this.worksheet.render(),this.notifySelectionChange()),s}async clearColumnFilter(e){if(!this.sheet||this._readOnly)return!1;const t=await this.sheet.clearColumnFilter(e);return t&&(this.worksheet.render(),this.notifySelectionChange()),t}async undo(){!this.sheet||this._readOnly||await this.sheet.undo()&&(this.worksheet.render(),this.notifySelectionChange())}async redo(){!this.sheet||this._readOnly||await this.sheet.redo()&&(this.worksheet.render(),this.notifySelectionChange())}toggleFunctionBrowser(){this.worksheet.toggleFunctionBrowser()}cleanup(){this.worksheet.cleanup(),this.selectionChangeCallbacks=[]}setGridResolver(e){this.sheet&&this.sheet.setGridResolver(e)}async recalculateCrossSheetFormulas(){this.sheet&&(await this.sheet.recalculateCrossSheetFormulas(),this.worksheet.render())}}export{Yt as C,Bs as M,An as R,Le as a,B as b,ot as c,ae as d,T as e,Bn as f,Hn as g,_t as h,ds as i,ze as j,Ve as k,Ce as l,ys as m,he as n,Vt as o,Ht as p,Pt as q,Ut as r,ms as s,Bt as t,ge as u,fs as v,$t as w,kt as x,Kt as y,_ as z};
