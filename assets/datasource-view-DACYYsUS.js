var b=Object.defineProperty;var z=(n,e,t)=>e in n?b(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var w=(n,e,t)=>z(n,typeof e!="symbol"?e+"":e,t);import{x as I,r as c,y as D,j as l,e as N}from"./index-D5oNvs3K.js";import{C as k,t as x,f as P,p as F,u as q,j as Q}from"./use-mobile-sheet-gestures-CXy8Dgwh.js";import{B as T}from"./button-qO4JQShF.js";import{e as B}from"./datasources-CxHMap9r.js";import{c as G}from"./IconDotsVertical-CIzKPvuZ.js";import"./index-Blev2G-K.js";import"./index-FAgfuOTz.js";import"./dropdown-menu-BoN6q3f2.js";import"./index-Dzzh6ZHZ.js";/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var K=G("outline","player-play","IconPlayerPlay",[["path",{d:"M7 4v16l13 -8z",key:"svg-0"}]]);class A{constructor(){w(this,"grid",new Map);w(this,"cellIndex",new k)}loadQueryResults(e,t){this.grid.clear();for(let r=0;r<e.length;r++){const d=x({r:1,c:r+1});this.grid.set(d,{v:e[r].name,s:{b:!0}})}for(let r=0;r<t.length;r++){const d=t[r];for(let s=0;s<e.length;s++){const a=d[e[s].name];if(a==null)continue;const f=x({r:r+2,c:s+1});this.grid.set(f,{v:String(a)})}}this.rebuildIndex()}async set(e,t){}async get(e){return this.grid.get(x(e))}async has(e){return this.grid.has(x(e))}async delete(e){return!1}async deleteRange(e){return new Set}async setGrid(e){}async getGrid(e){const t=new Map;for(const[r,d]of this.cellIndex.cellsInRange(e)){const s=x({r,c:d}),a=this.grid.get(s);a!==void 0&&t.set(s,a)}return t}async findEdge(e,t,r){return P(this.cellIndex,e,t,r,(d,s)=>{const a=this.grid.get(x({r:d,c:s}));return a!==void 0&&(!!a.v||!!a.f)})}async shiftCells(e,t,r){}async moveCells(e,t,r,d){}async buildDependantsMap(e){return new Map}async getFormulaGrid(){return new Map}getPresences(){return[]}updateActiveCell(e){}async setDimensionSize(e,t,r){}async getDimensionSizes(e){return new Map}async setColumnStyle(e,t){}async getColumnStyles(){return new Map}async setRowStyle(e,t){}async getRowStyles(){return new Map}async setSheetStyle(e){}async getSheetStyle(){}async setMerge(e,t){}async deleteMerge(e){return!1}async getMerges(){return new Map}async setFilterState(e){}async getFilterState(){}async setFreezePane(e,t){}async getFreezePane(){return{frozenRows:0,frozenCols:0}}beginBatch(){}endBatch(){}async undo(){return{success:!1}}async redo(){return{success:!1}}canUndo(){return!1}canRedo(){return!1}rebuildIndex(){this.cellIndex.rebuild(Array.from(this.grid.keys()).map(e=>{const t=F(e);return[t.r,t.c]}))}}function $({tabId:n}){const{resolvedTheme:e}=I(),t=c.useRef(null),[r,d]=c.useState(!1),s=c.useRef(void 0),a=c.useRef(new A),{doc:f,loading:C,error:v}=D.useDocument(),[y,_]=c.useState(""),[S,R]=c.useState(!1),[g,E]=c.useState(null),[M,m]=c.useState(null);q({containerRef:t,sheetRef:s}),c.useEffect(()=>{d(!0)},[]),c.useEffect(()=>{if(!f)return;const o=f.getRoot().tabs[n];o!=null&&o.query&&_(o.query)},[f,n]),c.useEffect(()=>{const u=t.current;if(!r||!u)return;let o,i=!1;return Q(u,{theme:e,store:a.current,readOnly:!0}).then(p=>{if(i){p.cleanup();return}o=p,s.current=p}),()=>{i=!0,o&&o.cleanup(),s.current=void 0}},[r,e]);const h=c.useCallback(async()=>{if(!f||!y.trim())return;const o=f.getRoot().tabs[n];if(!(o!=null&&o.datasourceId)){m("No datasource connected to this tab");return}f.update(i=>{i.tabs[n]&&(i.tabs[n].query=y)}),R(!0),m(null);try{const i=await B(o.datasourceId,y);E(i),a.current.loadQueryResults(i.columns,i.rows),s.current&&(await s.current.reloadDimensions(),s.current.render())}catch(i){m(i.message)}finally{R(!1)}},[f,n,y]),j=c.useCallback(u=>{(u.metaKey||u.ctrlKey)&&u.key==="Enter"&&(u.preventDefault(),h())},[h]);return C?l.jsx(N,{}):v?l.jsx("div",{className:"flex h-full w-full items-center justify-center",children:l.jsx("div",{className:"text-red-500",children:v.message})}):l.jsxs("div",{className:"flex h-full w-full flex-col",children:[l.jsx("div",{className:"border-b p-2 shrink-0",children:l.jsx("textarea",{className:"w-full h-24 p-2 font-mono text-sm border rounded resize-y bg-background text-foreground focus:outline-none focus:ring-1 focus:ring-primary",placeholder:"SELECT * FROM users LIMIT 100",value:y,onChange:u=>_(u.target.value),onKeyDown:j})}),l.jsxs("div",{className:"flex items-center gap-3 px-3 py-1.5 border-b shrink-0",children:[l.jsxs(T,{size:"sm",onClick:h,disabled:S||!y.trim(),children:[l.jsx(K,{className:"size-4"}),S?"Executing...":"Execute"]}),g&&l.jsxs("span",{className:"text-xs text-muted-foreground",children:[g.rowCount," row",g.rowCount!==1?"s":"",g.truncated?" (truncated)":""," in ",g.executionTime,"ms"]}),M&&l.jsx("span",{className:"text-xs text-destructive truncate",children:M})]}),l.jsx("div",{ref:t,className:"flex-1 w-full",style:{touchAction:"manipulation"}})]})}export{$ as DataSourceView};
