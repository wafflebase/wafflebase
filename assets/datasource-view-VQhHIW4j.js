var j=Object.defineProperty;var z=(n,e,t)=>e in n?j(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var _=(n,e,t)=>z(n,typeof e!="symbol"?e+"":e,t);import{x as I,r as o,y as D,j as l,e as N}from"./index-Be86izrq.js";import{C as k,t as g,f as P,p as F,u as q,o as Q}from"./use-mobile-sheet-gestures-C4icGIwp.js";import{B as T}from"./button-EK1VOglo.js";import{e as B}from"./datasources-86NudJhE.js";import{c as G}from"./IconDotsVertical-JA2D39GJ.js";import"./index-3cL1CT6c.js";import"./index-Bo56FxG0.js";import"./dropdown-menu-CrG1Wdzl.js";import"./index-CGFVQLu4.js";/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var K=G("outline","player-play","IconPlayerPlay",[["path",{d:"M7 4v16l13 -8z",key:"svg-0"}]]);class A{constructor(){_(this,"grid",new Map);_(this,"cellIndex",new k)}loadQueryResults(e,t){this.grid.clear();for(let s=0;s<e.length;s++){const d=g({r:1,c:s+1});this.grid.set(d,{v:e[s].name,s:{b:!0}})}for(let s=0;s<t.length;s++){const d=t[s];for(let r=0;r<e.length;r++){const a=d[e[r].name];if(a==null)continue;const f=g({r:s+2,c:r+1});this.grid.set(f,{v:String(a)})}}this.rebuildIndex()}async set(e,t){}async get(e){return this.grid.get(g(e))}async has(e){return this.grid.has(g(e))}async delete(e){return!1}async deleteRange(e){return new Set}async setGrid(e){}async getGrid(e){const t=new Map;for(const[s,d]of this.cellIndex.cellsInRange(e)){const r=g({r:s,c:d}),a=this.grid.get(r);a!==void 0&&t.set(r,a)}return t}async findEdge(e,t,s){return P(this.cellIndex,e,t,s,(d,r)=>{const a=this.grid.get(g({r:d,c:r}));return a!==void 0&&(!!a.v||!!a.f)})}async shiftCells(e,t,s){}async moveCells(e,t,s,d){}async buildDependantsMap(e){return new Map}async getFormulaGrid(){return new Map}getPresences(){return[]}updateActiveCell(e){}async setDimensionSize(e,t,s){}async getDimensionSizes(e){return new Map}async setColumnStyle(e,t){}async getColumnStyles(){return new Map}async setRowStyle(e,t){}async getRowStyles(){return new Map}async setSheetStyle(e){}async getSheetStyle(){}async addRangeStyle(e){}async setRangeStyles(e){}async getRangeStyles(){return[]}async setMerge(e,t){}async deleteMerge(e){return!1}async getMerges(){return new Map}async setFilterState(e){}async getFilterState(){}async setFreezePane(e,t){}async getFreezePane(){return{frozenRows:0,frozenCols:0}}beginBatch(){}endBatch(){}async undo(){return{success:!1}}async redo(){return{success:!1}}canUndo(){return!1}canRedo(){return!1}rebuildIndex(){this.cellIndex.rebuild(Array.from(this.grid.keys()).map(e=>{const t=F(e);return[t.r,t.c]}))}}function $({tabId:n}){const{resolvedTheme:e}=I(),t=o.useRef(null),[s,d]=o.useState(!1),r=o.useRef(void 0),a=o.useRef(new A),{doc:f,loading:C,error:w}=D.useDocument(),[y,v]=o.useState(""),[S,R]=o.useState(!1),[x,E]=o.useState(null),[M,h]=o.useState(null);q({containerRef:t,sheetRef:r}),o.useEffect(()=>{d(!0)},[]),o.useEffect(()=>{if(!f)return;const c=f.getRoot().tabs[n];c!=null&&c.query&&v(c.query)},[f,n]),o.useEffect(()=>{const u=t.current;if(!s||!u)return;let c,i=!1;return Q(u,{theme:e,store:a.current,readOnly:!0}).then(p=>{if(i){p.cleanup();return}c=p,r.current=p}),()=>{i=!0,c&&c.cleanup(),r.current=void 0}},[s,e]);const m=o.useCallback(async()=>{if(!f||!y.trim())return;const c=f.getRoot().tabs[n];if(!(c!=null&&c.datasourceId)){h("No datasource connected to this tab");return}f.update(i=>{i.tabs[n]&&(i.tabs[n].query=y)}),R(!0),h(null);try{const i=await B(c.datasourceId,y);E(i),a.current.loadQueryResults(i.columns,i.rows),r.current&&(await r.current.reloadDimensions(),r.current.render())}catch(i){h(i.message)}finally{R(!1)}},[f,n,y]),b=o.useCallback(u=>{(u.metaKey||u.ctrlKey)&&u.key==="Enter"&&(u.preventDefault(),m())},[m]);return C?l.jsx(N,{}):w?l.jsx("div",{className:"flex h-full w-full items-center justify-center",children:l.jsx("div",{className:"text-red-500",children:w.message})}):l.jsxs("div",{className:"flex h-full w-full flex-col",children:[l.jsx("div",{className:"border-b p-2 shrink-0",children:l.jsx("textarea",{className:"w-full h-24 p-2 font-mono text-sm border rounded resize-y bg-background text-foreground focus:outline-none focus:ring-1 focus:ring-primary",placeholder:"SELECT * FROM users LIMIT 100",value:y,onChange:u=>v(u.target.value),onKeyDown:b})}),l.jsxs("div",{className:"flex items-center gap-3 px-3 py-1.5 border-b shrink-0",children:[l.jsxs(T,{size:"sm",onClick:m,disabled:S||!y.trim(),children:[l.jsx(K,{className:"size-4"}),S?"Executing...":"Execute"]}),x&&l.jsxs("span",{className:"text-xs text-muted-foreground",children:[x.rowCount," row",x.rowCount!==1?"s":"",x.truncated?" (truncated)":""," in ",x.executionTime,"ms"]}),M&&l.jsx("span",{className:"text-xs text-destructive truncate",children:M})]}),l.jsx("div",{ref:t,className:"flex-1 w-full",style:{touchAction:"manipulation"}})]})}export{$ as DataSourceView};
