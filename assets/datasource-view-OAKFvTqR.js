var z=Object.defineProperty;var I=(n,e,t)=>e in n?z(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var w=(n,e,t)=>I(n,typeof e!="symbol"?e+"":e,t);import{A as D,r as o,y as N,i as k,j as l,e as F}from"./index-BAE90tNc.js";import{C as P,t as g,f as q,p as A,w as Q,x as T}from"./use-mobile-sheet-gestures-CpJNt2Ut.js";import{B}from"./button-DR31X2If.js";import{e as G}from"./datasources-Cr9zrCna.js";import{c as K}from"./IconDotsVertical-D34z_iVU.js";import"./index-BWnTk6ab.js";import"./index-BH3h_c4l.js";import"./dropdown-menu-CuttjPRH.js";import"./index-DeC5LhUt.js";/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var L=K("outline","player-play","IconPlayerPlay",[["path",{d:"M7 4v16l13 -8z",key:"svg-0"}]]);class J{constructor(){w(this,"grid",new Map);w(this,"cellIndex",new P)}loadQueryResults(e,t){this.grid.clear();for(let s=0;s<e.length;s++){const i=g({r:1,c:s+1});this.grid.set(i,{v:e[s].name,s:{b:!0}})}for(let s=0;s<t.length;s++){const i=t[s];for(let u=0;u<e.length;u++){const r=i[e[u].name];if(r==null)continue;const h=g({r:s+2,c:u+1});this.grid.set(h,{v:String(r)})}}this.rebuildIndex()}async set(e,t){}async get(e){return this.grid.get(g(e))}async has(e){return this.grid.has(g(e))}async delete(e){return!1}async deleteRange(e){return new Set}async setGrid(e){}async getGrid(e){const t=new Map;for(const[s,i]of this.cellIndex.cellsInRange(e)){const u=g({r:s,c:i}),r=this.grid.get(u);r!==void 0&&t.set(u,r)}return t}async findEdge(e,t,s){return q(this.cellIndex,e,t,s,(i,u)=>{const r=this.grid.get(g({r:i,c:u}));return r!==void 0&&(!!r.v||!!r.f)})}async shiftCells(e,t,s){}async moveCells(e,t,s,i){}async buildDependantsMap(e){return new Map}async getFormulaGrid(){return new Map}getPresences(){return[]}updateActiveCell(e){}async setDimensionSize(e,t,s){}async getDimensionSizes(e){return new Map}async setColumnStyle(e,t){}async getColumnStyles(){return new Map}async setRowStyle(e,t){}async getRowStyles(){return new Map}async setSheetStyle(e){}async getSheetStyle(){}async addRangeStyle(e){}async setRangeStyles(e){}async getRangeStyles(){return[]}async setConditionalFormats(e){}async getConditionalFormats(){return[]}async setMerge(e,t){}async deleteMerge(e){return!1}async getMerges(){return new Map}async setFilterState(e){}async getFilterState(){}async setFreezePane(e,t){}async getFreezePane(){return{frozenRows:0,frozenCols:0}}beginBatch(){}endBatch(){}async undo(){return{success:!1}}async redo(){return{success:!1}}canUndo(){return!1}canRedo(){return!1}rebuildIndex(){this.cellIndex.rebuild(Array.from(this.grid.keys()).map(e=>{const t=A(e);return[t.r,t.c]}))}}function te({tabId:n,readOnly:e=!1}){const{resolvedTheme:t}=D(),s=o.useRef(null),[i,u]=o.useState(!1),r=o.useRef(void 0),h=o.useRef(new J),{doc:f,loading:M,error:v}=N.useDocument(),[y,S]=o.useState(""),[R,C]=o.useState(!1),[x,b]=o.useState(null),[E,m]=o.useState(null);Q({containerRef:s,sheetRef:r}),o.useEffect(()=>{u(!0)},[]),o.useEffect(()=>{if(!f)return;const a=f.getRoot().tabs[n];a!=null&&a.query&&S(a.query)},[f,n]),o.useEffect(()=>{const d=s.current;if(!i||!d)return;let a,c=!1;return T(d,{theme:t,store:h.current,readOnly:!0}).then(_=>{if(c){_.cleanup();return}a=_,r.current=_}),()=>{c=!0,a&&a.cleanup(),r.current=void 0}},[i,t]);const p=o.useCallback(async()=>{if(!f||!y.trim()||e)return;const a=f.getRoot().tabs[n];if(!(a!=null&&a.datasourceId)){m("No datasource connected to this tab");return}f.update(c=>{c.tabs[n]&&(c.tabs[n].query=y)}),C(!0),m(null);try{const c=await G(a.datasourceId,y);b(c),h.current.loadQueryResults(c.columns,c.rows),r.current&&(await r.current.reloadDimensions(),r.current.render())}catch(c){if(k(c))return;m(c.message)}finally{C(!1)}},[f,n,y,e]),j=o.useCallback(d=>{if((d.metaKey||d.ctrlKey)&&d.key==="Enter"){if(e)return;d.preventDefault(),p()}},[p,e]);return M?l.jsx(F,{}):v?l.jsx("div",{className:"flex h-full w-full items-center justify-center",children:l.jsx("div",{className:"text-red-500",children:v.message})}):l.jsxs("div",{className:"flex h-full w-full flex-col",children:[l.jsx("div",{className:"border-b p-2 shrink-0",children:l.jsx("textarea",{className:"w-full h-24 p-2 font-mono text-sm border rounded resize-y bg-background text-foreground focus:outline-none focus:ring-1 focus:ring-primary",placeholder:"SELECT * FROM users LIMIT 100",value:y,onChange:d=>{e||S(d.target.value)},onKeyDown:j,readOnly:e})}),l.jsxs("div",{className:"flex items-center gap-3 px-3 py-1.5 border-b shrink-0",children:[l.jsxs(B,{size:"sm",onClick:p,disabled:e||R||!y.trim(),children:[l.jsx(L,{className:"size-4"}),R?"Executing...":"Execute"]}),x&&l.jsxs("span",{className:"text-xs text-muted-foreground",children:[x.rowCount," row",x.rowCount!==1?"s":"",x.truncated?" (truncated)":""," in ",x.executionTime,"ms"]}),E&&l.jsx("span",{className:"text-xs text-destructive truncate",children:E})]}),l.jsx("div",{ref:s,className:"flex-1 w-full",style:{touchAction:"manipulation"}})]})}export{te as DataSourceView};
